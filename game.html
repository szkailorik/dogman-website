<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Man: Supa Buddies Slingshot | Ë∂ÖÁ∫ß‰ºô‰º¥ÂºπÂºìÂ§ßÊàò</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .game-nav {
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }

        .nav-brand img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #FFD700;
        }

        .nav-brand span {
            font-family: 'Bangers', cursive;
            font-size: 1.5rem;
            color: #FFD700;
            text-shadow: 2px 2px 0 #c0392b;
        }

        .back-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .back-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }

        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 75px 15px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-title {
            font-family: 'Bangers', cursive;
            font-size: 2.2rem;
            color: #FFD700;
            text-shadow: 3px 3px 0 #e74c3c, 5px 5px 0 rgba(0,0,0,0.4);
            margin-bottom: 5px;
            text-align: center;
        }

        .game-subtitle {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 15px;
            text-align: center;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 900px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(30,30,60,0.7));
            border-radius: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .level-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .info-box {
            text-align: center;
            padding: 5px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .info-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }

        .info-value {
            font-family: 'Bangers', cursive;
            font-size: 1.5rem;
            color: #FFD700;
        }

        .stars-display {
            display: flex;
            gap: 3px;
        }

        .star {
            font-size: 1.5rem;
            color: #333;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .star.earned {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .sound-controls {
            display: flex;
            gap: 8px;
        }

        .sound-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255,215,0,0.5);
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sound-btn:hover {
            background: linear-gradient(135deg, rgba(255,215,0,0.4), rgba(255,215,0,0.2));
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255,215,0,0.3);
        }

        .game-wrapper {
            background: linear-gradient(135deg, #1a1a2e, #0a0a1a);
            border-radius: 15px;
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6), inset 0 0 30px rgba(255,215,0,0.1);
            border: 2px solid rgba(255,215,0,0.2);
        }

        #gameCanvas {
            display: block;
            border-radius: 10px;
            cursor: crosshair;
        }

        .buddies-panel {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(30,30,60,0.6));
            border-radius: 15px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .buddy-slot {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .buddy-slot.active {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,215,0,0.1));
            box-shadow: 0 0 20px rgba(255,215,0,0.4);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .buddy-slot.used {
            opacity: 0.3;
            filter: grayscale(1);
        }

        .game-controls {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            padding: 12px 25px;
            font-size: 0.95rem;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Comic Neue', sans-serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn-restart {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-next {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-levels {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* ÂºπÁ™óÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #0f0f2a);
            padding: 35px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #FFD700;
            max-width: 450px;
            box-shadow: 0 0 50px rgba(255,215,0,0.3);
        }

        .modal-title {
            font-family: 'Bangers', cursive;
            font-size: 2.2rem;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #c0392b;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 25px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .level-btn {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 2px solid #444;
            background: linear-gradient(135deg, #2a2a4a, #1a1a3a);
            color: white;
            font-family: 'Bangers', cursive;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .level-btn:hover:not(:disabled) {
            transform: scale(1.1);
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.4);
        }

        .level-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .level-btn.completed {
            border-color: #2ecc71;
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }

        .level-btn .level-stars {
            font-size: 0.6rem;
            margin-top: 2px;
        }

        .close-modal-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal-btn:hover {
            transform: scale(1.05);
        }

        .result-stars {
            font-size: 3rem;
            margin: 15px 0;
        }

        .result-score {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #ccc;
        }

        .result-score span {
            font-family: 'Bangers', cursive;
            font-size: 1.8rem;
            color: #2ecc71;
        }

        .result-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .result-btn {
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-btn:hover {
            transform: scale(1.05);
        }

        /* ËØ¥ÊòéÂå∫ */
        .instructions {
            margin-top: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border-radius: 15px;
            padding: 20px 25px;
            max-width: 700px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .instructions h3 {
            font-family: 'Bangers', cursive;
            font-size: 1.4rem;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }

        .instructions p {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .buddy-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .buddy-card {
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .buddy-card .emoji {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .buddy-card .name {
            font-weight: bold;
            color: #FFD700;
            font-size: 0.9rem;
        }

        .buddy-card .skill {
            font-size: 0.75rem;
            color: #aaa;
        }

        @media (max-width: 950px) {
            #gameCanvas {
                width: 100%;
                height: auto;
            }
            .game-header {
                flex-direction: column;
                gap: 12px;
            }
            .levels-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <nav class="game-nav">
        <a href="index.html" class="nav-brand">
            <img src="https://pilkey.com/userFiles/uploads/dog-man/dog-man/Dog_Man_1.jpeg" alt="Dog Man">
            <span>DOG MAN</span>
        </a>
        <button class="back-btn" onclick="window.location.href='index.html'">ËøîÂõû‰∏ªÈ°µ</button>
    </nav>

    <div class="game-container">
        <h1 class="game-title">SUPA BUDDIES SLINGSHOT</h1>
        <p class="game-subtitle">Áî®ÂºπÂºìÂèëÂ∞ÑË∂ÖÁ∫ß‰ºô‰º¥ÔºåÊâìÂÄíÊâÄÊúâÂèçÊ¥æÔºÅ</p>

        <div class="game-header">
            <div class="level-info">
                <div class="info-box">
                    <div class="info-label">ÂÖ≥Âç°</div>
                    <div class="info-value" id="currentLevel">1</div>
                </div>
                <div class="info-box">
                    <div class="info-label">ÂàÜÊï∞</div>
                    <div class="info-value" id="currentScore">0</div>
                </div>
                <div class="info-box">
                    <div class="info-label">ÂèçÊ¥æ</div>
                    <div class="info-value" id="villainsLeft">3</div>
                </div>
            </div>
            <div class="stars-display">
                <span class="star" id="star1">‚òÖ</span>
                <span class="star" id="star2">‚òÖ</span>
                <span class="star" id="star3">‚òÖ</span>
            </div>
            <div class="sound-controls">
                <button class="sound-btn" id="soundBtn" onclick="toggleSound()" title="Èü≥Êïà">üîä</button>
            </div>
        </div>

        <div class="game-wrapper">
            <canvas id="gameCanvas" width="1100" height="600"></canvas>
        </div>

        <div class="buddies-panel" id="buddiesPanel"></div>

        <div class="game-controls">
            <button class="control-btn btn-restart" onclick="restartLevel()">ÈáçÁé©Êú¨ÂÖ≥</button>
            <button class="control-btn btn-next" id="nextLevelBtn" onclick="nextLevel()" disabled>‰∏ã‰∏ÄÂÖ≥</button>
            <button class="control-btn btn-levels" onclick="showLevelSelect()">ÈÄâÊã©ÂÖ≥Âç°</button>
        </div>

        <div class="instructions">
            <h3>Ê∏∏ÊàèËØ¥Êòé</h3>
            <p>üéØ <strong>ÁõÆÊ†áÔºö</strong>Áî®ÂºπÂºìÂèëÂ∞ÑË∂ÖÁ∫ß‰ºô‰º¥ÔºåÊâìÂÄíÊâÄÊúâÂèçÊ¥æÔºÅ</p>
            <p>üñ±Ô∏è <strong>Êìç‰ΩúÔºö</strong>ÊãñÂä®ËßíËâ≤ÂêëÂ∑¶ÂêéÊñπÊãâÂä®ÔºåÊùæÂºÄÂèëÂ∞Ñ„ÄÇÊãâÂæóË∂äËøúÂäõÈáèË∂äÂ§ßÔºÅ</p>
            <p>‚≠ê <strong>ËØÑÂàÜÔºö</strong>Áî®Ë∂äÂ∞ëÁöÑËßíËâ≤ÂÆåÊàêÂÖ≥Âç°ÔºåËé∑ÂæóË∂äÂ§öÊòüÊòüÔºÅ</p>
            <p>üí° <strong>ÊèêÁ§∫Ôºö</strong>È£ûË°å‰∏≠ÁÇπÂáªÂ±èÂπïÂèØ‰ΩøÁî®ÁâπÊÆäÊäÄËÉΩÔºÅ</p>

            <div class="buddy-info">
                <div class="buddy-card">
                    <canvas id="dogmanIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Dog Man</div>
                    <div class="skill">ÁãóÂ§¥Ë≠¶ÂØü | Ê†áÂáÜÊîªÂáª</div>
                </div>
                <div class="buddy-card">
                    <canvas id="lilpeteyIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Li'l Petey</div>
                    <div class="skill">Â∞èÊ©òÁå´ | ÂàÜË£Ç√ó3</div>
                </div>
                <div class="buddy-card">
                    <canvas id="80hdIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">80-HD</div>
                    <div class="skill">ÁêÉÂΩ¢Êú∫Âô®‰∫∫ | Ë∂ÖÈáç</div>
                </div>
                <div class="buddy-card">
                    <canvas id="flippyIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Flippy</div>
                    <div class="skill">ÂøµÂäõÈ±º | Âä†ÈÄü</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÖ≥Âç°ÈÄâÊã© -->
    <div class="modal" id="levelSelectModal">
        <div class="modal-content">
            <h2 class="modal-title">ÈÄâÊã©ÂÖ≥Âç°</h2>
            <div class="levels-grid" id="levelsGrid"></div>
            <button class="close-modal-btn" onclick="closeLevelSelect()">ÂÖ≥Èó≠</button>
        </div>
    </div>

    <!-- ÁªìÊûúÂºπÁ™ó -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <h2 class="modal-title" id="resultTitle">ÂÖ≥Âç°ÂÆåÊàê!</h2>
            <div class="result-stars" id="resultStars">‚òÖ‚òÖ‚òÖ</div>
            <div class="result-score">ÂæóÂàÜ: <span id="resultScore">0</span></div>
            <div class="result-buttons">
                <button class="result-btn btn-restart" onclick="restartLevel(); closeResultModal();">ÈáçÁé©</button>
                <button class="result-btn btn-next" id="resultNextBtn" onclick="nextLevel(); closeResultModal();">‰∏ã‰∏ÄÂÖ≥</button>
                <button class="result-btn btn-levels" onclick="closeResultModal(); showLevelSelect();">ÂÖ≥Âç°</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ÂÖºÂÆπÊÄß - roundRect polyfill
        // ========================================
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            };
        }

        // ========================================
        // Ê∏∏ÊàèÈÖçÁΩÆ
        // ========================================
        const canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');

        // Áâ©ÁêÜÂ∏∏Èáè - Êõ¥ÈïøÁöÑÈ£ûË°åÊó∂Èó¥
        const GRAVITY = 0.25;  // Èôç‰ΩéÈáçÂäõÔºåÈ£ûÂæóÊõ¥Ëøú
        const AIR_RESISTANCE = 0.998;  // ÂáèÂ∞ëÁ©∫Ê∞îÈòªÂäõ
        const GROUND_FRICTION = 0.85;
        const BOUNCE_DAMPING = 0.65;
        const GROUND_Y = 520;  // Êõ¥Â§ßÁîªÈù¢ÔºåÂú∞Èù¢‰ΩçÁΩÆË∞ÉÊï¥
        const SLINGSHOT_X = 180;  // ÂºπÂºìÂè≥ÁßªÔºåÊõ¥Â§öÊãñÂä®Á©∫Èó¥
        const SLINGSHOT_Y = 430;  // ÂºπÂºì‰ΩçÁΩÆË∞ÉÊï¥
        const MAX_PULL_DISTANCE = 140;  // ÂèØ‰ª•ÊãâÂæóÊõ¥Ëøú
        const LAUNCH_POWER_MULTIPLIER = 0.20;  // Â¢ûÂä†ÂèëÂ∞ÑÂäõÂ∫¶
        const MAX_LEVELS = 30;

        // ========================================
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        // ========================================
        let currentLevel = 1;
        let score = 0;
        let gameState = 'ready';
        let levelProgress = JSON.parse(localStorage.getItem('dogmanLevelProgress')) || {};
        let projectile = null;
        let projectiles = [];
        let buddies = [];
        let currentBuddyIndex = 0;
        let villains = [];
        let blocks = [];
        let debris = [];
        let particles = [];
        let fallingObjects = []; // Á∫¢/ÁªøÁÆ±Â≠êÊéâËêΩÁöÑÁâ©‰Ωì
        let isDragging = false;
        let frameCount = 0;
        let lastBonusScore = 0; // ‰∏äÊ¨°Â•ñÂä±ÂàÜÊï∞
        let lastUnusedCount = 0; // ‰∏äÊ¨°Êú™‰ΩøÁî®ÈÅìÂÖ∑Êï∞Èáè

        // ========================================
        // È´òÁ∫ßÈü≥ÊïàÁ≥ªÁªü
        // ========================================
        let audioCtx = null;
        let soundEnabled = true;
        let masterGain = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                masterGain.gain.value = 0.5;
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // ÂàõÂª∫Â§çÊùÇÈü≥Êïà
        function createSound(options) {
            if (!soundEnabled || !audioCtx) return;

            const { frequencies, durations, types, volumes, delays } = options;

            frequencies.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    const filter = audioCtx.createBiquadFilter();

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(masterGain);

                    osc.type = types[i] || 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

                    if (options.freqSlide) {
                        osc.frequency.exponentialRampToValueAtTime(
                            options.freqSlide[i] || freq * 0.5,
                            audioCtx.currentTime + durations[i]
                        );
                    }

                    filter.type = 'lowpass';
                    filter.frequency.value = options.filterFreq || 3000;

                    gain.gain.setValueAtTime(volumes[i] || 0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + durations[i]);

                    osc.start(audioCtx.currentTime);
                    osc.stop(audioCtx.currentTime + durations[i]);
                }, delays[i] || 0);
            });
        }

        // ÁãóÂè´Â£∞
        function playBarkSound() {
            createSound({
                frequencies: [400, 550, 380],
                durations: [0.12, 0.15, 0.18],
                types: ['sawtooth', 'sawtooth', 'sawtooth'],
                volumes: [0.35, 0.4, 0.3],
                delays: [0, 100, 220],
                freqSlide: [350, 450, 280],
                filterFreq: 2000
            });
        }

        // Áå´Âè´Â£∞
        function playMeowSound() {
            createSound({
                frequencies: [800, 600, 400],
                durations: [0.15, 0.2, 0.25],
                types: ['sine', 'sine', 'sine'],
                volumes: [0.3, 0.35, 0.25],
                delays: [0, 80, 180],
                freqSlide: [600, 450, 300],
                filterFreq: 4000
            });
        }

        // Êú∫Âô®‰∫∫Â£∞
        function playRobotSound() {
            createSound({
                frequencies: [200, 300, 150, 250],
                durations: [0.08, 0.08, 0.1, 0.1],
                types: ['square', 'square', 'square', 'sawtooth'],
                volumes: [0.25, 0.25, 0.2, 0.2],
                delays: [0, 70, 140, 200],
                filterFreq: 1500
            });
        }

        // ÂºπÂºìÂèëÂ∞Ñ
        function playLaunchSound(type) {
            if (!soundEnabled) return;
            initAudio();

            // ÂºπÂºìÂºπÂ∞ÑÂ£∞
            createSound({
                frequencies: [150, 200, 100],
                durations: [0.1, 0.08, 0.12],
                types: ['triangle', 'triangle', 'sine'],
                volumes: [0.4, 0.3, 0.25],
                delays: [0, 30, 60],
                filterFreq: 800
            });

            setTimeout(() => {
                switch(type) {
                    case 'dogman': playBarkSound(); break;
                    case 'lilpetey': playMeowSound(); break;
                    case '80hd': playRobotSound(); break;
                    case 'flippy': playWaterSound(); break;
                }
            }, 150);
        }

        // Ê∞¥Â£∞
        function playWaterSound() {
            createSound({
                frequencies: [600, 800, 500, 700],
                durations: [0.06, 0.05, 0.07, 0.05],
                types: ['sine', 'sine', 'sine', 'sine'],
                volumes: [0.2, 0.15, 0.18, 0.12],
                delays: [0, 50, 100, 150],
                filterFreq: 5000
            });
        }

        // Êú®Â§¥Á†¥Á¢é
        function playWoodBreak() {
            createSound({
                frequencies: [150, 100, 80, 120],
                durations: [0.15, 0.12, 0.18, 0.1],
                types: ['sawtooth', 'triangle', 'sawtooth', 'triangle'],
                volumes: [0.35, 0.3, 0.25, 0.2],
                delays: [0, 40, 80, 120],
                filterFreq: 1200
            });
        }

        // Áü≥Â§¥Á†¥Á¢é
        function playStoneBreak() {
            createSound({
                frequencies: [80, 60, 100, 50],
                durations: [0.2, 0.25, 0.15, 0.3],
                types: ['square', 'sawtooth', 'square', 'triangle'],
                volumes: [0.4, 0.35, 0.3, 0.25],
                delays: [0, 50, 100, 150],
                filterFreq: 600
            });
        }

        // ÁéªÁíÉÁ†¥Á¢é
        function playGlassBreak() {
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [2000 + Math.random() * 3000],
                        durations: [0.04 + Math.random() * 0.04],
                        types: ['sine'],
                        volumes: [0.12 + Math.random() * 0.08],
                        delays: [0],
                        filterFreq: 8000
                    });
                }, i * 25);
            }
        }

        // ÂùèËøêÊ∞îÈü≥Êïà - ‰∏çÁ••ÁöÑË≠¶ÂëäÂ£∞
        function playBadLuckSound() {
            if (!soundEnabled) return;
            initAudio();
            // ‰ΩéÊ≤âË≠¶Âëä
            createSound({
                frequencies: [150, 120, 90, 70],
                durations: [0.2, 0.25, 0.3, 0.4],
                types: ['sawtooth', 'square', 'sawtooth', 'square'],
                volumes: [0.4, 0.35, 0.3, 0.25],
                delays: [0, 100, 200, 300],
                filterFreq: 400
            });
            // Âù†ËêΩÂ£∞
            setTimeout(() => {
                createSound({
                    frequencies: [400, 300, 200, 100],
                    durations: [0.15, 0.15, 0.15, 0.2],
                    types: ['sine', 'sine', 'sine', 'triangle'],
                    volumes: [0.3, 0.25, 0.2, 0.15],
                    delays: [0, 80, 160, 240],
                    filterFreq: 800
                });
            }, 200);
        }

        // Â•ΩËøêÊ∞îÈü≥Êïà - Ê¨¢Âø´ÁöÑÈìÉÂ£∞
        function playGoodLuckSound() {
            if (!soundEnabled) return;
            initAudio();
            // ÂçáË∞ÉÁöÑÊ¨¢Âø´Èü≥
            createSound({
                frequencies: [523, 659, 784, 1047],
                durations: [0.12, 0.12, 0.12, 0.2],
                types: ['sine', 'sine', 'sine', 'sine'],
                volumes: [0.3, 0.35, 0.4, 0.45],
                delays: [0, 80, 160, 240],
                filterFreq: 6000
            });
            // ÊòüÊòüÈó™ÁÉÅÂ£∞
            setTimeout(() => {
                for (let i = 0; i < 4; i++) {
                    setTimeout(() => {
                        createSound({
                            frequencies: [2000 + Math.random() * 1000],
                            durations: [0.06],
                            types: ['sine'],
                            volumes: [0.15],
                            delays: [0],
                            filterFreq: 8000
                        });
                    }, i * 50);
                }
            }, 300);
        }

        // Á¢∞ÊíûÂ£∞
        function playImpact(type) {
            if (!soundEnabled) return;
            const configs = {
                wood: { freq: 200, type: 'triangle', filter: 1000 },
                stone: { freq: 100, type: 'square', filter: 600 },
                glass: { freq: 1500, type: 'sine', filter: 4000 },
                ground: { freq: 120, type: 'triangle', filter: 500 },
                redbox: { freq: 180, type: 'sawtooth', filter: 800 },
                greenbox: { freq: 400, type: 'sine', filter: 2000 },
                default: { freq: 250, type: 'triangle', filter: 1500 }
            };
            const cfg = configs[type] || configs.default;
            createSound({
                frequencies: [cfg.freq, cfg.freq * 0.7],
                durations: [0.08, 0.1],
                types: [cfg.type, cfg.type],
                volumes: [0.25, 0.15],
                delays: [0, 30],
                filterFreq: cfg.filter
            });
        }

        // Ê†πÊçÆÂèçÊ¥æÁ±ªÂûãÊí≠ÊîæÂáªË¥•Èü≥Êïà
        function playVillainDefeatSound(type) {
            if (!soundEnabled) return;
            initAudio();
            switch(type) {
                case 'petey':
                    playPeteyDefeat();
                    playAngryMeow();
                    break;
                case 'flatpetey':
                    playPaperTear();
                    break;
                case 'piggy':
                    playPigSqueal();
                    break;
                case 'robot':
                    playRobotDefeat();
                    break;
                default:
                    playPeteyDefeat();
            }
        }

        // PeteyÂáªË¥•
        function playPeteyDefeat() {
            createSound({
                frequencies: [700, 500, 350, 200],
                durations: [0.15, 0.18, 0.2, 0.25],
                types: ['sawtooth', 'sawtooth', 'sine', 'sine'],
                volumes: [0.35, 0.3, 0.25, 0.2],
                delays: [0, 120, 250, 400],
                freqSlide: [500, 350, 200, 100],
                filterFreq: 2500
            });
        }

        // Êú∫Âô®‰∫∫ÂáªË¥•
        function playRobotDefeat() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [300 - i * 40],
                        durations: [0.12],
                        types: ['square'],
                        volumes: [0.25 - i * 0.03],
                        delays: [0],
                        filterFreq: 1000 - i * 150
                    });
                }, i * 100);
            }
        }

        // ÂàÜË£ÇÊäÄËÉΩ
        function playSplitSound() {
            createSound({
                frequencies: [400, 600, 500, 700, 550],
                durations: [0.1, 0.08, 0.1, 0.08, 0.12],
                types: ['sine', 'sine', 'sine', 'sine', 'sine'],
                volumes: [0.3, 0.25, 0.28, 0.22, 0.2],
                delays: [0, 50, 100, 150, 200],
                filterFreq: 4000
            });
        }

        // Âä†ÈÄüÊäÄËÉΩ
        function playBoostSound() {
            createSound({
                frequencies: [200, 400, 600, 800, 1000],
                durations: [0.05, 0.05, 0.05, 0.05, 0.1],
                types: ['sawtooth', 'sawtooth', 'sawtooth', 'sawtooth', 'sine'],
                volumes: [0.2, 0.22, 0.25, 0.28, 0.3],
                delays: [0, 30, 60, 90, 120],
                filterFreq: 3000
            });
        }

        // ÂºπÂºìÊãâ‰º∏Â£∞
        function playStretchSound() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [80, 100, 120],
                durations: [0.15, 0.12, 0.1],
                types: ['sawtooth', 'triangle', 'sawtooth'],
                volumes: [0.15, 0.12, 0.1],
                delays: [0, 50, 100],
                filterFreq: 800
            });
        }

        // Ë≠¶Á¨õÂ£∞ (ËÉúÂà©Êó∂)
        function playSirenSound() {
            if (!soundEnabled) return;
            initAudio();
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [600 + i * 100, 800 + i * 100],
                        durations: [0.15, 0.15],
                        types: ['sine', 'sine'],
                        volumes: [0.2, 0.15],
                        delays: [0, 80],
                        freqSlide: [800 + i * 100, 600 + i * 100],
                        filterFreq: 3000
                    });
                }, i * 200);
            }
        }

        // ÂüéÂ∏ÇÁéØÂ¢ÉÈü≥ (‰ΩéÊ≤âÁöÑÂó°Âó°Â£∞)
        function playAmbientCity() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [60, 80, 50],
                durations: [0.5, 0.4, 0.6],
                types: ['sine', 'triangle', 'sine'],
                volumes: [0.05, 0.04, 0.03],
                delays: [0, 100, 200],
                filterFreq: 200
            });
        }

        // Áå´ÁöÑ‰∏çÊª°Â£∞ (PeteyË¢´Âáª‰∏≠)
        function playAngryMeow() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [500, 700, 400, 300],
                durations: [0.1, 0.15, 0.2, 0.25],
                types: ['sawtooth', 'sawtooth', 'sine', 'sine'],
                volumes: [0.3, 0.35, 0.25, 0.2],
                delays: [0, 60, 150, 250],
                freqSlide: [600, 500, 300, 200],
                filterFreq: 3000
            });
        }

        // Áå™Âè´Â£∞ (PiggyË¢´Âáª‰∏≠)
        function playPigSqueal() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [400, 600, 500, 450],
                durations: [0.08, 0.1, 0.12, 0.15],
                types: ['sawtooth', 'square', 'sawtooth', 'triangle'],
                volumes: [0.25, 0.3, 0.25, 0.2],
                delays: [0, 50, 120, 200],
                freqSlide: [500, 700, 400, 350],
                filterFreq: 2500
            });
        }

        // Á∫∏ÊíïË£ÇÂ£∞ (Flat PeteyË¢´Âáª‰∏≠)
        function playPaperTear() {
            if (!soundEnabled) return;
            initAudio();
            // ÁôΩÂô™Èü≥ÊïàÊûú
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [1500 + Math.random() * 2000],
                        durations: [0.03 + Math.random() * 0.03],
                        types: ['sawtooth'],
                        volumes: [0.1 + Math.random() * 0.1],
                        delays: [0],
                        filterFreq: 6000
                    });
                }, i * 20);
            }
        }

        // ËÉúÂà©Èü≥Êïà - Â¢ûÂº∫Áâà
        function playVictorySound() {
            if (!soundEnabled) return;
            initAudio();

            // ËÉúÂà©ÊóãÂæã
            const notes = [523, 659, 784, 1047, 784, 1047];
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    createSound({
                        frequencies: [freq, freq * 1.5, freq * 2],
                        durations: [0.25, 0.2, 0.15],
                        types: ['sine', 'triangle', 'sine'],
                        volumes: [0.3, 0.15, 0.1],
                        delays: [0, 30, 60],
                        filterFreq: 5000
                    });
                }, i * 120);
            });

            // Dog Man ÂºÄÂøÉÂè´Â£∞
            setTimeout(playBarkSound, 700);
            setTimeout(playBarkSound, 900);
            setTimeout(() => {
                // Ê¨¢ÂëºÈìÉÂ£∞
                createSound({
                    frequencies: [1200, 1400, 1600],
                    durations: [0.1, 0.1, 0.15],
                    types: ['sine', 'sine', 'sine'],
                    volumes: [0.2, 0.2, 0.25],
                    delays: [0, 100, 200],
                    filterFreq: 6000
                });
            }, 1100);

            // Ë≠¶Á¨õ
            setTimeout(playSirenSound, 1400);
        }

        // Â§±Ë¥•Èü≥Êïà
        function playFailSound() {
            if (!soundEnabled) return;
            initAudio();
            const notes = [400, 350, 300, 250, 200];
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    createSound({
                        frequencies: [freq],
                        durations: [0.2],
                        types: ['sawtooth'],
                        volumes: [0.25 - i * 0.03],
                        delays: [0],
                        filterFreq: 1000
                    });
                }, i * 180);
            });
        }

        // ÁÇπÂáªÂ£∞
        function playClickSound() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [800, 1000],
                durations: [0.04, 0.03],
                types: ['sine', 'sine'],
                volumes: [0.2, 0.15],
                delays: [0, 20],
                filterFreq: 5000
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').textContent = soundEnabled ? 'üîä' : 'üîá';
            if (soundEnabled) {
                initAudio();
                playClickSound();
            }
        }

        // ========================================
        // ÂÖ≥Âç°ÂÆö‰πâ
        // ========================================
        // Âú∫ÊôØÁ±ªÂûã - Âü∫‰∫éDog ManÂéü‰ΩúÂú∫ÊôØ
        const sceneTypes = ['city', 'policestation', 'catjail', 'secretlab'];
        let currentScene = 'city';

        const levels = [
            // Á¨¨1ÂÖ≥ - Êñ∞ÊâãÂÖ•Èó®
            {
                scene: 'city',
                buddies: ['dogman', 'dogman', 'dogman'],
                villains: [{ type: 'petey', x: 850, y: GROUND_Y - 58 }],
                blocks: [
                    { type: 'glass', x: 810, y: GROUND_Y - 25, w: 80, h: 25 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 920, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 835, y: GROUND_Y - 120, w: 35, h: 35, moveX: 30 }
                ],
                stars: [1, 2, 3]
            },
            // Á¨¨2ÂÖ≥ - ÁÆÄÂçïÂèåÊïå
            {
                scene: 'city',
                buddies: ['dogman', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 820, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 950, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 780, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 910, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 990, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'greenbox', x: 700, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 820, y: GROUND_Y - 130, w: 35, h: 35, moveY: 20 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 100, w: 35, h: 35, moveX: 40 }
                ],
                stars: [1, 2, 3]
            },
            // Á¨¨3ÂÖ≥ - ÂàùÈÅáÁü≥Â§¥
            {
                scene: 'policestation',
                buddies: ['dogman', 'lilpetey', '80hd'],
                villains: [
                    { type: 'petey', x: 800, y: GROUND_Y - 138 },
                    { type: 'petey', x: 900, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 760, y: GROUND_Y - 25, w: 25, h: 110 },
                    { type: 'wood', x: 860, y: GROUND_Y - 25, w: 25, h: 110 },
                    { type: 'glass', x: 750, y: GROUND_Y - 135, w: 145, h: 20 },
                    { type: 'glass', x: 870, y: GROUND_Y - 25, w: 20, h: 60 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 60 },
                    { type: 'greenbox', x: 680, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1000, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 180, w: 35, h: 35, moveX: 25 }
                ],
                stars: [1, 2, 3]
            },
            // Á¨¨4ÂÖ≥ - TNTÂàù‰ΩìÈ™å
            {
                scene: 'catjail',
                buddies: ['dogman', 'dogman', 'flippy', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 750, y: GROUND_Y - 58 },
                    { type: 'petey', x: 920, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 710, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 790, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 880, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 960, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 110 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1020, y: GROUND_Y - 50, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 835, y: GROUND_Y - 130, w: 35, h: 35, moveX: 50 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 120, w: 35, h: 35, moveX: 60 }
                ],
                stars: [2, 3, 4]
            },
            // Á¨¨5ÂÖ≥ - ÂèåÂ±ÇÁªìÊûÑ
            {
                scene: 'secretlab',
                buddies: ['80hd', 'dogman', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 680, y: GROUND_Y - 60 },
                    { type: 'petey', x: 820, y: GROUND_Y - 183 },
                    { type: 'petey', x: 960, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 640, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'glass', x: 780, y: GROUND_Y - 25, w: 25, h: 155 },
                    { type: 'glass', x: 880, y: GROUND_Y - 25, w: 25, h: 155 },
                    { type: 'glass', x: 770, y: GROUND_Y - 180, w: 145, h: 18 },
                    { type: 'wood', x: 920, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'tnt', x: 680, y: GROUND_Y - 120 },
                    { type: 'greenbox', x: 580, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1060, y: GROUND_Y - 50, w: 35, h: 35, moveY: 25 },
                    { type: 'greenbox', x: 820, y: GROUND_Y - 235, w: 35, h: 35 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 50 }
                ],
                stars: [2, 3, 4]
            },
            // Á¨¨6ÂÖ≥ - ‰∏âÊïåÊåëÊàò
            {
                scene: 'city',
                buddies: ['dogman', 'flippy', 'flippy', '80hd'],
                villains: [
                    { type: 'petey', x: 650, y: GROUND_Y - 55 },
                    { type: 'petey', x: 820, y: GROUND_Y - 55 },
                    { type: 'petey', x: 990, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 610, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 690, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 780, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 860, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 1030, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 80, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 820, y: GROUND_Y - 120, w: 35, h: 35 },
                    { type: 'greenbox', x: 1090, y: GROUND_Y - 80, w: 35, h: 35, moveY: 30 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 150, w: 35, h: 35, moveX: 40 }
                ],
                stars: [2, 3, 4]
            },
            // Á¨¨7ÂÖ≥ - È´òÂ°îÊîªÁï•
            {
                scene: 'policestation',
                buddies: ['lilpetey', 'lilpetey', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 720, y: GROUND_Y - 220 },
                    { type: 'petey', x: 840, y: GROUND_Y - 220 },
                    { type: 'petey', x: 960, y: GROUND_Y - 220 }
                ],
                blocks: [
                    { type: 'wood', x: 670, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 770, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 870, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 970, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'glass', x: 660, y: GROUND_Y - 220, w: 340, h: 20 },
                    { type: 'tnt', x: 720, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 920, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1040, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 820, y: GROUND_Y - 270, w: 35, h: 35, moveX: 40 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 }
                ],
                stars: [2, 3, 4]
            },
            // Á¨¨8ÂÖ≥ - ÂèåÂ±ÇÈò≤Âæ°
            {
                scene: 'catjail',
                buddies: ['80hd', '80hd', 'flippy', 'dogman'],
                villains: [
                    { type: 'flatpetey', x: 780, y: GROUND_Y - 55 },
                    { type: 'petey', x: 900, y: GROUND_Y - 138 },
                    { type: 'petey', x: 780, y: GROUND_Y - 218 }
                ],
                blocks: [
                    { type: 'wood', x: 730, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'wood', x: 850, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'glass', x: 720, y: GROUND_Y - 55, w: 140, h: 18 },
                    { type: 'glass', x: 720, y: GROUND_Y - 135, w: 140, h: 18 },
                    { type: 'glass', x: 720, y: GROUND_Y - 215, w: 140, h: 18 },
                    { type: 'glass', x: 885, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 955, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'wood', x: 875, y: GROUND_Y - 160, w: 110, h: 18 },
                    { type: 'greenbox', x: 660, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1020, y: GROUND_Y - 50, w: 35, h: 35, moveY: 35 },
                    { type: 'greenbox', x: 780, y: GROUND_Y - 260, w: 35, h: 35 },
                    { type: 'redbox', x: 920, y: GROUND_Y - 200, w: 35, h: 35, moveX: 30 }
                ],
                stars: [2, 3, 4]
            },
            // Á¨¨9ÂÖ≥ - ÂõõÊïåÂõ¥Êîª
            {
                scene: 'secretlab',
                buddies: ['dogman', 'lilpetey', 'flippy', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 620, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 135 },
                    { type: 'petey', x: 980, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 295 }
                ],
                blocks: [
                    { type: 'glass', x: 580, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'wood', x: 750, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'wood', x: 870, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'glass', x: 740, y: GROUND_Y - 215, w: 145, h: 18 },
                    { type: 'glass', x: 750, y: GROUND_Y - 235, w: 25, h: 85 },
                    { type: 'glass', x: 870, y: GROUND_Y - 235, w: 25, h: 85 },
                    { type: 'glass', x: 740, y: GROUND_Y - 320, w: 145, h: 18 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'glass', x: 1020, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 520, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1080, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 370, w: 35, h: 35, moveX: 30 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveY: 40 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨10ÂÖ≥ - ÂèåÂ°îÂØπÂÜ≥
            {
                scene: 'city',
                buddies: ['flippy', 'flippy', 'lilpetey', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 670, y: GROUND_Y - 135 },
                    { type: 'piggy', x: 840, y: GROUND_Y - 55 },
                    { type: 'petey', x: 1010, y: GROUND_Y - 135 }
                ],
                blocks: [
                    { type: 'glass', x: 620, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 720, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 610, y: GROUND_Y - 160, w: 140, h: 18 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'wood', x: 880, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'glass', x: 960, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 1060, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 950, y: GROUND_Y - 160, w: 140, h: 18 },
                    { type: 'tnt', x: 670, y: GROUND_Y - 50 },
                    { type: 'tnt', x: 1010, y: GROUND_Y - 50 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 50, w: 35, h: 35, moveY: 25 },
                    { type: 'greenbox', x: 1120, y: GROUND_Y - 50, w: 35, h: 35, moveY: 25 },
                    { type: 'greenbox', x: 840, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 35 },
                    { type: 'redbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 40 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨11ÂÖ≥ - ÂùöÂõ∫Â†°Âûí
            {
                scene: 'policestation',
                buddies: ['80hd', 'dogman', 'lilpetey', 'flippy', 'dogman'],
                villains: [
                    { type: 'piggy', x: 720, y: GROUND_Y - 60 },
                    { type: 'piggy', x: 840, y: GROUND_Y - 55 },
                    { type: 'petey', x: 780, y: GROUND_Y - 208 }
                ],
                blocks: [
                    { type: 'wood', x: 670, y: GROUND_Y - 25, w: 25, h: 180 },
                    { type: 'wood', x: 890, y: GROUND_Y - 25, w: 25, h: 180 },
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 185, h: 25 },
                    { type: 'glass', x: 660, y: GROUND_Y - 205, w: 265, h: 22 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 960, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 780, y: GROUND_Y - 260, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 780, y: GROUND_Y - 130, w: 35, h: 35, moveY: 20 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨12ÂÖ≥ - Â§öÂ±ÇÂ°îÊ•º
            {
                scene: 'catjail',
                buddies: ['lilpetey', '80hd', 'flippy', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 620, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 135 },
                    { type: 'petey', x: 980, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 265 }
                ],
                blocks: [
                    { type: 'glass', x: 580, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'wood', x: 740, y: GROUND_Y - 25, w: 25, h: 135 },
                    { type: 'wood', x: 880, y: GROUND_Y - 25, w: 25, h: 135 },
                    { type: 'glass', x: 730, y: GROUND_Y - 160, w: 185, h: 18 },
                    { type: 'wood', x: 740, y: GROUND_Y - 180, w: 25, h: 105 },
                    { type: 'wood', x: 880, y: GROUND_Y - 180, w: 25, h: 105 },
                    { type: 'glass', x: 730, y: GROUND_Y - 285, w: 185, h: 18 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 1020, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 520, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1080, y: GROUND_Y - 50, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 330, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveX: 45 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 200, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨13ÂÖ≥ - Áü≥Â§¥Ë¶ÅÂ°û
            {
                scene: 'secretlab',
                buddies: ['80hd', '80hd', 'flippy', 'lilpetey', 'dogman'],
                villains: [
                    { type: 'petey', x: 670, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 840, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 1010, y: GROUND_Y - 60 },
                    { type: 'petey', x: 840, y: GROUND_Y - 228 }
                ],
                blocks: [
                    { type: 'wood', x: 620, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 790, y: GROUND_Y - 25, w: 25, h: 200 },
                    { type: 'wood', x: 910, y: GROUND_Y - 25, w: 25, h: 200 },
                    { type: 'glass', x: 780, y: GROUND_Y - 225, w: 145, h: 18 },
                    { type: 'wood', x: 960, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 1060, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'tnt', x: 670, y: GROUND_Y - 130 },
                    { type: 'tnt', x: 1010, y: GROUND_Y - 130 },
                    { type: 'greenbox', x: 560, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1120, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 840, y: GROUND_Y - 280, w: 35, h: 35, moveX: 40 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 840, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨14ÂÖ≥ - Ë∂ÖÈ´òÂ°î
            {
                scene: 'city',
                buddies: ['flippy', 'lilpetey', '80hd', 'dogman', 'flippy', 'dogman'],
                villains: [
                    { type: 'piggy', x: 620, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 135 },
                    { type: 'piggy', x: 980, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 285 }
                ],
                blocks: [
                    { type: 'wood', x: 570, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 670, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'glass', x: 740, y: GROUND_Y - 25, w: 20, h: 185 },
                    { type: 'glass', x: 880, y: GROUND_Y - 25, w: 20, h: 185 },
                    { type: 'wood', x: 730, y: GROUND_Y - 210, w: 180, h: 18 },
                    { type: 'glass', x: 740, y: GROUND_Y - 230, w: 25, h: 105 },
                    { type: 'glass', x: 880, y: GROUND_Y - 230, w: 25, h: 105 },
                    { type: 'wood', x: 730, y: GROUND_Y - 335, w: 180, h: 18 },
                    { type: 'wood', x: 930, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 1030, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 250 },
                    { type: 'greenbox', x: 500, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 385, w: 35, h: 35, moveX: 30 },
                    { type: 'greenbox', x: 620, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 980, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // Á¨¨15ÂÖ≥ - Â§çÊùÇÂ†°Âûí
            {
                scene: 'secretlab',
                buddies: ['80hd', 'flippy', 'lilpetey', 'dogman', '80hd', 'flippy'],
                villains: [
                    { type: 'piggy', x: 620, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 740, y: GROUND_Y - 138 },
                    { type: 'flatpetey', x: 860, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 980, y: GROUND_Y - 138 },
                    { type: 'petey', x: 810, y: GROUND_Y - 288 }
                ],
                blocks: [
                    { type: 'glass', x: 580, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'glass', x: 690, y: GROUND_Y - 210, w: 145, h: 18 },
                    { type: 'glass', x: 820, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 900, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'wood', x: 940, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'wood', x: 1040, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'glass', x: 930, y: GROUND_Y - 210, w: 145, h: 18 },
                    { type: 'glass', x: 760, y: GROUND_Y - 230, w: 20, h: 105 },
                    { type: 'glass', x: 880, y: GROUND_Y - 230, w: 20, h: 105 },
                    { type: 'wood', x: 750, y: GROUND_Y - 335, w: 160, h: 18 },
                    { type: 'tnt', x: 620, y: GROUND_Y - 100 },
                    { type: 'tnt', x: 980, y: GROUND_Y - 100 },
                    { type: 'tnt', x: 810, y: GROUND_Y - 250 },
                    { type: 'greenbox', x: 520, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 810, y: GROUND_Y - 385, w: 35, h: 35, moveX: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveX: 50 },
                    { type: 'redbox', x: 860, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // Á¨¨16ÂÖ≥ - ËøêÊ∞îÂ§ßÊåëÊàò
            {
                scene: 'city',
                buddies: ['dogman', 'lilpetey', 'dogman', 'flippy', '80hd'],
                villains: [
                    { type: 'petey', x: 700, y: GROUND_Y - 58 },
                    { type: 'petey', x: 850, y: GROUND_Y - 58 },
                    { type: 'piggy', x: 1000, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 740, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 810, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 890, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 960, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 1040, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 775, y: GROUND_Y - 200, w: 35, h: 35 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 50 },
                    { type: 'redbox', x: 700, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 3, 4]
            },
            // Á¨¨17ÂÖ≥ - Êú∫Âô®‰∫∫Èò≤Á∫ø
            {
                scene: 'policestation',
                buddies: ['80hd', 'dogman', 'lilpetey', 'flippy', '80hd'],
                villains: [
                    { type: 'robot', x: 750, y: GROUND_Y - 140 },
                    { type: 'petey', x: 900, y: GROUND_Y - 58 },
                    { type: 'robot', x: 650, y: GROUND_Y - 60 }
                ],
                blocks: [
                    { type: 'wood', x: 600, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 690, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'greenbox', x: 540, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1000, y: GROUND_Y - 50, w: 35, h: 35, moveY: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 30 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 180, w: 35, h: 35, moveY: 45 },
                    { type: 'redbox', x: 650, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 3, 4]
            },
            // Á¨¨18ÂÖ≥ - ÈáëÂ≠óÂ°î
            {
                scene: 'catjail',
                buddies: ['flippy', 'lilpetey', 'dogman', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 800, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 138 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 218 }
                ],
                blocks: [
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 200, h: 20 },
                    { type: 'glass', x: 720, y: GROUND_Y - 45, w: 25, h: 90 },
                    { type: 'glass', x: 880, y: GROUND_Y - 45, w: 25, h: 90 },
                    { type: 'glass', x: 720, y: GROUND_Y - 135, w: 185, h: 18 },
                    { type: 'glass', x: 740, y: GROUND_Y - 155, w: 20, h: 80 },
                    { type: 'glass', x: 860, y: GROUND_Y - 155, w: 20, h: 80 },
                    { type: 'wood', x: 740, y: GROUND_Y - 235, w: 140, h: 18 },
                    { type: 'greenbox', x: 640, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 290, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 1020, y: GROUND_Y - 100, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 580, y: GROUND_Y - 150, w: 35, h: 35, moveX: 45 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 80, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨19ÂÖ≥ - Êú∫Âô®‰∫∫ÂèåÂ°î
            {
                scene: 'secretlab',
                buddies: ['dogman', 'dogman', '80hd', 'flippy', 'lilpetey'],
                villains: [
                    { type: 'robot', x: 650, y: GROUND_Y - 60 },
                    { type: 'robot', x: 950, y: GROUND_Y - 60 },
                    { type: 'petey', x: 800, y: GROUND_Y - 188 }
                ],
                blocks: [
                    { type: 'wood', x: 600, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 750, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 870, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 740, y: GROUND_Y - 190, w: 165, h: 18 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 540, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1060, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 250, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 180, w: 35, h: 35, moveY: 45 },
                    { type: 'redbox', x: 950, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨20ÂÖ≥ - ÂèåÂ°îÂØπÂÜ≥
            {
                scene: 'city',
                buddies: ['80hd', 'flippy', 'dogman', 'lilpetey', '80hd'],
                villains: [
                    { type: 'petey', x: 650, y: GROUND_Y - 188 },
                    { type: 'piggy', x: 950, y: GROUND_Y - 188 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 600, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 590, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 890, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'glass', x: 760, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 840, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'greenbox', x: 540, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1060, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 250, w: 35, h: 35, moveX: 30 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 250, w: 35, h: 35, moveX: 30 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨21ÂÖ≥ - ‰∏âÊïåÊ∑∑Êàò
            {
                scene: 'policestation',
                buddies: ['lilpetey', 'lilpetey', '80hd', 'dogman', 'flippy'],
                villains: [
                    { type: 'petey', x: 700, y: GROUND_Y - 58 },
                    { type: 'robot', x: 850, y: GROUND_Y - 138 },
                    { type: 'petey', x: 1000, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 740, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 790, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 960, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1040, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 200, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 700, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 40 },
                    { type: 'redbox', x: 1000, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨22ÂÖ≥ - ÂõõÂ±ÇË¶ÅÂ°û
            {
                scene: 'catjail',
                buddies: ['80hd', 'flippy', 'dogman', 'lilpetey', '80hd', 'dogman'],
                villains: [
                    { type: 'piggy', x: 800, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 138 },
                    { type: 'robot', x: 800, y: GROUND_Y - 218 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 298 }
                ],
                blocks: [
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 270 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 270 },
                    { type: 'glass', x: 745, y: GROUND_Y - 55, w: 155, h: 15 },
                    { type: 'glass', x: 745, y: GROUND_Y - 135, w: 155, h: 15 },
                    { type: 'glass', x: 745, y: GROUND_Y - 215, w: 155, h: 15 },
                    { type: 'glass', x: 745, y: GROUND_Y - 295, w: 155, h: 15 },
                    { type: 'tnt', x: 780, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 240 },
                    { type: 'greenbox', x: 660, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 960, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 350, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 160, w: 35, h: 35 },
                    { type: 'redbox', x: 600, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 160, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // Á¨¨23ÂÖ≥ - ÂàÜÊï£Èò≤Âæ°
            {
                scene: 'secretlab',
                buddies: ['flippy', '80hd', 'lilpetey', 'dogman', 'flippy', 'dogman'],
                villains: [
                    { type: 'robot', x: 600, y: GROUND_Y - 60 },
                    { type: 'petey', x: 750, y: GROUND_Y - 188 },
                    { type: 'piggy', x: 900, y: GROUND_Y - 55 },
                    { type: 'petey', x: 1050, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'wood', x: 550, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 650, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 820, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 690, y: GROUND_Y - 190, w: 165, h: 18 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 760, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 490, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 250, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 900, y: GROUND_Y - 130, w: 35, h: 35, moveY: 30 },
                    { type: 'redbox', x: 460, y: GROUND_Y - 200, w: 35, h: 35, moveY: 45 }
                ],
                stars: [3, 5, 6]
            },
            // Á¨¨24ÂÖ≥ - ËøêÊ∞îÈ£éÊö¥
            {
                scene: 'city',
                buddies: ['dogman', 'lilpetey', '80hd', 'flippy', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 650, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 55 },
                    { type: 'petey', x: 950, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 610, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 690, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 760, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 840, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 910, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 990, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1050, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 150, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 150, w: 35, h: 35, moveY: 35 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 150, w: 35, h: 35, moveY: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveX: 60 },
                    { type: 'redbox', x: 720, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 880, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // Á¨¨25ÂÖ≥ - ÂùöÂõ∫Â†°Âûí
            {
                scene: 'policestation',
                buddies: ['80hd', '80hd', 'flippy', 'lilpetey', 'dogman', 'flippy'],
                villains: [
                    { type: 'robot', x: 750, y: GROUND_Y - 60 },
                    { type: 'robot', x: 950, y: GROUND_Y - 60 },
                    { type: 'piggy', x: 850, y: GROUND_Y - 188 }
                ],
                blocks: [
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 790, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 950, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 640, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1060, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 250, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 580, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // Á¨¨26ÂÖ≥ - Èò∂Ê¢ØÈò≤Á∫ø
            {
                scene: 'catjail',
                buddies: ['lilpetey', 'flippy', '80hd', 'dogman', 'lilpetey', '80hd'],
                villains: [
                    { type: 'petey', x: 600, y: GROUND_Y - 58 },
                    { type: 'piggy', x: 750, y: GROUND_Y - 138 },
                    { type: 'robot', x: 900, y: GROUND_Y - 218 },
                    { type: 'petey', x: 1050, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 560, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 640, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 800, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 690, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'wood', x: 850, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'glass', x: 840, y: GROUND_Y - 220, w: 145, h: 18 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 900, y: GROUND_Y - 160 },
                    { type: 'greenbox', x: 500, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 900, y: GROUND_Y - 280, w: 35, h: 35, moveX: 45 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 1050, y: GROUND_Y - 130, w: 35, h: 35, moveY: 35 },
                    { type: 'redbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 40 },
                    { type: 'redbox', x: 875, y: GROUND_Y - 80, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // Á¨¨27ÂÖ≥ - Ë∂ÖÁ∫ßÈ´òÂ°î
            {
                scene: 'secretlab',
                buddies: ['flippy', '80hd', 'dogman', 'lilpetey', 'flippy', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 800, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 138 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 218 },
                    { type: 'robot', x: 800, y: GROUND_Y - 298 },
                    { type: 'petey', x: 800, y: GROUND_Y - 378 }
                ],
                blocks: [
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 355 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 355 },
                    { type: 'glass', x: 745, y: GROUND_Y - 55, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 135, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 215, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 295, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 375, w: 155, h: 12 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 160 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 240 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 960, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 430, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 320, w: 35, h: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 320, w: 35, h: 35 },
                    { type: 'redbox', x: 600, y: GROUND_Y - 200, w: 35, h: 35, moveY: 60 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 160, w: 35, h: 35 }
                ],
                stars: [4, 6, 7]
            },
            // Á¨¨28ÂÖ≥ - ÂàÜÊï£Ëø∑ÂÆ´
            {
                scene: 'city',
                buddies: ['80hd', 'lilpetey', 'flippy', 'dogman', '80hd', 'lilpetey', 'dogman'],
                villains: [
                    { type: 'petey', x: 600, y: GROUND_Y - 58 },
                    { type: 'robot', x: 750, y: GROUND_Y - 60 },
                    { type: 'piggy', x: 900, y: GROUND_Y - 55 },
                    { type: 'flatpetey', x: 1050, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 560, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 640, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 130 },
                    { type: 'tnt', x: 900, y: GROUND_Y - 100 },
                    { type: 'greenbox', x: 500, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 1050, y: GROUND_Y - 130, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveY: 55 },
                    { type: 'redbox', x: 680, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 900, y: GROUND_Y - 180, w: 35, h: 35, moveX: 35 }
                ],
                stars: [3, 5, 7]
            },
            // Á¨¨29ÂÖ≥ - Âè≤ËØóÂÜ≥Êàò
            {
                scene: 'policestation',
                buddies: ['flippy', '80hd', 'lilpetey', 'dogman', 'flippy', '80hd', 'lilpetey', 'dogman'],
                villains: [
                    { type: 'petey', x: 550, y: GROUND_Y - 58 },
                    { type: 'robot', x: 700, y: GROUND_Y - 138 },
                    { type: 'piggy', x: 850, y: GROUND_Y - 55 },
                    { type: 'robot', x: 1000, y: GROUND_Y - 138 },
                    { type: 'petey', x: 850, y: GROUND_Y - 268 }
                ],
                blocks: [
                    { type: 'glass', x: 510, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 590, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 650, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 750, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 640, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 800, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 900, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 1050, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 940, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 790, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'glass', x: 930, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'wood', x: 780, y: GROUND_Y - 270, w: 165, h: 18 },
                    { type: 'tnt', x: 700, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 1000, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 200 },
                    { type: 'greenbox', x: 450, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1110, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 330, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 700, y: GROUND_Y - 200, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 1000, y: GROUND_Y - 200, w: 35, h: 35, moveY: 30 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 250, w: 35, h: 35, moveX: 60 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [4, 6, 8]
            },
            // Á¨¨30ÂÖ≥ - ÁªàÊûÅÊåëÊàò
            {
                scene: 'secretlab',
                buddies: ['80hd', 'flippy', 'lilpetey', 'dogman', '80hd', 'flippy', 'lilpetey', 'dogman', 'flippy'],
                villains: [
                    { type: 'petey', x: 550, y: GROUND_Y - 58 },
                    { type: 'piggy', x: 700, y: GROUND_Y - 188 },
                    { type: 'robot', x: 850, y: GROUND_Y - 268 },
                    { type: 'flatpetey', x: 850, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 1000, y: GROUND_Y - 188 },
                    { type: 'petey', x: 1050, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 510, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 590, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 650, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 750, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 640, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'glass', x: 800, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 900, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 1050, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 940, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'glass', x: 790, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'glass', x: 930, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'wood', x: 780, y: GROUND_Y - 270, w: 165, h: 18 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 700, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 100 },
                    { type: 'tnt', x: 1000, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 450, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 330, w: 35, h: 35, moveX: 60 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 700, y: GROUND_Y - 250, w: 35, h: 35, moveY: 40 },
                    { type: 'greenbox', x: 1000, y: GROUND_Y - 250, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 280, w: 35, h: 35, moveX: 70 },
                    { type: 'redbox', x: 700, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 1000, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 200, w: 35, h: 35 }
                ],
                stars: [5, 7, 9]
            }
        ];

        // ========================================
        // ‰ºô‰º¥Á±ªÂûã - Âü∫‰∫éÁúüÂÆûDog ManËßíËâ≤ËÆæËÆ°
        // ========================================
        const buddyTypes = {
            dogman: { name: 'Dog Man', radius: 26, mass: 1, color: '#D2691E', special: null },
            lilpetey: { name: "Li'l Petey", radius: 20, mass: 0.6, color: '#FF8C00', special: 'split' },
            '80hd': { name: '80-HD', radius: 28, mass: 2.2, color: '#5DADE2', special: null },
            flippy: { name: 'Flippy', radius: 22, mass: 0.7, color: '#F4D03F', special: 'boost' }
        };
        window.buddyTypes = buddyTypes; // ÂÖ®Â±ÄËÆøÈóÆ

        // ÂèçÊ¥æÁ±ªÂûã - Âü∫‰∫éDog ManÂéü‰Ωú
        const villainTypes = {
            petey: { name: 'Petey', width: 50, height: 58, health: 1 },
            flatpetey: { name: 'Flat Petey', width: 45, height: 55, health: 1 },
            piggy: { name: 'Piggy', width: 52, height: 55, health: 2 },
            robot: { name: 'Robot', width: 48, height: 60, health: 2 }
        };

        // ========================================
        // ÂàùÂßãÂåñ
        // ========================================
        function init() {
            loadLevel(currentLevel);
            generateLevelButtons();
            setupEventListeners();
            canvas.addEventListener('click', () => initAudio(), { once: true });
            drawBuddyIcons();
            gameLoop();
        }

        // ÁªòÂà∂ËØ¥ÊòéÂå∫ÁöÑËßíËâ≤ÂõæÊ†á - ‰ΩøÁî®ÁÆÄÂåñÊñπÊ≥ï
        function drawBuddyIcons() {
            try {
                const iconData = [
                    { id: 'dogmanIcon', type: 'dogman' },
                    { id: 'lilpeteyIcon', type: 'lilpetey' },
                    { id: '80hdIcon', type: '80hd' },
                    { id: 'flippyIcon', type: 'flippy' }
                ];

                iconData.forEach(icon => {
                    const iconCanvas = document.getElementById(icon.id);
                    if (iconCanvas) {
                        const iconCtx = iconCanvas.getContext('2d');
                        iconCtx.clearRect(0, 0, 50, 50);
                        iconCtx.save();
                        iconCtx.translate(25, 28);
                        iconCtx.scale(0.6, 0.6);
                        drawBuddyOnContext(iconCtx, icon.type, 20);
                        iconCtx.restore();
                    }
                });
            } catch (e) {
                console.error('drawBuddyIcons error:', e);
            }
        }

        // Âú®ÊåáÂÆöcontext‰∏äÁªòÂà∂ËßíËâ≤
        function drawBuddyOnContext(targetCtx, type, radius) {
            const origCtx = ctx;
            ctx = targetCtx;
            switch(type) {
                case 'dogman': drawDogMan(radius); break;
                case 'lilpetey': drawLilPetey(radius * 0.85); break;
                case '80hd': draw80HD(radius); break;
                case 'flippy': drawFlippy(radius * 0.9); break;
            }
            ctx = origCtx;
        }

        function loadLevel(levelNum) {
            currentLevel = levelNum;
            const level = levels[levelNum - 1];
            if (!level) return;

            // ËÆæÁΩÆÂú∫ÊôØÁ±ªÂûã
            currentScene = level.scene || 'city';

            score = 0;
            gameState = 'ready';
            projectile = null;
            projectiles = [];
            debris = [];
            particles = [];
            fallingObjects = [];

            buddies = level.buddies.map(type => ({ type, ...buddyTypes[type], used: false }));
            currentBuddyIndex = 0;

            // Ê†πÊçÆÂèçÊ¥æÁ±ªÂûãËÆæÁΩÆÂ±ûÊÄß
            villains = level.villains.map(v => {
                const vType = villainTypes[v.type] || villainTypes.petey;
                return {
                    ...v,
                    width: vType.width,
                    height: vType.height,
                    health: v.type === 'robot' || v.type === 'piggy' ? 2 : 1,
                    maxHealth: v.type === 'robot' || v.type === 'piggy' ? 2 : 1,
                    alive: true,
                    vy: 0,
                    angle: 0
                };
            });

            blocks = level.blocks.map(b => ({
                ...b,
                health: b.type === 'stone' ? 3 : b.type === 'wood' ? 2 : b.type === 'tnt' ? 1 : b.type === 'redbox' ? 2 : b.type === 'greenbox' ? 1 : 1,
                maxHealth: b.type === 'stone' ? 3 : b.type === 'wood' ? 2 : b.type === 'redbox' ? 2 : 1,
                alive: true,
                vy: 0,
                vx: 0,
                angle: 0,
                // ÁßªÂä®ÁÆ±Â≠êÊîØÊåÅ
                originalX: b.x,
                originalY: b.y,
                movePhase: Math.random() * Math.PI * 2 // ÈöèÊú∫Ëµ∑ÂßãÁõ∏‰Ωç
            }));

            updateUI();
            renderBuddiesPanel();
            placeCurrentBuddy();
        }

        function placeCurrentBuddy() {
            if (currentBuddyIndex >= buddies.length) {
                checkGameEnd();
                return;
            }
            const buddy = buddies[currentBuddyIndex];
            projectile = {
                x: SLINGSHOT_X,
                y: SLINGSHOT_Y,
                vx: 0,
                vy: 0,
                ...buddy,
                active: false,
                specialUsed: false,
                rotation: 0,
                rotationSpeed: 0
            };
            gameState = 'ready';
        }

        // ========================================
        // Ê∏≤Êüì
        // ========================================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frameCount++;

            // Êõ¥Êñ∞Â±èÂπïÈúáÂä®
            updateScreenShake();

            // Â∫îÁî®Â±èÂπïÈúáÂä®
            ctx.save();
            ctx.translate(screenShake.x, screenShake.y);

            drawBackground();
            drawSlingshot();
            blocks.forEach(b => b.alive && drawBlock(b));
            villains.forEach(v => v.alive && drawVillain(v));
            debris.forEach(d => drawDebris(d));
            particles.forEach(p => drawParticle(p));
            fallingObjects.forEach(fo => drawFallingObject(fo));
            if (projectile) drawBuddy(projectile);
            projectiles.forEach(p => drawBuddy(p));
            if (isDragging && gameState === 'aiming') drawTrajectory();

            // ÁªòÂà∂ÂÜ≤ÂáªÊ≥¢ÊïàÊûú
            drawShockwaves();

            ctx.restore(); // ÁªìÊùüÂ±èÂπïÈúáÂä®

            // ÁªòÂà∂ÊµÆÂä®ÊñáÂ≠ó
            if (window.floatingTexts) {
                window.floatingTexts.forEach(ft => {
                    ctx.save();
                    ctx.globalAlpha = ft.alpha;
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = ft.color;
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 3;
                    ctx.strokeText(ft.text, ft.x, ft.y);
                    ctx.fillText(ft.text, ft.x, ft.y);
                    ctx.restore();

                    ft.y += ft.vy;
                    ft.life--;
                    ft.alpha = Math.max(0, ft.life / 60);
                });
                window.floatingTexts = window.floatingTexts.filter(ft => ft.life > 0);
            }

            // ÁªòÂà∂Â§ßÂûãÊñáÂ≠óÊèêÁ§∫ÔºàÂ±èÂπï‰∏≠Â§ÆÔºâ
            drawBigTexts();
        }

        // ÁªòÂà∂ÊéâËêΩÁâ©‰Ωì - Ë∂ÖÁ∫ßÂèØÁà±ÁâàÊú¨ÔºÅ
        function drawFallingObject(fo) {
            ctx.save();
            ctx.translate(fo.x, fo.y);

            // Âä®ÊÄÅÊóãËΩ¨ÊïàÊûú
            const wobble = Math.sin(frameCount * 0.2) * 0.1;
            ctx.rotate(fo.rotation + wobble);

            if (fo.type === 'bad') {
                // ====== Ë∂ÖÂ§ßÁÅ´ÁÑ∞Èô®Áü≥ÔºÅ======
                const meteorSize = fo.size * 1.5; // ÊîæÂ§ß50%

                // Ë∂ÖÈïøÁÅ´ÁÑ∞Â∞æÂ∑¥ - Â§öÂ±ÇÊ∏êÂèò
                for (let i = 5; i >= 0; i--) {
                    const tailAlpha = 0.8 - i * 0.12;
                    ctx.fillStyle = `rgba(255, ${100 + i * 30}, 0, ${tailAlpha})`;
                    ctx.beginPath();
                    const tailWidth = meteorSize * (0.8 - i * 0.1);
                    const tailHeight = meteorSize * (1.5 + i * 0.8);
                    ctx.moveTo(-tailWidth, 0);
                    ctx.quadraticCurveTo(-tailWidth * 0.5, -tailHeight * 0.5, 0, -tailHeight);
                    ctx.quadraticCurveTo(tailWidth * 0.5, -tailHeight * 0.5, tailWidth, 0);
                    ctx.closePath();
                    ctx.fill();
                }

                // Èô®Áü≥‰∏ª‰Ωì - Â≤©Áü≥Ë¥®ÊÑü
                const bombGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, meteorSize);
                bombGrad.addColorStop(0, '#FF8844');
                bombGrad.addColorStop(0.3, '#DD4422');
                bombGrad.addColorStop(0.7, '#AA2211');
                bombGrad.addColorStop(1, '#661100');
                ctx.fillStyle = bombGrad;
                ctx.beginPath();
                // ‰∏çËßÑÂàôÈô®Áü≥ÂΩ¢Áä∂
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const r = meteorSize * (0.8 + Math.sin(i * 3) * 0.2);
                    if (i === 0) ctx.moveTo(Math.cos(angle) * r, Math.sin(angle) * r);
                    else ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
                }
                ctx.closePath();
                ctx.fill();

                // Èô®Áü≥ÂÖâÊôï
                ctx.shadowColor = '#FF4400';
                ctx.shadowBlur = 30;
                ctx.strokeStyle = '#FF6600';
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.shadowBlur = 0;

                // ÊÑ§ÊÄíÂç°ÈÄöË°®ÊÉÖ
                ctx.fillStyle = '#FFFF00';
                // ÊÄíÁúº
                ctx.beginPath();
                ctx.ellipse(-meteorSize * 0.25, -meteorSize * 0.1, 6, 8, 0, 0, Math.PI * 2);
                ctx.ellipse(meteorSize * 0.25, -meteorSize * 0.1, 6, 8, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-meteorSize * 0.25, -meteorSize * 0.1, 3, 0, Math.PI * 2);
                ctx.arc(meteorSize * 0.25, -meteorSize * 0.1, 3, 0, Math.PI * 2);
                ctx.fill();
                // ÊÑ§ÊÄíÁúâÊØõ
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(-meteorSize * 0.4, -meteorSize * 0.3);
                ctx.lineTo(-meteorSize * 0.1, -meteorSize * 0.2);
                ctx.moveTo(meteorSize * 0.4, -meteorSize * 0.3);
                ctx.lineTo(meteorSize * 0.1, -meteorSize * 0.2);
                ctx.stroke();
                // Âº†Âò¥
                ctx.fillStyle = '#330000';
                ctx.beginPath();
                ctx.ellipse(0, meteorSize * 0.25, meteorSize * 0.25, meteorSize * 0.15, 0, 0, Math.PI);
                ctx.fill();

                // ÁÅ´Ëä±Á≤íÂ≠êÊïàÊûú
                ctx.fillStyle = '#FFFF00';
                for (let i = 0; i < 5; i++) {
                    const sparkX = (Math.random() - 0.5) * meteorSize * 2;
                    const sparkY = -meteorSize - Math.random() * meteorSize * 2;
                    ctx.beginPath();
                    ctx.arc(sparkX, sparkY, 2 + Math.random() * 3, 0, Math.PI * 2);
                    ctx.fill();
                }

            } else {
                // ====== Ë∂ÖÁ∫ßÂèØÁà±ÊòüÊòüÔºÅ======
                const starSize = fo.size * 1.5; // ÊîæÂ§ß50%

                // ÂΩ©ËôπÂ∞æÂ∑¥
                const colors = ['#FF6B9D', '#FFD93D', '#6BCB77', '#4D96FF', '#9B59B6'];
                for (let i = 0; i < 8; i++) {
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.globalAlpha = 0.8 - i * 0.08;
                    ctx.beginPath();
                    ctx.arc((Math.sin(i * 0.5) * 5), -starSize - i * 12, 8 - i * 0.8, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1;

                // ÊòüÊòüÂÖâÊôï
                ctx.shadowColor = '#FFD700';
                ctx.shadowBlur = 40;

                // Â§ßÊòüÊòü‰∏ª‰Ωì
                ctx.fillStyle = '#FFD700';
                drawStarShape(ctx, 0, 0, 5, starSize, starSize * 0.5);

                // ÊòüÊòüÊ∏êÂèòÂÜÖÂ±Ç
                const starGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, starSize);
                starGrad.addColorStop(0, '#FFFFFF');
                starGrad.addColorStop(0.3, '#FFFF88');
                starGrad.addColorStop(1, '#FFD700');
                ctx.fillStyle = starGrad;
                drawStarShape(ctx, 0, 0, 5, starSize * 0.8, starSize * 0.4);

                ctx.shadowBlur = 0;

                // ÂèØÁà±Á¨ëËÑ∏
                ctx.fillStyle = '#000';
                // ÁúºÁùõ - Èó™‰∫ÆÂ§ßÁúº
                ctx.beginPath();
                ctx.ellipse(-starSize * 0.2, -starSize * 0.1, 5, 6, 0, 0, Math.PI * 2);
                ctx.ellipse(starSize * 0.2, -starSize * 0.1, 5, 6, 0, 0, Math.PI * 2);
                ctx.fill();
                // ÁúºÁùõÈ´òÂÖâ
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(-starSize * 0.2 - 1, -starSize * 0.1 - 2, 2, 0, Math.PI * 2);
                ctx.arc(starSize * 0.2 - 1, -starSize * 0.1 - 2, 2, 0, Math.PI * 2);
                ctx.fill();
                // ËÖÆÁ∫¢
                ctx.fillStyle = 'rgba(255, 150, 150, 0.6)';
                ctx.beginPath();
                ctx.ellipse(-starSize * 0.35, starSize * 0.1, 6, 4, 0, 0, Math.PI * 2);
                ctx.ellipse(starSize * 0.35, starSize * 0.1, 6, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                // ÂæÆÁ¨ë
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, starSize * 0.1, starSize * 0.2, 0.1 * Math.PI, 0.9 * Math.PI);
                ctx.stroke();

                // Èó™ÁÉÅÂ∞èÊòüÊòü
                ctx.fillStyle = '#FFFFFF';
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2 + frameCount * 0.05;
                    const dist = starSize * 1.5 + Math.sin(frameCount * 0.1 + i) * 10;
                    const sx = Math.cos(angle) * dist;
                    const sy = Math.sin(angle) * dist;
                    ctx.globalAlpha = 0.5 + Math.sin(frameCount * 0.2 + i) * 0.5;
                    drawStarShape(ctx, sx, sy, 4, 5, 2);
                }
                ctx.globalAlpha = 1;
            }

            ctx.restore();
        }

        // ËæÖÂä©ÂáΩÊï∞ÔºöÁªòÂà∂ÊòüÂΩ¢
        function drawStarShape(ctx, cx, cy, spikes, outerR, innerR) {
            let rot = Math.PI / 2 * 3;
            let step = Math.PI / spikes;
            ctx.beginPath();
            ctx.moveTo(cx, cy - outerR);
            for (let i = 0; i < spikes; i++) {
                let x = cx + Math.cos(rot) * outerR;
                let y = cy + Math.sin(rot) * outerR;
                ctx.lineTo(x, y);
                rot += step;
                x = cx + Math.cos(rot) * innerR;
                y = cy + Math.sin(rot) * innerR;
                ctx.lineTo(x, y);
                rot += step;
            }
            ctx.lineTo(cx, cy - outerR);
            ctx.closePath();
            ctx.fill();
        }

        function drawBackground() {
            // Ê†πÊçÆÂΩìÂâçÂú∫ÊôØÁªòÂà∂‰∏çÂêåËÉåÊôØ
            switch(currentScene) {
                case 'policestation':
                    drawPoliceStationScene();
                    break;
                case 'catjail':
                    drawCatJailScene();
                    break;
                case 'secretlab':
                    drawSecretLabScene();
                    break;
                default:
                    drawCityScene();
            }
        }

        // ÂüéÂ∏ÇÂú∫ÊôØ (Dog Man È£éÊ†º - ÁΩ™ÊÅ∂‰πãÂüéÊ∞õÂõ¥)
        function drawCityScene() {
            // ÈªÑÊòè/Â§úÊôöÂ§©Á©∫Ê∏êÂèò - ÁΩ™ÊÅ∂‰πãÂüéÊ∞õÂõ¥
            const skyGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            skyGrad.addColorStop(0, '#1a1a2e');
            skyGrad.addColorStop(0.3, '#16213e');
            skyGrad.addColorStop(0.5, '#1f4068');
            skyGrad.addColorStop(0.7, '#e43f5a');
            skyGrad.addColorStop(1, '#162447');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // Êúà‰∫Æ (ÁΩ™ÊÅ∂‰πãÂüéÁöÑÊúàÂÖâ)
            ctx.save();
            ctx.fillStyle = '#F5F5DC';
            ctx.shadowColor = '#FFFACD';
            ctx.shadowBlur = 40;
            ctx.beginPath();
            ctx.arc(820, 80, 30, 0, Math.PI * 2);
            ctx.fill();
            // Êúà‰∫ÆÈò¥ÂΩ±
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#1a1a2e';
            ctx.beginPath();
            ctx.arc(830, 75, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();

            // ÊòüÊòü
            ctx.fillStyle = '#FFFFFF';
            const stars = [[50, 40], [120, 80], [200, 30], [350, 60], [450, 25], [550, 70], [650, 45], [750, 90]];
            stars.forEach(([x, y]) => {
                ctx.globalAlpha = 0.5 + Math.sin(frameCount * 0.1 + x) * 0.3;
                ctx.beginPath();
                ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // ËøúÊôØÂüéÂ∏ÇÂâ™ÂΩ±
            ctx.fillStyle = '#0f0f23';
            // ÂêéÊéíÂª∫Á≠ëÂâ™ÂΩ±
            for (let i = 150; i < 500; i += 35) {
                const h = 80 + Math.sin(i * 0.1) * 40;
                ctx.fillRect(i, GROUND_Y - h - 50, 30, h + 50);
            }

            // ‰∏≠ÊôØÂª∫Á≠ë - Dav PilkeyÊ≠™ÊñúÈ£éÊ†º + ÈúìËôπÁÅØÊïàÊûú
            drawNeonBuilding(180, GROUND_Y, 55, 200, '#2d3436', '#e74c3c');
            drawNeonBuilding(250, GROUND_Y, 50, 160, '#2d3436', '#3498db');
            drawNeonBuilding(315, GROUND_Y, 60, 220, '#2d3436', '#9b59b6');
            drawNeonBuilding(390, GROUND_Y, 45, 140, '#2d3436', '#f39c12');
            drawNeonBuilding(450, GROUND_Y, 55, 180, '#2d3436', '#1abc9c');

            // Ë≠¶ÂëäÊ†áÂøó (CRIMEÂå∫Âüü)
            ctx.save();
            ctx.fillStyle = '#e74c3c';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CRIME ZONE', 700, 250);
            ctx.restore();

            // Ë∑ØÁÅØ
            drawStreetLamp(160, GROUND_Y);

            // Ë°óÈÅì (Ê∑±Ëâ≤ÊüèÊ≤πË∑Ø)
            const streetGrad = ctx.createLinearGradient(0, GROUND_Y, 0, GROUND_Y + 50);
            streetGrad.addColorStop(0, '#2c3e50');
            streetGrad.addColorStop(0.5, '#34495e');
            streetGrad.addColorStop(1, '#2c3e50');
            ctx.fillStyle = streetGrad;
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);

            // Ë°óÈÅì‰∏≠Á∫ø
            ctx.strokeStyle = '#f1c40f';
            ctx.lineWidth = 3;
            ctx.setLineDash([20, 15]);
            ctx.beginPath();
            ctx.moveTo(0, GROUND_Y + 25);
            ctx.lineTo(canvas.width, GROUND_Y + 25);
            ctx.stroke();
            ctx.setLineDash([]);

            // ‰∫∫Ë°åÈÅìËæπÁºò
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(0, GROUND_Y, canvas.width, 8);

            // Â∑¶ËæπËçâÂú∞Âå∫Âüü (ÂºπÂºìÊâÄÂú®Âú∞)
            ctx.fillStyle = '#1e3d2f';
            ctx.fillRect(0, GROUND_Y, 170, 50);
            // ÊöóËâ≤ËçâÂú∞
            ctx.strokeStyle = '#2d5a3f';
            ctx.lineWidth = 2;
            for (let i = 0; i < 170; i += 15) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND_Y);
                ctx.quadraticCurveTo(i + 4, GROUND_Y - 10, i + 8, GROUND_Y - 6);
                ctx.stroke();
            }

            // ÈõæÊ∞îÊïàÊûú
            ctx.fillStyle = 'rgba(100, 100, 120, 0.15)';
            ctx.fillRect(0, GROUND_Y - 80, canvas.width, 80);
        }

        // ÈúìËôπÁÅØÈ£éÊ†ºÂª∫Á≠ë
        function drawNeonBuilding(x, groundY, width, height, buildingColor, neonColor) {
            ctx.save();
            const wobble = Math.sin(x * 0.05) * 4;
            ctx.translate(x, groundY);
            ctx.transform(1, 0, wobble * 0.008, 1, 0, 0);

            // Âª∫Á≠ë‰∏ª‰Ωì (Ê∑±Ëâ≤)
            ctx.fillStyle = buildingColor;
            ctx.beginPath();
            ctx.moveTo(wobble, 0);
            ctx.lineTo(wobble - 2, -height + 8);
            ctx.lineTo(width + wobble + 2, -height + 8);
            ctx.lineTo(width + wobble, 0);
            ctx.closePath();
            ctx.fill();

            // ÈúìËôπÁÅØËæπÊ°Ü
            ctx.strokeStyle = neonColor;
            ctx.shadowColor = neonColor;
            ctx.shadowBlur = 10;
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.shadowBlur = 0;

            // ÂèëÂÖâÁ™óÊà∑
            ctx.fillStyle = 'rgba(255, 255, 200, 0.7)';
            for (let row = 0; row < Math.floor(height / 40); row++) {
                for (let col = 0; col < 2; col++) {
                    // ÈöèÊú∫ÂÜ≥ÂÆöÁ™óÊà∑ÊòØÂê¶‰∫ÆÁùÄ
                    if (Math.sin(x + row * 3 + col * 7 + frameCount * 0.01) > -0.3) {
                        const wx = 10 + col * (width / 2 - 8) + wobble;
                        const wy = -height + 25 + row * 40;
                        ctx.fillStyle = `rgba(255, 255, ${150 + Math.sin(frameCount * 0.05 + row) * 50}, 0.8)`;
                        ctx.fillRect(wx, wy, 14, 18);
                    }
                }
            }

            // Â±ãÈ°∂ÈúìËôπÊãõÁâå (ÈöèÊú∫)
            if (Math.sin(x) > 0) {
                ctx.fillStyle = neonColor;
                ctx.shadowColor = neonColor;
                ctx.shadowBlur = 8;
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                const signs = ['BAR', 'HOTEL', '24H', 'OPEN', 'CLUB'];
                ctx.fillText(signs[Math.floor(x / 50) % signs.length], width / 2 + wobble, -height - 5);
                ctx.shadowBlur = 0;
            }

            ctx.restore();
        }

        // Ë∑ØÁÅØ
        function drawStreetLamp(x, groundY) {
            ctx.save();
            // ÁÅØÊü±
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(x - 3, groundY - 120, 6, 120);

            // ÁÅØÂ§¥
            ctx.fillStyle = '#34495e';
            ctx.beginPath();
            ctx.moveTo(x - 15, groundY - 120);
            ctx.lineTo(x + 15, groundY - 120);
            ctx.lineTo(x + 10, groundY - 130);
            ctx.lineTo(x - 10, groundY - 130);
            ctx.closePath();
            ctx.fill();

            // ÁÅØÂÖâÊïàÊûú
            ctx.fillStyle = '#f39c12';
            ctx.shadowColor = '#f39c12';
            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.arc(x, groundY - 125, 8, 0, Math.PI * 2);
            ctx.fill();

            // Âú∞Èù¢ÂÖâÂúà
            ctx.shadowBlur = 0;
            const lightGrad = ctx.createRadialGradient(x, groundY, 0, x, groundY, 60);
            lightGrad.addColorStop(0, 'rgba(243, 156, 18, 0.3)');
            lightGrad.addColorStop(1, 'rgba(243, 156, 18, 0)');
            ctx.fillStyle = lightGrad;
            ctx.beginPath();
            ctx.ellipse(x, groundY + 5, 60, 15, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        // Ë≠¶ÂØüÂ±ÄÂú∫ÊôØ
        function drawPoliceStationScene() {
            // ÂÆ§ÂÜÖËÉåÊôØ
            const wallGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            wallGrad.addColorStop(0, '#ECEFF1');
            wallGrad.addColorStop(1, '#CFD8DC');
            ctx.fillStyle = wallGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // Ë≠¶ÂØüÂ±ÄÊ†áÂøó
            ctx.fillStyle = '#1565C0';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('POLICE STATION', 450, 50);

            // Ë≠¶ÂæΩ
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(450, 90, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#1565C0';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('‚òÖ', 450, 96);

            // Â¢ô‰∏äÁöÑÊµ∑Êä• (Dog ManÈÄöÁºâ‰ª§)
            ctx.fillStyle = '#FFF9C4';
            ctx.fillRect(100, 100, 80, 100);
            ctx.strokeStyle = '#5D4037';
            ctx.lineWidth = 2;
            ctx.strokeRect(100, 100, 80, 100);
            ctx.fillStyle = '#D32F2F';
            ctx.font = 'bold 10px Arial';
            ctx.fillText('WANTED', 140, 120);
            ctx.font = '8px Arial';
            ctx.fillStyle = '#5D4037';
            ctx.fillText('PETEY', 140, 180);

            // ChiefÁöÑÁªøËâ≤Ê≤ôÂèë (Dog ManÁªèÂÖ∏Âú∫ÊôØ)
            ctx.fillStyle = '#2E7D32';
            ctx.beginPath();
            ctx.roundRect(680, GROUND_Y - 80, 120, 60, 10);
            ctx.fill();
            ctx.fillStyle = '#1B5E20';
            ctx.beginPath();
            ctx.roundRect(680, GROUND_Y - 85, 120, 20, 5);
            ctx.fill();
            // Ê≤ôÂèëÊâ∂Êâã
            ctx.fillStyle = '#2E7D32';
            ctx.beginPath();
            ctx.roundRect(670, GROUND_Y - 70, 20, 50, 8);
            ctx.fill();
            ctx.beginPath();
            ctx.roundRect(790, GROUND_Y - 70, 20, 50, 8);
            ctx.fill();

            // Êñá‰ª∂Êüú
            ctx.fillStyle = '#78909C';
            ctx.fillRect(50, GROUND_Y - 150, 60, 150);
            ctx.strokeStyle = '#455A64';
            ctx.lineWidth = 1;
            for (let i = 0; i < 4; i++) {
                ctx.strokeRect(52, GROUND_Y - 148 + i * 36, 56, 34);
                ctx.fillStyle = '#37474F';
                ctx.fillRect(75, GROUND_Y - 135 + i * 36, 10, 5);
            }

            // Âú∞Êùø
            ctx.fillStyle = '#8D6E63';
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);
            // Âú∞ÊùøÁ∫πÁêÜ
            ctx.strokeStyle = '#6D4C41';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND_Y);
                ctx.lineTo(i, GROUND_Y + 50);
                ctx.stroke();
            }
        }

        // Áå´ÁõëÁã±Âú∫ÊôØ
        function drawCatJailScene() {
            // ÁÅ∞Ëâ≤ÁõëÁã±ËÉåÊôØ
            const wallGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            wallGrad.addColorStop(0, '#9E9E9E');
            wallGrad.addColorStop(1, '#757575');
            ctx.fillStyle = wallGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // ÁõëÁã±Ê†áÂøó
            ctx.fillStyle = '#D32F2F';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CAT JAIL', 450, 50);

            // ÈìÅÊ†èÊùÜ
            ctx.strokeStyle = '#424242';
            ctx.lineWidth = 8;
            for (let i = 50; i < canvas.width - 50; i += 45) {
                ctx.beginPath();
                ctx.moveTo(i, 80);
                ctx.lineTo(i, GROUND_Y - 20);
                ctx.stroke();
            }
            // Ê®™ÊùÜ
            ctx.beginPath();
            ctx.moveTo(50, 120);
            ctx.lineTo(canvas.width - 50, 120);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(50, GROUND_Y - 50);
            ctx.lineTo(canvas.width - 50, GROUND_Y - 50);
            ctx.stroke();

            // Ë∑∑Ë∑∑Êùø (PeteyÈÄÉË∑ëÁî®ÁöÑ)
            ctx.fillStyle = '#8D6E63';
            ctx.save();
            ctx.translate(200, GROUND_Y - 20);
            ctx.rotate(frameCount * 0.002);
            ctx.fillRect(-50, -5, 100, 10);
            ctx.restore();
            // ÊîØÁÇπ
            ctx.fillStyle = '#5D4037';
            ctx.beginPath();
            ctx.moveTo(190, GROUND_Y);
            ctx.lineTo(200, GROUND_Y - 20);
            ctx.lineTo(210, GROUND_Y);
            ctx.closePath();
            ctx.fill();

            // Ê∞¥Ê≥•Âú∞
            ctx.fillStyle = '#616161';
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);
            // Ë£ÇÁºù
            ctx.strokeStyle = '#424242';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(100, GROUND_Y + 10);
            ctx.lineTo(150, GROUND_Y + 30);
            ctx.lineTo(180, GROUND_Y + 20);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(400, GROUND_Y + 5);
            ctx.lineTo(450, GROUND_Y + 25);
            ctx.stroke();
        }

        // ÁßòÂØÜÂÆûÈ™åÂÆ§Âú∫ÊôØ
        function drawSecretLabScene() {
            // ÈªëÊöóÁßëÊäÄËÉåÊôØ
            const labGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            labGrad.addColorStop(0, '#1A237E');
            labGrad.addColorStop(1, '#0D47A1');
            ctx.fillStyle = labGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // ÁßëÊäÄÁΩëÊ†º
            ctx.strokeStyle = 'rgba(33, 150, 243, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, GROUND_Y);
                ctx.stroke();
            }
            for (let i = 0; i < GROUND_Y; i += 40) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }

            // ÂÆûÈ™åÂÆ§Ê†áÂøó
            ctx.fillStyle = '#F44336';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText("PETEY'S SECRET LAB", 450, 50);

            // ÁîµËÑëÂ±èÂπï
            ctx.fillStyle = '#263238';
            ctx.fillRect(60, 150, 100, 80);
            ctx.fillStyle = '#00E676';
            ctx.fillRect(65, 155, 90, 70);
            // ‰ª£Á†ÅÊïàÊûú
            ctx.fillStyle = '#1B5E20';
            ctx.font = '8px monospace';
            for (let i = 0; i < 6; i++) {
                ctx.fillText('> EVIL PLAN ' + (i + 1), 70, 165 + i * 10);
            }

            // ËØïÁÆ°Êû∂
            ctx.fillStyle = '#5D4037';
            ctx.fillRect(750, 200, 80, 10);
            // ÂÜíÊ≥°ËØïÁÆ°
            const tubeColors = ['#4CAF50', '#9C27B0', '#FF9800'];
            tubeColors.forEach((color, i) => {
                ctx.fillStyle = 'rgba(200,200,200,0.3)';
                ctx.fillRect(760 + i * 25, 120, 15, 80);
                ctx.fillStyle = color;
                ctx.fillRect(762 + i * 25, 150 + Math.sin(frameCount * 0.1 + i) * 10, 11, 48);
                // Ê∞îÊ≥°
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.beginPath();
                ctx.arc(767 + i * 25, 160 - (frameCount + i * 20) % 40, 3, 0, Math.PI * 2);
                ctx.fill();
            });

            // ÈáëÂ±ûÂú∞Êùø
            ctx.fillStyle = '#37474F';
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);
            // ÈáëÂ±ûÊùø
            for (let i = 0; i < canvas.width; i += 50) {
                ctx.strokeStyle = '#263238';
                ctx.lineWidth = 2;
                ctx.strokeRect(i, GROUND_Y, 50, 50);
                ctx.fillStyle = '#455A64';
                ctx.beginPath();
                ctx.arc(i + 5, GROUND_Y + 5, 3, 0, Math.PI * 2);
                ctx.arc(i + 45, GROUND_Y + 5, 3, 0, Math.PI * 2);
                ctx.arc(i + 5, GROUND_Y + 45, 3, 0, Math.PI * 2);
                ctx.arc(i + 45, GROUND_Y + 45, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Dav PilkeyÈ£éÊ†ºÁöÑÊ≠™ÊñúÂª∫Á≠ë
        function drawWobblyBuilding(x, groundY, width, height, color1, color2) {
            ctx.save();
            // Ê≠™ÊñúÊïàÊûú
            const wobble = Math.sin(x * 0.05) * 3;
            ctx.translate(x, groundY);
            ctx.transform(1, 0, wobble * 0.01, 1, 0, 0);

            // Âª∫Á≠ë‰∏ª‰Ωì
            const buildGrad = ctx.createLinearGradient(0, -height, width, 0);
            buildGrad.addColorStop(0, color1);
            buildGrad.addColorStop(1, color2);
            ctx.fillStyle = buildGrad;

            // Ê≠™Ê≠™Êâ≠Êâ≠ÁöÑËΩÆÂªì
            ctx.beginPath();
            ctx.moveTo(wobble, 0);
            ctx.lineTo(wobble - 2, -height + 10);
            ctx.quadraticCurveTo(width / 2 + wobble, -height - 5, width + wobble + 2, -height + 10);
            ctx.lineTo(width + wobble, 0);
            ctx.closePath();
            ctx.fill();

            // ËæπÊ°Ü
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ‰∏çËßÑÂàôÁ™óÊà∑ (Dav PilkeyÈ£éÊ†º)
            ctx.fillStyle = 'rgba(255,255,200,0.8)';
            for (let row = 0; row < Math.floor(height / 35); row++) {
                for (let col = 0; col < 2; col++) {
                    const wx = 8 + col * (width / 2 - 5) + Math.random() * 3;
                    const wy = -height + 20 + row * 35 + Math.random() * 3;
                    const ww = 12 + Math.random() * 4;
                    const wh = 15 + Math.random() * 5;
                    ctx.fillRect(wx + wobble, wy, ww, wh);
                }
            }

            ctx.restore();
        }

        // Ê≠™Ê≠™Êâ≠Êâ≠ÁöÑ‰∫ëÊúµ
        function drawWobblyCloud(x, y, size) {
            ctx.save();
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.beginPath();
            // ‰∏çËßÑÂàôÁöÑÂúÜÂΩ¢ÁªÑÊàê‰∫ëÊúµ
            ctx.arc(x, y, size * 0.45, 0, Math.PI * 2);
            ctx.arc(x + size * 0.35, y - size * 0.15, size * 0.38, 0, Math.PI * 2);
            ctx.arc(x + size * 0.65, y - size * 0.05, size * 0.42, 0, Math.PI * 2);
            ctx.arc(x + size * 0.45, y + size * 0.12, size * 0.32, 0, Math.PI * 2);
            ctx.arc(x + size * 0.15, y + size * 0.08, size * 0.28, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        // ËçâÂú∞
        function drawGrass(startX, endX) {
            ctx.strokeStyle = '#2E7D32';
            ctx.lineWidth = 2;
            for (let i = startX; i < endX; i += 12) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND_Y);
                ctx.quadraticCurveTo(i + 3, GROUND_Y - 12, i + 6, GROUND_Y - 8);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(i + 6, GROUND_Y);
                ctx.quadraticCurveTo(i + 8, GROUND_Y - 8, i + 10, GROUND_Y - 5);
                ctx.stroke();
            }
        }

        function drawSlingshot() {
            ctx.save();

            // ========================================
            // ÁªòÂà∂ Dog Man Êìç‰ΩúÂëò (Á´ôÂú®ÂºπÂºìÂêéÈù¢)
            // ========================================
            drawDogManOperator();

            // ========================================
            // Dog Man È£éÊ†ºÈ™®Â§¥ÂºπÂºì
            // ========================================
            const slingshotX = SLINGSHOT_X;
            const slingshotY = SLINGSHOT_Y;

            // È™®Â§¥È¢úËâ≤Ê∏êÂèò
            const boneGrad = ctx.createLinearGradient(slingshotX - 35, 0, slingshotX + 35, 0);
            boneGrad.addColorStop(0, '#F5F5DC');
            boneGrad.addColorStop(0.3, '#FFFAF0');
            boneGrad.addColorStop(0.5, '#FFFFFF');
            boneGrad.addColorStop(0.7, '#FFFAF0');
            boneGrad.addColorStop(1, '#F5F5DC');

            // Â∑¶ËæπÈ™®Â§¥Âèâ (YÂΩ¢Â∑¶ËáÇ)
            ctx.fillStyle = boneGrad;
            ctx.strokeStyle = '#D2B48C';
            ctx.lineWidth = 2;

            // Â∑¶È™®Â§¥ÁêÉÁ´Ø
            ctx.beginPath();
            ctx.arc(slingshotX - 32, slingshotY - 60, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            // Â∑¶È™®Â§¥Â∞èÁêÉ
            ctx.beginPath();
            ctx.arc(slingshotX - 38, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.arc(slingshotX - 26, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Âè≥È™®Â§¥ÁêÉÁ´Ø
            ctx.beginPath();
            ctx.arc(slingshotX + 32, slingshotY - 60, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            // Âè≥È™®Â§¥Â∞èÁêÉ
            ctx.beginPath();
            ctx.arc(slingshotX + 38, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.arc(slingshotX + 26, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // È™®Â§¥ÊîØÊû∂‰∏ª‰Ωì
            ctx.lineWidth = 14;
            ctx.strokeStyle = boneGrad;
            ctx.lineCap = 'round';

            // Â∑¶È™®Â§¥ËáÇ
            ctx.beginPath();
            ctx.moveTo(slingshotX - 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX - 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();

            // Âè≥È™®Â§¥ËáÇ
            ctx.beginPath();
            ctx.moveTo(slingshotX + 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX + 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();

            // È™®Â§¥ËæπÊ°Ü
            ctx.strokeStyle = '#D2B48C';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(slingshotX - 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX - 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(slingshotX + 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX + 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();

            // Â∫ïÈÉ®È™®Â§¥ÊîØÊü±
            ctx.fillStyle = boneGrad;
            ctx.beginPath();
            ctx.ellipse(slingshotX, slingshotY, 10, 14, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#D2B48C';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ÊîØÊü±
            ctx.fillStyle = boneGrad;
            ctx.fillRect(slingshotX - 8, slingshotY + 5, 16, GROUND_Y - slingshotY - 15);
            ctx.strokeStyle = '#D2B48C';
            ctx.strokeRect(slingshotX - 8, slingshotY + 5, 16, GROUND_Y - slingshotY - 15);

            // Â∫ïÈÉ®È™®Â§¥ÁêÉ
            ctx.fillStyle = boneGrad;
            ctx.beginPath();
            ctx.arc(slingshotX, GROUND_Y - 8, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(slingshotX - 10, GROUND_Y - 3, 5, 0, Math.PI * 2);
            ctx.arc(slingshotX + 10, GROUND_Y - 3, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Ë≠¶ÂæΩË£ÖÈ•∞ (Âú®ÂºπÂºì‰∏≠Èó¥)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(slingshotX, slingshotY + 30, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#1E3A5F';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('‚òÖ', slingshotX, slingshotY + 30);

            ctx.restore();

            // ========================================
            // Á∫¢Ëâ≤Ê©°ÁöÆÁ≠ã (Dog Man ÁöÑÈ°πÂúàÈ¢úËâ≤)
            // ========================================
            if (projectile && (gameState === 'ready' || gameState === 'aiming')) {
                ctx.save();

                // ÁöÆÁ≠ã‰∏ª‰Ωì - Á∫¢Ëâ≤ (ÂÉèÁãóÈ°πÂúà)
                const bandGrad = ctx.createLinearGradient(slingshotX - 30, slingshotY - 60, projectile.x, projectile.y);
                bandGrad.addColorStop(0, '#C41E3A');
                bandGrad.addColorStop(0.5, '#DC143C');
                bandGrad.addColorStop(1, '#8B0000');

                ctx.strokeStyle = bandGrad;
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';

                // Â∑¶Ê©°ÁöÆÁ≠ã
                ctx.beginPath();
                ctx.moveTo(slingshotX - 32, slingshotY - 58);
                ctx.lineTo(projectile.x, projectile.y);
                ctx.stroke();

                // Âè≥Ê©°ÁöÆÁ≠ã
                ctx.beginPath();
                ctx.moveTo(slingshotX + 32, slingshotY - 58);
                ctx.lineTo(projectile.x, projectile.y);
                ctx.stroke();

                // È´òÂÖâÊïàÊûú
                ctx.strokeStyle = 'rgba(255,150,150,0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(slingshotX - 30, slingshotY - 56);
                ctx.lineTo(projectile.x + 2, projectile.y - 2);
                ctx.stroke();

                ctx.restore();
            }
        }

        // Dog Man Êìç‰ΩúÂëò - Á´ôÂú®ÂºπÂºìÂêéÈù¢ÊãâÂºπÂºì
        // Ë≠¶ÂØüÂ±ÄÈïø Chief - Dav PilkeyÁÆÄÁ¨îÁîªÈ£éÊ†º
        // ChiefÊòØ‰∫∫Á±ªÔºå‰∏çÊòØÁãóÔºÅÁÆÄÂçïÁöÑÁÅ´Êü¥‰∫∫È£éÊ†º
        function drawDogManOperator() {
            const opX = SLINGSHOT_X - 45;
            const opY = GROUND_Y;
            const scale = 0.9;

            ctx.save();
            ctx.translate(opX, opY);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // ===== Ë∫´‰Ωì (ËìùËâ≤Ë≠¶Êúç - ÁÆÄÂçïÁü©ÂΩ¢) =====
            ctx.fillStyle = '#4169E1';
            ctx.beginPath();
            ctx.rect(-18 * scale, -70 * scale, 36 * scale, 55 * scale);
            ctx.fill();
            ctx.stroke();

            // ËÖø (ÁÆÄÂçïÁöÑ‰∏§Êù°Á∫ø/Áü©ÂΩ¢)
            ctx.fillStyle = '#4169E1';
            ctx.fillRect(-14 * scale, -18 * scale, 10 * scale, 22 * scale);
            ctx.strokeRect(-14 * scale, -18 * scale, 10 * scale, 22 * scale);
            ctx.fillRect(4 * scale, -18 * scale, 10 * scale, 22 * scale);
            ctx.strokeRect(4 * scale, -18 * scale, 10 * scale, 22 * scale);

            // ÈûãÂ≠ê (ÁÆÄÂçïÁöÑÈªëËâ≤Ê§≠ÂúÜ)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-9 * scale, 2 * scale, 8 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.ellipse(9 * scale, 2 * scale, 8 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // ÊâãËáÇ - ÂêëÂè≥‰º∏Â±ïÊãâÂºπÂºì (ÁÆÄÂçïÁöÑÁ∫øÊù°)
            ctx.lineWidth = 8 * scale;
            ctx.strokeStyle = '#4169E1';
            ctx.beginPath();
            ctx.moveTo(15 * scale, -55 * scale);
            ctx.lineTo(50 * scale, -45 * scale);
            ctx.stroke();

            // Âè¶‰∏ÄÂè™ÊâãËáÇ
            ctx.beginPath();
            ctx.moveTo(12 * scale, -45 * scale);
            ctx.lineTo(45 * scale, -35 * scale);
            ctx.stroke();

            // Êâã (ËÇ§Ëâ≤ÂúÜÂΩ¢)
            ctx.fillStyle = '#FFDAB9';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(52 * scale, -42 * scale, 8 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Ë≠¶ÂæΩ (ÈáëËâ≤ÂúÜÂΩ¢ + ÊòüÊòü)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, -50 * scale, 8 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.stroke();

            // ===== Â§¥ÈÉ® (ËÇ§Ëâ≤ÂúÜÂΩ¢ - ‰∫∫Á±ª!) =====
            ctx.fillStyle = '#FFDAB9';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -90 * scale, 18 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ÁúºÁùõ - Dav PilkeyÈ£éÊ†º: È´òÁò¶ÁöÑÈªëËâ≤Ê§≠ÂúÜ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-7 * scale, -93 * scale, 3 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(7 * scale, -93 * scale, 3 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // Âò¥Â∑¥ (ÁÆÄÂçïÁöÑÂºßÁ∫ø)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -82 * scale, 6 * scale, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();

            // ËÉ°Â≠ê (ChiefÊúâËÉ°Â≠ê)
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.rect(-8 * scale, -82 * scale, 16 * scale, 6 * scale);
            ctx.fill();

            // Ë≠¶Â∏Ω (ËìùËâ≤)
            ctx.fillStyle = '#1E3A5F';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            // Â∏ΩÊ™ê
            ctx.beginPath();
            ctx.ellipse(0, -105 * scale, 22 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            // Â∏ΩË∫´
            ctx.beginPath();
            ctx.rect(-16 * scale, -120 * scale, 32 * scale, 16 * scale);
            ctx.fill();
            ctx.stroke();

            // Â∏ΩÂæΩ (ÈáëËâ≤)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, -112 * scale, 6 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.restore();
        }

        function drawBuddy(buddy) {
            ctx.save();
            ctx.translate(buddy.x, buddy.y);
            ctx.rotate(buddy.rotation || 0);

            // Â§ñÂèëÂÖâÊïàÊûú
            if (buddy.special && !buddy.specialUsed && buddy.active) {
                ctx.shadowColor = buddy.type === 'lilpetey' ? '#FFD700' : '#00FFFF';
                ctx.shadowBlur = 15 + Math.sin(frameCount * 0.15) * 5;
            }

            // Ê†πÊçÆËßíËâ≤Á±ªÂûãÁªòÂà∂‰∏çÂêåÁöÑÂΩ¢Ë±°
            switch(buddy.type) {
                case 'dogman':
                    drawDogMan(buddy.radius);
                    break;
                case 'lilpetey':
                    drawLilPetey(buddy.radius);
                    break;
                case '80hd':
                    draw80HD(buddy.radius);
                    break;
                case 'flippy':
                    drawFlippy(buddy.radius);
                    break;
            }

            ctx.restore();
        }

        // Dog Man - Dav Pilkey ÁÆÄÁ¨îÁîªÈ£éÊ†º
        // ÁãóÂ§¥ + ‰∫∫Ë∫´ÔºåÈùûÂ∏∏ÁÆÄÂçïÁöÑÁ∫øÊù°
        function drawDogMan(r) {
            const scale = r / 26;

            // ===== Ë∫´‰Ωì (ÁÆÄÂçïÁöÑËìùËâ≤Ë≠¶Êúç) =====
            ctx.fillStyle = '#4169E1'; // Ë≠¶ÊúçËìù
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // Ë∫´‰Ωì - ÁÆÄÂçïÁöÑÊ§≠ÂúÜ/Áü©ÂΩ¢
            ctx.beginPath();
            ctx.ellipse(0, 10 * scale, 14 * scale, 18 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ÈáëËâ≤Ë≠¶ÂæΩ (ÁÆÄÂçïÂúÜÂΩ¢)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, 8 * scale, 5 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ===== ÁãóÂ§¥ (ÊµÖÊ£ïËâ≤/Á±≥Ëâ≤) =====
            ctx.fillStyle = '#DEB887'; // ÊµÖÊ£ïËâ≤ÁãóÊØõ
            ctx.beginPath();
            ctx.ellipse(0, -14 * scale, 15 * scale, 13 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ‰∏ãÂûÇÁöÑÁãóËÄ≥Êúµ (Dav PilkeyÈ£éÊ†º - ÁÆÄÂçïÁöÑÊ§≠ÂúÜÂΩ¢‰∏ãÂûÇ)
            ctx.fillStyle = '#D2A679';
            ctx.beginPath();
            ctx.ellipse(-14 * scale, -8 * scale, 5 * scale, 12 * scale, 0.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(14 * scale, -8 * scale, 5 * scale, 12 * scale, -0.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Âè£ÈºªÈÉ® (Á±≥Ëâ≤Âá∏Ëµ∑Âå∫Âüü)
            ctx.fillStyle = '#F5DEB3';
            ctx.beginPath();
            ctx.ellipse(0, -9 * scale, 9 * scale, 7 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // ÁúºÁùõ - Dav PilkeyÈ£éÊ†º: È´òÁò¶ÁöÑÊ§≠ÂúÜÂΩ¢ÔºåÈªëËâ≤
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-6 * scale, -18 * scale, 2.5 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(6 * scale, -18 * scale, 2.5 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // ÈªëËâ≤ÂúÜÈºªÂ≠ê
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(0, -12 * scale, 4 * scale, 3 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // Âò¥Â∑¥ - ÁÆÄÂçïÁöÑÂæÆÁ¨ëÊõ≤Á∫ø
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(0, -6 * scale, 5 * scale, 0.15 * Math.PI, 0.85 * Math.PI);
            ctx.stroke();

            // ËàåÂ§¥ (Á≤âÁ∫¢Ëâ≤Ôºå‰º∏Âá∫Êù•)
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.ellipse(0, -2 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1 * scale;
            ctx.stroke();
        }

        // Li'l Petey - Dav Pilkey ÁÆÄÁ¨îÁîªÈ£éÊ†ºÁöÑÊ©òËâ≤Â∞èÁå´
        function drawLilPetey(r) {
            const scale = r / 20;

            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // Ë∫´‰Ωì (Ê©òËâ≤ÔºåÁÆÄÂçïÊ§≠ÂúÜ)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.ellipse(0, 8 * scale, 12 * scale, 14 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Ë∫´‰ΩìÊù°Á∫π (ÁÆÄÂçïÁöÑÂá†Êù°Á∫ø)
            ctx.strokeStyle = '#BF360C';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.moveTo(-5 * scale, 0);
            ctx.lineTo(-5 * scale, 18 * scale);
            ctx.moveTo(0, -2 * scale);
            ctx.lineTo(0, 18 * scale);
            ctx.moveTo(5 * scale, 0);
            ctx.lineTo(5 * scale, 18 * scale);
            ctx.stroke();

            // Â§ßÂúÜËÑëË¢ã
            ctx.fillStyle = '#FF9800';
            ctx.strokeStyle = '#000000';
            ctx.beginPath();
            ctx.arc(0, -10 * scale, 13 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ‰∏âËßíËÄ≥Êúµ (ÁÆÄÂçï‰∏âËßíÂΩ¢)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(-9 * scale, -18 * scale);
            ctx.lineTo(-13 * scale, -30 * scale);
            ctx.lineTo(-3 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(9 * scale, -18 * scale);
            ctx.lineTo(13 * scale, -30 * scale);
            ctx.lineTo(3 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ËÄ≥ÊúµÂÜÖÁ≤âËâ≤
            ctx.fillStyle = '#FFAB91';
            ctx.beginPath();
            ctx.moveTo(-8 * scale, -19 * scale);
            ctx.lineTo(-11 * scale, -27 * scale);
            ctx.lineTo(-4 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(8 * scale, -19 * scale);
            ctx.lineTo(11 * scale, -27 * scale);
            ctx.lineTo(4 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();

            // ÁúºÁùõ - Dav PilkeyÈ£éÊ†º: È´òÁò¶Ê§≠ÂúÜ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-5 * scale, -12 * scale, 2 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(5 * scale, -12 * scale, 2 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // Á≤âËâ≤Â∞èÈºªÂ≠ê (ÂÄí‰∏âËßí)
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.moveTo(0, -8 * scale);
            ctx.lineTo(-3 * scale, -5 * scale);
            ctx.lineTo(3 * scale, -5 * scale);
            ctx.closePath();
            ctx.fill();

            // Âò¥Â∑¥ - ÁÆÄÂçïWÂΩ¢
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5 * scale;
            ctx.beginPath();
            ctx.moveTo(-4 * scale, -3 * scale);
            ctx.lineTo(-1 * scale, 0);
            ctx.lineTo(1 * scale, -3 * scale);
            ctx.lineTo(4 * scale, 0);
            ctx.stroke();

            // ËÉ°È°ª (ÊØèËæπ3Ê†πÁÆÄÂçïÁõ¥Á∫ø)
            ctx.lineWidth = 1 * scale;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(-6 * scale, (-6 + i * 3) * scale);
                ctx.lineTo(-15 * scale, (-8 + i * 3) * scale);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(6 * scale, (-6 + i * 3) * scale);
                ctx.lineTo(15 * scale, (-8 + i * 3) * scale);
                ctx.stroke();
            }
        }

        // 80-HD - Dav Pilkey ÁÆÄÁ¨îÁîªÈ£éÊ†ºÁêÉÂΩ¢Êú∫Âô®‰∫∫
        function draw80HD(r) {
            const scale = r / 28;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // Ê©ôËâ≤‰∏ãÂçäÁêÉ
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.arc(0, 0, 20 * scale, 0, Math.PI);
            ctx.fill();
            ctx.stroke();

            // ÊµÖËìùËâ≤‰∏äÂçäÁêÉ (ÁéªÁíÉÁΩ©)
            ctx.fillStyle = '#87CEEB';
            ctx.beginPath();
            ctx.arc(0, 0, 20 * scale, Math.PI, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ÁéªÁíÉÁΩ©È´òÂÖâ (ÁÆÄÂçïÁôΩËâ≤ÂºßÁ∫ø)
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3 * scale;
            ctx.beginPath();
            ctx.arc(-6 * scale, -10 * scale, 6 * scale, Math.PI * 0.8, Math.PI * 1.5);
            ctx.stroke();

            // ‰∏≠Èó¥ÂàÜÂâ≤Á∫ø
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3 * scale;
            ctx.beginPath();
            ctx.moveTo(-20 * scale, 0);
            ctx.lineTo(20 * scale, 0);
            ctx.stroke();

            // ÁúºÁùõ - ÁÆÄÂçïÁöÑ‰∏§‰∏™ÈªëÁÇπ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-6 * scale, -8 * scale, 3 * scale, 0, Math.PI * 2);
            ctx.arc(6 * scale, -8 * scale, 3 * scale, 0, Math.PI * 2);
            ctx.fill();

            // ÂæÆÁ¨ë
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(0, -3 * scale, 6 * scale, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();

            // Êù°Á∫πÊâãËáÇ (Â∑¶) - ÁÆÄÂçïÁöÑÊù°Á∫πÁü©ÂΩ¢
            ctx.save();
            ctx.translate(-18 * scale, 5 * scale);
            ctx.rotate(-0.2);
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#BDBDBD' : '#616161';
                ctx.fillRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1 * scale;
                ctx.strokeRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
            }
            ctx.restore();

            // Êù°Á∫πÊâãËáÇ (Âè≥)
            ctx.save();
            ctx.translate(18 * scale, 5 * scale);
            ctx.rotate(0.2);
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#BDBDBD' : '#616161';
                ctx.fillRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1 * scale;
                ctx.strokeRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
            }
            ctx.restore();

            // ÈªëËâ≤‰∫∫Â≠óÊãñ (ÁÆÄÂçïÁöÑÊ§≠ÂúÜ)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-8 * scale, 22 * scale, 6 * scale, 3 * scale, 0, 0, Math.PI * 2);
            ctx.ellipse(8 * scale, 22 * scale, 6 * scale, 3 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        // Flippy - Dav Pilkey ÁÆÄÁ¨îÁîªÈ£éÊ†ºÁöÑÈ±º
        // Flippy - ÊúâÂøµÂäõÁöÑÈáëÈ±º (Dav PilkeyÈ£éÊ†º)
        function drawFlippy(r) {
            const scale = r / 22;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // ===== ÂøµÂäõÂÖâÁéØ (Á¥´Ëâ≤Ê≥¢Êµ™) =====
            const pulseSize = 1 + Math.sin(frameCount * 0.1) * 0.15;
            ctx.strokeStyle = '#9C27B0';
            ctx.lineWidth = 2 * scale;
            // Â§ñÂ±ÇÂÖâÁéØ
            ctx.beginPath();
            ctx.arc(0, 0, 22 * scale * pulseSize, 0, Math.PI * 2);
            ctx.stroke();
            // ‰∏≠Â±ÇÂÖâÁéØ
            ctx.globalAlpha = 0.6;
            ctx.beginPath();
            ctx.arc(0, 0, 26 * scale * pulseSize, 0, Math.PI * 2);
            ctx.stroke();
            // ÂÜÖÂ±ÇÂÖâÁéØ
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            ctx.arc(0, 0, 30 * scale * pulseSize, 0, Math.PI * 2);
            ctx.stroke();
            ctx.globalAlpha = 1;

            // ===== È±ºË∫´‰Ωì (ÈáëÈªÑËâ≤) =====
            ctx.strokeStyle = '#000000';
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.ellipse(0, 0, 16 * scale, 11 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // È±ºÈ≥ûÁ∫πÁêÜ (ÁÆÄÂçïÂºßÁ∫ø)
            ctx.strokeStyle = '#FFA000';
            ctx.lineWidth = 1 * scale;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc((3 + i * 4) * scale, 2 * scale, (4 - i) * scale, 0.3 * Math.PI, 0.7 * Math.PI);
                ctx.stroke();
            }

            // ===== ËÉåÈ≥ç (Ê≥¢Êµ™ÂΩ¢) =====
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.moveTo(-5 * scale, -9 * scale);
            ctx.quadraticCurveTo(-2 * scale, -18 * scale, 3 * scale, -14 * scale);
            ctx.quadraticCurveTo(6 * scale, -18 * scale, 8 * scale, -9 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ===== Â∞æÈ≥ç (‰ºòÈõÖÁöÑÂèåÂèâ) =====
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.moveTo(14 * scale, 0);
            ctx.quadraticCurveTo(20 * scale, -3 * scale, 26 * scale, -10 * scale);
            ctx.quadraticCurveTo(22 * scale, -2 * scale, 24 * scale, 0);
            ctx.quadraticCurveTo(22 * scale, 2 * scale, 26 * scale, 10 * scale);
            ctx.quadraticCurveTo(20 * scale, 3 * scale, 14 * scale, 0);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ===== ËÉ∏È≥ç (Â∞èÁøÖËÜÄ) =====
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.ellipse(-2 * scale, 8 * scale, 5 * scale, 3 * scale, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ===== Â§ßÁúºÁùõ (ÂøµÂäõÈ±ºÁöÑÁâπÂæÅ) =====
            // ÁúºÁôΩ
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.ellipse(-7 * scale, -2 * scale, 7 * scale, 6 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Áû≥Â≠î - Â∏¶ÊúâÂøµÂäõÂÖâËäí
            ctx.fillStyle = '#9C27B0'; // Á¥´Ëâ≤Áû≥Â≠î‰ª£Ë°®ÂøµÂäõ
            ctx.beginPath();
            ctx.arc(-7 * scale, -2 * scale, 3.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // Áû≥Â≠î‰∏≠ÂøÉ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-7 * scale, -2 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // ÁúºÁùõÈ´òÂÖâ
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(-9 * scale, -4 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // ===== Âò¥Â∑¥ (OÂΩ¢ÊÉäËÆ∂Áä∂) =====
            ctx.fillStyle = '#FF69B4';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.ellipse(-15 * scale, 2 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ===== ÂøµÂäõÊ≥¢Á∫π (‰ªéÁúºÁùõÂèëÂá∫) =====
            if (frameCount % 20 < 10) {
                ctx.strokeStyle = 'rgba(156, 39, 176, 0.5)';
                ctx.lineWidth = 1 * scale;
                for (let i = 1; i <= 3; i++) {
                    ctx.beginPath();
                    ctx.arc(-7 * scale, -2 * scale, (8 + i * 3) * scale, -0.5, 0.5);
                    ctx.stroke();
                }
            }
        }

        function drawVillain(villain) {
            ctx.save();
            ctx.translate(villain.x + villain.width / 2, villain.y + villain.height / 2);
            ctx.rotate(villain.angle || 0);

            const hw = villain.width / 2;
            const hh = villain.height / 2;

            switch(villain.type) {
                case 'petey':
                    drawPeteyVillain(hw, hh);
                    break;
                case 'flatpetey':
                    drawFlatPetey(hw, hh);
                    break;
                case 'piggy':
                    drawPiggy(hw, hh);
                    break;
                case 'robot':
                    drawRobotVillain(hw, hh);
                    break;
                default:
                    drawPeteyVillain(hw, hh);
            }

            // Ë°ÄÊù°
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(-hw, -hh - 14, villain.width, 10);
            const healthPct = villain.health / villain.maxHealth;
            const healthGrad = ctx.createLinearGradient(-hw, 0, hw, 0);
            if (healthPct > 0.5) {
                healthGrad.addColorStop(0, '#27AE60');
                healthGrad.addColorStop(1, '#2ECC71');
            } else if (healthPct > 0.25) {
                healthGrad.addColorStop(0, '#E67E22');
                healthGrad.addColorStop(1, '#F39C12');
            } else {
                healthGrad.addColorStop(0, '#C0392B');
                healthGrad.addColorStop(1, '#E74C3C');
            }
            ctx.fillStyle = healthGrad;
            ctx.fillRect(-hw + 2, -hh - 12, (villain.width - 4) * healthPct, 6);

            ctx.restore();
        }

        // Petey - ÈÇ™ÊÅ∂ÁöÑÊ©òËâ≤ËôéÊñëÁå´
        // Petey - Dav PilkeyÁÆÄÁ¨îÁîªÈ£éÊ†º
        // Ê©òËâ≤Áå´ÔºåÁÆÄÂçïÁöÑÂΩ¢Áä∂ÂíåÈªëËâ≤ËΩÆÂªì
        function drawPeteyVillain(hw, hh) {
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // Áå´Ë∫´‰Ωì (ÁÆÄÂçïÊ©òËâ≤Ê§≠ÂúÜ)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.ellipse(0, 5, hw - 2, hh - 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ÁÆÄÂçïÊù°Á∫π (Âá†Êù°ÈªëÁ∫ø)
            ctx.strokeStyle = '#BF360C';
            ctx.lineWidth = 2;
            for (let i = -1; i <= 1; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 8, -hh + 25);
                ctx.lineTo(i * 8, hh - 15);
                ctx.stroke();
            }

            // Â∞æÂ∑¥ (ÁÆÄÂçïÂºØÊõ≤Á∫ø)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(hw - 5, hh - 15);
            ctx.quadraticCurveTo(hw + 12, hh - 15, hw + 10, hh - 5);
            ctx.quadraticCurveTo(hw + 8, hh, hw - 3, hh - 8);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Â§¥ (ÁÆÄÂçïÂúÜÂΩ¢)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.arc(0, -hh + 15, 16, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ‰∏âËßíËÄ≥Êúµ (ÁÆÄÂçï‰∏âËßíÂΩ¢ + ÈªëËâ≤ËΩÆÂªì)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(-12, -hh + 5);
            ctx.lineTo(-16, -hh - 10);
            ctx.lineTo(-5, -hh + 5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(12, -hh + 5);
            ctx.lineTo(16, -hh - 10);
            ctx.lineTo(5, -hh + 5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ÁúºÁùõ - Dav PilkeyÈ£éÊ†º: È´òÁò¶ÈªëËâ≤Ê§≠ÂúÜ (ÈÇ™ÊÅ∂Ë°®ÊÉÖ)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-6, -hh + 12, 3, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(6, -hh + 12, 3, 6, 0, 0, Math.PI * 2);
            ctx.fill();

            // ÈÇ™ÊÅ∂ÁúâÊØõ (ÁÆÄÂçïÁöÑVÂΩ¢Á∫ø)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-12, -hh + 4);
            ctx.lineTo(-3, -hh + 7);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(12, -hh + 4);
            ctx.lineTo(3, -hh + 7);
            ctx.stroke();

            // ÈºªÂ≠ê (ÁÆÄÂçïÂ∞è‰∏âËßí)
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.moveTo(0, -hh + 18);
            ctx.lineTo(-3, -hh + 22);
            ctx.lineTo(3, -hh + 22);
            ctx.closePath();
            ctx.fill();

            // ËÉ°È°ª (ÁÆÄÂçïÁöÑÁõ¥Á∫ø)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            // Â∑¶Ëæπ
            ctx.beginPath();
            ctx.moveTo(-6, -hh + 20);
            ctx.lineTo(-18, -hh + 18);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(-6, -hh + 22);
            ctx.lineTo(-18, -hh + 22);
            ctx.stroke();
            // Âè≥Ëæπ
            ctx.beginPath();
            ctx.moveTo(6, -hh + 20);
            ctx.lineTo(18, -hh + 18);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(6, -hh + 22);
            ctx.lineTo(18, -hh + 22);
            ctx.stroke();

            // ÈÇ™ÊÅ∂Á¨ëÂÆπ (ÁÆÄÂçïÂºßÁ∫ø + WÂΩ¢Âò¥)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-6, -hh + 26);
            ctx.lineTo(-3, -hh + 29);
            ctx.lineTo(0, -hh + 26);
            ctx.lineTo(3, -hh + 29);
            ctx.lineTo(6, -hh + 26);
            ctx.stroke();
        }

        // Flat Petey - Á∫∏ÁâáÁâàPetey
        // Flat Petey - ÈÄöÁºâ‰ª§Êµ∑Êä•È£éÊ†º
        function drawFlatPetey(hw, hh) {
            // ===== ÈÄöÁºâ‰ª§Á∫∏Âº† =====
            ctx.fillStyle = '#FFF8E1';
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 2;

            // Á∫∏Âº†‰∏ª‰Ωì (Áï•ÂæÆ‰∏çËßÑÂàôÁöÑËæπÁºò)
            ctx.beginPath();
            ctx.moveTo(-hw + 3, -hh + 5);
            ctx.lineTo(-hw + 5, hh - 3);
            ctx.lineTo(hw - 5, hh - 5);
            ctx.lineTo(hw - 3, -hh + 3);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ===== "WANTED" ÈÄöÁºâÊ†áÈ¢ò =====
            ctx.fillStyle = '#8B0000';
            ctx.font = 'bold 8px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('WANTED', 0, -hh + 14);

            // ===== PeteyÁöÑËÑ∏ (ÈÄöÁºâÁäØÁÖßÁâá) =====
            // ÁÖßÁâáÊ°Ü
            ctx.fillStyle = '#FFE4B5';
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.rect(-hw + 8, -hh + 18, hw * 2 - 16, hh - 5);
            ctx.fill();
            ctx.stroke();

            // PeteyÁöÑËÑ∏ - Ê©òËâ≤ÂúÜËÑ∏
            ctx.fillStyle = '#FF9800';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.arc(0, -hh + 38, 14, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ‰∏âËßíËÄ≥Êúµ
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(-10, -hh + 28);
            ctx.lineTo(-14, -hh + 18);
            ctx.lineTo(-5, -hh + 28);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(10, -hh + 28);
            ctx.lineTo(14, -hh + 18);
            ctx.lineTo(5, -hh + 28);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ÈÇ™ÊÅ∂ÁöÑÁúºÁùõ - ÈªëËâ≤È´òÁò¶Ê§≠ÂúÜ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-5, -hh + 35, 2, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(5, -hh + 35, 2, 4, 0, 0, Math.PI * 2);
            ctx.fill();

            // ÈÇ™ÊÅ∂ÁúâÊØõ
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(-9, -hh + 30);
            ctx.lineTo(-3, -hh + 32);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(9, -hh + 30);
            ctx.lineTo(3, -hh + 32);
            ctx.stroke();

            // Á≤âËâ≤ÈºªÂ≠ê
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.moveTo(0, -hh + 40);
            ctx.lineTo(-2, -hh + 43);
            ctx.lineTo(2, -hh + 43);
            ctx.closePath();
            ctx.fill();

            // ÈÇ™ÊÅ∂Á¨ëÂÆπ (WÂΩ¢)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(-5, -hh + 46);
            ctx.lineTo(-2, -hh + 49);
            ctx.lineTo(0, -hh + 46);
            ctx.lineTo(2, -hh + 49);
            ctx.lineTo(5, -hh + 46);
            ctx.stroke();

            // ËÉ°È°ª
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-5, -hh + 43);
            ctx.lineTo(-12, -hh + 41);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(-5, -hh + 45);
            ctx.lineTo(-12, -hh + 45);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(5, -hh + 43);
            ctx.lineTo(12, -hh + 41);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(5, -hh + 45);
            ctx.lineTo(12, -hh + 45);
            ctx.stroke();

            // Êù°Á∫π (Ë∫´‰ΩìÈÉ®ÂàÜ)
            ctx.strokeStyle = '#BF360C';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-3, -hh + 55);
            ctx.lineTo(-3, hh - 10);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(3, -hh + 55);
            ctx.lineTo(3, hh - 10);
            ctx.stroke();

            // ===== "PETEY" ÂêçÂ≠ó =====
            ctx.fillStyle = '#8B0000';
            ctx.font = 'bold 6px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('PETEY', 0, hh - 3);

            // Á∫∏Âº†ÊäòÁóï/Á†¥ÊçüÊïàÊûú
            ctx.strokeStyle = 'rgba(139,69,19,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-hw + 10, -hh + 35);
            ctx.lineTo(hw - 10, hh - 25);
            ctx.stroke();
        }

        // Piggy - Dav PilkeyÁÆÄÁ¨îÁîªÈ£éÊ†º
        // Á≤âËâ≤Áå™ÔºåÁÆÄÂçïÂΩ¢Áä∂ÔºåÈªëËâ≤ËΩÆÂªì
        function drawPiggy(hw, hh) {
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // Áå™Ë∫´‰Ωì (ÁÆÄÂçïÁ≤âËâ≤Ê§≠ÂúÜ)
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.ellipse(0, 5, hw - 2, hh - 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Áå™Â§¥ (ÁÆÄÂçïÂúÜÂΩ¢)
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.arc(0, -hh + 18, 16, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // Áå™ËÄ≥Êúµ (ÁÆÄÂçïÊ§≠ÂúÜ)
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.ellipse(-12, -hh + 5, 6, 9, -0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(12, -hh + 5, 6, 9, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ÁúºÁùõ - Dav PilkeyÈ£éÊ†º: È´òÁò¶ÈªëËâ≤Ê§≠ÂúÜ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-6, -hh + 15, 3, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(6, -hh + 15, 3, 5, 0, 0, Math.PI * 2);
            ctx.fill();

            // ÊÑ§ÊÄíÁúâÊØõ (ÁÆÄÂçïVÂΩ¢)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-10, -hh + 7);
            ctx.lineTo(-3, -hh + 11);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(10, -hh + 7);
            ctx.lineTo(3, -hh + 11);
            ctx.stroke();

            // Áå™ÈºªÂ≠ê (ÁÆÄÂçïÊ§≠ÂúÜ + ‰∏§‰∏™ÈºªÂ≠î)
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.ellipse(0, -hh + 24, 7, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.stroke();

            // ÈºªÂ≠î (‰∏§‰∏™Â∞èÂúÜ)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-3, -hh + 24, 2, 0, Math.PI * 2);
            ctx.arc(3, -hh + 24, 2, 0, Math.PI * 2);
            ctx.fill();

            // Âò¥Â∑¥ (ÁÆÄÂçïÂºßÁ∫ø)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -hh + 30, 5, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();

            // ÁúºÈïú (ÁÆÄÂçïÂúÜÊ°Ü)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(-6, -hh + 15, 7, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(6, -hh + 15, 7, 0, Math.PI * 2);
            ctx.stroke();
            // ÁúºÈïúËÖø
            ctx.beginPath();
            ctx.moveTo(-13, -hh + 15);
            ctx.lineTo(-hw + 3, -hh + 13);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(13, -hh + 15);
            ctx.lineTo(hw - 3, -hh + 13);
            ctx.stroke();
            // ÁúºÈïúÊ°•
            ctx.beginPath();
            ctx.moveTo(-1, -hh + 15);
            ctx.lineTo(1, -hh + 15);
            ctx.stroke();
        }

        // Robot - ÈÇ™ÊÅ∂Êú∫Âô®‰∫∫
        // Robot - Dav PilkeyÁÆÄÁ¨îÁîªÈ£éÊ†º
        // ÁÆÄÂçïÁöÑÊñπÂùóÊú∫Âô®‰∫∫ÔºåÈªëËâ≤ËΩÆÂªì
        function drawRobotVillain(hw, hh) {
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // Êú∫Âô®‰∫∫Ë∫´‰Ωì (ÁÆÄÂçïÁÅ∞Ëâ≤Áü©ÂΩ¢)
            ctx.fillStyle = '#78909C';
            ctx.beginPath();
            ctx.rect(-hw + 3, -hh + 22, (hw - 3) * 2, hh * 2 - 25);
            ctx.fill();
            ctx.stroke();

            // Êú∫Âô®‰∫∫Â§¥ÈÉ® (ÁÆÄÂçïÁü©ÂΩ¢)
            ctx.fillStyle = '#90A4AE';
            ctx.beginPath();
            ctx.rect(-hw + 5, -hh + 2, (hw - 5) * 2, 22);
            ctx.fill();
            ctx.stroke();

            // Â§©Á∫ø (ÁÆÄÂçïÁ∫øÊù°)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, -hh + 2);
            ctx.lineTo(0, -hh - 10);
            ctx.stroke();

            // Â§©Á∫øÈ°∂ÈÉ® (Á∫¢Ëâ≤ÂúÜ)
            ctx.fillStyle = '#FF0000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -hh - 12, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ÁúºÁùõ - ÁÆÄÂçïÁ∫¢Ëâ≤ÂúÜÂΩ¢ (ÈÇ™ÊÅ∂Êú∫Âô®‰∫∫)
            ctx.fillStyle = '#FF0000';
            ctx.beginPath();
            ctx.arc(-8, -hh + 13, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(8, -hh + 13, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ËÉ∏ÈÉ®Èù¢Êùø (ÁÆÄÂçïÁü©ÂΩ¢)
            ctx.fillStyle = '#455A64';
            ctx.strokeStyle = '#000000';
            ctx.beginPath();
            ctx.rect(-12, 0, 24, 18);
            ctx.fill();
            ctx.stroke();

            // ÊåâÈíÆ (ÁÆÄÂçïÂúÜÂΩ¢)
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.arc(-5, 9, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#F44336';
            ctx.beginPath();
            ctx.arc(5, 9, 3, 0, Math.PI * 2);
            ctx.fill();

            // Êú∫Ê¢∞ËáÇ (ÁÆÄÂçïÁü©ÂΩ¢)
            ctx.fillStyle = '#78909C';
            ctx.strokeStyle = '#000000';
            ctx.fillRect(-hw - 5, 2, 7, 16);
            ctx.strokeRect(-hw - 5, 2, 7, 16);
            ctx.fillRect(hw - 2, 2, 7, 16);
            ctx.strokeRect(hw - 2, 2, 7, 16);

            // Èí≥Â≠êÊâã (ÁÆÄÂçïVÂΩ¢)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-hw - 2, 18);
            ctx.lineTo(-hw - 6, 26);
            ctx.moveTo(-hw - 2, 18);
            ctx.lineTo(-hw + 2, 26);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(hw + 2, 18);
            ctx.lineTo(hw + 6, 26);
            ctx.moveTo(hw + 2, 18);
            ctx.lineTo(hw - 2, 26);
            ctx.stroke();
        }

        function drawBlock(block) {
            ctx.save();

            if (block.type === 'tnt') {
                // TNTÁÇ∏Âºπ
                ctx.translate(block.x + 20, block.y + 20);
                ctx.rotate(block.angle || 0);

                const tntGrad = ctx.createRadialGradient(-5, -5, 0, 0, 0, 22);
                tntGrad.addColorStop(0, '#FF6B6B');
                tntGrad.addColorStop(0.7, '#E74C3C');
                tntGrad.addColorStop(1, '#C0392B');

                ctx.fillStyle = tntGrad;
                ctx.beginPath();
                ctx.roundRect(-18, -18, 36, 36, 5);
                ctx.fill();

                ctx.strokeStyle = '#922B21';
                ctx.lineWidth = 2;
                ctx.stroke();

                // TNTÊñáÂ≠ó
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('TNT', 0, 0);

                // Èó™ÁÉÅÂØºÁÅ´Á¥¢
                ctx.fillStyle = frameCount % 30 < 15 ? '#FFD700' : '#FF6B6B';
                ctx.beginPath();
                ctx.arc(0, -22, 5, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
                return;
            }

            ctx.translate(block.x + block.w / 2, block.y + block.h / 2);
            ctx.rotate(block.angle || 0);

            const hw = block.w / 2;
            const hh = block.h / 2;

            let grad, strokeColor;

            if (block.type === 'wood') {
                grad = ctx.createLinearGradient(-hw, 0, hw, 0);
                grad.addColorStop(0, '#D4A574');
                grad.addColorStop(0.3, '#DEB887');
                grad.addColorStop(0.7, '#DEB887');
                grad.addColorStop(1, '#C49A6C');
                strokeColor = '#8B4513';
            } else if (block.type === 'stone') {
                grad = ctx.createLinearGradient(-hw, -hh, hw, hh);
                grad.addColorStop(0, '#A9A9A9');
                grad.addColorStop(0.5, '#808080');
                grad.addColorStop(1, '#696969');
                strokeColor = '#4A4A4A';
            } else {
                grad = ctx.createLinearGradient(-hw, -hh, hw, hh);
                grad.addColorStop(0, 'rgba(173,216,230,0.85)');
                grad.addColorStop(0.5, 'rgba(135,206,250,0.75)');
                grad.addColorStop(1, 'rgba(100,149,237,0.65)');
                strokeColor = 'rgba(70,130,180,0.8)';
            }

            ctx.fillStyle = grad;
            ctx.fillRect(-hw, -hh, block.w, block.h);

            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(-hw, -hh, block.w, block.h);

            // ÊçüÂùèÁ∫πÁêÜ
            if (block.health < block.maxHealth) {
                ctx.strokeStyle = 'rgba(0,0,0,0.4)';
                ctx.lineWidth = 1;
                const cracks = block.maxHealth - block.health;
                for (let i = 0; i < cracks; i++) {
                    ctx.beginPath();
                    ctx.moveTo(-hw + block.w * 0.2 * (i + 1), -hh);
                    ctx.lineTo(-hw + block.w * 0.3 * (i + 1), hh);
                    ctx.stroke();
                }
            }

            // ÁéªÁíÉÈ´òÂÖâ
            if (block.type === 'glass') {
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.moveTo(-hw + 3, -hh + 3);
                ctx.lineTo(-hw + 8, -hh + 3);
                ctx.lineTo(-hw + 3, -hh + 15);
                ctx.fill();
            }

            // Á∫¢ÁÆ±Â≠ê (ÂùèËøêÊ∞î)
            if (block.type === 'redbox') {
                // Á∫¢Ëâ≤ËÉåÊôØ
                const redGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, Math.max(hw, hh));
                redGrad.addColorStop(0, '#FF4444');
                redGrad.addColorStop(0.7, '#CC0000');
                redGrad.addColorStop(1, '#990000');
                ctx.fillStyle = redGrad;
                ctx.fillRect(-hw, -hh, block.w, block.h);
                ctx.strokeStyle = '#660000';
                ctx.lineWidth = 3;
                ctx.strokeRect(-hw, -hh, block.w, block.h);

                // È™∑È´ÖÂõæÊ†á
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(0, -3, 8, 0, Math.PI * 2);
                ctx.fill();
                // ÁúºÁùõ
                ctx.fillStyle = '#990000';
                ctx.beginPath();
                ctx.arc(-3, -4, 2, 0, Math.PI * 2);
                ctx.arc(3, -4, 2, 0, Math.PI * 2);
                ctx.fill();
                // Âò¥Â∑¥
                ctx.strokeStyle = '#990000';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(-4, 2);
                ctx.lineTo(-2, 5);
                ctx.lineTo(0, 2);
                ctx.lineTo(2, 5);
                ctx.lineTo(4, 2);
                ctx.stroke();
                // Èó™ÁÉÅÊïàÊûú
                if (frameCount % 40 < 20) {
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.fillRect(-hw, -hh, block.w, block.h);
                }
            }

            // ÁªøÁÆ±Â≠ê (Â•ΩËøêÊ∞î)
            if (block.type === 'greenbox') {
                // ÁªøËâ≤ËÉåÊôØ
                const greenGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, Math.max(hw, hh));
                greenGrad.addColorStop(0, '#44FF44');
                greenGrad.addColorStop(0.7, '#00CC00');
                greenGrad.addColorStop(1, '#009900');
                ctx.fillStyle = greenGrad;
                ctx.fillRect(-hw, -hh, block.w, block.h);
                ctx.strokeStyle = '#006600';
                ctx.lineWidth = 3;
                ctx.strokeRect(-hw, -hh, block.w, block.h);

                // ÊòüÊòüÂõæÊ†á
                ctx.fillStyle = '#FFD700';
                drawStarShape(ctx, 0, 0, 5, 10, 5);

                // Èó™ÁÉÅÊïàÊûú
                if (frameCount % 30 < 15) {
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(-hw, -hh, block.w, block.h);
                }
            }

            ctx.restore();
        }

        function drawDebris(d) {
            ctx.save();
            ctx.globalAlpha = d.alpha;
            ctx.translate(d.x, d.y);
            ctx.rotate(d.rotation);
            ctx.fillStyle = d.color;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;

            switch(d.type) {
                case 'glasses':
                    // ÁúºÈïúÁ¢éÁâá
                    ctx.strokeStyle = d.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(-8, 0, 7, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(8, 0, 7, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(-1, 0);
                    ctx.lineTo(1, 0);
                    ctx.stroke();
                    break;
                case 'paper':
                    // Á∫∏Áâá - ËñÑÁâáÂΩ¢Áä∂
                    ctx.beginPath();
                    ctx.moveTo(-d.size/2, -d.size/4);
                    ctx.lineTo(d.size/2, -d.size/3);
                    ctx.lineTo(d.size/2 - 2, d.size/3);
                    ctx.lineTo(-d.size/2 + 2, d.size/4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    break;
                case 'metal':
                    // ÈáëÂ±ûÁ¢éÁâá - ‰∏çËßÑÂàôÂ§öËæπÂΩ¢
                    ctx.beginPath();
                    ctx.moveTo(-d.size/2, 0);
                    ctx.lineTo(-d.size/3, -d.size/2);
                    ctx.lineTo(d.size/3, -d.size/3);
                    ctx.lineTo(d.size/2, d.size/4);
                    ctx.lineTo(0, d.size/2);
                    ctx.closePath();
                    ctx.fill();
                    // ÈáëÂ±ûÂÖâÊ≥Ω
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.beginPath();
                    ctx.moveTo(-d.size/4, -d.size/4);
                    ctx.lineTo(d.size/4, -d.size/3);
                    ctx.lineTo(d.size/4, 0);
                    ctx.lineTo(-d.size/4, 0);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'fur':
                    // ÊØõÂèë - Ê§≠ÂúÜÂΩ¢
                    ctx.beginPath();
                    ctx.ellipse(0, 0, d.size/2, d.size/4, 0, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                default:
                    ctx.fillRect(-d.size / 2, -d.size / 2, d.size, d.size);
            }
            ctx.restore();
        }

        function drawParticle(p) {
            ctx.save();
            ctx.globalAlpha = p.alpha;
            ctx.fillStyle = p.color;

            switch(p.type) {
                case 'star':
                    // ÁîªÊòüÊòü
                    drawStar(p.x, p.y, 5, p.size / 2, p.size / 4);
                    break;
                case 'spark':
                    // ÁîµÁÅ´Ëä± - Â∞è‰∫ÆÁÇπ
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    break;
                case 'smoke':
                    // ÁÉüÈõæ - Ê®°Á≥äÂúÜÂΩ¢
                    const smokeGrad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
                    smokeGrad.addColorStop(0, p.color);
                    smokeGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = smokeGrad;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                default:
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
            }
            ctx.restore();
        }

        // ÁîªÊòüÊòüÂΩ¢Áä∂
        function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;

            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;

                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fill();
        }

        function drawTrajectory() {
            const power = Math.min(getDistance(projectile, { x: SLINGSHOT_X, y: SLINGSHOT_Y }), MAX_PULL_DISTANCE);
            const angle = Math.atan2(SLINGSHOT_Y - projectile.y, SLINGSHOT_X - projectile.x);
            const vx = Math.cos(angle) * power * LAUNCH_POWER_MULTIPLIER;
            const vy = Math.sin(angle) * power * LAUNCH_POWER_MULTIPLIER;

            let px = SLINGSHOT_X, py = SLINGSHOT_Y;
            let pvx = vx, pvy = vy;

            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 40; i++) {
                pvx *= AIR_RESISTANCE;
                pvy += GRAVITY * (projectile.mass || 1);
                pvy *= AIR_RESISTANCE;
                px += pvx;
                py += pvy;

                if (py > GROUND_Y) break;

                const alpha = 1 - i / 40;
                ctx.globalAlpha = alpha * 0.6;
                ctx.beginPath();
                ctx.arc(px, py, 4 - i * 0.08, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }

        // ========================================
        // ÁßªÂä®ÁÆ±Â≠êÁ≥ªÁªü
        // ========================================
        function updateMovingBoxes() {
            blocks.forEach(block => {
                if (!block.alive || block.falling) return;

                // Âè™ÊúâËÆæÁΩÆ‰∫ÜÁßªÂä®Â±ûÊÄßÁöÑÁÆ±Â≠êÊâç‰ºöÁßªÂä®
                if (block.moveX || block.moveY) {
                    block.movePhase += 0.03; // ÁßªÂä®ÈÄüÂ∫¶

                    if (block.moveX) {
                        // Ê∞¥Âπ≥ÁßªÂä®
                        block.x = block.originalX + Math.sin(block.movePhase) * block.moveX;
                    }
                    if (block.moveY) {
                        // ÂûÇÁõ¥ÁßªÂä®
                        block.y = block.originalY + Math.sin(block.movePhase) * block.moveY;
                    }
                }
            });
        }

        // ========================================
        // ÊñπÂùóÁâ©ÁêÜÁ≥ªÁªü - Âè™Â§ÑÁêÜÊ≠£Âú®‰∏ãËêΩÁöÑÊñπÂùó
        // ========================================
        function updateBlockPhysics() {
            const BLOCK_GRAVITY = 0.5;
            const BLOCK_BOUNCE = 0.3;
            const FALL_DAMAGE_THRESHOLD = 5;

            // Âè™Â§ÑÁêÜÂ∑≤ÁªèÊ†áËÆ∞‰∏∫fallingÁöÑÊñπÂùó
            blocks.forEach(block => {
                if (!block.alive || !block.falling) return;

                // Â∫îÁî®ÈáçÂäõ
                block.vy = (block.vy || 0) + BLOCK_GRAVITY;
                block.y += block.vy;

                // ËßíÂ∫¶ÊóãËΩ¨
                if (block.vx) {
                    block.x += block.vx;
                    block.angle = (block.angle || 0) + block.vx * 0.02;
                    block.vx *= 0.98;
                }

                // Ê£ÄÊü•‰∏éÂú∞Èù¢Á¢∞Êíû
                const blockBottom = block.y + (block.h || 40);
                if (blockBottom >= GROUND_Y) {
                    block.y = GROUND_Y - (block.h || 40);

                    // Ê†πÊçÆ‰∏ãËêΩÈÄüÂ∫¶ÈÄ†Êàê‰º§ÂÆ≥
                    if (block.vy > FALL_DAMAGE_THRESHOLD) {
                        block.health -= 1;
                        playImpact(block.type);
                        createDustParticles(block.x + (block.w || 40) / 2, GROUND_Y, 8);

                        if (block.health <= 0) {
                            block.alive = false;
                            createDebrisFromBlock(block);
                            score += 50;
                            if (block.type === 'wood') playWoodBreak();
                            else if (block.type === 'stone') playStoneBreak();
                            else playGlassBreak();
                        }
                    }

                    block.vy *= -BLOCK_BOUNCE;
                    if (Math.abs(block.vy) < 1) {
                        block.vy = 0;
                        block.falling = false;
                    }
                }

                // Ê£ÄÊü•‰∏éÂÖ∂‰ªñÊñπÂùóÁöÑÁ¢∞Êíû
                blocks.forEach(other => {
                    if (other === block || !other.alive || other.falling) return;

                    const blockBottom = block.y + (block.h || 40);
                    const otherTop = other.y;
                    const otherBottom = other.y + (other.h || 40);

                    const blockLeft = block.x;
                    const blockRight = block.x + (block.w || 40);
                    const otherLeft = other.x;
                    const otherRight = other.x + (other.w || 40);

                    const horizontalOverlap = blockRight > otherLeft && blockLeft < otherRight;

                    if (horizontalOverlap && blockBottom >= otherTop && block.y < otherBottom && block.vy > 0) {
                        block.y = otherTop - (block.h || 40);

                        if (block.vy > FALL_DAMAGE_THRESHOLD) {
                            other.health -= 1;
                            block.health -= 1;
                            playImpact(block.type);
                            createDustParticles(block.x + (block.w || 40) / 2, block.y + (block.h || 40), 5);

                            if (other.health <= 0) {
                                other.alive = false;
                                createDebrisFromBlock(other);
                                score += 50;
                                // Ë¢´Á†∏ÂùèÁöÑÊñπÂùó‰∏äÈù¢ÁöÑÊñπÂùó‰πüË¶ÅÊéâËêΩ
                                triggerBlocksAboveToFall(other);
                            }
                            if (block.health <= 0) {
                                block.alive = false;
                                createDebrisFromBlock(block);
                                score += 50;
                            }
                        }

                        block.vy *= -BLOCK_BOUNCE;
                        if (Math.abs(block.vy) < 1) {
                            block.vy = 0;
                            block.falling = false;
                        }
                    }
                });

                // Ê£ÄÊü•ÊòØÂê¶Á†∏Âà∞Êïå‰∫∫
                villains.forEach(v => {
                    if (!v.alive) return;
                    const blockBottom = block.y + (block.h || 40);
                    const blockCenterX = block.x + (block.w || 40) / 2;

                    if (blockBottom >= v.y && block.y < v.y + v.height &&
                        blockCenterX > v.x && blockCenterX < v.x + v.width &&
                        block.vy > 3) {
                        v.health -= 1;
                        if (v.health <= 0) {
                            v.alive = false;
                            score += 500;
                            playVillainDefeatSound(v.type);
                            createDebrisFromVillain(v);
                            checkGameEnd();
                        }
                    }
                });
            });
        }

        // ÂΩì‰∏Ä‰∏™ÊñπÂùóË¢´ÊëßÊØÅÊó∂ÔºåÊ£ÄÊü•‰∏äÈù¢ÁöÑÊñπÂùóÊòØÂê¶ÈúÄË¶ÅÊéâËêΩ
        function triggerBlocksAboveToFall(destroyedBlock) {
            const destroyedTop = destroyedBlock.y;
            const destroyedBottom = destroyedBlock.y + (destroyedBlock.h || 40);
            const destroyedLeft = destroyedBlock.x;
            const destroyedRight = destroyedBlock.x + (destroyedBlock.w || 40);

            blocks.forEach(block => {
                if (!block.alive || block.falling) return;

                const blockBottom = block.y + (block.h || 40);
                const blockLeft = block.x;
                const blockRight = block.x + (block.w || 40);

                // Ê£ÄÊü•Ëøô‰∏™ÊñπÂùóÊòØÂê¶Âú®Ë¢´ÊëßÊØÅÁöÑÊñπÂùó‰∏äÊñπ
                // ÊñπÂùóÁöÑÂ∫ïÈÉ®Â∫îËØ•Êé•ËøëË¢´ÊëßÊØÅÊñπÂùóÁöÑÈ°∂ÈÉ®ÔºåÂπ∂‰∏îÊúâÊ∞¥Âπ≥ÈáçÂè†
                const isAbove = blockBottom <= destroyedTop + 10 && blockBottom >= destroyedTop - 20;
                const hasOverlap = blockRight > destroyedLeft && blockLeft < destroyedRight;

                if (isAbove && hasOverlap) {
                    // Ê£ÄÊü•Ëøô‰∏™ÊñπÂùóÊòØÂê¶ËøòÊúâÂÖ∂‰ªñÊîØÊíë
                    if (!hasOtherSupport(block, destroyedBlock)) {
                        block.falling = true;
                        block.vy = 0;
                    }
                }
            });
        }

        // Ê£ÄÊü•ÊñπÂùóÊòØÂê¶ÊúâÂÖ∂‰ªñÊîØÊíëÔºàÊéíÈô§ÊåáÂÆöÁöÑÊñπÂùóÔºâ
        function hasOtherSupport(block, excludeBlock) {
            const blockBottom = block.y + (block.h || 40);
            const blockLeft = block.x;
            const blockRight = block.x + (block.w || 40);

            // Ê£ÄÊü•ÊòØÂê¶Âú®Âú∞Èù¢‰∏ä
            if (blockBottom >= GROUND_Y - 5) {
                return true;
            }

            // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÂÖ∂‰ªñÊñπÂùóÊîØÊíë
            for (const other of blocks) {
                if (other === block || other === excludeBlock || !other.alive) continue;

                const otherTop = other.y;
                const otherLeft = other.x;
                const otherRight = other.x + (other.w || 40);

                const verticalContact = blockBottom >= otherTop - 5 && blockBottom <= otherTop + 10;
                const horizontalOverlap = blockRight > otherLeft + 5 && blockLeft < otherRight - 5;

                if (verticalContact && horizontalOverlap) {
                    return true;
                }
            }

            return false;
        }

        // ========================================
        // Áâ©ÁêÜÊõ¥Êñ∞
        // ========================================
        function update() {
            if (gameState === 'flying' || gameState === 'waiting') {
                if (projectile && projectile.active) updateProjectile(projectile);
                projectiles.forEach(p => updateProjectile(p));
                projectiles = projectiles.filter(p => p.active);

                // Êõ¥Êñ∞Á¢éÁâá
                debris.forEach(d => {
                    d.x += d.vx;
                    d.y += d.vy;
                    d.vy += 0.5;
                    d.rotation += d.rotSpeed;
                    d.alpha -= 0.015;
                });
                debris = debris.filter(d => d.alpha > 0 && d.y < canvas.height);

                // Êõ¥Êñ∞Á≤íÂ≠ê
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.1;
                    p.alpha -= 0.03;
                    p.size *= 0.97;
                });
                particles = particles.filter(p => p.alpha > 0);

                // Êõ¥Êñ∞ÁßªÂä®ÁöÑÁÆ±Â≠ê
                updateMovingBoxes();

                // Êõ¥Êñ∞ÊñπÂùóÁâ©ÁêÜ - ÊîØÊíëÂÄíÂ°åÁ≥ªÁªü
                updateBlockPhysics();

                // Êõ¥Êñ∞ÊéâËêΩÁâ©‰Ωì
                fallingObjects.forEach(fo => {
                    fo.x += fo.vx || 0;
                    fo.y += fo.vy;
                    fo.vy += 0.4; // ÈáçÂäõ
                    fo.rotation += fo.rotationSpeed || fo.rotSpeed || 0;

                    // ÂùèËøêÊ∞îÁâ©‰ΩìÔºöÊ£ÄÊµã‰∏éÂºπÂ∞ÑÁâ©ÁöÑÁ¢∞Êíû
                    if (fo.type === 'bad') {
                        // Ê£ÄÊµã‰∏ªÂºπÂ∞ÑÁâ©
                        if (projectile && projectile.active) {
                            const dist = Math.hypot(fo.x - projectile.x, fo.y - projectile.y);
                            if (dist < fo.size + projectile.radius) {
                                // ÊëßÊØÅÂºπÂ∞ÑÁâ©ÔºÅ
                                projectile.active = false;
                                fo.hit = true;
                                createBadHitEffect(fo.x, fo.y);
                                playBadLuckSound();
                            }
                        }
                        // Ê£ÄÊµãÂàÜË£ÇÁöÑÂºπÂ∞ÑÁâ©
                        projectiles.forEach(p => {
                            if (p.active) {
                                const dist = Math.hypot(fo.x - p.x, fo.y - p.y);
                                if (dist < fo.size + p.radius) {
                                    p.active = false;
                                    fo.hit = true;
                                    createBadHitEffect(fo.x, fo.y);
                                }
                            }
                        });
                    }

                    // Â•ΩËøêÊ∞îÁâ©‰ΩìÔºöÊ£ÄÊµã‰∏éÊïå‰∫∫ÁöÑÁ¢∞Êíû
                    if (fo.type === 'good') {
                        villains.forEach(v => {
                            if (v.alive) {
                                const vCenterX = v.x + v.width / 2;
                                const vCenterY = v.y + v.height / 2;
                                const dist = Math.hypot(fo.x - vCenterX, fo.y - vCenterY);
                                if (dist < fo.size + Math.max(v.width, v.height) / 2) {
                                    // ÊëßÊØÅÊïå‰∫∫ÔºÅ
                                    v.alive = false;
                                    score += 800;
                                    fo.hit = true;
                                    createGoodHitEffect(vCenterX, vCenterY);
                                    playGoodLuckSound();
                                    playVillainDefeatSound(v.type);
                                    createDebrisFromVillain(v);
                                    checkGameEnd();
                                }
                            }
                        });
                    }
                });
                // ÁßªÈô§Â∑≤Âáª‰∏≠ÊàñË∂ÖÂá∫Â±èÂπïÁöÑÊéâËêΩÁâ©‰Ωì
                fallingObjects = fallingObjects.filter(fo => !fo.hit && fo.y < canvas.height + 50);

                // Ê£ÄÊü•ÈùôÊ≠¢
                if (projectile && !projectile.active && projectiles.length === 0) {
                    setTimeout(() => {
                        if (gameState === 'waiting') {
                            currentBuddyIndex++;
                            placeCurrentBuddy();
                            renderBuddiesPanel();
                        }
                    }, 600);
                }
            }
            updateUI();
        }

        function updateProjectile(p) {
            if (!p.active) return;

            // Áâ©ÁêÜÊ®°Êãü
            p.vx *= AIR_RESISTANCE;
            p.vy += GRAVITY * p.mass;
            p.vy *= AIR_RESISTANCE;
            p.x += p.vx;
            p.y += p.vy;

            // ÊóãËΩ¨
            p.rotationSpeed = p.vx * 0.02;
            p.rotation += p.rotationSpeed;

            // ËæπÁïå
            if (p.x < -60 || p.x > canvas.width + 60) {
                p.active = false;
                gameState = 'waiting';
            }

            // Âú∞Èù¢Á¢∞Êíû
            if (p.y + p.radius >= GROUND_Y) {
                p.y = GROUND_Y - p.radius;
                if (Math.abs(p.vy) > 2) playImpact('ground');
                p.vy *= -BOUNCE_DAMPING;
                p.vx *= GROUND_FRICTION;
                createDustParticles(p.x, GROUND_Y, 5);

                if (Math.abs(p.vy) < 0.8 && Math.abs(p.vx) < 0.8) {
                    p.active = false;
                    gameState = 'waiting';
                }
            }

            // ÈöúÁ¢çÁâ©Á¢∞Êíû
            blocks.forEach(block => {
                if (block.alive && checkCollision(p, block)) {
                    handleBlockCollision(p, block);
                }
            });

            // ÂèçÊ¥æÁ¢∞Êíû
            villains.forEach(villain => {
                if (villain.alive && checkCollisionRect(p, villain)) {
                    handleVillainCollision(p, villain);
                }
            });
        }

        function checkCollision(circle, rect) {
            const cx = circle.x, cy = circle.y, r = circle.radius;
            let rx = rect.x, ry = rect.y, rw = rect.w || 40, rh = rect.h || 40;

            const closestX = Math.max(rx, Math.min(cx, rx + rw));
            const closestY = Math.max(ry, Math.min(cy, ry + rh));
            return getDistance(circle, { x: closestX, y: closestY }) < r;
        }

        function checkCollisionRect(circle, rect) {
            return checkCollision(circle, { x: rect.x, y: rect.y, w: rect.width, h: rect.height });
        }

        function handleBlockCollision(p, block) {
            const damage = p.type === '80hd' ? 2 : 1;
            const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);

            playImpact(block.type);
            block.health -= damage;

            // Á¢∞ÊíûÂìçÂ∫î
            const centerX = block.x + (block.w || 40) / 2;
            const centerY = block.y + (block.h || 40) / 2;

            if (Math.abs(p.x - centerX) / (block.w || 40) > Math.abs(p.y - centerY) / (block.h || 40)) {
                p.vx *= -BOUNCE_DAMPING;
            } else {
                p.vy *= -BOUNCE_DAMPING;
            }

            if (block.health <= 0) {
                block.alive = false;

                // Ëß¶Âèë‰∏äÊñπÊñπÂùóÊéâËêΩ
                triggerBlocksAboveToFall(block);

                if (block.type === 'tnt') {
                    // TNTÁàÜÁÇ∏
                    explodeTNT(block);
                } else if (block.type === 'redbox') {
                    // Á∫¢ÁÆ±Â≠ê - ÂùèËøêÊ∞îÔºÅ
                    triggerBadLuck(block);
                    score += 150;
                } else if (block.type === 'greenbox') {
                    // ÁªøÁÆ±Â≠ê - Â•ΩËøêÊ∞îÔºÅ
                    triggerGoodLuck(block);
                    score += 250;
                } else {
                    if (block.type === 'wood') playWoodBreak();
                    else if (block.type === 'stone') playStoneBreak();
                    else playGlassBreak();

                    createDebrisFromBlock(block);
                    score += block.type === 'stone' ? 300 : block.type === 'wood' ? 200 : 100;
                }
            }
        }

        function explodeTNT(tnt) {
            playStoneBreak();
            playGlassBreak();

            // ÁàÜÁÇ∏Á≤íÂ≠ê
            for (let i = 0; i < 30; i++) {
                particles.push({
                    x: tnt.x + 20,
                    y: tnt.y + 20,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15 - 5,
                    size: 5 + Math.random() * 10,
                    color: Math.random() > 0.5 ? '#FF6B6B' : '#FFD700',
                    alpha: 1
                });
            }

            // ÁàÜÁÇ∏ËåÉÂõ¥ÂΩ±Âìç
            const explosionRadius = 120;
            const explosionPower = 15;

            blocks.forEach(b => {
                if (b.alive && b !== tnt) {
                    const dist = getDistance({ x: tnt.x + 20, y: tnt.y + 20 }, { x: b.x + (b.w || 40) / 2, y: b.y + (b.h || 40) / 2 });
                    if (dist < explosionRadius) {
                        b.health -= 2;
                        if (b.health <= 0) {
                            b.alive = false;
                            triggerBlocksAboveToFall(b);
                            createDebrisFromBlock(b);
                            score += 150;
                            if (b.type === 'tnt') setTimeout(() => explodeTNT(b), 100);
                            else if (b.type === 'redbox') triggerBadLuck(b);
                            else if (b.type === 'greenbox') triggerGoodLuck(b);
                        }
                    }
                }
            });

            villains.forEach(v => {
                if (v.alive) {
                    const dist = getDistance({ x: tnt.x + 20, y: tnt.y + 20 }, { x: v.x + v.width / 2, y: v.y + v.height / 2 });
                    if (dist < explosionRadius) {
                        v.health -= 2;
                        if (v.health <= 0) {
                            v.alive = false;
                            score += v.type === 'robot' ? 1000 : 500;
                            playVillainDefeatSound(v.type);
                            createDebrisFromVillain(v);
                        }
                        checkGameEnd();
                    }
                }
            });

            score += 500;
        }

        // Ëß¶ÂèëÂùèËøêÊ∞î - Á∫¢ÁÆ±Â≠êË¢´Âáª‰∏≠
        function triggerBadLuck(block) {
            playBadLuckSound();

            const cx = block.x + (block.w || 40) / 2;
            const cy = block.y + (block.h || 40) / 2;

            // Âº∫ÁÉàÂ±èÂπïÈúáÂä®ÔºÅ
            triggerScreenShake(12, 20);

            // ÈöèÊú∫ÈÄâÊã©ÂùèËøêÊ∞îÊïàÊûú
            const badEffects = ['meteor', 'enemyHeal', 'losePoints', 'multiMeteor'];
            const effect = badEffects[Math.floor(Math.random() * badEffects.length)];

            // Â§ßÈáèÁ∫¢Ëâ≤Ë≠¶ÂëäÁ≤íÂ≠êÁàÜÁÇ∏
            for (let i = 0; i < 35; i++) {
                const angle = (i / 35) * Math.PI * 2;
                const speed = 4 + Math.random() * 8;
                particles.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: 6 + Math.random() * 10,
                    color: ['#FF0000', '#FF4500', '#DC143C', '#8B0000'][Math.floor(Math.random() * 4)],
                    alpha: 1
                });
            }

            // Á∫¢Ëâ≤ÂÜ≤ÂáªÊ≥¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: cx, y: cy,
                radius: 5,
                maxRadius: 100,
                color: 'rgba(255, 0, 0, 0.5)',
                lineWidth: 6
            });

            // ÊòæÁ§∫Â§ßÂûãË≠¶ÂëäÊñáÂ≠ó
            showBigText('üíÄ ' + getEffectName(effect, 'bad'), '#FF0000', 90);

            switch(effect) {
                case 'meteor':
                    // Ë∂ÖÂ§ßÈô®Áü≥ - ‰ªéÂ§©ËÄåÈôçÔºÅ
                    let targetX = canvas.width / 2;
                    if (projectile && projectile.active) {
                        targetX = projectile.x + (Math.random() - 0.5) * 100;
                    }
                    // ‰∏ªÈô®Áü≥
                    fallingObjects.push({
                        x: targetX, y: -80, vy: 5, vx: 0, size: 40,
                        type: 'bad', rotation: 0,
                        rotationSpeed: 0.15, hit: false
                    });
                    // ‰º¥ÈöèÂ∞èÈô®Áü≥
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            fallingObjects.push({
                                x: targetX + (Math.random() - 0.5) * 150,
                                y: -50, vy: 4 + Math.random() * 2, vx: (Math.random() - 0.5) * 2, size: 18 + Math.random() * 10,
                                type: 'bad', rotation: Math.random() * Math.PI,
                                rotationSpeed: (Math.random() - 0.5) * 0.2, hit: false
                            });
                        }, i * 150);
                    }
                    break;

                case 'multiMeteor':
                    // ÊµÅÊòüÈõ®ÔºÅÊª°Â§©Èô®Áü≥ÔºÅ
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            let dropX = 150 + Math.random() * (canvas.width - 300);
                            fallingObjects.push({
                                x: dropX,
                                y: -50 - Math.random() * 100, vy: 4 + Math.random() * 3, vx: (Math.random() - 0.5) * 3, size: 20 + Math.random() * 15,
                                type: 'bad', rotation: Math.random() * Math.PI,
                                rotationSpeed: (Math.random() - 0.5) * 0.3, hit: false
                            });
                            // ÊØè‰∏™Èô®Áü≥ÈÉΩÊúâÁÅ´Ëä±Á≤íÂ≠ê
                            for (let j = 0; j < 5; j++) {
                                particles.push({
                                    x: dropX, y: 50,
                                    vx: (Math.random() - 0.5) * 6,
                                    vy: Math.random() * 3,
                                    size: 3 + Math.random() * 4,
                                    color: ['#FF6600', '#FF9900', '#FFCC00'][Math.floor(Math.random() * 3)],
                                    alpha: 1
                                });
                            }
                        }, i * 200);
                    }
                    break;

                case 'enemyHeal':
                    // Êïå‰∫∫ÂõûË°Ä + ÊòéÊòæÊ≤ªÊÑàÊïàÊûú
                    villains.forEach(v => {
                        if (v.alive) {
                            v.health = v.maxHealth; // ÂÆåÂÖ®ÊÅ¢Â§çÔºÅ
                            // Â§ßÈáèÊ≤ªÊÑàÁ≤íÂ≠ê
                            for (let i = 0; i < 20; i++) {
                                particles.push({
                                    x: v.x + v.width/2, y: v.y + v.height/2,
                                    vx: (Math.random() - 0.5) * 8,
                                    vy: -Math.random() * 6 - 2,
                                    size: 5 + Math.random() * 6,
                                    color: '#FF69B4', alpha: 1
                                });
                            }
                            // Ê≤ªÊÑàÂÜ≤ÂáªÊ≥¢
                            window.shockwaves.push({
                                x: v.x + v.width/2, y: v.y + v.height/2,
                                radius: 5, maxRadius: 60,
                                color: 'rgba(255, 105, 180, 0.4)', lineWidth: 4
                            });
                        }
                    });
                    break;

                case 'losePoints':
                    // Â§ßÈáèÊâ£ÂàÜ
                    const pointsLost = Math.min(score, 800 + Math.floor(Math.random() * 700));
                    score = Math.max(0, score - pointsLost);
                    updateUI();
                    // ÈáëÂ∏ÅÈ£ûËµ∞ÊïàÊûú
                    for (let i = 0; i < 20; i++) {
                        particles.push({
                            x: cx, y: cy,
                            vx: (Math.random() - 0.5) * 15,
                            vy: -Math.random() * 10 - 5,
                            size: 6 + Math.random() * 6,
                            color: '#FFD700', alpha: 1
                        });
                    }
                    break;
            }

            // Á∫¢Ëâ≤Á¢éÁâáÁàÜÁÇ∏
            for (let i = 0; i < 15; i++) {
                debris.push({
                    x: cx + (Math.random() - 0.5) * 40,
                    y: cy + (Math.random() - 0.5) * 40,
                    vx: (Math.random() - 0.5) * 10,
                    vy: -Math.random() * 8 - 3,
                    size: 6 + Math.random() * 10,
                    color: '#FF4444', alpha: 1,
                    rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.4
                });
            }
        }

        // Ëß¶ÂèëÂ•ΩËøêÊ∞î - ÁªøÁÆ±Â≠êË¢´Âáª‰∏≠
        function triggerGoodLuck(block) {
            playGoodLuckSound();

            const cx = block.x + (block.w || 40) / 2;
            const cy = block.y + (block.h || 40) / 2;

            // Ê¨¢Âø´ÁöÑÂ±èÂπïÈúáÂä®
            triggerScreenShake(8, 15);

            // ÈöèÊú∫ÈÄâÊã©Â•ΩËøêÊ∞îÊïàÊûú
            const goodEffects = ['starfall', 'bonusPoints', 'extraBuddy', 'destroyBlocks', 'multiStar'];
            const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];

            // Â§ßÈáèÁªøËâ≤/ÈáëËâ≤Â∫ÜÁ•ùÁ≤íÂ≠ê
            for (let i = 0; i < 40; i++) {
                const angle = (i / 40) * Math.PI * 2;
                const speed = 3 + Math.random() * 7;
                particles.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 2,
                    size: 5 + Math.random() * 8,
                    color: ['#00FF00', '#7CFC00', '#FFD700', '#FFFF00'][Math.floor(Math.random() * 4)],
                    alpha: 1
                });
            }

            // ÁªøËâ≤/ÈáëËâ≤ÂÜ≤ÂáªÊ≥¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: cx, y: cy,
                radius: 5,
                maxRadius: 80,
                color: 'rgba(0, 255, 0, 0.4)',
                lineWidth: 5
            });

            // ÊòæÁ§∫Â§ßÂûãÂ∫ÜÁ•ùÊñáÂ≠ó
            showBigText('üéâ ' + getEffectName(effect, 'good'), '#00FF00', 90);

            switch(effect) {
                case 'starfall':
                    // Ë∂ÖÁ∫ßÂπ∏ËøêÊòüÔºÅÁ≤æÂáÜÊâìÂáªÊïå‰∫∫ÔºÅ
                    const aliveVillains = villains.filter(v => v.alive);
                    if (aliveVillains.length > 0) {
                        const target = aliveVillains[Math.floor(Math.random() * aliveVillains.length)];
                        // ‰∏ªÊòüÊòü - Êõ¥Â§ßÊõ¥‰∫Æ
                        fallingObjects.push({
                            x: target.x + target.width/2,
                            y: -80, vy: 5, vx: 0, size: 35,
                            type: 'good', rotation: 0,
                            rotationSpeed: 0.12, hit: false
                        });
                        // ‰º¥ÈöèÂ∞èÊòüÊòü
                        for (let i = 0; i < 4; i++) {
                            setTimeout(() => {
                                fallingObjects.push({
                                    x: target.x + target.width/2 + (Math.random() - 0.5) * 80,
                                    y: -40, vy: 4 + Math.random() * 2, vx: (Math.random() - 0.5) * 2, size: 15 + Math.random() * 8,
                                    type: 'good', rotation: Math.random() * Math.PI,
                                    rotationSpeed: 0.1 + Math.random() * 0.1, hit: false
                                });
                            }, i * 100);
                        }
                        // ÁõÆÊ†áÊ†áËÆ∞ - ÂΩ©ËôπÂÖâÊü±ÊïàÊûú
                        for (let i = 0; i < 20; i++) {
                            particles.push({
                                x: target.x + target.width/2 + (Math.random() - 0.5) * 30,
                                y: target.y - 20,
                                vx: (Math.random() - 0.5) * 3,
                                vy: -Math.random() * 5 - 2,
                                size: 4 + Math.random() * 6,
                                color: ['#FFD700', '#FF6B9D', '#4D96FF', '#6BCB77'][Math.floor(Math.random() * 4)],
                                alpha: 1
                            });
                        }
                    }
                    break;

                case 'multiStar':
                    // ÊòüÊòüÈõ®ÔºÅÊØè‰∏™Êïå‰∫∫ÈÉΩ‰ºöË¢´ÊîªÂáªÔºÅ
                    const targets = villains.filter(v => v.alive);
                    targets.forEach((t, i) => {
                        setTimeout(() => {
                            // ÊØè‰∏™Êïå‰∫∫‰∏äÊñπ3È¢óÊòüÊòü
                            for (let j = 0; j < 3; j++) {
                                setTimeout(() => {
                                    fallingObjects.push({
                                        x: t.x + t.width/2 + (Math.random() - 0.5) * 60,
                                        y: -50 - Math.random() * 50, vy: 5 + Math.random() * 2, vx: (Math.random() - 0.5) * 2, size: 22 + Math.random() * 10,
                                        type: 'good', rotation: Math.random() * Math.PI,
                                        rotationSpeed: 0.1 + Math.random() * 0.15, hit: false
                                    });
                                }, j * 80);
                            }
                            // ÂΩ©ËôπÁ≤íÂ≠ê
                            for (let k = 0; k < 15; k++) {
                                particles.push({
                                    x: t.x + t.width/2,
                                    y: t.y,
                                    vx: (Math.random() - 0.5) * 8,
                                    vy: -Math.random() * 6 - 2,
                                    size: 4 + Math.random() * 5,
                                    color: ['#FFD700', '#FF6B9D', '#4D96FF', '#6BCB77', '#9B59B6'][Math.floor(Math.random() * 5)],
                                    alpha: 1
                                });
                            }
                        }, i * 200);
                    });
                    break;

                case 'bonusPoints':
                    // Â§ßÈáèÂ•ñÂä±ÁßØÂàÜ
                    const bonusPoints = 1500 + Math.floor(Math.random() * 2000);
                    score += bonusPoints;
                    updateUI();
                    // ÈáëÂ∏ÅÂñ∑Ê≥âÊïàÊûú
                    for (let i = 0; i < 30; i++) {
                        particles.push({
                            x: cx, y: cy,
                            vx: (Math.random() - 0.5) * 12,
                            vy: -Math.random() * 12 - 5,
                            size: 6 + Math.random() * 8,
                            color: '#FFD700', alpha: 1
                        });
                    }
                    // ÈáëËâ≤ÂÜ≤ÂáªÊ≥¢
                    window.shockwaves.push({
                        x: cx, y: cy,
                        radius: 10, maxRadius: 100,
                        color: 'rgba(255, 215, 0, 0.5)', lineWidth: 6
                    });
                    break;

                case 'extraBuddy':
                    // Ëé∑ÂæóÈ¢ùÂ§ñÈÅìÂÖ∑
                    const buddyTypeList = ['dogman', 'lilpetey', '80hd', 'flippy'];
                    const newBuddyType = buddyTypeList[Math.floor(Math.random() * buddyTypeList.length)];
                    const newBuddy = {
                        type: newBuddyType,
                        ...window.buddyTypes[newBuddyType],
                        used: false
                    };
                    buddies.push(newBuddy);
                    renderBuddiesPanel();
                    // ÂΩ©ËôπÁ≤íÂ≠ê
                    for (let i = 0; i < 25; i++) {
                        particles.push({
                            x: cx, y: cy,
                            vx: (Math.random() - 0.5) * 10,
                            vy: -Math.random() * 10 - 3,
                            size: 5 + Math.random() * 6,
                            color: ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#8B00FF'][Math.floor(Math.random() * 6)],
                            alpha: 1
                        });
                    }
                    break;

                case 'destroyBlocks':
                    // ÊëßÊØÅÊõ¥Â§öÊñπÂùó
                    const aliveBlocks = blocks.filter(b => b.alive && b.type !== 'redbox' && b.type !== 'greenbox');
                    const toDestroy = aliveBlocks.slice(0, Math.min(5, aliveBlocks.length));
                    toDestroy.forEach((b, i) => {
                        setTimeout(() => {
                            if (b.alive) {
                                b.alive = false;
                                createDebrisFromBlock(b);
                                score += 150;
                                playGlassBreak();
                                triggerScreenShake(5, 10);
                                // ÊØè‰∏™ÊñπÂùóÁàÜÁÇ∏ÊïàÊûú
                                window.shockwaves.push({
                                    x: b.x + (b.w || 40)/2,
                                    y: b.y + (b.h || 40)/2,
                                    radius: 5, maxRadius: 50,
                                    color: 'rgba(255, 255, 0, 0.4)', lineWidth: 3
                                });
                            }
                        }, i * 120);
                    });
                    break;
            }

            // ÁªøËâ≤/ÈáëËâ≤Á¢éÁâá
            for (let i = 0; i < 12; i++) {
                debris.push({
                    x: cx + (Math.random() - 0.5) * 40,
                    y: cy + (Math.random() - 0.5) * 40,
                    vx: (Math.random() - 0.5) * 8,
                    vy: -Math.random() * 6 - 3,
                    size: 6 + Math.random() * 10,
                    color: Math.random() > 0.5 ? '#44FF44' : '#FFD700',
                    alpha: 1,
                    rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.4
                });
            }
        }

        // ÊòæÁ§∫ÊµÆÂä®ÊñáÂ≠ó
        function showFloatingText(x, y, text, color) {
            const textObj = {
                x: x, y: y, text: text, color: color,
                alpha: 1, vy: -1.5, life: 60
            };
            if (!window.floatingTexts) window.floatingTexts = [];
            window.floatingTexts.push(textObj);
        }

        // Ëé∑ÂèñÊïàÊûúÂêçÁß∞
        function getEffectName(effect, type) {
            const names = {
                'meteor': '‚òÑÔ∏è Èô®Áü≥Êù•Ë¢≠!',
                'multiMeteor': '‚òÑÔ∏è‚òÑÔ∏è ÊµÅÊòüÈõ®!',
                'enemyHeal': 'üíó Êïå‰∫∫ÂõûË°Ä!',
                'losePoints': 'üíî Êâ£ÂàÜ!',
                'starfall': '‚≠ê Âπ∏ËøêÊòü!',
                'multiStar': 'üåü ÊòüÊòüÈõ®!',
                'bonusPoints': 'üí∞ Â•ñÂä±ÁßØÂàÜ!',
                'extraBuddy': 'üéÅ È¢ùÂ§ñÈÅìÂÖ∑!',
                'destroyBlocks': 'üí• ÊñπÂùóÁ†¥Âùè!'
            };
            return names[effect] || (type === 'bad' ? 'ÂùèËøêÊ∞î!' : 'Â•ΩËøêÊ∞î!');
        }

        // Ëé∑ÂèñÈÅìÂÖ∑ÂêçÁß∞
        function getBuddyName(type) {
            const names = {
                'dogman': 'ÁãóË∂Ö‰∫∫',
                'lilpetey': 'Â∞èÁöÆÂºü',
                '80hd': 'Êú∫Âô®Áãó',
                'flippy': 'ÂøµÂäõÈ±º'
            };
            return names[type] || type;
        }

        function handleVillainCollision(p, villain) {
            const damage = p.type === '80hd' ? 2 : 1;
            villain.health -= damage;

            playImpact('default');
            p.vx *= 0.5;
            p.vy *= 0.5;

            if (villain.health <= 0) {
                villain.alive = false;
                score += villain.type === 'robot' || villain.type === 'piggy' ? 1000 : 500;
                playVillainDefeatSound(villain.type);
                createDebrisFromVillain(villain);
            }

            updateUI();
            checkGameEnd();
        }

        function createDebrisFromBlock(block) {
            const color = block.type === 'wood' ? '#DEB887' : block.type === 'stone' ? '#808080' : '#87CEEB';
            for (let i = 0; i < 10; i++) {
                debris.push({
                    x: block.x + Math.random() * (block.w || 40),
                    y: block.y + Math.random() * (block.h || 40),
                    vx: (Math.random() - 0.5) * 8,
                    vy: -Math.random() * 6 - 2,
                    size: 4 + Math.random() * 8,
                    color: color,
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.3
                });
            }
        }

        function createDebrisFromVillain(villain) {
            const cx = villain.x + villain.width / 2;
            const cy = villain.y + villain.height / 2;

            // Ê†πÊçÆ‰∏çÂêåÂèçÊ¥æÁ±ªÂûãÂàõÂª∫‰∏çÂêåÁöÑÁàÜÁÇ∏ÊïàÊûú
            switch(villain.type) {
                case 'petey':
                    // Petey - Ê©òËâ≤ÊØõÂèëÈ£ûÊ∫Ö + ÊÑ§ÊÄíÁöÑÊòüÊòü
                    createPeteyExplosion(cx, cy);
                    break;
                case 'flatpetey':
                    // Flat Petey - Á∫∏ÁâáÁ¢éÁâáÈ£ûÊï£
                    createPaperExplosion(cx, cy);
                    break;
                case 'piggy':
                    // Piggy - Á≤âËâ≤ÁÉüÈõæ + ÁúºÈïúÈ£ûÂá∫
                    createPiggyExplosion(cx, cy);
                    break;
                case 'robot':
                    // Robot - ÈáëÂ±ûÁ¢éÁâá + ÁîµÁÅ´Ëä± + ÂÜíÁÉü
                    createRobotExplosion(cx, cy);
                    break;
                default:
                    createDefaultExplosion(cx, cy, '#FF8C00');
            }
        }

        // PeteyÁàÜÁÇ∏ - Ê©òËâ≤ÊØõÂèë + ÊÑ§ÊÄíÊòüÊòü
        function createPeteyExplosion(cx, cy) {
            // Ê©òËâ≤ÊØõÂèëÁ¢éÁâá
            for (let i = 0; i < 20; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 4 + Math.random() * 8;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 5,
                    size: 4 + Math.random() * 8,
                    color: Math.random() > 0.5 ? '#FF9800' : '#BF360C',
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.6,
                    type: 'fur'
                });
            }
            // ÊÑ§ÊÄíÊòüÊòü
            for (let i = 0; i < 5; i++) {
                particles.push({
                    x: cx + (Math.random() - 0.5) * 40,
                    y: cy + (Math.random() - 0.5) * 40,
                    vx: (Math.random() - 0.5) * 4,
                    vy: -Math.random() * 5 - 2,
                    size: 15 + Math.random() * 10,
                    color: '#FFD700',
                    alpha: 1,
                    type: 'star'
                });
            }
        }

        // Flat PeteyÁàÜÁÇ∏ - Á∫∏ÁâáÈ£ûÊï£
        function createPaperExplosion(cx, cy) {
            for (let i = 0; i < 25; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 3 + Math.random() * 6;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 3,
                    size: 8 + Math.random() * 15,
                    color: Math.random() > 0.7 ? '#FF9800' : '#FFF8E1',
                    alpha: 1,
                    rotation: Math.random() * Math.PI,
                    rotSpeed: (Math.random() - 0.5) * 0.8,
                    type: 'paper'
                });
            }
        }

        // PiggyÁàÜÁÇ∏ - Á≤âËâ≤ÁÉüÈõæ + ÁúºÈïú
        function createPiggyExplosion(cx, cy) {
            // Á≤âËâ≤ÁÉüÈõæ
            for (let i = 0; i < 15; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 5;
                particles.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 3,
                    size: 20 + Math.random() * 30,
                    color: '#FFB6C1',
                    alpha: 0.7,
                    type: 'smoke'
                });
            }
            // ÁúºÈïúÈ£ûÂá∫
            debris.push({
                x: cx, y: cy - 10,
                vx: -3 + Math.random() * 6,
                vy: -8 - Math.random() * 5,
                size: 25,
                color: '#5D4037',
                alpha: 1,
                rotation: 0,
                rotSpeed: 0.3,
                type: 'glasses'
            });
            // Á≤âËâ≤Á¢éÁâá
            for (let i = 0; i < 12; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 4 + Math.random() * 6;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 4,
                    size: 5 + Math.random() * 8,
                    color: '#FFB6C1',
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.5
                });
            }
        }

        // RobotÁàÜÁÇ∏ - ÈáëÂ±ûÁ¢éÁâá + ÁîµÁÅ´Ëä± + ÂÜíÁÉü
        function createRobotExplosion(cx, cy) {
            // ÈáëÂ±ûÁ¢éÁâá
            for (let i = 0; i < 18; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 5 + Math.random() * 8;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 6,
                    size: 6 + Math.random() * 12,
                    color: Math.random() > 0.5 ? '#78909C' : '#455A64',
                    alpha: 1,
                    rotation: Math.random() * Math.PI,
                    rotSpeed: (Math.random() - 0.5) * 0.7,
                    type: 'metal'
                });
            }
            // ÁîµÁÅ´Ëä±
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    particles.push({
                        x: cx + (Math.random() - 0.5) * 50,
                        y: cy + (Math.random() - 0.5) * 50,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        size: 3 + Math.random() * 5,
                        color: Math.random() > 0.5 ? '#FFEB3B' : '#FF5722',
                        alpha: 1,
                        type: 'spark'
                    });
                }, i * 50);
            }
            // ÂÜíÁÉüÊïàÊûú
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: cx + (Math.random() - 0.5) * 30,
                    y: cy,
                    vx: (Math.random() - 0.5) * 2,
                    vy: -2 - Math.random() * 3,
                    size: 25 + Math.random() * 20,
                    color: '#37474F',
                    alpha: 0.6,
                    type: 'smoke'
                });
            }
        }

        // ÈªòËÆ§ÁàÜÁÇ∏
        function createDefaultExplosion(cx, cy, color) {
            for (let i = 0; i < 12; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 4 + Math.random() * 6;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 4,
                    size: 5 + Math.random() * 10,
                    color: color,
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.4
                });
            }
        }

        function createDustParticles(x, y, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x + (Math.random() - 0.5) * 20,
                    y: y,
                    vx: (Math.random() - 0.5) * 3,
                    vy: -Math.random() * 2 - 1,
                    size: 3 + Math.random() * 4,
                    color: '#8B7355',
                    alpha: 0.7
                });
            }
        }

        // Â±èÂπïÈúáÂä®ÊïàÊûú
        let screenShake = { x: 0, y: 0, intensity: 0 };

        function triggerScreenShake(intensity, duration) {
            screenShake.intensity = intensity;
            screenShake.duration = duration;
        }

        function updateScreenShake() {
            if (screenShake.intensity > 0) {
                screenShake.x = (Math.random() - 0.5) * screenShake.intensity * 2;
                screenShake.y = (Math.random() - 0.5) * screenShake.intensity * 2;
                screenShake.intensity *= 0.9;
                if (screenShake.intensity < 0.5) {
                    screenShake.intensity = 0;
                    screenShake.x = 0;
                    screenShake.y = 0;
                }
            }
        }

        // ÂùèËøêÊ∞îÂáª‰∏≠ÊïàÊûú - ÈùûÂ∏∏ÊòéÊòæÁöÑÁ∫¢Ëâ≤ÁàÜÁÇ∏
        function createBadHitEffect(x, y) {
            // Âº∫ÁÉàÂ±èÂπïÈúáÂä®
            triggerScreenShake(15, 20);

            // Â§ßÂûãÁ∫¢Ëâ≤ÁàÜÁÇ∏
            for (let i = 0; i < 40; i++) {
                const angle = (i / 40) * Math.PI * 2;
                const speed = 5 + Math.random() * 10;
                particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: 8 + Math.random() * 12,
                    color: Math.random() > 0.5 ? '#FF0000' : '#FF4500',
                    alpha: 1
                });
            }

            // Á∫¢Ëâ≤ÂÜ≤ÂáªÊ≥¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: x, y: y,
                radius: 10,
                maxRadius: 150,
                color: 'rgba(255, 0, 0, 0.6)',
                lineWidth: 8
            });

            // ÊòæÁ§∫Â§ßÂûãË≠¶ÂëäÊñáÂ≠ó
            showBigText('üíÄ ÂùèËøêÊ∞î! ÂºπÂ∞ÑÁâ©Ë¢´ÊëßÊØÅ!', '#FF0000', 120);
        }

        // Â•ΩËøêÊ∞îÂáª‰∏≠ÊïàÊûú - ÊòéÊòæÁöÑÈáëËâ≤/ÁªøËâ≤Â∫ÜÁ•ù
        function createGoodHitEffect(x, y) {
            // Â±èÂπïÈúáÂä®
            triggerScreenShake(10, 15);

            // ÈáëËâ≤ÊòüÊòüÁàÜÁÇ∏
            for (let i = 0; i < 50; i++) {
                const angle = (i / 50) * Math.PI * 2;
                const speed = 4 + Math.random() * 8;
                particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 3,
                    size: 6 + Math.random() * 10,
                    color: ['#FFD700', '#00FF00', '#FFFF00', '#7CFC00'][Math.floor(Math.random() * 4)],
                    alpha: 1
                });
            }

            // ÁªøËâ≤ÂÜ≤ÂáªÊ≥¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: x, y: y,
                radius: 10,
                maxRadius: 120,
                color: 'rgba(0, 255, 0, 0.5)',
                lineWidth: 6
            });

            // ÊòæÁ§∫Â∫ÜÁ•ùÊñáÂ≠ó
            showBigText('‚≠ê Â•ΩËøêÊ∞î! Êïå‰∫∫Ë¢´Ê∂àÁÅ≠!', '#00FF00', 100);
        }

        // ÊòæÁ§∫Â§ßÂûãÊñáÂ≠óÊèêÁ§∫
        function showBigText(text, color, duration) {
            if (!window.bigTexts) window.bigTexts = [];
            window.bigTexts.push({
                text: text,
                color: color,
                alpha: 1,
                scale: 0.5,
                duration: duration,
                maxDuration: duration
            });
        }

        // ÁªòÂà∂ÂÜ≤ÂáªÊ≥¢
        function drawShockwaves() {
            if (!window.shockwaves) return;
            window.shockwaves.forEach(sw => {
                ctx.beginPath();
                ctx.arc(sw.x, sw.y, sw.radius, 0, Math.PI * 2);
                ctx.strokeStyle = sw.color;
                ctx.lineWidth = sw.lineWidth * (1 - sw.radius / sw.maxRadius);
                ctx.stroke();
                sw.radius += 8;
            });
            window.shockwaves = window.shockwaves.filter(sw => sw.radius < sw.maxRadius);
        }

        // ÁªòÂà∂Â§ßÂûãÊñáÂ≠ó
        function drawBigTexts() {
            if (!window.bigTexts) return;
            window.bigTexts.forEach(bt => {
                ctx.save();
                ctx.globalAlpha = bt.alpha;
                ctx.font = `bold ${32 * bt.scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // ÈªëËâ≤ÊèèËæπ
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 4;
                ctx.strokeText(bt.text, canvas.width / 2, canvas.height / 3);

                // Â°´ÂÖÖÈ¢úËâ≤
                ctx.fillStyle = bt.color;
                ctx.fillText(bt.text, canvas.width / 2, canvas.height / 3);
                ctx.restore();

                // Âä®Áîª
                if (bt.scale < 1.2) bt.scale += 0.05;
                bt.duration--;
                if (bt.duration < 30) bt.alpha = bt.duration / 30;
            });
            window.bigTexts = window.bigTexts.filter(bt => bt.duration > 0);
        }

        // ========================================
        // ‰∫ã‰ª∂Â§ÑÁêÜ
        // ========================================
        function setupEventListeners() {
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('click', handleClick);
            canvas.addEventListener('touchstart', e => { e.preventDefault(); handleMouseDown(getTouchEvent(e)); });
            canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMouseMove(getTouchEvent(e)); });
            canvas.addEventListener('touchend', e => { e.preventDefault(); handleMouseUp(e); });
        }

        function getTouchEvent(e) {
            return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function handleMouseDown(e) {
            if (gameState !== 'ready' || !projectile) return;
            const pos = getMousePos(e);
            if (getDistance(pos, projectile) < projectile.radius + 25) {
                isDragging = true;
                gameState = 'aiming';
                initAudio();
                playStretchSound();
            }
        }

        function handleMouseMove(e) {
            if (!isDragging || gameState !== 'aiming') return;
            const pos = getMousePos(e);

            const dx = pos.x - SLINGSHOT_X;
            const dy = pos.y - SLINGSHOT_Y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist > MAX_PULL_DISTANCE) {
                projectile.x = SLINGSHOT_X + (dx / dist) * MAX_PULL_DISTANCE;
                projectile.y = SLINGSHOT_Y + (dy / dist) * MAX_PULL_DISTANCE;
            } else {
                projectile.x = pos.x;
                projectile.y = pos.y;
            }

            if (projectile.x > SLINGSHOT_X) projectile.x = SLINGSHOT_X;
        }

        function handleMouseUp(e) {
            if (!isDragging || gameState !== 'aiming') return;
            isDragging = false;
            launchProjectile();
        }

        function handleClick(e) {
            if (gameState === 'flying' && projectile && projectile.active && !projectile.specialUsed) {
                if (projectile.special === 'split') {
                    projectile.specialUsed = true;
                    playSplitSound();
                    playMeowSound();
                    for (let i = -1; i <= 1; i++) {
                        if (i === 0) continue;
                        projectiles.push({
                            ...projectile,
                            x: projectile.x,
                            y: projectile.y,
                            vx: projectile.vx + i * 4,
                            vy: projectile.vy + i * 2.5,
                            radius: 14,
                            active: true,
                            specialUsed: true
                        });
                    }
                } else if (projectile.special === 'boost') {
                    projectile.specialUsed = true;
                    playBoostSound();
                    const speed = Math.sqrt(projectile.vx ** 2 + projectile.vy ** 2);
                    const angle = Math.atan2(projectile.vy, projectile.vx);
                    projectile.vx = Math.cos(angle) * (speed + 18);
                    projectile.vy = Math.sin(angle) * (speed + 18);

                    // Âä†ÈÄüÁâπÊïà
                    for (let i = 0; i < 10; i++) {
                        particles.push({
                            x: projectile.x,
                            y: projectile.y,
                            vx: -projectile.vx * 0.1 + (Math.random() - 0.5) * 3,
                            vy: -projectile.vy * 0.1 + (Math.random() - 0.5) * 3,
                            size: 4 + Math.random() * 4,
                            color: '#00FFFF',
                            alpha: 1
                        });
                    }
                }
            }
        }

        function launchProjectile() {
            const power = Math.min(getDistance(projectile, { x: SLINGSHOT_X, y: SLINGSHOT_Y }), MAX_PULL_DISTANCE);
            const angle = Math.atan2(SLINGSHOT_Y - projectile.y, SLINGSHOT_X - projectile.x);

            projectile.vx = Math.cos(angle) * power * LAUNCH_POWER_MULTIPLIER;
            projectile.vy = Math.sin(angle) * power * LAUNCH_POWER_MULTIPLIER;
            projectile.x = SLINGSHOT_X;
            projectile.y = SLINGSHOT_Y;
            projectile.active = true;

            playLaunchSound(projectile.type);
            buddies[currentBuddyIndex].used = true;
            gameState = 'flying';
            renderBuddiesPanel();
        }

        // ========================================
        // Ê∏∏ÊàèÈÄªËæë
        // ========================================
        function checkGameEnd() {
            const alive = villains.filter(v => v.alive).length;
            document.getElementById('villainsLeft').textContent = alive;

            if (alive === 0) {
                gameState = 'won';
                const used = buddies.filter(b => b.used).length;
                const unused = buddies.length - used;
                const lvl = levels[currentLevel - 1];
                let stars = 1;
                if (used <= lvl.stars[2]) stars = 3;
                else if (used <= lvl.stars[1]) stars = 2;

                // ËÆ°ÁÆóÊú™‰ΩøÁî®ÈÅìÂÖ∑ÁöÑÂ•ñÂä±ÂàÜÊï∞
                let bonusScore = 0;
                buddies.forEach((buddy, index) => {
                    if (!buddy.used) {
                        // ‰∏çÂêåÈÅìÂÖ∑‰∏çÂêåÂ•ñÂä±
                        const bonusValues = {
                            'dogman': 5000,
                            'lilpetey': 6000,
                            '80hd': 7000,
                            'flippy': 8000
                        };
                        bonusScore += bonusValues[buddy.type] || 5000;
                    }
                });

                score += bonusScore;
                lastBonusScore = bonusScore;
                lastUnusedCount = unused;

                levelProgress[currentLevel] = {
                    completed: true,
                    stars: Math.max(stars, levelProgress[currentLevel]?.stars || 0),
                    score: Math.max(score, levelProgress[currentLevel]?.score || 0)
                };
                localStorage.setItem('dogmanLevelProgress', JSON.stringify(levelProgress));
                setTimeout(() => showResult(true, stars, bonusScore, unused), 1200);
            } else if (currentBuddyIndex >= buddies.length - 1 && gameState === 'waiting') {
                if (!projectile?.active && projectiles.length === 0) {
                    setTimeout(() => {
                        if (villains.filter(v => v.alive).length > 0) {
                            gameState = 'lost';
                            showResult(false, 0, 0, 0);
                        }
                    }, 1200);
                }
            }
        }

        function showResult(won, stars, bonusScore = 0, unusedCount = 0) {
            document.getElementById('resultTitle').textContent = won ?
                (currentLevel === MAX_LEVELS ? 'ÊÅ≠ÂñúÈÄöÂÖ≥!' : 'ÂÖ≥Âç°ÂÆåÊàê!') : 'Â§±Ë¥•';

            let starText = '';
            for (let i = 0; i < 3; i++) starText += i < stars ? '‚≠ê' : '‚òÜ';
            document.getElementById('resultStars').textContent = starText;

            // ÊòæÁ§∫ËØ¶ÁªÜÂàÜÊï∞
            let scoreHTML = `Âü∫Á°ÄÂàÜÊï∞: ${score - bonusScore}`;
            if (bonusScore > 0) {
                scoreHTML += `<br><span style="color: #4CAF50;">üéÅ ÈÅìÂÖ∑ÂõûÊî∂Â•ñÂä± x${unusedCount}: +${bonusScore}</span>`;
            }
            scoreHTML += `<br><strong style="font-size: 1.3em;">ÊÄªÂàÜ: ${score}</strong>`;
            document.getElementById('resultScore').innerHTML = scoreHTML;

            document.getElementById('resultNextBtn').style.display = (won && currentLevel < MAX_LEVELS) ? 'inline-block' : 'none';
            document.getElementById('resultModal').style.display = 'flex';

            if (won) playVictorySound(); else playFailSound();
            updateStarsDisplay(stars);
            document.getElementById('nextLevelBtn').disabled = !won || currentLevel >= MAX_LEVELS;
        }

        function closeResultModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        function restartLevel() {
            playClickSound();
            closeResultModal();
            loadLevel(currentLevel);
        }

        function nextLevel() {
            if (currentLevel < MAX_LEVELS) {
                playClickSound();
                currentLevel++;
                closeResultModal();
                loadLevel(currentLevel);
                generateLevelButtons();
            }
        }

        function updateUI() {
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('currentScore').textContent = score;
            document.getElementById('villainsLeft').textContent = villains.filter(v => v.alive).length;
        }

        function updateStarsDisplay(stars) {
            for (let i = 1; i <= 3; i++) {
                document.getElementById('star' + i).className = 'star' + (i <= stars ? ' earned' : '');
            }
        }

        function renderBuddiesPanel() {
            const panel = document.getElementById('buddiesPanel');
            panel.innerHTML = '';
            buddies.forEach((b, i) => {
                const slot = document.createElement('div');
                slot.className = 'buddy-slot' + (i === currentBuddyIndex && !b.used ? ' active' : '') + (b.used ? ' used' : '');

                // ÂàõÂª∫Â∞ècanvasÊòæÁ§∫ËßíËâ≤ÂõæÊ†á
                const miniCanvas = document.createElement('canvas');
                miniCanvas.width = 50;
                miniCanvas.height = 50;
                miniCanvas.style.width = '50px';
                miniCanvas.style.height = '50px';
                const miniCtx = miniCanvas.getContext('2d');

                // ÁªòÂà∂Â∞èÁâàÊú¨ÁöÑËßíËâ≤
                miniCtx.save();
                miniCtx.translate(25, 28);
                miniCtx.scale(0.65, 0.65);
                drawBuddyOnContext(miniCtx, b.type, 22);
                miniCtx.restore();

                slot.appendChild(miniCanvas);
                slot.title = b.name;
                panel.appendChild(slot);
            });
        }

        function showLevelSelect() {
            playClickSound();
            generateLevelButtons();
            document.getElementById('levelSelectModal').style.display = 'flex';
        }

        function closeLevelSelect() {
            playClickSound();
            document.getElementById('levelSelectModal').style.display = 'none';
        }

        function generateLevelButtons() {
            const grid = document.getElementById('levelsGrid');
            grid.innerHTML = '';
            for (let i = 1; i <= MAX_LEVELS; i++) {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                const progress = levelProgress[i];
                const unlocked = i === 1 || levelProgress[i - 1]?.completed;
                if (progress?.completed) btn.classList.add('completed');
                btn.disabled = !unlocked;
                btn.innerHTML = `${i}<div class="level-stars">${progress?.stars ? '‚≠ê'.repeat(progress.stars) : ''}</div>`;
                btn.onclick = () => { if (unlocked) { playClickSound(); closeLevelSelect(); loadLevel(i); } };
                grid.appendChild(btn);
            }
        }

        function getDistance(a, b) {
            return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
        }

        function lightenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return `rgb(${R},${G},${B})`;
        }

        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, (num >> 16) - amt);
            const G = Math.max(0, ((num >> 8) & 0x00FF) - amt);
            const B = Math.max(0, (num & 0x0000FF) - amt);
            return `rgb(${R},${G},${B})`;
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        init();
    </script>
</body>
</html>
