<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Dog Man: Supa Buddies Slingshot | è¶…çº§ä¼™ä¼´å¼¹å¼“å¤§æˆ˜</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Neue', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .game-nav {
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }

        .nav-brand img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #FFD700;
        }

        .nav-brand span {
            font-family: 'Bangers', cursive;
            font-size: 1.5rem;
            color: #FFD700;
            text-shadow: 2px 2px 0 #c0392b;
        }

        .back-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .back-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }

        .game-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 75px 15px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-title {
            font-family: 'Bangers', cursive;
            font-size: 2.2rem;
            color: #FFD700;
            text-shadow: 3px 3px 0 #e74c3c, 5px 5px 0 rgba(0,0,0,0.4);
            margin-bottom: 5px;
            text-align: center;
        }

        .game-subtitle {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 15px;
            text-align: center;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 900px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(30,30,60,0.7));
            border-radius: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .level-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .info-box {
            text-align: center;
            padding: 5px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .info-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }

        .info-value {
            font-family: 'Bangers', cursive;
            font-size: 1.5rem;
            color: #FFD700;
        }

        .stars-display {
            display: flex;
            gap: 3px;
        }

        .star {
            font-size: 1.5rem;
            color: #333;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .star.earned {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .sound-controls {
            display: flex;
            gap: 8px;
        }

        .sound-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255,215,0,0.5);
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.1));
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sound-btn:hover {
            background: linear-gradient(135deg, rgba(255,215,0,0.4), rgba(255,215,0,0.2));
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255,215,0,0.3);
        }

        .game-wrapper {
            background: linear-gradient(135deg, #1a1a2e, #0a0a1a);
            border-radius: 15px;
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6), inset 0 0 30px rgba(255,215,0,0.1);
            border: 2px solid rgba(255,215,0,0.2);
        }

        #gameCanvas {
            display: block;
            border-radius: 10px;
            cursor: crosshair;
        }

        .buddies-panel {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(30,30,60,0.6));
            border-radius: 15px;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .buddy-slot {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .buddy-slot.active {
            border-color: #FFD700;
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,215,0,0.1));
            box-shadow: 0 0 20px rgba(255,215,0,0.4);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .buddy-slot.used {
            opacity: 0.3;
            filter: grayscale(1);
        }

        .buddy-slot.selected:not(.used) {
            border-color: #2ecc71;
            background: linear-gradient(135deg, rgba(46,204,113,0.4), rgba(46,204,113,0.2));
            box-shadow: 0 0 15px rgba(46,204,113,0.5);
        }

        .buddy-slot:not(.used):hover {
            transform: scale(1.1);
            cursor: pointer;
        }

        .game-controls {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            padding: 12px 25px;
            font-size: 0.95rem;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Comic Neue', sans-serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn-restart {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-next {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-levels {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #0f0f2a);
            padding: 35px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid #FFD700;
            max-width: 450px;
            box-shadow: 0 0 50px rgba(255,215,0,0.3);
        }

        .modal-title {
            font-family: 'Bangers', cursive;
            font-size: 2.2rem;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #c0392b;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 25px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .level-btn {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 2px solid #444;
            background: linear-gradient(135deg, #2a2a4a, #1a1a3a);
            color: white;
            font-family: 'Bangers', cursive;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .level-btn:hover:not(:disabled) {
            transform: scale(1.1);
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255,215,0,0.4);
        }

        .level-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .level-btn.completed {
            border-color: #2ecc71;
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }

        .level-btn .level-stars {
            font-size: 0.6rem;
            margin-top: 2px;
        }

        .close-modal-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal-btn:hover {
            transform: scale(1.05);
        }

        .result-stars {
            font-size: 3rem;
            margin: 15px 0;
        }

        .result-score {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #ccc;
        }

        .result-score span {
            font-family: 'Bangers', cursive;
            font-size: 1.8rem;
            color: #2ecc71;
        }

        .result-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .result-btn {
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .result-btn:hover {
            transform: scale(1.05);
        }

        /* è¯´æ˜åŒº */
        .instructions {
            margin-top: 25px;
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border-radius: 15px;
            padding: 20px 25px;
            max-width: 700px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .instructions h3 {
            font-family: 'Bangers', cursive;
            font-size: 1.4rem;
            color: #FFD700;
            margin-bottom: 15px;
            text-align: center;
        }

        .instructions p {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .buddy-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .buddy-card {
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .buddy-card .emoji {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .buddy-card .name {
            font-weight: bold;
            color: #FFD700;
            font-size: 0.9rem;
        }

        .buddy-card .skill {
            font-size: 0.75rem;
            color: #aaa;
        }

        @media (max-width: 950px) {
            #gameCanvas {
                width: 100%;
                height: auto;
            }
            .game-header {
                flex-direction: column;
                gap: 12px;
            }
            .levels-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* æ‰‹æœºå…¨å±æ¨¡å¼ */
        @media (max-width: 768px) {
            .game-nav {
                padding: 8px 15px;
            }
            .nav-brand span {
                font-size: 1.2rem;
            }
            .back-btn {
                padding: 8px 15px;
                font-size: 0.85rem;
            }
            .game-container {
                padding: 60px 5px 10px;
            }
            .game-title {
                font-size: 1.5rem;
                margin-bottom: 3px;
            }
            .game-subtitle {
                font-size: 0.8rem;
                margin-bottom: 8px;
            }
            .game-header {
                padding: 8px 12px;
                margin-bottom: 5px;
            }
            .info-box {
                padding: 3px 10px;
            }
            .info-label {
                font-size: 0.65rem;
            }
            .info-value {
                font-size: 1.2rem;
            }
            .game-wrapper {
                padding: 4px;
                width: 100%;
            }
            #gameCanvas {
                width: 100% !important;
                max-width: 100vw;
                touch-action: none;
            }
            .buddies-panel {
                padding: 8px 12px;
                gap: 5px;
                margin-top: 8px;
            }
            .buddy-slot {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
            }
            .game-controls {
                gap: 8px;
                margin-top: 10px;
            }
            .control-btn {
                padding: 10px 18px;
                font-size: 0.85rem;
            }
            .instructions {
                display: none;
            }
        }

        /* æ¨ªå±å…¨å±æ¨¡å¼ - æ¸¸æˆç”»å¸ƒæœ€å¤§åŒ– */
        @media (max-width: 950px) and (orientation: landscape) {
            body {
                overflow: hidden;
            }
            .game-nav {
                display: none !important;
            }
            .game-container {
                padding: 0;
                margin: 0;
                max-width: 100%;
                height: 100vh;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .game-title, .game-subtitle {
                display: none !important;
            }
            .game-header {
                position: fixed;
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
                padding: 5px 15px;
                margin: 0;
                background: rgba(0,0,0,0.8);
                border-radius: 10px;
                z-index: 100;
            }
            .game-header .level-info {
                gap: 10px;
            }
            .game-header .info-box {
                padding: 2px 8px;
            }
            .game-header .info-label {
                font-size: 0.6rem;
            }
            .game-header .info-value {
                font-size: 1rem;
            }
            .game-header .stars-display {
                display: none;
            }
            .game-header .sound-controls {
                display: none;
            }
            .game-wrapper {
                padding: 0;
                border: none;
                box-shadow: none;
                background: transparent;
                border-radius: 0;
            }
            #gameCanvas {
                width: 100vw !important;
                height: 100vh !important;
                height: 100dvh !important;
                max-width: 100vw;
                max-height: 100vh;
                max-height: 100dvh;
                object-fit: contain;
                border-radius: 0;
            }
            .buddies-panel {
                position: fixed;
                left: 5px;
                top: 50%;
                transform: translateY(-50%);
                flex-direction: column;
                margin: 0;
                padding: 5px;
                background: rgba(0,0,0,0.7);
                border-radius: 10px;
                z-index: 100;
            }
            .buddy-slot {
                width: 35px;
                height: 35px;
                font-size: 1.2rem;
            }
            .game-controls {
                position: fixed;
                bottom: 8px;
                right: 10px;
                left: auto;
                transform: none;
                margin: 0;
                flex-direction: column;
                gap: 5px;
            }
            .control-btn {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
            .instructions {
                display: none !important;
            }
            .fullscreen-btn {
                top: 5px;
                right: 5px;
                bottom: auto;
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }

        /* å…¨å±æŒ‰é’® */
        .fullscreen-btn {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        @media (max-width: 950px) {
            .fullscreen-btn {
                display: flex;
            }
        }

        /* iOS ä¼ªå…¨å±æ¨¡å¼ */
        body.ios-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }

        body.ios-fullscreen .game-nav {
            display: none;
        }

        body.ios-fullscreen .game-container {
            padding-top: 10px;
            height: 100vh;
            height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œé€‚é… iOS Safari */
        }

        body.ios-fullscreen .game-title,
        body.ios-fullscreen .game-subtitle {
            display: none;
        }

        body.ios-fullscreen .game-header {
            padding: 5px 10px;
            margin-bottom: 5px;
        }

        body.ios-fullscreen .instructions {
            display: none;
        }

        body.ios-fullscreen .fullscreen-btn {
            bottom: 60px;
            right: 10px;
        }

        /* iOS å¯åŠ¨ç”»é¢æ ·å¼ */
        .ios-start-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .ios-start-screen h1 {
            font-family: 'Bangers', cursive;
            font-size: 2.5rem;
            color: #FFD700;
            text-shadow: 3px 3px 0 #e74c3c;
            margin-bottom: 20px;
        }

        .ios-start-screen .start-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            animation: start-pulse 1.5s infinite;
            margin-top: 30px;
        }

        @keyframes start-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); }
        }

        .ios-start-screen .sound-notice {
            margin-top: 20px;
            font-size: 0.9rem;
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- iOS/ç§»åŠ¨ç«¯å¯åŠ¨ç”»é¢ - ç”¨äºè§£é”éŸ³é¢‘ -->
    <div class="ios-start-screen" id="startScreen">
        <h1>ğŸ• DOG MAN ğŸ•</h1>
        <div style="font-size: 3rem; margin: 20px 0;">ğŸ®</div>
        <p style="font-size: 1.1rem; color: #ccc;">SUPA BUDDIES SLINGSHOT</p>
        <p style="font-size: 0.9rem; color: #888; margin-top: 10px;">è¶…çº§ä¼™ä¼´å¼¹å¼“å¤§æˆ˜</p>
        <button class="start-btn" id="startGameBtn">
            ç‚¹å‡»å¼€å§‹æ¸¸æˆ
        </button>
        <p class="sound-notice">ğŸ”Š ç‚¹å‡»å¼€å§‹ä»¥å¯ç”¨æ¸¸æˆéŸ³æ•ˆ</p>
        <p id="audioDebug" style="font-size:0.7rem;color:#666;margin-top:10px;"></p>
    </div>

    <nav class="game-nav">
        <a href="index.html" class="nav-brand">
            <img src="https://pilkey.com/userFiles/uploads/dog-man/dog-man/Dog_Man_1.jpeg" alt="Dog Man">
            <span>DOG MAN</span>
        </a>
        <button class="back-btn" onclick="window.location.href='index.html'">è¿”å›ä¸»é¡µ</button>
    </nav>

    <div class="game-container">
        <h1 class="game-title">SUPA BUDDIES SLINGSHOT</h1>
        <p class="game-subtitle">ç”¨å¼¹å¼“å‘å°„è¶…çº§ä¼™ä¼´ï¼Œæ‰“å€’æ‰€æœ‰åæ´¾ï¼</p>

        <div class="game-header">
            <div class="level-info">
                <div class="info-box">
                    <div class="info-label">å…³å¡</div>
                    <div class="info-value" id="currentLevel">1</div>
                </div>
                <div class="info-box">
                    <div class="info-label">åˆ†æ•°</div>
                    <div class="info-value" id="currentScore">0</div>
                </div>
                <div class="info-box">
                    <div class="info-label">åæ´¾</div>
                    <div class="info-value" id="villainsLeft">3</div>
                </div>
            </div>
            <div class="stars-display">
                <span class="star" id="star1">â˜…</span>
                <span class="star" id="star2">â˜…</span>
                <span class="star" id="star3">â˜…</span>
            </div>
            <div class="sound-controls">
                <button class="sound-btn" id="soundBtn" onclick="toggleSound()" title="éŸ³æ•ˆ">ğŸ”Š</button>
            </div>
        </div>

        <div class="game-wrapper">
            <canvas id="gameCanvas" width="1100" height="600"></canvas>
        </div>

        <div class="buddies-panel" id="buddiesPanel"></div>

        <div class="game-controls">
            <button class="control-btn btn-restart" onclick="restartLevel()">é‡ç©æœ¬å…³</button>
            <button class="control-btn btn-next" id="nextLevelBtn" onclick="nextLevel()" disabled>ä¸‹ä¸€å…³</button>
            <button class="control-btn btn-levels" onclick="showLevelSelect()">é€‰æ‹©å…³å¡</button>
        </div>

        <!-- å…¨å±æŒ‰é’® -->
        <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()">â›¶</button>

        <div class="instructions">
            <h3>æ¸¸æˆè¯´æ˜</h3>
            <p>ğŸ¯ <strong>ç›®æ ‡ï¼š</strong>ç”¨å¼¹å¼“å‘å°„è¶…çº§ä¼™ä¼´ï¼Œæ‰“å€’æ‰€æœ‰åæ´¾ï¼</p>
            <p>ğŸ–±ï¸ <strong>æ“ä½œï¼š</strong>æ‹–åŠ¨è§’è‰²å‘å·¦åæ–¹æ‹‰åŠ¨ï¼Œæ¾å¼€å‘å°„ã€‚æ‹‰å¾—è¶Šè¿œåŠ›é‡è¶Šå¤§ï¼</p>
            <p>â­ <strong>è¯„åˆ†ï¼š</strong>ç”¨è¶Šå°‘çš„è§’è‰²å®Œæˆå…³å¡ï¼Œè·å¾—è¶Šå¤šæ˜Ÿæ˜Ÿï¼</p>
            <p>ğŸ’¡ <strong>æç¤ºï¼š</strong>é£è¡Œä¸­ç‚¹å‡»å±å¹•å¯ä½¿ç”¨ç‰¹æ®ŠæŠ€èƒ½ï¼</p>

            <div class="buddy-info">
                <div class="buddy-card">
                    <canvas id="dogmanIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Dog Man</div>
                    <div class="skill">ç‹—å¤´è­¦å¯Ÿ | æ ‡å‡†æ”»å‡»</div>
                </div>
                <div class="buddy-card">
                    <canvas id="lilpeteyIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Li'l Petey</div>
                    <div class="skill">å°æ©˜çŒ« | åˆ†è£‚Ã—3</div>
                </div>
                <div class="buddy-card">
                    <canvas id="80hdIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">80-HD</div>
                    <div class="skill">æœºå™¨äºº | è¶…çº§é‡å‡»</div>
                </div>
                <div class="buddy-card">
                    <canvas id="flippyIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Flippy</div>
                    <div class="skill">å¿µåŠ›é±¼ | åŠ é€Ÿå†²åˆº</div>
                </div>
                <div class="buddy-card">
                    <canvas id="chiefIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Chief</div>
                    <div class="skill">è­¦é•¿ | å†²å‡»æ³¢</div>
                </div>
                <div class="buddy-card">
                    <canvas id="sarahIcon" width="50" height="50" style="width:50px;height:50px;"></canvas>
                    <div class="name">Sarah</div>
                    <div class="skill">è®°è€… | å›æ—‹é•–</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³å¡é€‰æ‹© -->
    <div class="modal" id="levelSelectModal">
        <div class="modal-content">
            <h2 class="modal-title">é€‰æ‹©å…³å¡</h2>
            <div class="levels-grid" id="levelsGrid"></div>
            <button class="close-modal-btn" onclick="closeLevelSelect()">å…³é—­</button>
        </div>
    </div>

    <!-- ç»“æœå¼¹çª— -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <h2 class="modal-title" id="resultTitle">å…³å¡å®Œæˆ!</h2>
            <div class="result-stars" id="resultStars">â˜…â˜…â˜…</div>
            <div class="result-score">å¾—åˆ†: <span id="resultScore">0</span></div>
            <div class="result-buttons">
                <button class="result-btn btn-restart" onclick="restartLevel(); closeResultModal();">é‡ç©</button>
                <button class="result-btn btn-next" id="resultNextBtn" onclick="nextLevel(); closeResultModal();">ä¸‹ä¸€å…³</button>
                <button class="result-btn btn-levels" onclick="closeResultModal(); showLevelSelect();">å…³å¡</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // å…¼å®¹æ€§ - roundRect polyfill
        // ========================================
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            };
        }

        // ========================================
        // æ¸¸æˆé…ç½®
        // ========================================
        const canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');

        // ç‰©ç†å¸¸é‡ - æ›´é•¿çš„é£è¡Œæ—¶é—´
        const GRAVITY = 0.25;  // é™ä½é‡åŠ›ï¼Œé£å¾—æ›´è¿œ
        const AIR_RESISTANCE = 0.998;  // å‡å°‘ç©ºæ°”é˜»åŠ›
        const GROUND_FRICTION = 0.85;
        const BOUNCE_DAMPING = 0.65;
        const GROUND_Y = 520;  // æ›´å¤§ç”»é¢ï¼Œåœ°é¢ä½ç½®è°ƒæ•´
        const SLINGSHOT_X = 180;  // å¼¹å¼“å³ç§»ï¼Œæ›´å¤šæ‹–åŠ¨ç©ºé—´
        const SLINGSHOT_Y = 430;  // å¼¹å¼“ä½ç½®è°ƒæ•´
        const MAX_PULL_DISTANCE = 140;  // å¯ä»¥æ‹‰å¾—æ›´è¿œ
        const LAUNCH_POWER_MULTIPLIER = 0.20;  // å¢åŠ å‘å°„åŠ›åº¦
        const MAX_LEVELS = 30;

        // ========================================
        // æ¸¸æˆçŠ¶æ€
        // ========================================
        let currentLevel = 1;
        let score = 0;
        let gameState = 'ready';
        let levelProgress = JSON.parse(localStorage.getItem('dogmanLevelProgress')) || {};
        let projectile = null;
        let projectiles = [];
        let buddies = [];
        let currentBuddyIndex = 0;
        let villains = [];
        let blocks = [];
        let debris = [];
        let particles = [];
        let fallingObjects = []; // çº¢/ç»¿ç®±å­æ‰è½çš„ç‰©ä½“
        let isDragging = false;
        let frameCount = 0;
        let lastBonusScore = 0; // ä¸Šæ¬¡å¥–åŠ±åˆ†æ•°
        let lastUnusedCount = 0; // ä¸Šæ¬¡æœªä½¿ç”¨é“å…·æ•°é‡

        // ========================================
        // é«˜çº§éŸ³æ•ˆç³»ç»Ÿ (iOS å…¼å®¹ - åŒå¼•æ“)
        // ========================================
        let audioCtx = null;
        let soundEnabled = true;
        let masterGain = null;
        let audioInitialized = false;
        let useHTMLAudio = false; // iOS å¤‡é€‰æ–¹æ¡ˆ

        // iOS æ£€æµ‹
        const isIOSDevice = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        // HTML5 Audio æ± ï¼ˆiOS å¤‡é€‰ï¼‰
        const audioPool = [];
        const AUDIO_POOL_SIZE = 10;

        function initAudioPool() {
            for (let i = 0; i < AUDIO_POOL_SIZE; i++) {
                const audio = new Audio();
                audio.volume = 0.5;
                audioPool.push(audio);
            }
            console.log('HTML5 Audio pool created');
        }

        // è·å–å¯ç”¨çš„ Audio å…ƒç´ 
        function getAvailableAudio() {
            for (let audio of audioPool) {
                if (audio.paused || audio.ended) {
                    return audio;
                }
            }
            // å¦‚æœéƒ½åœ¨ç”¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
            return audioPool[0];
        }

        // ç”Ÿæˆç®€å•çš„éŸ³æ•ˆæ•°æ® URL
        function generateToneDataURL(frequency, duration, type = 'sine') {
            const sampleRate = 22050;
            const samples = Math.floor(sampleRate * duration);
            const buffer = new Float32Array(samples);

            for (let i = 0; i < samples; i++) {
                const t = i / sampleRate;
                let value = 0;
                switch (type) {
                    case 'sine':
                        value = Math.sin(2 * Math.PI * frequency * t);
                        break;
                    case 'square':
                        value = Math.sin(2 * Math.PI * frequency * t) > 0 ? 1 : -1;
                        break;
                    case 'sawtooth':
                        value = 2 * (t * frequency - Math.floor(t * frequency + 0.5));
                        break;
                }
                // æ·¡å‡º
                const fadeOut = 1 - (i / samples);
                buffer[i] = value * fadeOut * 0.3;
            }

            return buffer;
        }

        function initAudio() {
            // å…ˆå°è¯•åˆå§‹åŒ– HTML5 Audio æ± 
            if (audioPool.length === 0) {
                initAudioPool();
            }

            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    masterGain = audioCtx.createGain();
                    masterGain.connect(audioCtx.destination);
                    masterGain.gain.value = 0.5;
                    console.log('AudioContext created, state:', audioCtx.state);
                } catch (e) {
                    console.error('Failed to create AudioContext:', e);
                    useHTMLAudio = true;
                    return;
                }
            }

            // iOS éœ€è¦åœ¨ç”¨æˆ·äº¤äº’åæ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log('AudioContext resumed successfully, state:', audioCtx.state);
                    audioInitialized = true;
                }).catch(e => {
                    console.error('Failed to resume AudioContext:', e);
                    useHTMLAudio = true;
                });
            } else {
                audioInitialized = true;
                console.log('AudioContext already running');
            }
        }

        // iOS éŸ³é¢‘è§£é” - æ’­æ”¾ä¸€ä¸ªé™éŸ³éŸ³é¢‘æ¥è§£é”
        function unlockIOSAudio() {
            // å…ˆè§£é” HTML5 Audio
            if (audioPool.length > 0) {
                const audio = audioPool[0];
                audio.play().then(() => {
                    audio.pause();
                    console.log('HTML5 Audio unlocked');
                }).catch(e => {
                    console.log('HTML5 Audio unlock failed:', e);
                });
            }

            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    masterGain = audioCtx.createGain();
                    masterGain.connect(audioCtx.destination);
                    masterGain.gain.value = 0.5;
                    console.log('AudioContext created in unlock');
                }

                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        console.log('AudioContext resumed');
                        audioInitialized = true;
                        // æ’­æ”¾ä¸€ä¸ªæµ‹è¯•éŸ³æ¥ç¡®è®¤éŸ³é¢‘å·¥ä½œ
                        playTestSound();
                    });
                } else {
                    audioInitialized = true;
                }

                // åˆ›å»ºå¹¶æ’­æ”¾ä¸€ä¸ªçŸ­æš‚çš„é™éŸ³ç¼“å†²æ¥è§£é”
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
            } catch (e) {
                console.error('Failed to unlock iOS audio:', e);
            }
        }

        // æ’­æ”¾æµ‹è¯•éŸ³æ•ˆç¡®è®¤éŸ³é¢‘å·¥ä½œ
        function playTestSound() {
            if (!soundEnabled) return;

            // ç¡®ä¿ AudioContext å­˜åœ¨ä¸”è¿è¡Œ
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    masterGain = audioCtx.createGain();
                    masterGain.connect(audioCtx.destination);
                    masterGain.gain.value = 0.5;
                } catch (e) {
                    console.error('Cannot create AudioContext:', e);
                    return;
                }
            }

            // æ¢å¤æš‚åœçš„ä¸Šä¸‹æ–‡
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    playBeep();
                }).catch(e => console.error('Resume failed:', e));
            } else {
                playBeep();
            }
        }

        // ç®€å•çš„å“”å£°
        function playBeep() {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 880;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.15);
                console.log('Beep played, context state:', audioCtx.state);
                audioInitialized = true;
            } catch (e) {
                console.error('Beep failed:', e);
            }
        }

        // ç®€åŒ–ç‰ˆéŸ³æ•ˆ - ç›´æ¥ç”¨ oscillatorï¼ˆæ›´å…¼å®¹ iOSï¼‰
        function playSimpleSound(freq, duration, type) {
            if (!soundEnabled || !audioCtx) return;
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type || 'sine';
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) {
                console.error('Simple sound failed:', e);
            }
        }

        // åœ¨æ‰€æœ‰ç”¨æˆ·äº¤äº’æ—¶å°è¯•è§£é”éŸ³é¢‘
        function setupIOSAudioUnlock() {
            const unlockEvents = ['touchstart', 'touchend', 'mousedown', 'click'];

            function unlockHandler() {
                unlockIOSAudio();
                // è§£é”åç§»é™¤äº‹ä»¶ç›‘å¬
                if (audioInitialized) {
                    unlockEvents.forEach(event => {
                        document.removeEventListener(event, unlockHandler);
                    });
                }
            }

            unlockEvents.forEach(event => {
                document.addEventListener(event, unlockHandler, { passive: true });
            });
        }

        // åˆ›å»ºå¤æ‚éŸ³æ•ˆ
        function createSound(options) {
            if (!soundEnabled) return;

            // iOS: æ¯æ¬¡æ’­æ”¾å‰éƒ½å°è¯•åˆå§‹åŒ–å’Œæ¢å¤éŸ³é¢‘
            if (!audioCtx) {
                initAudio();
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨ HTML5 Audio å¤‡é€‰æ–¹æ¡ˆ
            if (!audioCtx || (audioCtx.state === 'suspended' && isIOSDevice)) {
                // å°è¯•æ¢å¤
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume().catch(e => console.log('Resume failed'));
                }
                // iOS ä¸Šå¦‚æœ Web Audio ä¸å·¥ä½œï¼Œè®°å½•ä½†ä¸é˜»å¡
                console.log('Audio state:', audioCtx ? audioCtx.state : 'no context');
            }

            if (!audioCtx) return;

            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡æ˜¯è¿è¡ŒçŠ¶æ€
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            const { frequencies, durations, types, volumes, delays } = options;

            frequencies.forEach((freq, i) => {
                setTimeout(() => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    const filter = audioCtx.createBiquadFilter();

                    osc.connect(filter);
                    filter.connect(gain);
                    gain.connect(masterGain);

                    osc.type = types[i] || 'sine';
                    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

                    if (options.freqSlide) {
                        osc.frequency.exponentialRampToValueAtTime(
                            options.freqSlide[i] || freq * 0.5,
                            audioCtx.currentTime + durations[i]
                        );
                    }

                    filter.type = 'lowpass';
                    filter.frequency.value = options.filterFreq || 3000;

                    gain.gain.setValueAtTime(volumes[i] || 0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + durations[i]);

                    osc.start(audioCtx.currentTime);
                    osc.stop(audioCtx.currentTime + durations[i]);
                }, delays[i] || 0);
            });
        }

        // ç‹—å«å£°
        function playBarkSound() {
            // ç®€åŒ–ç‰ˆ - æ›´å…¼å®¹ iOS
            playSimpleSound(400, 0.12, 'sawtooth');
            setTimeout(() => playSimpleSound(550, 0.15, 'sawtooth'), 100);
            setTimeout(() => playSimpleSound(380, 0.18, 'sawtooth'), 220);
        }

        // çŒ«å«å£°
        function playMeowSound() {
            // ç®€åŒ–ç‰ˆ - æ›´å…¼å®¹ iOS
            playSimpleSound(800, 0.15, 'sine');
            setTimeout(() => playSimpleSound(600, 0.2, 'sine'), 80);
            setTimeout(() => playSimpleSound(400, 0.25, 'sine'), 180);
        }

        // æœºå™¨äººå£°
        function playRobotSound() {
            // ç®€åŒ–ç‰ˆ - æ›´å…¼å®¹ iOS
            playSimpleSound(200, 0.08, 'square');
            setTimeout(() => playSimpleSound(300, 0.08, 'square'), 70);
            setTimeout(() => playSimpleSound(150, 0.1, 'square'), 140);
            setTimeout(() => playSimpleSound(250, 0.1, 'sawtooth'), 200);
        }

        // å¼¹å¼“å‘å°„
        function playLaunchSound(type) {
            if (!soundEnabled) return;

            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å­˜åœ¨å¹¶è¿è¡Œ
            if (!audioCtx) {
                initAudio();
            }
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            // ä½¿ç”¨ç®€åŒ–ç‰ˆéŸ³æ•ˆï¼ˆæ›´å…¼å®¹ iOSï¼‰
            playSimpleSound(150, 0.1, 'triangle');
            setTimeout(() => playSimpleSound(200, 0.08, 'triangle'), 30);
            setTimeout(() => playSimpleSound(100, 0.12, 'sine'), 60);

            setTimeout(() => {
                switch(type) {
                    case 'dogman': playBarkSound(); break;
                    case 'lilpetey': playMeowSound(); break;
                    case '80hd': playRobotSound(); break;
                    case 'flippy': playWaterSound(); break;
                }
            }, 150);
        }

        // æ°´å£°
        function playWaterSound() {
            // ç®€åŒ–ç‰ˆ - æ›´å…¼å®¹ iOS
            playSimpleSound(600, 0.06, 'sine');
            setTimeout(() => playSimpleSound(800, 0.05, 'sine'), 50);
            setTimeout(() => playSimpleSound(500, 0.07, 'sine'), 100);
        }

        // æœ¨å¤´ç ´ç¢
        function playWoodBreak() {
            // ç®€åŒ–ç‰ˆ - æ›´å…¼å®¹ iOS
            playSimpleSound(150, 0.15, 'sawtooth');
            setTimeout(() => playSimpleSound(100, 0.12, 'triangle'), 40);
            setTimeout(() => playSimpleSound(80, 0.18, 'sawtooth'), 80);
        }

        // çŸ³å¤´ç ´ç¢
        function playStoneBreak() {
            // ç®€åŒ–ç‰ˆ - æ›´å…¼å®¹ iOS
            playSimpleSound(80, 0.2, 'square');
            setTimeout(() => playSimpleSound(60, 0.25, 'sawtooth'), 50);
            setTimeout(() => playSimpleSound(100, 0.15, 'square'), 100);
        }

        // ç»ç’ƒç ´ç¢
        function playGlassBreak() {
            // ç®€åŒ–ç‰ˆ - æ›´å…¼å®¹ iOS
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    playSimpleSound(2000 + Math.random() * 2000, 0.05, 'sine');
                }, i * 30);
            }
        }

        // åè¿æ°”éŸ³æ•ˆ - ä¸ç¥¥çš„è­¦å‘Šå£°
        function playBadLuckSound() {
            if (!soundEnabled) return;
            initAudio();
            // ä½æ²‰è­¦å‘Š
            createSound({
                frequencies: [150, 120, 90, 70],
                durations: [0.2, 0.25, 0.3, 0.4],
                types: ['sawtooth', 'square', 'sawtooth', 'square'],
                volumes: [0.4, 0.35, 0.3, 0.25],
                delays: [0, 100, 200, 300],
                filterFreq: 400
            });
            // å è½å£°
            setTimeout(() => {
                createSound({
                    frequencies: [400, 300, 200, 100],
                    durations: [0.15, 0.15, 0.15, 0.2],
                    types: ['sine', 'sine', 'sine', 'triangle'],
                    volumes: [0.3, 0.25, 0.2, 0.15],
                    delays: [0, 80, 160, 240],
                    filterFreq: 800
                });
            }, 200);
        }

        // å¥½è¿æ°”éŸ³æ•ˆ - æ¬¢å¿«çš„é“ƒå£°
        function playGoodLuckSound() {
            if (!soundEnabled) return;
            initAudio();
            // å‡è°ƒçš„æ¬¢å¿«éŸ³
            createSound({
                frequencies: [523, 659, 784, 1047],
                durations: [0.12, 0.12, 0.12, 0.2],
                types: ['sine', 'sine', 'sine', 'sine'],
                volumes: [0.3, 0.35, 0.4, 0.45],
                delays: [0, 80, 160, 240],
                filterFreq: 6000
            });
            // æ˜Ÿæ˜Ÿé—ªçƒå£°
            setTimeout(() => {
                for (let i = 0; i < 4; i++) {
                    setTimeout(() => {
                        createSound({
                            frequencies: [2000 + Math.random() * 1000],
                            durations: [0.06],
                            types: ['sine'],
                            volumes: [0.15],
                            delays: [0],
                            filterFreq: 8000
                        });
                    }, i * 50);
                }
            }, 300);
        }

        // ç¢°æ’å£°
        function playImpact(type) {
            if (!soundEnabled) return;
            const configs = {
                wood: { freq: 200, type: 'triangle', filter: 1000 },
                stone: { freq: 100, type: 'square', filter: 600 },
                glass: { freq: 1500, type: 'sine', filter: 4000 },
                ground: { freq: 120, type: 'triangle', filter: 500 },
                redbox: { freq: 180, type: 'sawtooth', filter: 800 },
                greenbox: { freq: 400, type: 'sine', filter: 2000 },
                default: { freq: 250, type: 'triangle', filter: 1500 }
            };
            const cfg = configs[type] || configs.default;
            createSound({
                frequencies: [cfg.freq, cfg.freq * 0.7],
                durations: [0.08, 0.1],
                types: [cfg.type, cfg.type],
                volumes: [0.25, 0.15],
                delays: [0, 30],
                filterFreq: cfg.filter
            });
        }

        // æ ¹æ®åæ´¾ç±»å‹æ’­æ”¾å‡»è´¥éŸ³æ•ˆ
        function playVillainDefeatSound(type) {
            if (!soundEnabled) return;
            initAudio();
            // å…ˆæ’­æ”¾æƒ¨å«å£°
            playScreamSound(type);

            switch(type) {
                case 'petey':
                    playPeteyDefeat();
                    playAngryMeow();
                    break;
                case 'flatpetey':
                    playPaperTear();
                    playFlatScream();
                    break;
                case 'piggy':
                    playPigSqueal();
                    break;
                case 'robot':
                    playRobotDefeat();
                    break;
                default:
                    playPeteyDefeat();
            }
        }

        // æƒ¨å«å£° - æ ¹æ®æ•Œäººç±»å‹
        function playScreamSound(type) {
            const baseFreq = type === 'piggy' ? 600 : type === 'robot' ? 200 : 800;

            // ä¸»æƒ¨å« - ä¸‹é™éŸ³è°ƒ
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [baseFreq - i * 100 + Math.random() * 50],
                        durations: [0.15 + i * 0.05],
                        types: [type === 'robot' ? 'square' : 'sawtooth'],
                        volumes: [0.4 - i * 0.08],
                        delays: [0],
                        freqSlide: [baseFreq - i * 150 - 200],
                        filterFreq: 3000 - i * 400
                    });
                }, i * 80);
            }
        }

        // æ‰å¹³çŒ«æƒ¨å«
        function playFlatScream() {
            createSound({
                frequencies: [1200, 800, 500],
                durations: [0.1, 0.15, 0.2],
                types: ['sine', 'sine', 'sine'],
                volumes: [0.3, 0.25, 0.15],
                delays: [0, 100, 200],
                freqSlide: [600, 300, 150],
                filterFreq: 4000
            });
        }

        // Peteyå‡»è´¥
        function playPeteyDefeat() {
            createSound({
                frequencies: [700, 500, 350, 200],
                durations: [0.15, 0.18, 0.2, 0.25],
                types: ['sawtooth', 'sawtooth', 'sine', 'sine'],
                volumes: [0.35, 0.3, 0.25, 0.2],
                delays: [0, 120, 250, 400],
                freqSlide: [500, 350, 200, 100],
                filterFreq: 2500
            });
        }

        // æœºå™¨äººå‡»è´¥ - ç”µå­æƒ¨å«
        function playRobotDefeat() {
            // ç”µå­çŸ­è·¯å£°
            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [400 - i * 50 + Math.random() * 100],
                        durations: [0.08 + Math.random() * 0.05],
                        types: ['square'],
                        volumes: [0.3 - i * 0.04],
                        delays: [0],
                        filterFreq: 800 - i * 100
                    });
                }, i * 70);
            }
            // çˆ†ç‚¸å£°
            setTimeout(() => {
                createSound({
                    frequencies: [100, 80, 60],
                    durations: [0.2, 0.15, 0.2],
                    types: ['sawtooth', 'square', 'sine'],
                    volumes: [0.35, 0.3, 0.2],
                    delays: [0, 50, 100],
                    filterFreq: 500
                });
            }, 300);
        }

        // åˆ†è£‚æŠ€èƒ½
        function playSplitSound() {
            createSound({
                frequencies: [400, 600, 500, 700, 550],
                durations: [0.1, 0.08, 0.1, 0.08, 0.12],
                types: ['sine', 'sine', 'sine', 'sine', 'sine'],
                volumes: [0.3, 0.25, 0.28, 0.22, 0.2],
                delays: [0, 50, 100, 150, 200],
                filterFreq: 4000
            });
        }

        // åŠ é€ŸæŠ€èƒ½
        function playBoostSound() {
            createSound({
                frequencies: [200, 400, 600, 800, 1000],
                durations: [0.05, 0.05, 0.05, 0.05, 0.1],
                types: ['sawtooth', 'sawtooth', 'sawtooth', 'sawtooth', 'sine'],
                volumes: [0.2, 0.22, 0.25, 0.28, 0.3],
                delays: [0, 30, 60, 90, 120],
                filterFreq: 3000
            });
        }

        // å¼¹å¼“æ‹‰ä¼¸å£°
        function playStretchSound() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [80, 100, 120],
                durations: [0.15, 0.12, 0.1],
                types: ['sawtooth', 'triangle', 'sawtooth'],
                volumes: [0.15, 0.12, 0.1],
                delays: [0, 50, 100],
                filterFreq: 800
            });
        }

        // è­¦ç¬›å£° (èƒœåˆ©æ—¶)
        function playSirenSound() {
            if (!soundEnabled) return;
            initAudio();
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [600 + i * 100, 800 + i * 100],
                        durations: [0.15, 0.15],
                        types: ['sine', 'sine'],
                        volumes: [0.2, 0.15],
                        delays: [0, 80],
                        freqSlide: [800 + i * 100, 600 + i * 100],
                        filterFreq: 3000
                    });
                }, i * 200);
            }
        }

        // åŸå¸‚ç¯å¢ƒéŸ³ (ä½æ²‰çš„å—¡å—¡å£°)
        function playAmbientCity() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [60, 80, 50],
                durations: [0.5, 0.4, 0.6],
                types: ['sine', 'triangle', 'sine'],
                volumes: [0.05, 0.04, 0.03],
                delays: [0, 100, 200],
                filterFreq: 200
            });
        }

        // çŒ«çš„ä¸æ»¡å£° (Peteyè¢«å‡»ä¸­)
        function playAngryMeow() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [500, 700, 400, 300],
                durations: [0.1, 0.15, 0.2, 0.25],
                types: ['sawtooth', 'sawtooth', 'sine', 'sine'],
                volumes: [0.3, 0.35, 0.25, 0.2],
                delays: [0, 60, 150, 250],
                freqSlide: [600, 500, 300, 200],
                filterFreq: 3000
            });
        }

        // çŒªå«å£° (Piggyè¢«å‡»ä¸­)
        function playPigSqueal() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [400, 600, 500, 450],
                durations: [0.08, 0.1, 0.12, 0.15],
                types: ['sawtooth', 'square', 'sawtooth', 'triangle'],
                volumes: [0.25, 0.3, 0.25, 0.2],
                delays: [0, 50, 120, 200],
                freqSlide: [500, 700, 400, 350],
                filterFreq: 2500
            });
        }

        // çº¸æ’•è£‚å£° (Flat Peteyè¢«å‡»ä¸­)
        function playPaperTear() {
            if (!soundEnabled) return;
            initAudio();
            // ç™½å™ªéŸ³æ•ˆæœ
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createSound({
                        frequencies: [1500 + Math.random() * 2000],
                        durations: [0.03 + Math.random() * 0.03],
                        types: ['sawtooth'],
                        volumes: [0.1 + Math.random() * 0.1],
                        delays: [0],
                        filterFreq: 6000
                    });
                }, i * 20);
            }
        }

        // èƒœåˆ©éŸ³æ•ˆ - å¢å¼ºç‰ˆ
        function playVictorySound() {
            if (!soundEnabled) return;
            initAudio();

            // èƒœåˆ©æ—‹å¾‹
            const notes = [523, 659, 784, 1047, 784, 1047];
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    createSound({
                        frequencies: [freq, freq * 1.5, freq * 2],
                        durations: [0.25, 0.2, 0.15],
                        types: ['sine', 'triangle', 'sine'],
                        volumes: [0.3, 0.15, 0.1],
                        delays: [0, 30, 60],
                        filterFreq: 5000
                    });
                }, i * 120);
            });

            // Dog Man å¼€å¿ƒå«å£°
            setTimeout(playBarkSound, 700);
            setTimeout(playBarkSound, 900);
            setTimeout(() => {
                // æ¬¢å‘¼é“ƒå£°
                createSound({
                    frequencies: [1200, 1400, 1600],
                    durations: [0.1, 0.1, 0.15],
                    types: ['sine', 'sine', 'sine'],
                    volumes: [0.2, 0.2, 0.25],
                    delays: [0, 100, 200],
                    filterFreq: 6000
                });
            }, 1100);

            // è­¦ç¬›
            setTimeout(playSirenSound, 1400);
        }

        // å¤±è´¥éŸ³æ•ˆ
        function playFailSound() {
            if (!soundEnabled) return;
            initAudio();
            const notes = [400, 350, 300, 250, 200];
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    createSound({
                        frequencies: [freq],
                        durations: [0.2],
                        types: ['sawtooth'],
                        volumes: [0.25 - i * 0.03],
                        delays: [0],
                        filterFreq: 1000
                    });
                }, i * 180);
            });
        }

        // ç‚¹å‡»å£°
        function playClickSound() {
            if (!soundEnabled) return;
            initAudio();
            createSound({
                frequencies: [800, 1000],
                durations: [0.04, 0.03],
                types: ['sine', 'sine'],
                volumes: [0.2, 0.15],
                delays: [0, 20],
                filterFreq: 5000
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            if (soundEnabled) {
                // ç”¨æˆ·ç‚¹å‡»å¼€å¯éŸ³æ•ˆ - è¿™æ˜¯ä¸€ä¸ªç”¨æˆ·äº¤äº’ï¼Œå¯ä»¥åˆå§‹åŒ–éŸ³é¢‘
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        masterGain = audioCtx.createGain();
                        masterGain.connect(audioCtx.destination);
                        masterGain.gain.value = 0.5;
                    } catch (e) {
                        console.error('Failed to create audio context:', e);
                    }
                }
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        console.log('Audio enabled and resumed');
                        playBeep();
                    });
                } else {
                    playBeep();
                }
            }
        }

        // ========================================
        // å…³å¡å®šä¹‰
        // ========================================
        // åœºæ™¯ç±»å‹ - åŸºäºDog ManåŸä½œåœºæ™¯
        const sceneTypes = ['city', 'policestation', 'catjail', 'secretlab'];
        let currentScene = 'city';

        const levels = [
            // ç¬¬1å…³ - æ–°æ‰‹å…¥é—¨ï¼ˆå‡å°‘å¥½è¿ç®±ï¼‰
            {
                scene: 'city',
                buddies: ['dogman', 'dogman'],
                villains: [{ type: 'petey', x: 850, y: GROUND_Y - 58 }],
                blocks: [
                    { type: 'glass', x: 810, y: GROUND_Y - 25, w: 80, h: 25 },
                    { type: 'glass', x: 820, y: GROUND_Y - 50, w: 60, h: 20 }
                ],
                stars: [1, 2, 2]
            },
            // ç¬¬2å…³ - ç®€å•åŒæ•Œï¼ˆç§»é™¤å¥½è¿ç®±ï¼‰
            {
                scene: 'city',
                buddies: ['dogman', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 820, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 950, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 780, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 910, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 990, y: GROUND_Y - 25, w: 25, h: 80 }
                ],
                stars: [1, 2, 3]
            },
            // ç¬¬3å…³ - åˆé‡çŸ³å¤´ï¼ˆåªä¿ç•™1ä¸ªå¥½è¿ç®±ï¼‰
            {
                scene: 'policestation',
                buddies: ['dogman', 'lilpetey', '80hd'],
                villains: [
                    { type: 'petey', x: 800, y: GROUND_Y - 138 },
                    { type: 'petey', x: 900, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 760, y: GROUND_Y - 25, w: 25, h: 110 },
                    { type: 'wood', x: 860, y: GROUND_Y - 25, w: 25, h: 110 },
                    { type: 'glass', x: 750, y: GROUND_Y - 135, w: 145, h: 20 },
                    { type: 'glass', x: 870, y: GROUND_Y - 25, w: 20, h: 60 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 60 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 180, w: 35, h: 35 }
                ],
                stars: [1, 2, 3]
            },
            // ç¬¬4å…³ - TNTåˆä½“éªŒï¼ˆå‡å°‘ç®±å­ï¼Œæ·»åŠ Chiefï¼‰
            {
                scene: 'catjail',
                buddies: ['dogman', 'chief', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 750, y: GROUND_Y - 58 },
                    { type: 'petey', x: 920, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 710, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 790, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 880, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 960, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 110 },
                    { type: 'greenbox', x: 835, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [1, 2, 3]
            },
            // ç¬¬5å…³ - åŒå±‚ç»“æ„ï¼ˆå¹³è¡¡è°ƒæ•´ï¼Œæ·»åŠ Sarahï¼‰
            {
                scene: 'secretlab',
                buddies: ['80hd', 'sarah', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 680, y: GROUND_Y - 60 },
                    { type: 'petey', x: 820, y: GROUND_Y - 183 },
                    { type: 'petey', x: 960, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 640, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'glass', x: 780, y: GROUND_Y - 25, w: 25, h: 155 },
                    { type: 'glass', x: 880, y: GROUND_Y - 25, w: 25, h: 155 },
                    { type: 'glass', x: 770, y: GROUND_Y - 180, w: 145, h: 18 },
                    { type: 'wood', x: 920, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 90 },
                    { type: 'tnt', x: 680, y: GROUND_Y - 120 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 50 }
                ],
                stars: [2, 3, 4]
            },
            // ç¬¬6å…³ - ä¸‰æ•ŒæŒ‘æˆ˜ï¼ˆä½¿ç”¨æ–°è§’è‰²ï¼‰
            {
                scene: 'city',
                buddies: ['chief', 'flippy', 'sarah', '80hd'],
                villains: [
                    { type: 'petey', x: 650, y: GROUND_Y - 55 },
                    { type: 'petey', x: 820, y: GROUND_Y - 55 },
                    { type: 'petey', x: 990, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 610, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 690, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 780, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 860, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 1030, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'greenbox', x: 820, y: GROUND_Y - 120, w: 35, h: 35 }
                ],
                stars: [2, 3, 4]
            },
            // ç¬¬7å…³ - é«˜å¡”æ”»ç•¥ï¼ˆå‡å°‘ç®±å­ï¼‰
            {
                scene: 'policestation',
                buddies: ['lilpetey', 'chief', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 720, y: GROUND_Y - 220 },
                    { type: 'petey', x: 840, y: GROUND_Y - 220 },
                    { type: 'petey', x: 960, y: GROUND_Y - 220 }
                ],
                blocks: [
                    { type: 'wood', x: 670, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 770, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 870, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 970, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'glass', x: 660, y: GROUND_Y - 220, w: 340, h: 20 },
                    { type: 'tnt', x: 720, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 920, y: GROUND_Y - 80 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 }
                ],
                stars: [2, 3, 4]
            },
            // ç¬¬8å…³ - åŒå±‚é˜²å¾¡ï¼ˆæ·»åŠ æ–°è§’è‰²ï¼‰
            {
                scene: 'catjail',
                buddies: ['80hd', 'sarah', 'flippy', 'chief'],
                villains: [
                    { type: 'flatpetey', x: 780, y: GROUND_Y - 55 },
                    { type: 'petey', x: 900, y: GROUND_Y - 138 },
                    { type: 'petey', x: 780, y: GROUND_Y - 218 }
                ],
                blocks: [
                    { type: 'wood', x: 730, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'wood', x: 850, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'glass', x: 720, y: GROUND_Y - 55, w: 140, h: 18 },
                    { type: 'glass', x: 720, y: GROUND_Y - 135, w: 140, h: 18 },
                    { type: 'glass', x: 720, y: GROUND_Y - 215, w: 140, h: 18 },
                    { type: 'glass', x: 885, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 955, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'wood', x: 875, y: GROUND_Y - 160, w: 110, h: 18 },
                    { type: 'greenbox', x: 660, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1020, y: GROUND_Y - 50, w: 35, h: 35, moveY: 35 },
                    { type: 'greenbox', x: 780, y: GROUND_Y - 260, w: 35, h: 35 },
                    { type: 'redbox', x: 920, y: GROUND_Y - 200, w: 35, h: 35, moveX: 30 }
                ],
                stars: [2, 3, 4]
            },
            // ç¬¬9å…³ - å››æ•Œå›´æ”»
            {
                scene: 'secretlab',
                buddies: ['dogman', 'lilpetey', 'flippy', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 620, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 135 },
                    { type: 'petey', x: 980, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 295 }
                ],
                blocks: [
                    { type: 'glass', x: 580, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'wood', x: 750, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'wood', x: 870, y: GROUND_Y - 25, w: 25, h: 190 },
                    { type: 'glass', x: 740, y: GROUND_Y - 215, w: 145, h: 18 },
                    { type: 'glass', x: 750, y: GROUND_Y - 235, w: 25, h: 85 },
                    { type: 'glass', x: 870, y: GROUND_Y - 235, w: 25, h: 85 },
                    { type: 'glass', x: 740, y: GROUND_Y - 320, w: 145, h: 18 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'glass', x: 1020, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 520, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1080, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 370, w: 35, h: 35, moveX: 30 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveY: 40 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬10å…³ - åŒå¡”å¯¹å†³
            {
                scene: 'city',
                buddies: ['flippy', 'flippy', 'lilpetey', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 670, y: GROUND_Y - 135 },
                    { type: 'piggy', x: 840, y: GROUND_Y - 55 },
                    { type: 'petey', x: 1010, y: GROUND_Y - 135 }
                ],
                blocks: [
                    { type: 'glass', x: 620, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 720, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 610, y: GROUND_Y - 160, w: 140, h: 18 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'wood', x: 880, y: GROUND_Y - 25, w: 25, h: 85 },
                    { type: 'glass', x: 960, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 1060, y: GROUND_Y - 25, w: 20, h: 135 },
                    { type: 'glass', x: 950, y: GROUND_Y - 160, w: 140, h: 18 },
                    { type: 'tnt', x: 670, y: GROUND_Y - 50 },
                    { type: 'tnt', x: 1010, y: GROUND_Y - 50 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 50, w: 35, h: 35, moveY: 25 },
                    { type: 'greenbox', x: 1120, y: GROUND_Y - 50, w: 35, h: 35, moveY: 25 },
                    { type: 'greenbox', x: 840, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 35 },
                    { type: 'redbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 40 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬11å…³ - åšå›ºå ¡å’
            {
                scene: 'policestation',
                buddies: ['80hd', 'dogman', 'lilpetey', 'flippy', 'dogman'],
                villains: [
                    { type: 'piggy', x: 720, y: GROUND_Y - 60 },
                    { type: 'piggy', x: 840, y: GROUND_Y - 55 },
                    { type: 'petey', x: 780, y: GROUND_Y - 208 }
                ],
                blocks: [
                    { type: 'wood', x: 670, y: GROUND_Y - 25, w: 25, h: 180 },
                    { type: 'wood', x: 890, y: GROUND_Y - 25, w: 25, h: 180 },
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 185, h: 25 },
                    { type: 'glass', x: 660, y: GROUND_Y - 205, w: 265, h: 22 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 960, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 780, y: GROUND_Y - 260, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 780, y: GROUND_Y - 130, w: 35, h: 35, moveY: 20 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬12å…³ - å¤šå±‚å¡”æ¥¼
            {
                scene: 'catjail',
                buddies: ['lilpetey', '80hd', 'flippy', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 620, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 135 },
                    { type: 'petey', x: 980, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 265 }
                ],
                blocks: [
                    { type: 'glass', x: 580, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'wood', x: 740, y: GROUND_Y - 25, w: 25, h: 135 },
                    { type: 'wood', x: 880, y: GROUND_Y - 25, w: 25, h: 135 },
                    { type: 'glass', x: 730, y: GROUND_Y - 160, w: 185, h: 18 },
                    { type: 'wood', x: 740, y: GROUND_Y - 180, w: 25, h: 105 },
                    { type: 'wood', x: 880, y: GROUND_Y - 180, w: 25, h: 105 },
                    { type: 'glass', x: 730, y: GROUND_Y - 285, w: 185, h: 18 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 1020, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 520, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1080, y: GROUND_Y - 50, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 330, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveX: 45 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 200, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬13å…³ - çŸ³å¤´è¦å¡
            {
                scene: 'secretlab',
                buddies: ['80hd', '80hd', 'flippy', 'lilpetey', 'dogman'],
                villains: [
                    { type: 'petey', x: 670, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 840, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 1010, y: GROUND_Y - 60 },
                    { type: 'petey', x: 840, y: GROUND_Y - 228 }
                ],
                blocks: [
                    { type: 'wood', x: 620, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 790, y: GROUND_Y - 25, w: 25, h: 200 },
                    { type: 'wood', x: 910, y: GROUND_Y - 25, w: 25, h: 200 },
                    { type: 'glass', x: 780, y: GROUND_Y - 225, w: 145, h: 18 },
                    { type: 'wood', x: 960, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 1060, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'tnt', x: 670, y: GROUND_Y - 130 },
                    { type: 'tnt', x: 1010, y: GROUND_Y - 130 },
                    { type: 'greenbox', x: 560, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1120, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 840, y: GROUND_Y - 280, w: 35, h: 35, moveX: 40 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 840, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬14å…³ - è¶…é«˜å¡”
            {
                scene: 'city',
                buddies: ['flippy', 'lilpetey', '80hd', 'dogman', 'flippy', 'dogman'],
                villains: [
                    { type: 'piggy', x: 620, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 135 },
                    { type: 'piggy', x: 980, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 285 }
                ],
                blocks: [
                    { type: 'wood', x: 570, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 670, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'glass', x: 740, y: GROUND_Y - 25, w: 20, h: 185 },
                    { type: 'glass', x: 880, y: GROUND_Y - 25, w: 20, h: 185 },
                    { type: 'wood', x: 730, y: GROUND_Y - 210, w: 180, h: 18 },
                    { type: 'glass', x: 740, y: GROUND_Y - 230, w: 25, h: 105 },
                    { type: 'glass', x: 880, y: GROUND_Y - 230, w: 25, h: 105 },
                    { type: 'wood', x: 730, y: GROUND_Y - 335, w: 180, h: 18 },
                    { type: 'wood', x: 930, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'wood', x: 1030, y: GROUND_Y - 25, w: 25, h: 105 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 250 },
                    { type: 'greenbox', x: 500, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 385, w: 35, h: 35, moveX: 30 },
                    { type: 'greenbox', x: 620, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 980, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // ç¬¬15å…³ - å¤æ‚å ¡å’
            {
                scene: 'secretlab',
                buddies: ['80hd', 'flippy', 'lilpetey', 'dogman', '80hd', 'flippy'],
                villains: [
                    { type: 'piggy', x: 620, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 740, y: GROUND_Y - 138 },
                    { type: 'flatpetey', x: 860, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 980, y: GROUND_Y - 138 },
                    { type: 'petey', x: 810, y: GROUND_Y - 288 }
                ],
                blocks: [
                    { type: 'glass', x: 580, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'glass', x: 690, y: GROUND_Y - 210, w: 145, h: 18 },
                    { type: 'glass', x: 820, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'glass', x: 900, y: GROUND_Y - 25, w: 20, h: 65 },
                    { type: 'wood', x: 940, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'wood', x: 1040, y: GROUND_Y - 25, w: 25, h: 185 },
                    { type: 'glass', x: 930, y: GROUND_Y - 210, w: 145, h: 18 },
                    { type: 'glass', x: 760, y: GROUND_Y - 230, w: 20, h: 105 },
                    { type: 'glass', x: 880, y: GROUND_Y - 230, w: 20, h: 105 },
                    { type: 'wood', x: 750, y: GROUND_Y - 335, w: 160, h: 18 },
                    { type: 'tnt', x: 620, y: GROUND_Y - 100 },
                    { type: 'tnt', x: 980, y: GROUND_Y - 100 },
                    { type: 'tnt', x: 810, y: GROUND_Y - 250 },
                    { type: 'greenbox', x: 520, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 810, y: GROUND_Y - 385, w: 35, h: 35, moveX: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveX: 50 },
                    { type: 'redbox', x: 860, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // ç¬¬16å…³ - è¿æ°”å¤§æŒ‘æˆ˜
            {
                scene: 'city',
                buddies: ['dogman', 'lilpetey', 'dogman', 'flippy', '80hd'],
                villains: [
                    { type: 'petey', x: 700, y: GROUND_Y - 58 },
                    { type: 'petey', x: 850, y: GROUND_Y - 58 },
                    { type: 'piggy', x: 1000, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 740, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 810, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 890, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 960, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 1040, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 775, y: GROUND_Y - 200, w: 35, h: 35 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 50 },
                    { type: 'redbox', x: 700, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 3, 4]
            },
            // ç¬¬17å…³ - æœºå™¨äººé˜²çº¿
            {
                scene: 'policestation',
                buddies: ['80hd', 'dogman', 'lilpetey', 'flippy', '80hd'],
                villains: [
                    { type: 'robot', x: 750, y: GROUND_Y - 140 },
                    { type: 'petey', x: 900, y: GROUND_Y - 58 },
                    { type: 'robot', x: 650, y: GROUND_Y - 60 }
                ],
                blocks: [
                    { type: 'wood', x: 600, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 690, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'greenbox', x: 540, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1000, y: GROUND_Y - 50, w: 35, h: 35, moveY: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 30 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 180, w: 35, h: 35, moveY: 45 },
                    { type: 'redbox', x: 650, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 3, 4]
            },
            // ç¬¬18å…³ - é‡‘å­—å¡”
            {
                scene: 'catjail',
                buddies: ['flippy', 'lilpetey', 'dogman', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 800, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 138 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 218 }
                ],
                blocks: [
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 200, h: 20 },
                    { type: 'glass', x: 720, y: GROUND_Y - 45, w: 25, h: 90 },
                    { type: 'glass', x: 880, y: GROUND_Y - 45, w: 25, h: 90 },
                    { type: 'glass', x: 720, y: GROUND_Y - 135, w: 185, h: 18 },
                    { type: 'glass', x: 740, y: GROUND_Y - 155, w: 20, h: 80 },
                    { type: 'glass', x: 860, y: GROUND_Y - 155, w: 20, h: 80 },
                    { type: 'wood', x: 740, y: GROUND_Y - 235, w: 140, h: 18 },
                    { type: 'greenbox', x: 640, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 290, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 1020, y: GROUND_Y - 100, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 580, y: GROUND_Y - 150, w: 35, h: 35, moveX: 45 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 80, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬19å…³ - æœºå™¨äººåŒå¡”
            {
                scene: 'secretlab',
                buddies: ['dogman', 'dogman', '80hd', 'flippy', 'lilpetey'],
                villains: [
                    { type: 'robot', x: 650, y: GROUND_Y - 60 },
                    { type: 'robot', x: 950, y: GROUND_Y - 60 },
                    { type: 'petey', x: 800, y: GROUND_Y - 188 }
                ],
                blocks: [
                    { type: 'wood', x: 600, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 750, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 870, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 740, y: GROUND_Y - 190, w: 165, h: 18 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'tnt', x: 800, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 540, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1060, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 250, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 180, w: 35, h: 35, moveY: 45 },
                    { type: 'redbox', x: 950, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬20å…³ - åŒå¡”å¯¹å†³
            {
                scene: 'city',
                buddies: ['80hd', 'flippy', 'dogman', 'lilpetey', '80hd'],
                villains: [
                    { type: 'petey', x: 650, y: GROUND_Y - 188 },
                    { type: 'piggy', x: 950, y: GROUND_Y - 188 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'wood', x: 600, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 590, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 890, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'glass', x: 760, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 840, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'greenbox', x: 540, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1060, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 250, w: 35, h: 35, moveX: 30 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 250, w: 35, h: 35, moveX: 30 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬21å…³ - ä¸‰æ•Œæ··æˆ˜
            {
                scene: 'policestation',
                buddies: ['lilpetey', 'lilpetey', '80hd', 'dogman', 'flippy'],
                villains: [
                    { type: 'petey', x: 700, y: GROUND_Y - 58 },
                    { type: 'robot', x: 850, y: GROUND_Y - 138 },
                    { type: 'petey', x: 1000, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 660, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 740, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 790, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 960, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1040, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1100, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 200, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 700, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 500, y: GROUND_Y - 150, w: 35, h: 35, moveX: 40 },
                    { type: 'redbox', x: 1000, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬22å…³ - å››å±‚è¦å¡
            {
                scene: 'catjail',
                buddies: ['80hd', 'flippy', 'dogman', 'lilpetey', '80hd', 'dogman'],
                villains: [
                    { type: 'piggy', x: 800, y: GROUND_Y - 55 },
                    { type: 'petey', x: 800, y: GROUND_Y - 138 },
                    { type: 'robot', x: 800, y: GROUND_Y - 218 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 298 }
                ],
                blocks: [
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 270 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 270 },
                    { type: 'glass', x: 745, y: GROUND_Y - 55, w: 155, h: 15 },
                    { type: 'glass', x: 745, y: GROUND_Y - 135, w: 155, h: 15 },
                    { type: 'glass', x: 745, y: GROUND_Y - 215, w: 155, h: 15 },
                    { type: 'glass', x: 745, y: GROUND_Y - 295, w: 155, h: 15 },
                    { type: 'tnt', x: 780, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 240 },
                    { type: 'greenbox', x: 660, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 960, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 350, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 160, w: 35, h: 35 },
                    { type: 'redbox', x: 600, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 160, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // ç¬¬23å…³ - åˆ†æ•£é˜²å¾¡
            {
                scene: 'secretlab',
                buddies: ['flippy', '80hd', 'lilpetey', 'dogman', 'flippy', 'dogman'],
                villains: [
                    { type: 'robot', x: 600, y: GROUND_Y - 60 },
                    { type: 'petey', x: 750, y: GROUND_Y - 188 },
                    { type: 'piggy', x: 900, y: GROUND_Y - 55 },
                    { type: 'petey', x: 1050, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'wood', x: 550, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 650, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 820, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 690, y: GROUND_Y - 190, w: 165, h: 18 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 760, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 490, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 250, w: 35, h: 35, moveX: 35 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 900, y: GROUND_Y - 130, w: 35, h: 35, moveY: 30 },
                    { type: 'redbox', x: 460, y: GROUND_Y - 200, w: 35, h: 35, moveY: 45 }
                ],
                stars: [3, 5, 6]
            },
            // ç¬¬24å…³ - è¿æ°”é£æš´
            {
                scene: 'city',
                buddies: ['dogman', 'lilpetey', '80hd', 'flippy', 'dogman', 'lilpetey'],
                villains: [
                    { type: 'petey', x: 650, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 55 },
                    { type: 'petey', x: 950, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 610, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 690, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 760, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 840, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 910, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 990, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1050, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 150, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 150, w: 35, h: 35, moveY: 35 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 150, w: 35, h: 35, moveY: 35 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveX: 60 },
                    { type: 'redbox', x: 720, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 880, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [2, 4, 5]
            },
            // ç¬¬25å…³ - åšå›ºå ¡å’
            {
                scene: 'policestation',
                buddies: ['80hd', '80hd', 'flippy', 'lilpetey', 'dogman', 'flippy'],
                villains: [
                    { type: 'robot', x: 750, y: GROUND_Y - 60 },
                    { type: 'robot', x: 950, y: GROUND_Y - 60 },
                    { type: 'piggy', x: 850, y: GROUND_Y - 188 }
                ],
                blocks: [
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 1000, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 790, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 950, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 640, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1060, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 250, w: 35, h: 35, moveX: 40 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 950, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 580, y: GROUND_Y - 180, w: 35, h: 35, moveY: 50 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // ç¬¬26å…³ - é˜¶æ¢¯é˜²çº¿
            {
                scene: 'catjail',
                buddies: ['lilpetey', 'flippy', '80hd', 'dogman', 'lilpetey', '80hd'],
                villains: [
                    { type: 'petey', x: 600, y: GROUND_Y - 58 },
                    { type: 'piggy', x: 750, y: GROUND_Y - 138 },
                    { type: 'robot', x: 900, y: GROUND_Y - 218 },
                    { type: 'petey', x: 1050, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 560, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 640, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 700, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 800, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 690, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'wood', x: 850, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 25, h: 195 },
                    { type: 'glass', x: 840, y: GROUND_Y - 220, w: 145, h: 18 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 900, y: GROUND_Y - 160 },
                    { type: 'greenbox', x: 500, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 900, y: GROUND_Y - 280, w: 35, h: 35, moveX: 45 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 1050, y: GROUND_Y - 130, w: 35, h: 35, moveY: 35 },
                    { type: 'redbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 40 },
                    { type: 'redbox', x: 875, y: GROUND_Y - 80, w: 35, h: 35 }
                ],
                stars: [3, 5, 6]
            },
            // ç¬¬27å…³ - è¶…çº§é«˜å¡”
            {
                scene: 'secretlab',
                buddies: ['flippy', '80hd', 'dogman', 'lilpetey', 'flippy', '80hd', 'dogman'],
                villains: [
                    { type: 'petey', x: 800, y: GROUND_Y - 58 },
                    { type: 'flatpetey', x: 800, y: GROUND_Y - 138 },
                    { type: 'piggy', x: 800, y: GROUND_Y - 218 },
                    { type: 'robot', x: 800, y: GROUND_Y - 298 },
                    { type: 'petey', x: 800, y: GROUND_Y - 378 }
                ],
                blocks: [
                    { type: 'wood', x: 720, y: GROUND_Y - 25, w: 25, h: 355 },
                    { type: 'wood', x: 900, y: GROUND_Y - 25, w: 25, h: 355 },
                    { type: 'glass', x: 745, y: GROUND_Y - 55, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 135, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 215, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 295, w: 155, h: 12 },
                    { type: 'glass', x: 745, y: GROUND_Y - 375, w: 155, h: 12 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 160 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 240 },
                    { type: 'greenbox', x: 650, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 960, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 800, y: GROUND_Y - 430, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 320, w: 35, h: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 320, w: 35, h: 35 },
                    { type: 'redbox', x: 600, y: GROUND_Y - 200, w: 35, h: 35, moveY: 60 },
                    { type: 'redbox', x: 800, y: GROUND_Y - 160, w: 35, h: 35 }
                ],
                stars: [4, 6, 7]
            },
            // ç¬¬28å…³ - åˆ†æ•£è¿·å®«
            {
                scene: 'city',
                buddies: ['80hd', 'lilpetey', 'flippy', 'dogman', '80hd', 'lilpetey', 'dogman'],
                villains: [
                    { type: 'petey', x: 600, y: GROUND_Y - 58 },
                    { type: 'robot', x: 750, y: GROUND_Y - 60 },
                    { type: 'piggy', x: 900, y: GROUND_Y - 55 },
                    { type: 'flatpetey', x: 1050, y: GROUND_Y - 55 }
                ],
                blocks: [
                    { type: 'glass', x: 560, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 640, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 700, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'wood', x: 800, y: GROUND_Y - 25, w: 25, h: 100 },
                    { type: 'glass', x: 860, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 940, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'tnt', x: 750, y: GROUND_Y - 130 },
                    { type: 'tnt', x: 900, y: GROUND_Y - 100 },
                    { type: 'greenbox', x: 500, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 750, y: GROUND_Y - 200, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 600, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 1050, y: GROUND_Y - 130, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 200, w: 35, h: 35, moveY: 55 },
                    { type: 'redbox', x: 680, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 900, y: GROUND_Y - 180, w: 35, h: 35, moveX: 35 }
                ],
                stars: [3, 5, 7]
            },
            // ç¬¬29å…³ - å²è¯—å†³æˆ˜
            {
                scene: 'policestation',
                buddies: ['flippy', '80hd', 'lilpetey', 'dogman', 'flippy', '80hd', 'lilpetey', 'dogman'],
                villains: [
                    { type: 'petey', x: 550, y: GROUND_Y - 58 },
                    { type: 'robot', x: 700, y: GROUND_Y - 138 },
                    { type: 'piggy', x: 850, y: GROUND_Y - 55 },
                    { type: 'robot', x: 1000, y: GROUND_Y - 138 },
                    { type: 'petey', x: 850, y: GROUND_Y - 268 }
                ],
                blocks: [
                    { type: 'glass', x: 510, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 590, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 650, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 750, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 640, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 800, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'glass', x: 900, y: GROUND_Y - 25, w: 25, h: 80 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'wood', x: 1050, y: GROUND_Y - 25, w: 25, h: 115 },
                    { type: 'glass', x: 940, y: GROUND_Y - 140, w: 145, h: 18 },
                    { type: 'glass', x: 790, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'glass', x: 930, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'wood', x: 780, y: GROUND_Y - 270, w: 165, h: 18 },
                    { type: 'tnt', x: 700, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 1000, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 200 },
                    { type: 'greenbox', x: 450, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1110, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 330, w: 35, h: 35, moveX: 50 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 700, y: GROUND_Y - 200, w: 35, h: 35, moveY: 30 },
                    { type: 'greenbox', x: 1000, y: GROUND_Y - 200, w: 35, h: 35, moveY: 30 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 250, w: 35, h: 35, moveX: 60 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 130, w: 35, h: 35 }
                ],
                stars: [4, 6, 8]
            },
            // ç¬¬30å…³ - ç»ˆææŒ‘æˆ˜
            {
                scene: 'secretlab',
                buddies: ['80hd', 'flippy', 'lilpetey', 'dogman', '80hd', 'flippy', 'lilpetey', 'dogman', 'flippy'],
                villains: [
                    { type: 'petey', x: 550, y: GROUND_Y - 58 },
                    { type: 'piggy', x: 700, y: GROUND_Y - 188 },
                    { type: 'robot', x: 850, y: GROUND_Y - 268 },
                    { type: 'flatpetey', x: 850, y: GROUND_Y - 55 },
                    { type: 'piggy', x: 1000, y: GROUND_Y - 188 },
                    { type: 'petey', x: 1050, y: GROUND_Y - 58 }
                ],
                blocks: [
                    { type: 'glass', x: 510, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 590, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'wood', x: 650, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 750, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 640, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'glass', x: 800, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'glass', x: 900, y: GROUND_Y - 25, w: 20, h: 70 },
                    { type: 'wood', x: 950, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'wood', x: 1050, y: GROUND_Y - 25, w: 25, h: 165 },
                    { type: 'glass', x: 940, y: GROUND_Y - 190, w: 145, h: 18 },
                    { type: 'glass', x: 790, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'glass', x: 930, y: GROUND_Y - 160, w: 20, h: 110 },
                    { type: 'wood', x: 780, y: GROUND_Y - 270, w: 165, h: 18 },
                    { type: 'glass', x: 1010, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'glass', x: 1090, y: GROUND_Y - 25, w: 20, h: 80 },
                    { type: 'tnt', x: 700, y: GROUND_Y - 80 },
                    { type: 'tnt', x: 850, y: GROUND_Y - 100 },
                    { type: 'tnt', x: 1000, y: GROUND_Y - 80 },
                    { type: 'greenbox', x: 450, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 1150, y: GROUND_Y - 50, w: 35, h: 35 },
                    { type: 'greenbox', x: 850, y: GROUND_Y - 330, w: 35, h: 35, moveX: 60 },
                    { type: 'greenbox', x: 550, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'greenbox', x: 700, y: GROUND_Y - 250, w: 35, h: 35, moveY: 40 },
                    { type: 'greenbox', x: 1000, y: GROUND_Y - 250, w: 35, h: 35, moveY: 40 },
                    { type: 'redbox', x: 480, y: GROUND_Y - 280, w: 35, h: 35, moveX: 70 },
                    { type: 'redbox', x: 700, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 1000, y: GROUND_Y - 130, w: 35, h: 35 },
                    { type: 'redbox', x: 850, y: GROUND_Y - 200, w: 35, h: 35 }
                ],
                stars: [5, 7, 9]
            }
        ];

        // ========================================
        // ä¼™ä¼´ç±»å‹ - åŸºäºçœŸå®Dog Manè§’è‰²è®¾è®¡
        // ========================================
        const buddyTypes = {
            dogman: { name: 'Dog Man', radius: 26, mass: 1, color: '#D2691E', special: null, desc: 'æ ‡å‡†æ”»å‡»' },
            lilpetey: { name: "Li'l Petey", radius: 20, mass: 0.6, color: '#FF8C00', special: 'split', desc: 'åˆ†è£‚Ã—3' },
            '80hd': { name: '80-HD', radius: 28, mass: 2.2, color: '#5DADE2', special: 'heavy', desc: 'è¶…çº§é‡å‡»' },
            flippy: { name: 'Flippy', radius: 22, mass: 0.7, color: '#F4D03F', special: 'boost', desc: 'åŠ é€Ÿå†²åˆº' },
            chief: { name: 'Chief', radius: 24, mass: 1.2, color: '#2E86AB', special: 'shockwave', desc: 'å†²å‡»æ³¢' },
            sarah: { name: 'Sarah', radius: 21, mass: 0.8, color: '#E91E63', special: 'boomerang', desc: 'å›æ—‹é•–' }
        };
        window.buddyTypes = buddyTypes; // å…¨å±€è®¿é—®

        // å½“å‰é€‰ä¸­çš„è§’è‰²ç´¢å¼•ï¼ˆç”¨äºè‡ªé€‰åŠŸèƒ½ï¼‰
        let selectedBuddyIndex = 0;

        // åæ´¾ç±»å‹ - åŸºäºDog ManåŸä½œ
        const villainTypes = {
            petey: { name: 'Petey', width: 50, height: 58, health: 1 },
            flatpetey: { name: 'Flat Petey', width: 45, height: 55, health: 1 },
            piggy: { name: 'Piggy', width: 52, height: 55, health: 2 },
            robot: { name: 'Robot', width: 48, height: 60, health: 2 }
        };

        // ========================================
        // åˆå§‹åŒ–
        // ========================================
        function init() {
            loadLevel(currentLevel);
            generateLevelButtons();
            setupEventListeners();
            canvas.addEventListener('click', () => initAudio(), { once: true });
            drawBuddyIcons();
            gameLoop();
        }

        // ç»˜åˆ¶è¯´æ˜åŒºçš„è§’è‰²å›¾æ ‡ - ä½¿ç”¨ç®€åŒ–æ–¹æ³•
        function drawBuddyIcons() {
            try {
                const iconData = [
                    { id: 'dogmanIcon', type: 'dogman' },
                    { id: 'lilpeteyIcon', type: 'lilpetey' },
                    { id: '80hdIcon', type: '80hd' },
                    { id: 'flippyIcon', type: 'flippy' },
                    { id: 'chiefIcon', type: 'chief' },
                    { id: 'sarahIcon', type: 'sarah' }
                ];

                iconData.forEach(icon => {
                    const iconCanvas = document.getElementById(icon.id);
                    if (iconCanvas) {
                        const iconCtx = iconCanvas.getContext('2d');
                        iconCtx.clearRect(0, 0, 50, 50);
                        iconCtx.save();
                        iconCtx.translate(25, 28);
                        iconCtx.scale(0.6, 0.6);
                        drawBuddyOnContext(iconCtx, icon.type, 20);
                        iconCtx.restore();
                    }
                });
            } catch (e) {
                console.error('drawBuddyIcons error:', e);
            }
        }

        // åœ¨æŒ‡å®šcontextä¸Šç»˜åˆ¶è§’è‰²
        function drawBuddyOnContext(targetCtx, type, radius) {
            const origCtx = ctx;
            ctx = targetCtx;
            switch(type) {
                case 'dogman': drawDogMan(radius); break;
                case 'lilpetey': drawLilPetey(radius * 0.85); break;
                case '80hd': draw80HD(radius); break;
                case 'flippy': drawFlippy(radius * 0.9); break;
                case 'chief': drawChief(radius * 0.95); break;
                case 'sarah': drawSarah(radius * 0.9); break;
            }
            ctx = origCtx;
        }

        function loadLevel(levelNum) {
            currentLevel = levelNum;
            const level = levels[levelNum - 1];
            if (!level) return;

            // è®¾ç½®åœºæ™¯ç±»å‹
            currentScene = level.scene || 'city';

            score = 0;
            gameState = 'ready';
            projectile = null;
            projectiles = [];
            debris = [];
            particles = [];
            fallingObjects = [];

            buddies = level.buddies.map(type => ({ type, ...buddyTypes[type], used: false }));
            currentBuddyIndex = 0;

            // æ ¹æ®åæ´¾ç±»å‹è®¾ç½®å±æ€§
            villains = level.villains.map(v => {
                const vType = villainTypes[v.type] || villainTypes.petey;
                return {
                    ...v,
                    width: vType.width,
                    height: vType.height,
                    health: v.type === 'robot' || v.type === 'piggy' ? 2 : 1,
                    maxHealth: v.type === 'robot' || v.type === 'piggy' ? 2 : 1,
                    alive: true,
                    vy: 0,
                    angle: 0
                };
            });

            blocks = level.blocks.map(b => ({
                ...b,
                health: b.type === 'stone' ? 3 : b.type === 'wood' ? 2 : b.type === 'tnt' ? 1 : b.type === 'redbox' ? 2 : b.type === 'greenbox' ? 1 : 1,
                maxHealth: b.type === 'stone' ? 3 : b.type === 'wood' ? 2 : b.type === 'redbox' ? 2 : 1,
                alive: true,
                vy: 0,
                vx: 0,
                angle: 0,
                // ç§»åŠ¨ç®±å­æ”¯æŒ
                originalX: b.x,
                originalY: b.y,
                movePhase: Math.random() * Math.PI * 2 // éšæœºèµ·å§‹ç›¸ä½
            }));

            updateUI();
            renderBuddiesPanel();
            placeCurrentBuddy();
        }

        function placeCurrentBuddy() {
            if (currentBuddyIndex >= buddies.length) {
                checkGameEnd();
                return;
            }
            const buddy = buddies[currentBuddyIndex];
            projectile = {
                x: SLINGSHOT_X,
                y: SLINGSHOT_Y,
                vx: 0,
                vy: 0,
                ...buddy,
                active: false,
                specialUsed: false,
                rotation: 0,
                rotationSpeed: 0
            };
            gameState = 'ready';
        }

        // ========================================
        // æ¸²æŸ“
        // ========================================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frameCount++;

            // æ›´æ–°å±å¹•éœ‡åŠ¨
            updateScreenShake();

            // åº”ç”¨å±å¹•éœ‡åŠ¨
            ctx.save();
            ctx.translate(screenShake.x, screenShake.y);

            drawBackground();
            drawSlingshot();
            blocks.forEach(b => b.alive && drawBlock(b));
            villains.forEach(v => v.alive && drawVillain(v));
            debris.forEach(d => drawDebris(d));
            particles.forEach(p => drawParticle(p));
            fallingObjects.forEach(fo => drawFallingObject(fo));
            if (projectile) drawBuddy(projectile);
            projectiles.forEach(p => drawBuddy(p));
            if (isDragging && gameState === 'aiming') drawTrajectory();

            // ç»˜åˆ¶å†²å‡»æ³¢æ•ˆæœ
            drawShockwaves();

            ctx.restore(); // ç»“æŸå±å¹•éœ‡åŠ¨

            // ç»˜åˆ¶æµ®åŠ¨æ–‡å­—
            if (window.floatingTexts) {
                window.floatingTexts.forEach(ft => {
                    ctx.save();
                    ctx.globalAlpha = ft.alpha;
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = ft.color;
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 3;
                    ctx.strokeText(ft.text, ft.x, ft.y);
                    ctx.fillText(ft.text, ft.x, ft.y);
                    ctx.restore();

                    ft.y += ft.vy;
                    ft.life--;
                    ft.alpha = Math.max(0, ft.life / 60);
                });
                window.floatingTexts = window.floatingTexts.filter(ft => ft.life > 0);
            }

            // ç»˜åˆ¶å¤§å‹æ–‡å­—æç¤ºï¼ˆå±å¹•ä¸­å¤®ï¼‰
            drawBigTexts();
        }

        // ç»˜åˆ¶æ‰è½ç‰©ä½“ - è¶…çº§å¯çˆ±ç‰ˆæœ¬ï¼
        function drawFallingObject(fo) {
            ctx.save();
            ctx.translate(fo.x, fo.y);

            // åŠ¨æ€æ—‹è½¬æ•ˆæœ
            const wobble = Math.sin(frameCount * 0.2) * 0.1;
            ctx.rotate(fo.rotation + wobble);

            if (fo.type === 'bad') {
                // ====== è¶…å¤§ç«ç„°é™¨çŸ³ï¼======
                const meteorSize = fo.size * 1.5; // æ”¾å¤§50%

                // è¶…é•¿ç«ç„°å°¾å·´ - å¤šå±‚æ¸å˜
                for (let i = 5; i >= 0; i--) {
                    const tailAlpha = 0.8 - i * 0.12;
                    ctx.fillStyle = `rgba(255, ${100 + i * 30}, 0, ${tailAlpha})`;
                    ctx.beginPath();
                    const tailWidth = meteorSize * (0.8 - i * 0.1);
                    const tailHeight = meteorSize * (1.5 + i * 0.8);
                    ctx.moveTo(-tailWidth, 0);
                    ctx.quadraticCurveTo(-tailWidth * 0.5, -tailHeight * 0.5, 0, -tailHeight);
                    ctx.quadraticCurveTo(tailWidth * 0.5, -tailHeight * 0.5, tailWidth, 0);
                    ctx.closePath();
                    ctx.fill();
                }

                // é™¨çŸ³ä¸»ä½“ - å²©çŸ³è´¨æ„Ÿ
                const bombGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, meteorSize);
                bombGrad.addColorStop(0, '#FF8844');
                bombGrad.addColorStop(0.3, '#DD4422');
                bombGrad.addColorStop(0.7, '#AA2211');
                bombGrad.addColorStop(1, '#661100');
                ctx.fillStyle = bombGrad;
                ctx.beginPath();
                // ä¸è§„åˆ™é™¨çŸ³å½¢çŠ¶
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const r = meteorSize * (0.8 + Math.sin(i * 3) * 0.2);
                    if (i === 0) ctx.moveTo(Math.cos(angle) * r, Math.sin(angle) * r);
                    else ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
                }
                ctx.closePath();
                ctx.fill();

                // é™¨çŸ³å…‰æ™•
                ctx.shadowColor = '#FF4400';
                ctx.shadowBlur = 30;
                ctx.strokeStyle = '#FF6600';
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.shadowBlur = 0;

                // æ„¤æ€’å¡é€šè¡¨æƒ…
                ctx.fillStyle = '#FFFF00';
                // æ€’çœ¼
                ctx.beginPath();
                ctx.ellipse(-meteorSize * 0.25, -meteorSize * 0.1, 6, 8, 0, 0, Math.PI * 2);
                ctx.ellipse(meteorSize * 0.25, -meteorSize * 0.1, 6, 8, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-meteorSize * 0.25, -meteorSize * 0.1, 3, 0, Math.PI * 2);
                ctx.arc(meteorSize * 0.25, -meteorSize * 0.1, 3, 0, Math.PI * 2);
                ctx.fill();
                // æ„¤æ€’çœ‰æ¯›
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(-meteorSize * 0.4, -meteorSize * 0.3);
                ctx.lineTo(-meteorSize * 0.1, -meteorSize * 0.2);
                ctx.moveTo(meteorSize * 0.4, -meteorSize * 0.3);
                ctx.lineTo(meteorSize * 0.1, -meteorSize * 0.2);
                ctx.stroke();
                // å¼ å˜´
                ctx.fillStyle = '#330000';
                ctx.beginPath();
                ctx.ellipse(0, meteorSize * 0.25, meteorSize * 0.25, meteorSize * 0.15, 0, 0, Math.PI);
                ctx.fill();

                // ç«èŠ±ç²’å­æ•ˆæœ
                ctx.fillStyle = '#FFFF00';
                for (let i = 0; i < 5; i++) {
                    const sparkX = (Math.random() - 0.5) * meteorSize * 2;
                    const sparkY = -meteorSize - Math.random() * meteorSize * 2;
                    ctx.beginPath();
                    ctx.arc(sparkX, sparkY, 2 + Math.random() * 3, 0, Math.PI * 2);
                    ctx.fill();
                }

            } else {
                // ====== è¶…çº§å¯çˆ±æ˜Ÿæ˜Ÿï¼======
                const starSize = fo.size * 1.5; // æ”¾å¤§50%

                // å½©è™¹å°¾å·´
                const colors = ['#FF6B9D', '#FFD93D', '#6BCB77', '#4D96FF', '#9B59B6'];
                for (let i = 0; i < 8; i++) {
                    ctx.fillStyle = colors[i % colors.length];
                    ctx.globalAlpha = 0.8 - i * 0.08;
                    ctx.beginPath();
                    ctx.arc((Math.sin(i * 0.5) * 5), -starSize - i * 12, 8 - i * 0.8, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1;

                // æ˜Ÿæ˜Ÿå…‰æ™•
                ctx.shadowColor = '#FFD700';
                ctx.shadowBlur = 40;

                // å¤§æ˜Ÿæ˜Ÿä¸»ä½“
                ctx.fillStyle = '#FFD700';
                drawStarShape(ctx, 0, 0, 5, starSize, starSize * 0.5);

                // æ˜Ÿæ˜Ÿæ¸å˜å†…å±‚
                const starGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, starSize);
                starGrad.addColorStop(0, '#FFFFFF');
                starGrad.addColorStop(0.3, '#FFFF88');
                starGrad.addColorStop(1, '#FFD700');
                ctx.fillStyle = starGrad;
                drawStarShape(ctx, 0, 0, 5, starSize * 0.8, starSize * 0.4);

                ctx.shadowBlur = 0;

                // å¯çˆ±ç¬‘è„¸
                ctx.fillStyle = '#000';
                // çœ¼ç› - é—ªäº®å¤§çœ¼
                ctx.beginPath();
                ctx.ellipse(-starSize * 0.2, -starSize * 0.1, 5, 6, 0, 0, Math.PI * 2);
                ctx.ellipse(starSize * 0.2, -starSize * 0.1, 5, 6, 0, 0, Math.PI * 2);
                ctx.fill();
                // çœ¼ç›é«˜å…‰
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(-starSize * 0.2 - 1, -starSize * 0.1 - 2, 2, 0, Math.PI * 2);
                ctx.arc(starSize * 0.2 - 1, -starSize * 0.1 - 2, 2, 0, Math.PI * 2);
                ctx.fill();
                // è…®çº¢
                ctx.fillStyle = 'rgba(255, 150, 150, 0.6)';
                ctx.beginPath();
                ctx.ellipse(-starSize * 0.35, starSize * 0.1, 6, 4, 0, 0, Math.PI * 2);
                ctx.ellipse(starSize * 0.35, starSize * 0.1, 6, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                // å¾®ç¬‘
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, starSize * 0.1, starSize * 0.2, 0.1 * Math.PI, 0.9 * Math.PI);
                ctx.stroke();

                // é—ªçƒå°æ˜Ÿæ˜Ÿ
                ctx.fillStyle = '#FFFFFF';
                for (let i = 0; i < 6; i++) {
                    const angle = (i / 6) * Math.PI * 2 + frameCount * 0.05;
                    const dist = starSize * 1.5 + Math.sin(frameCount * 0.1 + i) * 10;
                    const sx = Math.cos(angle) * dist;
                    const sy = Math.sin(angle) * dist;
                    ctx.globalAlpha = 0.5 + Math.sin(frameCount * 0.2 + i) * 0.5;
                    drawStarShape(ctx, sx, sy, 4, 5, 2);
                }
                ctx.globalAlpha = 1;
            }

            ctx.restore();
        }

        // è¾…åŠ©å‡½æ•°ï¼šç»˜åˆ¶æ˜Ÿå½¢
        function drawStarShape(ctx, cx, cy, spikes, outerR, innerR) {
            let rot = Math.PI / 2 * 3;
            let step = Math.PI / spikes;
            ctx.beginPath();
            ctx.moveTo(cx, cy - outerR);
            for (let i = 0; i < spikes; i++) {
                let x = cx + Math.cos(rot) * outerR;
                let y = cy + Math.sin(rot) * outerR;
                ctx.lineTo(x, y);
                rot += step;
                x = cx + Math.cos(rot) * innerR;
                y = cy + Math.sin(rot) * innerR;
                ctx.lineTo(x, y);
                rot += step;
            }
            ctx.lineTo(cx, cy - outerR);
            ctx.closePath();
            ctx.fill();
        }

        function drawBackground() {
            // æ ¹æ®å½“å‰åœºæ™¯ç»˜åˆ¶ä¸åŒèƒŒæ™¯
            switch(currentScene) {
                case 'policestation':
                    drawPoliceStationScene();
                    break;
                case 'catjail':
                    drawCatJailScene();
                    break;
                case 'secretlab':
                    drawSecretLabScene();
                    break;
                default:
                    drawCityScene();
            }
        }

        // åŸå¸‚åœºæ™¯ (Dog Man é£æ ¼ - ç½ªæ¶ä¹‹åŸæ°›å›´)
        function drawCityScene() {
            // é»„æ˜/å¤œæ™šå¤©ç©ºæ¸å˜ - ç½ªæ¶ä¹‹åŸæ°›å›´
            const skyGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            skyGrad.addColorStop(0, '#1a1a2e');
            skyGrad.addColorStop(0.3, '#16213e');
            skyGrad.addColorStop(0.5, '#1f4068');
            skyGrad.addColorStop(0.7, '#e43f5a');
            skyGrad.addColorStop(1, '#162447');
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // æœˆäº® (ç½ªæ¶ä¹‹åŸçš„æœˆå…‰)
            ctx.save();
            ctx.fillStyle = '#F5F5DC';
            ctx.shadowColor = '#FFFACD';
            ctx.shadowBlur = 40;
            ctx.beginPath();
            ctx.arc(820, 80, 30, 0, Math.PI * 2);
            ctx.fill();
            // æœˆäº®é˜´å½±
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#1a1a2e';
            ctx.beginPath();
            ctx.arc(830, 75, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();

            // æ˜Ÿæ˜Ÿ
            ctx.fillStyle = '#FFFFFF';
            const stars = [[50, 40], [120, 80], [200, 30], [350, 60], [450, 25], [550, 70], [650, 45], [750, 90]];
            stars.forEach(([x, y]) => {
                ctx.globalAlpha = 0.5 + Math.sin(frameCount * 0.1 + x) * 0.3;
                ctx.beginPath();
                ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // è¿œæ™¯åŸå¸‚å‰ªå½±
            ctx.fillStyle = '#0f0f23';
            // åæ’å»ºç­‘å‰ªå½±
            for (let i = 150; i < 500; i += 35) {
                const h = 80 + Math.sin(i * 0.1) * 40;
                ctx.fillRect(i, GROUND_Y - h - 50, 30, h + 50);
            }

            // ä¸­æ™¯å»ºç­‘ - Dav Pilkeyæ­ªæ–œé£æ ¼ + éœ“è™¹ç¯æ•ˆæœ
            drawNeonBuilding(180, GROUND_Y, 55, 200, '#2d3436', '#e74c3c');
            drawNeonBuilding(250, GROUND_Y, 50, 160, '#2d3436', '#3498db');
            drawNeonBuilding(315, GROUND_Y, 60, 220, '#2d3436', '#9b59b6');
            drawNeonBuilding(390, GROUND_Y, 45, 140, '#2d3436', '#f39c12');
            drawNeonBuilding(450, GROUND_Y, 55, 180, '#2d3436', '#1abc9c');

            // è­¦å‘Šæ ‡å¿— (CRIMEåŒºåŸŸ)
            ctx.save();
            ctx.fillStyle = '#e74c3c';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CRIME ZONE', 700, 250);
            ctx.restore();

            // è·¯ç¯
            drawStreetLamp(160, GROUND_Y);

            // è¡—é“ (æ·±è‰²æŸæ²¹è·¯)
            const streetGrad = ctx.createLinearGradient(0, GROUND_Y, 0, GROUND_Y + 50);
            streetGrad.addColorStop(0, '#2c3e50');
            streetGrad.addColorStop(0.5, '#34495e');
            streetGrad.addColorStop(1, '#2c3e50');
            ctx.fillStyle = streetGrad;
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);

            // è¡—é“ä¸­çº¿
            ctx.strokeStyle = '#f1c40f';
            ctx.lineWidth = 3;
            ctx.setLineDash([20, 15]);
            ctx.beginPath();
            ctx.moveTo(0, GROUND_Y + 25);
            ctx.lineTo(canvas.width, GROUND_Y + 25);
            ctx.stroke();
            ctx.setLineDash([]);

            // äººè¡Œé“è¾¹ç¼˜
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(0, GROUND_Y, canvas.width, 8);

            // å·¦è¾¹è‰åœ°åŒºåŸŸ (å¼¹å¼“æ‰€åœ¨åœ°)
            ctx.fillStyle = '#1e3d2f';
            ctx.fillRect(0, GROUND_Y, 170, 50);
            // æš—è‰²è‰åœ°
            ctx.strokeStyle = '#2d5a3f';
            ctx.lineWidth = 2;
            for (let i = 0; i < 170; i += 15) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND_Y);
                ctx.quadraticCurveTo(i + 4, GROUND_Y - 10, i + 8, GROUND_Y - 6);
                ctx.stroke();
            }

            // é›¾æ°”æ•ˆæœ
            ctx.fillStyle = 'rgba(100, 100, 120, 0.15)';
            ctx.fillRect(0, GROUND_Y - 80, canvas.width, 80);
        }

        // éœ“è™¹ç¯é£æ ¼å»ºç­‘
        function drawNeonBuilding(x, groundY, width, height, buildingColor, neonColor) {
            ctx.save();
            const wobble = Math.sin(x * 0.05) * 4;
            ctx.translate(x, groundY);
            ctx.transform(1, 0, wobble * 0.008, 1, 0, 0);

            // å»ºç­‘ä¸»ä½“ (æ·±è‰²)
            ctx.fillStyle = buildingColor;
            ctx.beginPath();
            ctx.moveTo(wobble, 0);
            ctx.lineTo(wobble - 2, -height + 8);
            ctx.lineTo(width + wobble + 2, -height + 8);
            ctx.lineTo(width + wobble, 0);
            ctx.closePath();
            ctx.fill();

            // éœ“è™¹ç¯è¾¹æ¡†
            ctx.strokeStyle = neonColor;
            ctx.shadowColor = neonColor;
            ctx.shadowBlur = 10;
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.shadowBlur = 0;

            // å‘å…‰çª—æˆ·
            ctx.fillStyle = 'rgba(255, 255, 200, 0.7)';
            for (let row = 0; row < Math.floor(height / 40); row++) {
                for (let col = 0; col < 2; col++) {
                    // éšæœºå†³å®šçª—æˆ·æ˜¯å¦äº®ç€
                    if (Math.sin(x + row * 3 + col * 7 + frameCount * 0.01) > -0.3) {
                        const wx = 10 + col * (width / 2 - 8) + wobble;
                        const wy = -height + 25 + row * 40;
                        ctx.fillStyle = `rgba(255, 255, ${150 + Math.sin(frameCount * 0.05 + row) * 50}, 0.8)`;
                        ctx.fillRect(wx, wy, 14, 18);
                    }
                }
            }

            // å±‹é¡¶éœ“è™¹æ‹›ç‰Œ (éšæœº)
            if (Math.sin(x) > 0) {
                ctx.fillStyle = neonColor;
                ctx.shadowColor = neonColor;
                ctx.shadowBlur = 8;
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                const signs = ['BAR', 'HOTEL', '24H', 'OPEN', 'CLUB'];
                ctx.fillText(signs[Math.floor(x / 50) % signs.length], width / 2 + wobble, -height - 5);
                ctx.shadowBlur = 0;
            }

            ctx.restore();
        }

        // è·¯ç¯
        function drawStreetLamp(x, groundY) {
            ctx.save();
            // ç¯æŸ±
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(x - 3, groundY - 120, 6, 120);

            // ç¯å¤´
            ctx.fillStyle = '#34495e';
            ctx.beginPath();
            ctx.moveTo(x - 15, groundY - 120);
            ctx.lineTo(x + 15, groundY - 120);
            ctx.lineTo(x + 10, groundY - 130);
            ctx.lineTo(x - 10, groundY - 130);
            ctx.closePath();
            ctx.fill();

            // ç¯å…‰æ•ˆæœ
            ctx.fillStyle = '#f39c12';
            ctx.shadowColor = '#f39c12';
            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.arc(x, groundY - 125, 8, 0, Math.PI * 2);
            ctx.fill();

            // åœ°é¢å…‰åœˆ
            ctx.shadowBlur = 0;
            const lightGrad = ctx.createRadialGradient(x, groundY, 0, x, groundY, 60);
            lightGrad.addColorStop(0, 'rgba(243, 156, 18, 0.3)');
            lightGrad.addColorStop(1, 'rgba(243, 156, 18, 0)');
            ctx.fillStyle = lightGrad;
            ctx.beginPath();
            ctx.ellipse(x, groundY + 5, 60, 15, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        // è­¦å¯Ÿå±€åœºæ™¯
        function drawPoliceStationScene() {
            // å®¤å†…èƒŒæ™¯
            const wallGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            wallGrad.addColorStop(0, '#ECEFF1');
            wallGrad.addColorStop(1, '#CFD8DC');
            ctx.fillStyle = wallGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // è­¦å¯Ÿå±€æ ‡å¿—
            ctx.fillStyle = '#1565C0';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('POLICE STATION', 450, 50);

            // è­¦å¾½
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(450, 90, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#1565C0';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('â˜…', 450, 96);

            // å¢™ä¸Šçš„æµ·æŠ¥ (Dog Mané€šç¼‰ä»¤)
            ctx.fillStyle = '#FFF9C4';
            ctx.fillRect(100, 100, 80, 100);
            ctx.strokeStyle = '#5D4037';
            ctx.lineWidth = 2;
            ctx.strokeRect(100, 100, 80, 100);
            ctx.fillStyle = '#D32F2F';
            ctx.font = 'bold 10px Arial';
            ctx.fillText('WANTED', 140, 120);
            ctx.font = '8px Arial';
            ctx.fillStyle = '#5D4037';
            ctx.fillText('PETEY', 140, 180);

            // Chiefçš„ç»¿è‰²æ²™å‘ (Dog Manç»å…¸åœºæ™¯)
            ctx.fillStyle = '#2E7D32';
            ctx.beginPath();
            ctx.roundRect(680, GROUND_Y - 80, 120, 60, 10);
            ctx.fill();
            ctx.fillStyle = '#1B5E20';
            ctx.beginPath();
            ctx.roundRect(680, GROUND_Y - 85, 120, 20, 5);
            ctx.fill();
            // æ²™å‘æ‰¶æ‰‹
            ctx.fillStyle = '#2E7D32';
            ctx.beginPath();
            ctx.roundRect(670, GROUND_Y - 70, 20, 50, 8);
            ctx.fill();
            ctx.beginPath();
            ctx.roundRect(790, GROUND_Y - 70, 20, 50, 8);
            ctx.fill();

            // æ–‡ä»¶æŸœ
            ctx.fillStyle = '#78909C';
            ctx.fillRect(50, GROUND_Y - 150, 60, 150);
            ctx.strokeStyle = '#455A64';
            ctx.lineWidth = 1;
            for (let i = 0; i < 4; i++) {
                ctx.strokeRect(52, GROUND_Y - 148 + i * 36, 56, 34);
                ctx.fillStyle = '#37474F';
                ctx.fillRect(75, GROUND_Y - 135 + i * 36, 10, 5);
            }

            // åœ°æ¿
            ctx.fillStyle = '#8D6E63';
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);
            // åœ°æ¿çº¹ç†
            ctx.strokeStyle = '#6D4C41';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND_Y);
                ctx.lineTo(i, GROUND_Y + 50);
                ctx.stroke();
            }
        }

        // çŒ«ç›‘ç‹±åœºæ™¯
        function drawCatJailScene() {
            // ç°è‰²ç›‘ç‹±èƒŒæ™¯
            const wallGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            wallGrad.addColorStop(0, '#9E9E9E');
            wallGrad.addColorStop(1, '#757575');
            ctx.fillStyle = wallGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // ç›‘ç‹±æ ‡å¿—
            ctx.fillStyle = '#D32F2F';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CAT JAIL', 450, 50);

            // é“æ æ†
            ctx.strokeStyle = '#424242';
            ctx.lineWidth = 8;
            for (let i = 50; i < canvas.width - 50; i += 45) {
                ctx.beginPath();
                ctx.moveTo(i, 80);
                ctx.lineTo(i, GROUND_Y - 20);
                ctx.stroke();
            }
            // æ¨ªæ†
            ctx.beginPath();
            ctx.moveTo(50, 120);
            ctx.lineTo(canvas.width - 50, 120);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(50, GROUND_Y - 50);
            ctx.lineTo(canvas.width - 50, GROUND_Y - 50);
            ctx.stroke();

            // è··è··æ¿ (Peteyé€ƒè·‘ç”¨çš„)
            ctx.fillStyle = '#8D6E63';
            ctx.save();
            ctx.translate(200, GROUND_Y - 20);
            ctx.rotate(frameCount * 0.002);
            ctx.fillRect(-50, -5, 100, 10);
            ctx.restore();
            // æ”¯ç‚¹
            ctx.fillStyle = '#5D4037';
            ctx.beginPath();
            ctx.moveTo(190, GROUND_Y);
            ctx.lineTo(200, GROUND_Y - 20);
            ctx.lineTo(210, GROUND_Y);
            ctx.closePath();
            ctx.fill();

            // æ°´æ³¥åœ°
            ctx.fillStyle = '#616161';
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);
            // è£‚ç¼
            ctx.strokeStyle = '#424242';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(100, GROUND_Y + 10);
            ctx.lineTo(150, GROUND_Y + 30);
            ctx.lineTo(180, GROUND_Y + 20);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(400, GROUND_Y + 5);
            ctx.lineTo(450, GROUND_Y + 25);
            ctx.stroke();
        }

        // ç§˜å¯†å®éªŒå®¤åœºæ™¯
        function drawSecretLabScene() {
            // é»‘æš—ç§‘æŠ€èƒŒæ™¯
            const labGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
            labGrad.addColorStop(0, '#1A237E');
            labGrad.addColorStop(1, '#0D47A1');
            ctx.fillStyle = labGrad;
            ctx.fillRect(0, 0, canvas.width, GROUND_Y);

            // ç§‘æŠ€ç½‘æ ¼
            ctx.strokeStyle = 'rgba(33, 150, 243, 0.3)';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, GROUND_Y);
                ctx.stroke();
            }
            for (let i = 0; i < GROUND_Y; i += 40) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }

            // å®éªŒå®¤æ ‡å¿—
            ctx.fillStyle = '#F44336';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText("PETEY'S SECRET LAB", 450, 50);

            // ç”µè„‘å±å¹•
            ctx.fillStyle = '#263238';
            ctx.fillRect(60, 150, 100, 80);
            ctx.fillStyle = '#00E676';
            ctx.fillRect(65, 155, 90, 70);
            // ä»£ç æ•ˆæœ
            ctx.fillStyle = '#1B5E20';
            ctx.font = '8px monospace';
            for (let i = 0; i < 6; i++) {
                ctx.fillText('> EVIL PLAN ' + (i + 1), 70, 165 + i * 10);
            }

            // è¯•ç®¡æ¶
            ctx.fillStyle = '#5D4037';
            ctx.fillRect(750, 200, 80, 10);
            // å†’æ³¡è¯•ç®¡
            const tubeColors = ['#4CAF50', '#9C27B0', '#FF9800'];
            tubeColors.forEach((color, i) => {
                ctx.fillStyle = 'rgba(200,200,200,0.3)';
                ctx.fillRect(760 + i * 25, 120, 15, 80);
                ctx.fillStyle = color;
                ctx.fillRect(762 + i * 25, 150 + Math.sin(frameCount * 0.1 + i) * 10, 11, 48);
                // æ°”æ³¡
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.beginPath();
                ctx.arc(767 + i * 25, 160 - (frameCount + i * 20) % 40, 3, 0, Math.PI * 2);
                ctx.fill();
            });

            // é‡‘å±åœ°æ¿
            ctx.fillStyle = '#37474F';
            ctx.fillRect(0, GROUND_Y, canvas.width, 50);
            // é‡‘å±æ¿
            for (let i = 0; i < canvas.width; i += 50) {
                ctx.strokeStyle = '#263238';
                ctx.lineWidth = 2;
                ctx.strokeRect(i, GROUND_Y, 50, 50);
                ctx.fillStyle = '#455A64';
                ctx.beginPath();
                ctx.arc(i + 5, GROUND_Y + 5, 3, 0, Math.PI * 2);
                ctx.arc(i + 45, GROUND_Y + 5, 3, 0, Math.PI * 2);
                ctx.arc(i + 5, GROUND_Y + 45, 3, 0, Math.PI * 2);
                ctx.arc(i + 45, GROUND_Y + 45, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Dav Pilkeyé£æ ¼çš„æ­ªæ–œå»ºç­‘
        function drawWobblyBuilding(x, groundY, width, height, color1, color2) {
            ctx.save();
            // æ­ªæ–œæ•ˆæœ
            const wobble = Math.sin(x * 0.05) * 3;
            ctx.translate(x, groundY);
            ctx.transform(1, 0, wobble * 0.01, 1, 0, 0);

            // å»ºç­‘ä¸»ä½“
            const buildGrad = ctx.createLinearGradient(0, -height, width, 0);
            buildGrad.addColorStop(0, color1);
            buildGrad.addColorStop(1, color2);
            ctx.fillStyle = buildGrad;

            // æ­ªæ­ªæ‰­æ‰­çš„è½®å»“
            ctx.beginPath();
            ctx.moveTo(wobble, 0);
            ctx.lineTo(wobble - 2, -height + 10);
            ctx.quadraticCurveTo(width / 2 + wobble, -height - 5, width + wobble + 2, -height + 10);
            ctx.lineTo(width + wobble, 0);
            ctx.closePath();
            ctx.fill();

            // è¾¹æ¡†
            ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            ctx.lineWidth = 2;
            ctx.stroke();

            // ä¸è§„åˆ™çª—æˆ· (Dav Pilkeyé£æ ¼)
            ctx.fillStyle = 'rgba(255,255,200,0.8)';
            for (let row = 0; row < Math.floor(height / 35); row++) {
                for (let col = 0; col < 2; col++) {
                    const wx = 8 + col * (width / 2 - 5) + Math.random() * 3;
                    const wy = -height + 20 + row * 35 + Math.random() * 3;
                    const ww = 12 + Math.random() * 4;
                    const wh = 15 + Math.random() * 5;
                    ctx.fillRect(wx + wobble, wy, ww, wh);
                }
            }

            ctx.restore();
        }

        // æ­ªæ­ªæ‰­æ‰­çš„äº‘æœµ
        function drawWobblyCloud(x, y, size) {
            ctx.save();
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            ctx.beginPath();
            // ä¸è§„åˆ™çš„åœ†å½¢ç»„æˆäº‘æœµ
            ctx.arc(x, y, size * 0.45, 0, Math.PI * 2);
            ctx.arc(x + size * 0.35, y - size * 0.15, size * 0.38, 0, Math.PI * 2);
            ctx.arc(x + size * 0.65, y - size * 0.05, size * 0.42, 0, Math.PI * 2);
            ctx.arc(x + size * 0.45, y + size * 0.12, size * 0.32, 0, Math.PI * 2);
            ctx.arc(x + size * 0.15, y + size * 0.08, size * 0.28, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        // è‰åœ°
        function drawGrass(startX, endX) {
            ctx.strokeStyle = '#2E7D32';
            ctx.lineWidth = 2;
            for (let i = startX; i < endX; i += 12) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND_Y);
                ctx.quadraticCurveTo(i + 3, GROUND_Y - 12, i + 6, GROUND_Y - 8);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(i + 6, GROUND_Y);
                ctx.quadraticCurveTo(i + 8, GROUND_Y - 8, i + 10, GROUND_Y - 5);
                ctx.stroke();
            }
        }

        function drawSlingshot() {
            ctx.save();

            // ========================================
            // ç»˜åˆ¶ Dog Man æ“ä½œå‘˜ (ç«™åœ¨å¼¹å¼“åé¢)
            // ========================================
            drawDogManOperator();

            // ========================================
            // Dog Man é£æ ¼éª¨å¤´å¼¹å¼“
            // ========================================
            const slingshotX = SLINGSHOT_X;
            const slingshotY = SLINGSHOT_Y;

            // éª¨å¤´é¢œè‰²æ¸å˜
            const boneGrad = ctx.createLinearGradient(slingshotX - 35, 0, slingshotX + 35, 0);
            boneGrad.addColorStop(0, '#F5F5DC');
            boneGrad.addColorStop(0.3, '#FFFAF0');
            boneGrad.addColorStop(0.5, '#FFFFFF');
            boneGrad.addColorStop(0.7, '#FFFAF0');
            boneGrad.addColorStop(1, '#F5F5DC');

            // å·¦è¾¹éª¨å¤´å‰ (Yå½¢å·¦è‡‚)
            ctx.fillStyle = boneGrad;
            ctx.strokeStyle = '#D2B48C';
            ctx.lineWidth = 2;

            // å·¦éª¨å¤´çƒç«¯
            ctx.beginPath();
            ctx.arc(slingshotX - 32, slingshotY - 60, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            // å·¦éª¨å¤´å°çƒ
            ctx.beginPath();
            ctx.arc(slingshotX - 38, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.arc(slingshotX - 26, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // å³éª¨å¤´çƒç«¯
            ctx.beginPath();
            ctx.arc(slingshotX + 32, slingshotY - 60, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            // å³éª¨å¤´å°çƒ
            ctx.beginPath();
            ctx.arc(slingshotX + 38, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.arc(slingshotX + 26, slingshotY - 55, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // éª¨å¤´æ”¯æ¶ä¸»ä½“
            ctx.lineWidth = 14;
            ctx.strokeStyle = boneGrad;
            ctx.lineCap = 'round';

            // å·¦éª¨å¤´è‡‚
            ctx.beginPath();
            ctx.moveTo(slingshotX - 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX - 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();

            // å³éª¨å¤´è‡‚
            ctx.beginPath();
            ctx.moveTo(slingshotX + 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX + 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();

            // éª¨å¤´è¾¹æ¡†
            ctx.strokeStyle = '#D2B48C';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(slingshotX - 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX - 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(slingshotX + 28, slingshotY - 50);
            ctx.quadraticCurveTo(slingshotX + 12, slingshotY - 25, slingshotX, slingshotY - 5);
            ctx.stroke();

            // åº•éƒ¨éª¨å¤´æ”¯æŸ±
            ctx.fillStyle = boneGrad;
            ctx.beginPath();
            ctx.ellipse(slingshotX, slingshotY, 10, 14, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#D2B48C';
            ctx.lineWidth = 2;
            ctx.stroke();

            // æ”¯æŸ±
            ctx.fillStyle = boneGrad;
            ctx.fillRect(slingshotX - 8, slingshotY + 5, 16, GROUND_Y - slingshotY - 15);
            ctx.strokeStyle = '#D2B48C';
            ctx.strokeRect(slingshotX - 8, slingshotY + 5, 16, GROUND_Y - slingshotY - 15);

            // åº•éƒ¨éª¨å¤´çƒ
            ctx.fillStyle = boneGrad;
            ctx.beginPath();
            ctx.arc(slingshotX, GROUND_Y - 8, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(slingshotX - 10, GROUND_Y - 3, 5, 0, Math.PI * 2);
            ctx.arc(slingshotX + 10, GROUND_Y - 3, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // è­¦å¾½è£…é¥° (åœ¨å¼¹å¼“ä¸­é—´)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(slingshotX, slingshotY + 30, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#1E3A5F';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('â˜…', slingshotX, slingshotY + 30);

            ctx.restore();

            // ========================================
            // çº¢è‰²æ©¡çš®ç­‹ (Dog Man çš„é¡¹åœˆé¢œè‰²)
            // ========================================
            if (projectile && (gameState === 'ready' || gameState === 'aiming')) {
                ctx.save();

                // çš®ç­‹ä¸»ä½“ - çº¢è‰² (åƒç‹—é¡¹åœˆ)
                const bandGrad = ctx.createLinearGradient(slingshotX - 30, slingshotY - 60, projectile.x, projectile.y);
                bandGrad.addColorStop(0, '#C41E3A');
                bandGrad.addColorStop(0.5, '#DC143C');
                bandGrad.addColorStop(1, '#8B0000');

                ctx.strokeStyle = bandGrad;
                ctx.lineWidth = 6;
                ctx.lineCap = 'round';

                // å·¦æ©¡çš®ç­‹
                ctx.beginPath();
                ctx.moveTo(slingshotX - 32, slingshotY - 58);
                ctx.lineTo(projectile.x, projectile.y);
                ctx.stroke();

                // å³æ©¡çš®ç­‹
                ctx.beginPath();
                ctx.moveTo(slingshotX + 32, slingshotY - 58);
                ctx.lineTo(projectile.x, projectile.y);
                ctx.stroke();

                // é«˜å…‰æ•ˆæœ
                ctx.strokeStyle = 'rgba(255,150,150,0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(slingshotX - 30, slingshotY - 56);
                ctx.lineTo(projectile.x + 2, projectile.y - 2);
                ctx.stroke();

                ctx.restore();
            }
        }

        // Dog Man æ“ä½œå‘˜ - ç«™åœ¨å¼¹å¼“åé¢æ‹‰å¼¹å¼“
        // è­¦å¯Ÿå±€é•¿ Chief - Dav Pilkeyç®€ç¬”ç”»é£æ ¼
        // Chiefæ˜¯äººç±»ï¼Œä¸æ˜¯ç‹—ï¼ç®€å•çš„ç«æŸ´äººé£æ ¼
        function drawDogManOperator() {
            const opX = SLINGSHOT_X - 45;
            const opY = GROUND_Y;
            const scale = 0.9;

            ctx.save();
            ctx.translate(opX, opY);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // ===== èº«ä½“ (è“è‰²è­¦æœ - ç®€å•çŸ©å½¢) =====
            ctx.fillStyle = '#4169E1';
            ctx.beginPath();
            ctx.rect(-18 * scale, -70 * scale, 36 * scale, 55 * scale);
            ctx.fill();
            ctx.stroke();

            // è…¿ (ç®€å•çš„ä¸¤æ¡çº¿/çŸ©å½¢)
            ctx.fillStyle = '#4169E1';
            ctx.fillRect(-14 * scale, -18 * scale, 10 * scale, 22 * scale);
            ctx.strokeRect(-14 * scale, -18 * scale, 10 * scale, 22 * scale);
            ctx.fillRect(4 * scale, -18 * scale, 10 * scale, 22 * scale);
            ctx.strokeRect(4 * scale, -18 * scale, 10 * scale, 22 * scale);

            // é‹å­ (ç®€å•çš„é»‘è‰²æ¤­åœ†)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-9 * scale, 2 * scale, 8 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.ellipse(9 * scale, 2 * scale, 8 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // æ‰‹è‡‚ - å‘å³ä¼¸å±•æ‹‰å¼¹å¼“ (ç®€å•çš„çº¿æ¡)
            ctx.lineWidth = 8 * scale;
            ctx.strokeStyle = '#4169E1';
            ctx.beginPath();
            ctx.moveTo(15 * scale, -55 * scale);
            ctx.lineTo(50 * scale, -45 * scale);
            ctx.stroke();

            // å¦ä¸€åªæ‰‹è‡‚
            ctx.beginPath();
            ctx.moveTo(12 * scale, -45 * scale);
            ctx.lineTo(45 * scale, -35 * scale);
            ctx.stroke();

            // æ‰‹ (è‚¤è‰²åœ†å½¢)
            ctx.fillStyle = '#FFDAB9';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(52 * scale, -42 * scale, 8 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // è­¦å¾½ (é‡‘è‰²åœ†å½¢ + æ˜Ÿæ˜Ÿ)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, -50 * scale, 8 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.stroke();

            // ===== å¤´éƒ¨ (è‚¤è‰²åœ†å½¢ - äººç±»!) =====
            ctx.fillStyle = '#FFDAB9';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -90 * scale, 18 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // çœ¼ç› - Dav Pilkeyé£æ ¼: é«˜ç˜¦çš„é»‘è‰²æ¤­åœ†
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-7 * scale, -93 * scale, 3 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(7 * scale, -93 * scale, 3 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // å˜´å·´ (ç®€å•çš„å¼§çº¿)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -82 * scale, 6 * scale, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();

            // èƒ¡å­ (Chiefæœ‰èƒ¡å­)
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.rect(-8 * scale, -82 * scale, 16 * scale, 6 * scale);
            ctx.fill();

            // è­¦å¸½ (è“è‰²)
            ctx.fillStyle = '#1E3A5F';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            // å¸½æª
            ctx.beginPath();
            ctx.ellipse(0, -105 * scale, 22 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            // å¸½èº«
            ctx.beginPath();
            ctx.rect(-16 * scale, -120 * scale, 32 * scale, 16 * scale);
            ctx.fill();
            ctx.stroke();

            // å¸½å¾½ (é‡‘è‰²)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, -112 * scale, 6 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            ctx.stroke();

            ctx.restore();
        }

        function drawBuddy(buddy) {
            ctx.save();
            ctx.translate(buddy.x, buddy.y);
            ctx.rotate(buddy.rotation || 0);

            // Flippyç´«å…‰åŠ é€Ÿæ•ˆæœ
            if (buddy.boostActive && buddy.type === 'flippy') {
                // å¼ºçƒˆç´«è‰²å…‰æ™•
                ctx.shadowColor = '#E040FB';
                ctx.shadowBlur = 35 + Math.sin(frameCount * 0.2) * 15;

                // å¤šå±‚ç´«è‰²å…‰ç¯
                const pulseSize = 1 + Math.sin(frameCount * 0.15) * 0.2;
                ctx.strokeStyle = '#9C27B0';
                ctx.lineWidth = 4;
                ctx.globalAlpha = 0.5;
                ctx.beginPath();
                ctx.arc(0, 0, buddy.radius * 1.8 * pulseSize, 0, Math.PI * 2);
                ctx.stroke();

                ctx.strokeStyle = '#E040FB';
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.arc(0, 0, buddy.radius * 2.2 * pulseSize, 0, Math.PI * 2);
                ctx.stroke();

                ctx.strokeStyle = '#AA00FF';
                ctx.globalAlpha = 0.2;
                ctx.beginPath();
                ctx.arc(0, 0, buddy.radius * 2.6 * pulseSize, 0, Math.PI * 2);
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
            // æ™®é€šå¤–å‘å…‰æ•ˆæœ
            else if (buddy.special && !buddy.specialUsed && buddy.active) {
                ctx.shadowColor = buddy.type === 'lilpetey' ? '#FFD700' : buddy.type === 'flippy' ? '#9C27B0' : '#00FFFF';
                ctx.shadowBlur = 15 + Math.sin(frameCount * 0.15) * 5;
            }

            // æ ¹æ®è§’è‰²ç±»å‹ç»˜åˆ¶ä¸åŒçš„å½¢è±¡
            switch(buddy.type) {
                case 'dogman':
                    drawDogMan(buddy.radius);
                    break;
                case 'lilpetey':
                    drawLilPetey(buddy.radius);
                    break;
                case '80hd':
                    draw80HD(buddy.radius);
                    break;
                case 'flippy':
                    drawFlippy(buddy.radius);
                    break;
            }

            ctx.restore();
        }

        // Dog Man - Dav Pilkey ç®€ç¬”ç”»é£æ ¼
        // ç‹—å¤´ + äººèº«ï¼Œéå¸¸ç®€å•çš„çº¿æ¡
        function drawDogMan(r) {
            const scale = r / 26;

            // ===== èº«ä½“ (ç®€å•çš„è“è‰²è­¦æœ) =====
            ctx.fillStyle = '#4169E1'; // è­¦æœè“
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // èº«ä½“ - ç®€å•çš„æ¤­åœ†/çŸ©å½¢
            ctx.beginPath();
            ctx.ellipse(0, 10 * scale, 14 * scale, 18 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // é‡‘è‰²è­¦å¾½ (ç®€å•åœ†å½¢)
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, 8 * scale, 5 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ===== ç‹—å¤´ (æµ…æ£•è‰²/ç±³è‰²) =====
            ctx.fillStyle = '#DEB887'; // æµ…æ£•è‰²ç‹—æ¯›
            ctx.beginPath();
            ctx.ellipse(0, -14 * scale, 15 * scale, 13 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ä¸‹å‚çš„ç‹—è€³æœµ (Dav Pilkeyé£æ ¼ - ç®€å•çš„æ¤­åœ†å½¢ä¸‹å‚)
            ctx.fillStyle = '#D2A679';
            ctx.beginPath();
            ctx.ellipse(-14 * scale, -8 * scale, 5 * scale, 12 * scale, 0.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(14 * scale, -8 * scale, 5 * scale, 12 * scale, -0.2, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // å£é¼»éƒ¨ (ç±³è‰²å‡¸èµ·åŒºåŸŸ)
            ctx.fillStyle = '#F5DEB3';
            ctx.beginPath();
            ctx.ellipse(0, -9 * scale, 9 * scale, 7 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // çœ¼ç› - Dav Pilkeyé£æ ¼: é«˜ç˜¦çš„æ¤­åœ†å½¢ï¼Œé»‘è‰²
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-6 * scale, -18 * scale, 2.5 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(6 * scale, -18 * scale, 2.5 * scale, 5 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // é»‘è‰²åœ†é¼»å­
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(0, -12 * scale, 4 * scale, 3 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // å˜´å·´ - ç®€å•çš„å¾®ç¬‘æ›²çº¿
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(0, -6 * scale, 5 * scale, 0.15 * Math.PI, 0.85 * Math.PI);
            ctx.stroke();

            // èˆŒå¤´ (ç²‰çº¢è‰²ï¼Œä¼¸å‡ºæ¥)
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.ellipse(0, -2 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1 * scale;
            ctx.stroke();
        }

        // Li'l Petey - Dav Pilkey ç®€ç¬”ç”»é£æ ¼çš„æ©˜è‰²å°çŒ«
        function drawLilPetey(r) {
            const scale = r / 20;

            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // èº«ä½“ (æ©˜è‰²ï¼Œç®€å•æ¤­åœ†)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.ellipse(0, 8 * scale, 12 * scale, 14 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // èº«ä½“æ¡çº¹ (ç®€å•çš„å‡ æ¡çº¿)
            ctx.strokeStyle = '#BF360C';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.moveTo(-5 * scale, 0);
            ctx.lineTo(-5 * scale, 18 * scale);
            ctx.moveTo(0, -2 * scale);
            ctx.lineTo(0, 18 * scale);
            ctx.moveTo(5 * scale, 0);
            ctx.lineTo(5 * scale, 18 * scale);
            ctx.stroke();

            // å¤§åœ†è„‘è¢‹
            ctx.fillStyle = '#FF9800';
            ctx.strokeStyle = '#000000';
            ctx.beginPath();
            ctx.arc(0, -10 * scale, 13 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ä¸‰è§’è€³æœµ (ç®€å•ä¸‰è§’å½¢)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(-9 * scale, -18 * scale);
            ctx.lineTo(-13 * scale, -30 * scale);
            ctx.lineTo(-3 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(9 * scale, -18 * scale);
            ctx.lineTo(13 * scale, -30 * scale);
            ctx.lineTo(3 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // è€³æœµå†…ç²‰è‰²
            ctx.fillStyle = '#FFAB91';
            ctx.beginPath();
            ctx.moveTo(-8 * scale, -19 * scale);
            ctx.lineTo(-11 * scale, -27 * scale);
            ctx.lineTo(-4 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(8 * scale, -19 * scale);
            ctx.lineTo(11 * scale, -27 * scale);
            ctx.lineTo(4 * scale, -20 * scale);
            ctx.closePath();
            ctx.fill();

            // çœ¼ç› - Dav Pilkeyé£æ ¼: é«˜ç˜¦æ¤­åœ†
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-5 * scale, -12 * scale, 2 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(5 * scale, -12 * scale, 2 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();

            // ç²‰è‰²å°é¼»å­ (å€’ä¸‰è§’)
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.moveTo(0, -8 * scale);
            ctx.lineTo(-3 * scale, -5 * scale);
            ctx.lineTo(3 * scale, -5 * scale);
            ctx.closePath();
            ctx.fill();

            // å˜´å·´ - ç®€å•Wå½¢
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5 * scale;
            ctx.beginPath();
            ctx.moveTo(-4 * scale, -3 * scale);
            ctx.lineTo(-1 * scale, 0);
            ctx.lineTo(1 * scale, -3 * scale);
            ctx.lineTo(4 * scale, 0);
            ctx.stroke();

            // èƒ¡é¡» (æ¯è¾¹3æ ¹ç®€å•ç›´çº¿)
            ctx.lineWidth = 1 * scale;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(-6 * scale, (-6 + i * 3) * scale);
                ctx.lineTo(-15 * scale, (-8 + i * 3) * scale);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(6 * scale, (-6 + i * 3) * scale);
                ctx.lineTo(15 * scale, (-8 + i * 3) * scale);
                ctx.stroke();
            }
        }

        // 80-HD - Dav Pilkey ç®€ç¬”ç”»é£æ ¼çƒå½¢æœºå™¨äºº
        function draw80HD(r) {
            const scale = r / 28;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // æ©™è‰²ä¸‹åŠçƒ
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.arc(0, 0, 20 * scale, 0, Math.PI);
            ctx.fill();
            ctx.stroke();

            // æµ…è“è‰²ä¸ŠåŠçƒ (ç»ç’ƒç½©)
            ctx.fillStyle = '#87CEEB';
            ctx.beginPath();
            ctx.arc(0, 0, 20 * scale, Math.PI, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ç»ç’ƒç½©é«˜å…‰ (ç®€å•ç™½è‰²å¼§çº¿)
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3 * scale;
            ctx.beginPath();
            ctx.arc(-6 * scale, -10 * scale, 6 * scale, Math.PI * 0.8, Math.PI * 1.5);
            ctx.stroke();

            // ä¸­é—´åˆ†å‰²çº¿
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3 * scale;
            ctx.beginPath();
            ctx.moveTo(-20 * scale, 0);
            ctx.lineTo(20 * scale, 0);
            ctx.stroke();

            // çœ¼ç› - ç®€å•çš„ä¸¤ä¸ªé»‘ç‚¹
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-6 * scale, -8 * scale, 3 * scale, 0, Math.PI * 2);
            ctx.arc(6 * scale, -8 * scale, 3 * scale, 0, Math.PI * 2);
            ctx.fill();

            // å¾®ç¬‘
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(0, -3 * scale, 6 * scale, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();

            // æ¡çº¹æ‰‹è‡‚ (å·¦) - ç®€å•çš„æ¡çº¹çŸ©å½¢
            ctx.save();
            ctx.translate(-18 * scale, 5 * scale);
            ctx.rotate(-0.2);
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#BDBDBD' : '#616161';
                ctx.fillRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1 * scale;
                ctx.strokeRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
            }
            ctx.restore();

            // æ¡çº¹æ‰‹è‡‚ (å³)
            ctx.save();
            ctx.translate(18 * scale, 5 * scale);
            ctx.rotate(0.2);
            for (let i = 0; i < 3; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#BDBDBD' : '#616161';
                ctx.fillRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1 * scale;
                ctx.strokeRect(-4 * scale, i * 6 * scale, 8 * scale, 6 * scale);
            }
            ctx.restore();

            // é»‘è‰²äººå­—æ‹– (ç®€å•çš„æ¤­åœ†)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-8 * scale, 22 * scale, 6 * scale, 3 * scale, 0, 0, Math.PI * 2);
            ctx.ellipse(8 * scale, 22 * scale, 6 * scale, 3 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        // Flippy - Dav Pilkey ç®€ç¬”ç”»é£æ ¼çš„é±¼
        // Flippy - æœ‰å¿µåŠ›çš„é‡‘é±¼ (Dav Pilkeyé£æ ¼)
        function drawFlippy(r) {
            const scale = r / 22;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // ===== å¿µåŠ›å…‰ç¯ (ç´«è‰²æ³¢æµª) =====
            const pulseSize = 1 + Math.sin(frameCount * 0.1) * 0.15;
            ctx.strokeStyle = '#9C27B0';
            ctx.lineWidth = 2 * scale;
            // å¤–å±‚å…‰ç¯
            ctx.beginPath();
            ctx.arc(0, 0, 22 * scale * pulseSize, 0, Math.PI * 2);
            ctx.stroke();
            // ä¸­å±‚å…‰ç¯
            ctx.globalAlpha = 0.6;
            ctx.beginPath();
            ctx.arc(0, 0, 26 * scale * pulseSize, 0, Math.PI * 2);
            ctx.stroke();
            // å†…å±‚å…‰ç¯
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            ctx.arc(0, 0, 30 * scale * pulseSize, 0, Math.PI * 2);
            ctx.stroke();
            ctx.globalAlpha = 1;

            // ===== é±¼èº«ä½“ (é‡‘é»„è‰²) =====
            ctx.strokeStyle = '#000000';
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.ellipse(0, 0, 16 * scale, 11 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // é±¼é³çº¹ç† (ç®€å•å¼§çº¿)
            ctx.strokeStyle = '#FFA000';
            ctx.lineWidth = 1 * scale;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc((3 + i * 4) * scale, 2 * scale, (4 - i) * scale, 0.3 * Math.PI, 0.7 * Math.PI);
                ctx.stroke();
            }

            // ===== èƒŒé³ (æ³¢æµªå½¢) =====
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.moveTo(-5 * scale, -9 * scale);
            ctx.quadraticCurveTo(-2 * scale, -18 * scale, 3 * scale, -14 * scale);
            ctx.quadraticCurveTo(6 * scale, -18 * scale, 8 * scale, -9 * scale);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ===== å°¾é³ (ä¼˜é›…çš„åŒå‰) =====
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.moveTo(14 * scale, 0);
            ctx.quadraticCurveTo(20 * scale, -3 * scale, 26 * scale, -10 * scale);
            ctx.quadraticCurveTo(22 * scale, -2 * scale, 24 * scale, 0);
            ctx.quadraticCurveTo(22 * scale, 2 * scale, 26 * scale, 10 * scale);
            ctx.quadraticCurveTo(20 * scale, 3 * scale, 14 * scale, 0);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ===== èƒ¸é³ (å°ç¿…è†€) =====
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.ellipse(-2 * scale, 8 * scale, 5 * scale, 3 * scale, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ===== å¤§çœ¼ç› (å¿µåŠ›é±¼çš„ç‰¹å¾) =====
            // çœ¼ç™½
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.ellipse(-7 * scale, -2 * scale, 7 * scale, 6 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ç³å­” - å¸¦æœ‰å¿µåŠ›å…‰èŠ’
            ctx.fillStyle = '#9C27B0'; // ç´«è‰²ç³å­”ä»£è¡¨å¿µåŠ›
            ctx.beginPath();
            ctx.arc(-7 * scale, -2 * scale, 3.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // ç³å­”ä¸­å¿ƒ
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-7 * scale, -2 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // çœ¼ç›é«˜å…‰
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(-9 * scale, -4 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // ===== å˜´å·´ (Oå½¢æƒŠè®¶çŠ¶) =====
            ctx.fillStyle = '#FF69B4';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.ellipse(-15 * scale, 2 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ===== å¿µåŠ›æ³¢çº¹ (ä»çœ¼ç›å‘å‡º) =====
            if (frameCount % 20 < 10) {
                ctx.strokeStyle = 'rgba(156, 39, 176, 0.5)';
                ctx.lineWidth = 1 * scale;
                for (let i = 1; i <= 3; i++) {
                    ctx.beginPath();
                    ctx.arc(-7 * scale, -2 * scale, (8 + i * 3) * scale, -0.5, 0.5);
                    ctx.stroke();
                }
            }
        }

        // ===== Chief è­¦é•¿ (å†²å‡»æ³¢æŠ€èƒ½) =====
        function drawChief(r) {
            const scale = r / 24;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // èº«ä½“ (è“è‰²è­¦æœ)
            ctx.fillStyle = '#2E86AB';
            ctx.beginPath();
            ctx.ellipse(0, 8 * scale, 14 * scale, 12 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // è­¦å¾½
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(0, 2 * scale);
            for (let i = 0; i < 5; i++) {
                const angle = (i * 144 - 90) * Math.PI / 180;
                const x = Math.cos(angle) * 5 * scale;
                const y = Math.sin(angle) * 5 * scale + 2 * scale;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();

            // å¤´
            ctx.fillStyle = '#FFDAB9';
            ctx.beginPath();
            ctx.arc(0, -8 * scale, 12 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // è­¦å¸½
            ctx.fillStyle = '#1a5276';
            ctx.beginPath();
            ctx.ellipse(0, -18 * scale, 14 * scale, 6 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = '#2E86AB';
            ctx.beginPath();
            ctx.arc(0, -16 * scale, 10 * scale, Math.PI, 0);
            ctx.fill();
            ctx.stroke();

            // å¸½å¾½
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(0, -18 * scale, 3 * scale, 0, Math.PI * 2);
            ctx.fill();

            // çœ¼ç›
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.ellipse(-4 * scale, -10 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.ellipse(4 * scale, -10 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-4 * scale, -10 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.arc(4 * scale, -10 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // å˜´å·´
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(0, -4 * scale, 4 * scale, 0.2, Math.PI - 0.2);
            ctx.stroke();

            // å†²å‡»æ³¢å…‰ç¯ (é—ªçƒ)
            if (frameCount % 30 < 15) {
                ctx.strokeStyle = 'rgba(46, 134, 171, 0.6)';
                ctx.lineWidth = 3 * scale;
                ctx.beginPath();
                ctx.arc(0, 0, 28 * scale, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        // ===== Sarah è®°è€… (å›æ—‹é•–æŠ€èƒ½) =====
        function drawSarah(r) {
            const scale = r / 21;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2 * scale;

            // èº«ä½“ (ç²‰è‰²å¥—è£…)
            ctx.fillStyle = '#E91E63';
            ctx.beginPath();
            ctx.ellipse(0, 8 * scale, 12 * scale, 11 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // éº¦å…‹é£
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.roundRect(-18 * scale, 3 * scale, 8 * scale, 4 * scale, 2 * scale);
            ctx.fill();
            ctx.fillStyle = '#666';
            ctx.beginPath();
            ctx.arc(-21 * scale, 5 * scale, 4 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // å¤´
            ctx.fillStyle = '#FFDAB9';
            ctx.beginPath();
            ctx.arc(0, -8 * scale, 11 * scale, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // å¤´å‘ (æ£•è‰²é•¿å‘)
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.arc(0, -12 * scale, 12 * scale, Math.PI, 0);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(-10 * scale, -2 * scale, 4 * scale, 10 * scale, 0.2, 0, Math.PI * 2);
            ctx.ellipse(10 * scale, -2 * scale, 4 * scale, 10 * scale, -0.2, 0, Math.PI * 2);
            ctx.fill();

            // çœ¼ç›
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.ellipse(-4 * scale, -9 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.ellipse(4 * scale, -9 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = '#4169E1';
            ctx.beginPath();
            ctx.arc(-4 * scale, -9 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.arc(4 * scale, -9 * scale, 1.5 * scale, 0, Math.PI * 2);
            ctx.fill();

            // ç«æ¯›
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1 * scale;
            ctx.beginPath();
            ctx.moveTo(-6 * scale, -13 * scale);
            ctx.lineTo(-7 * scale, -15 * scale);
            ctx.moveTo(-4 * scale, -13 * scale);
            ctx.lineTo(-4 * scale, -15 * scale);
            ctx.moveTo(4 * scale, -13 * scale);
            ctx.lineTo(4 * scale, -15 * scale);
            ctx.moveTo(6 * scale, -13 * scale);
            ctx.lineTo(7 * scale, -15 * scale);
            ctx.stroke();

            // å˜´å·´ (å¾®ç¬‘)
            ctx.strokeStyle = '#C71585';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(0, -4 * scale, 4 * scale, 0.3, Math.PI - 0.3);
            ctx.stroke();

            // å›æ—‹æ•ˆæœ
            const angle = frameCount * 0.1;
            ctx.strokeStyle = 'rgba(233, 30, 99, 0.5)';
            ctx.lineWidth = 2 * scale;
            ctx.beginPath();
            ctx.arc(0, 0, 26 * scale, angle, angle + Math.PI);
            ctx.stroke();
        }

        function drawVillain(villain) {
            ctx.save();
            ctx.translate(villain.x + villain.width / 2, villain.y + villain.height / 2);
            ctx.rotate(villain.angle || 0);

            const hw = villain.width / 2;
            const hh = villain.height / 2;

            switch(villain.type) {
                case 'petey':
                    drawPeteyVillain(hw, hh);
                    break;
                case 'flatpetey':
                    drawFlatPetey(hw, hh);
                    break;
                case 'piggy':
                    drawPiggy(hw, hh);
                    break;
                case 'robot':
                    drawRobotVillain(hw, hh);
                    break;
                default:
                    drawPeteyVillain(hw, hh);
            }

            // è¡€æ¡
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(-hw, -hh - 14, villain.width, 10);
            const healthPct = villain.health / villain.maxHealth;
            const healthGrad = ctx.createLinearGradient(-hw, 0, hw, 0);
            if (healthPct > 0.5) {
                healthGrad.addColorStop(0, '#27AE60');
                healthGrad.addColorStop(1, '#2ECC71');
            } else if (healthPct > 0.25) {
                healthGrad.addColorStop(0, '#E67E22');
                healthGrad.addColorStop(1, '#F39C12');
            } else {
                healthGrad.addColorStop(0, '#C0392B');
                healthGrad.addColorStop(1, '#E74C3C');
            }
            ctx.fillStyle = healthGrad;
            ctx.fillRect(-hw + 2, -hh - 12, (villain.width - 4) * healthPct, 6);

            ctx.restore();
        }

        // Petey - é‚ªæ¶çš„æ©˜è‰²è™æ–‘çŒ«
        // Petey - Dav Pilkeyç®€ç¬”ç”»é£æ ¼
        // æ©˜è‰²çŒ«ï¼Œç®€å•çš„å½¢çŠ¶å’Œé»‘è‰²è½®å»“
        function drawPeteyVillain(hw, hh) {
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // çŒ«èº«ä½“ (ç®€å•æ©˜è‰²æ¤­åœ†)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.ellipse(0, 5, hw - 2, hh - 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ç®€å•æ¡çº¹ (å‡ æ¡é»‘çº¿)
            ctx.strokeStyle = '#BF360C';
            ctx.lineWidth = 2;
            for (let i = -1; i <= 1; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 8, -hh + 25);
                ctx.lineTo(i * 8, hh - 15);
                ctx.stroke();
            }

            // å°¾å·´ (ç®€å•å¼¯æ›²çº¿)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(hw - 5, hh - 15);
            ctx.quadraticCurveTo(hw + 12, hh - 15, hw + 10, hh - 5);
            ctx.quadraticCurveTo(hw + 8, hh, hw - 3, hh - 8);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // å¤´ (ç®€å•åœ†å½¢)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.arc(0, -hh + 15, 16, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ä¸‰è§’è€³æœµ (ç®€å•ä¸‰è§’å½¢ + é»‘è‰²è½®å»“)
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(-12, -hh + 5);
            ctx.lineTo(-16, -hh - 10);
            ctx.lineTo(-5, -hh + 5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(12, -hh + 5);
            ctx.lineTo(16, -hh - 10);
            ctx.lineTo(5, -hh + 5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // çœ¼ç› - Dav Pilkeyé£æ ¼: é«˜ç˜¦é»‘è‰²æ¤­åœ† (é‚ªæ¶è¡¨æƒ…)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-6, -hh + 12, 3, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(6, -hh + 12, 3, 6, 0, 0, Math.PI * 2);
            ctx.fill();

            // é‚ªæ¶çœ‰æ¯› (ç®€å•çš„Vå½¢çº¿)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-12, -hh + 4);
            ctx.lineTo(-3, -hh + 7);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(12, -hh + 4);
            ctx.lineTo(3, -hh + 7);
            ctx.stroke();

            // é¼»å­ (ç®€å•å°ä¸‰è§’)
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.moveTo(0, -hh + 18);
            ctx.lineTo(-3, -hh + 22);
            ctx.lineTo(3, -hh + 22);
            ctx.closePath();
            ctx.fill();

            // èƒ¡é¡» (ç®€å•çš„ç›´çº¿)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;
            // å·¦è¾¹
            ctx.beginPath();
            ctx.moveTo(-6, -hh + 20);
            ctx.lineTo(-18, -hh + 18);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(-6, -hh + 22);
            ctx.lineTo(-18, -hh + 22);
            ctx.stroke();
            // å³è¾¹
            ctx.beginPath();
            ctx.moveTo(6, -hh + 20);
            ctx.lineTo(18, -hh + 18);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(6, -hh + 22);
            ctx.lineTo(18, -hh + 22);
            ctx.stroke();

            // é‚ªæ¶ç¬‘å®¹ (ç®€å•å¼§çº¿ + Wå½¢å˜´)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-6, -hh + 26);
            ctx.lineTo(-3, -hh + 29);
            ctx.lineTo(0, -hh + 26);
            ctx.lineTo(3, -hh + 29);
            ctx.lineTo(6, -hh + 26);
            ctx.stroke();
        }

        // Flat Petey - çº¸ç‰‡ç‰ˆPetey
        // Flat Petey - é€šç¼‰ä»¤æµ·æŠ¥é£æ ¼
        function drawFlatPetey(hw, hh) {
            // ===== é€šç¼‰ä»¤çº¸å¼  =====
            ctx.fillStyle = '#FFF8E1';
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 2;

            // çº¸å¼ ä¸»ä½“ (ç•¥å¾®ä¸è§„åˆ™çš„è¾¹ç¼˜)
            ctx.beginPath();
            ctx.moveTo(-hw + 3, -hh + 5);
            ctx.lineTo(-hw + 5, hh - 3);
            ctx.lineTo(hw - 5, hh - 5);
            ctx.lineTo(hw - 3, -hh + 3);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // ===== "WANTED" é€šç¼‰æ ‡é¢˜ =====
            ctx.fillStyle = '#8B0000';
            ctx.font = 'bold 8px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('WANTED', 0, -hh + 14);

            // ===== Peteyçš„è„¸ (é€šç¼‰çŠ¯ç…§ç‰‡) =====
            // ç…§ç‰‡æ¡†
            ctx.fillStyle = '#FFE4B5';
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.rect(-hw + 8, -hh + 18, hw * 2 - 16, hh - 5);
            ctx.fill();
            ctx.stroke();

            // Peteyçš„è„¸ - æ©˜è‰²åœ†è„¸
            ctx.fillStyle = '#FF9800';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.arc(0, -hh + 38, 14, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // ä¸‰è§’è€³æœµ
            ctx.fillStyle = '#FF9800';
            ctx.beginPath();
            ctx.moveTo(-10, -hh + 28);
            ctx.lineTo(-14, -hh + 18);
            ctx.lineTo(-5, -hh + 28);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(10, -hh + 28);
            ctx.lineTo(14, -hh + 18);
            ctx.lineTo(5, -hh + 28);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // é‚ªæ¶çš„çœ¼ç› - é»‘è‰²é«˜ç˜¦æ¤­åœ†
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-5, -hh + 35, 2, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(5, -hh + 35, 2, 4, 0, 0, Math.PI * 2);
            ctx.fill();

            // é‚ªæ¶çœ‰æ¯›
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(-9, -hh + 30);
            ctx.lineTo(-3, -hh + 32);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(9, -hh + 30);
            ctx.lineTo(3, -hh + 32);
            ctx.stroke();

            // ç²‰è‰²é¼»å­
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.moveTo(0, -hh + 40);
            ctx.lineTo(-2, -hh + 43);
            ctx.lineTo(2, -hh + 43);
            ctx.closePath();
            ctx.fill();

            // é‚ªæ¶ç¬‘å®¹ (Wå½¢)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(-5, -hh + 46);
            ctx.lineTo(-2, -hh + 49);
            ctx.lineTo(0, -hh + 46);
            ctx.lineTo(2, -hh + 49);
            ctx.lineTo(5, -hh + 46);
            ctx.stroke();

            // èƒ¡é¡»
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-5, -hh + 43);
            ctx.lineTo(-12, -hh + 41);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(-5, -hh + 45);
            ctx.lineTo(-12, -hh + 45);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(5, -hh + 43);
            ctx.lineTo(12, -hh + 41);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(5, -hh + 45);
            ctx.lineTo(12, -hh + 45);
            ctx.stroke();

            // æ¡çº¹ (èº«ä½“éƒ¨åˆ†)
            ctx.strokeStyle = '#BF360C';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-3, -hh + 55);
            ctx.lineTo(-3, hh - 10);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(3, -hh + 55);
            ctx.lineTo(3, hh - 10);
            ctx.stroke();

            // ===== "PETEY" åå­— =====
            ctx.fillStyle = '#8B0000';
            ctx.font = 'bold 6px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('PETEY', 0, hh - 3);

            // çº¸å¼ æŠ˜ç—•/ç ´æŸæ•ˆæœ
            ctx.strokeStyle = 'rgba(139,69,19,0.2)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-hw + 10, -hh + 35);
            ctx.lineTo(hw - 10, hh - 25);
            ctx.stroke();
        }

        // Piggy - Dav Pilkeyç®€ç¬”ç”»é£æ ¼
        // ç²‰è‰²çŒªï¼Œç®€å•å½¢çŠ¶ï¼Œé»‘è‰²è½®å»“
        function drawPiggy(hw, hh) {
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // çŒªèº«ä½“ (ç®€å•ç²‰è‰²æ¤­åœ†)
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.ellipse(0, 5, hw - 2, hh - 8, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // çŒªå¤´ (ç®€å•åœ†å½¢)
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.arc(0, -hh + 18, 16, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // çŒªè€³æœµ (ç®€å•æ¤­åœ†)
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.ellipse(-12, -hh + 5, 6, 9, -0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            ctx.beginPath();
            ctx.ellipse(12, -hh + 5, 6, 9, 0.3, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // çœ¼ç› - Dav Pilkeyé£æ ¼: é«˜ç˜¦é»‘è‰²æ¤­åœ†
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.ellipse(-6, -hh + 15, 3, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(6, -hh + 15, 3, 5, 0, 0, Math.PI * 2);
            ctx.fill();

            // æ„¤æ€’çœ‰æ¯› (ç®€å•Vå½¢)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-10, -hh + 7);
            ctx.lineTo(-3, -hh + 11);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(10, -hh + 7);
            ctx.lineTo(3, -hh + 11);
            ctx.stroke();

            // çŒªé¼»å­ (ç®€å•æ¤­åœ† + ä¸¤ä¸ªé¼»å­”)
            ctx.fillStyle = '#FF69B4';
            ctx.beginPath();
            ctx.ellipse(0, -hh + 24, 7, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.stroke();

            // é¼»å­” (ä¸¤ä¸ªå°åœ†)
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-3, -hh + 24, 2, 0, Math.PI * 2);
            ctx.arc(3, -hh + 24, 2, 0, Math.PI * 2);
            ctx.fill();

            // å˜´å·´ (ç®€å•å¼§çº¿)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -hh + 30, 5, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();

            // çœ¼é•œ (ç®€å•åœ†æ¡†)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(-6, -hh + 15, 7, 0, Math.PI * 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(6, -hh + 15, 7, 0, Math.PI * 2);
            ctx.stroke();
            // çœ¼é•œè…¿
            ctx.beginPath();
            ctx.moveTo(-13, -hh + 15);
            ctx.lineTo(-hw + 3, -hh + 13);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(13, -hh + 15);
            ctx.lineTo(hw - 3, -hh + 13);
            ctx.stroke();
            // çœ¼é•œæ¡¥
            ctx.beginPath();
            ctx.moveTo(-1, -hh + 15);
            ctx.lineTo(1, -hh + 15);
            ctx.stroke();
        }

        // Robot - é‚ªæ¶æœºå™¨äºº
        // Robot - Dav Pilkeyç®€ç¬”ç”»é£æ ¼
        // ç®€å•çš„æ–¹å—æœºå™¨äººï¼Œé»‘è‰²è½®å»“
        function drawRobotVillain(hw, hh) {
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            // æœºå™¨äººèº«ä½“ (ç®€å•ç°è‰²çŸ©å½¢)
            ctx.fillStyle = '#78909C';
            ctx.beginPath();
            ctx.rect(-hw + 3, -hh + 22, (hw - 3) * 2, hh * 2 - 25);
            ctx.fill();
            ctx.stroke();

            // æœºå™¨äººå¤´éƒ¨ (ç®€å•çŸ©å½¢)
            ctx.fillStyle = '#90A4AE';
            ctx.beginPath();
            ctx.rect(-hw + 5, -hh + 2, (hw - 5) * 2, 22);
            ctx.fill();
            ctx.stroke();

            // å¤©çº¿ (ç®€å•çº¿æ¡)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, -hh + 2);
            ctx.lineTo(0, -hh - 10);
            ctx.stroke();

            // å¤©çº¿é¡¶éƒ¨ (çº¢è‰²åœ†)
            ctx.fillStyle = '#FF0000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, -hh - 12, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // çœ¼ç› - ç®€å•çº¢è‰²åœ†å½¢ (é‚ªæ¶æœºå™¨äºº)
            ctx.fillStyle = '#FF0000';
            ctx.beginPath();
            ctx.arc(-8, -hh + 13, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#000000';
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(8, -hh + 13, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();

            // èƒ¸éƒ¨é¢æ¿ (ç®€å•çŸ©å½¢)
            ctx.fillStyle = '#455A64';
            ctx.strokeStyle = '#000000';
            ctx.beginPath();
            ctx.rect(-12, 0, 24, 18);
            ctx.fill();
            ctx.stroke();

            // æŒ‰é’® (ç®€å•åœ†å½¢)
            ctx.fillStyle = '#4CAF50';
            ctx.beginPath();
            ctx.arc(-5, 9, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#F44336';
            ctx.beginPath();
            ctx.arc(5, 9, 3, 0, Math.PI * 2);
            ctx.fill();

            // æœºæ¢°è‡‚ (ç®€å•çŸ©å½¢)
            ctx.fillStyle = '#78909C';
            ctx.strokeStyle = '#000000';
            ctx.fillRect(-hw - 5, 2, 7, 16);
            ctx.strokeRect(-hw - 5, 2, 7, 16);
            ctx.fillRect(hw - 2, 2, 7, 16);
            ctx.strokeRect(hw - 2, 2, 7, 16);

            // é’³å­æ‰‹ (ç®€å•Vå½¢)
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-hw - 2, 18);
            ctx.lineTo(-hw - 6, 26);
            ctx.moveTo(-hw - 2, 18);
            ctx.lineTo(-hw + 2, 26);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(hw + 2, 18);
            ctx.lineTo(hw + 6, 26);
            ctx.moveTo(hw + 2, 18);
            ctx.lineTo(hw - 2, 26);
            ctx.stroke();
        }

        function drawBlock(block) {
            ctx.save();

            if (block.type === 'tnt') {
                // TNTç‚¸å¼¹
                ctx.translate(block.x + 20, block.y + 20);
                ctx.rotate(block.angle || 0);

                const tntGrad = ctx.createRadialGradient(-5, -5, 0, 0, 0, 22);
                tntGrad.addColorStop(0, '#FF6B6B');
                tntGrad.addColorStop(0.7, '#E74C3C');
                tntGrad.addColorStop(1, '#C0392B');

                ctx.fillStyle = tntGrad;
                ctx.beginPath();
                ctx.roundRect(-18, -18, 36, 36, 5);
                ctx.fill();

                ctx.strokeStyle = '#922B21';
                ctx.lineWidth = 2;
                ctx.stroke();

                // TNTæ–‡å­—
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('TNT', 0, 0);

                // é—ªçƒå¯¼ç«ç´¢
                ctx.fillStyle = frameCount % 30 < 15 ? '#FFD700' : '#FF6B6B';
                ctx.beginPath();
                ctx.arc(0, -22, 5, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
                return;
            }

            ctx.translate(block.x + block.w / 2, block.y + block.h / 2);
            ctx.rotate(block.angle || 0);

            const hw = block.w / 2;
            const hh = block.h / 2;

            let grad, strokeColor;

            if (block.type === 'wood') {
                grad = ctx.createLinearGradient(-hw, 0, hw, 0);
                grad.addColorStop(0, '#D4A574');
                grad.addColorStop(0.3, '#DEB887');
                grad.addColorStop(0.7, '#DEB887');
                grad.addColorStop(1, '#C49A6C');
                strokeColor = '#8B4513';
            } else if (block.type === 'stone') {
                grad = ctx.createLinearGradient(-hw, -hh, hw, hh);
                grad.addColorStop(0, '#A9A9A9');
                grad.addColorStop(0.5, '#808080');
                grad.addColorStop(1, '#696969');
                strokeColor = '#4A4A4A';
            } else {
                grad = ctx.createLinearGradient(-hw, -hh, hw, hh);
                grad.addColorStop(0, 'rgba(173,216,230,0.85)');
                grad.addColorStop(0.5, 'rgba(135,206,250,0.75)');
                grad.addColorStop(1, 'rgba(100,149,237,0.65)');
                strokeColor = 'rgba(70,130,180,0.8)';
            }

            ctx.fillStyle = grad;
            ctx.fillRect(-hw, -hh, block.w, block.h);

            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(-hw, -hh, block.w, block.h);

            // æŸåçº¹ç†
            if (block.health < block.maxHealth) {
                ctx.strokeStyle = 'rgba(0,0,0,0.4)';
                ctx.lineWidth = 1;
                const cracks = block.maxHealth - block.health;
                for (let i = 0; i < cracks; i++) {
                    ctx.beginPath();
                    ctx.moveTo(-hw + block.w * 0.2 * (i + 1), -hh);
                    ctx.lineTo(-hw + block.w * 0.3 * (i + 1), hh);
                    ctx.stroke();
                }
            }

            // ç»ç’ƒé«˜å…‰
            if (block.type === 'glass') {
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.moveTo(-hw + 3, -hh + 3);
                ctx.lineTo(-hw + 8, -hh + 3);
                ctx.lineTo(-hw + 3, -hh + 15);
                ctx.fill();
            }

            // çº¢ç®±å­ (åè¿æ°”)
            if (block.type === 'redbox') {
                // çº¢è‰²èƒŒæ™¯
                const redGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, Math.max(hw, hh));
                redGrad.addColorStop(0, '#FF4444');
                redGrad.addColorStop(0.7, '#CC0000');
                redGrad.addColorStop(1, '#990000');
                ctx.fillStyle = redGrad;
                ctx.fillRect(-hw, -hh, block.w, block.h);
                ctx.strokeStyle = '#660000';
                ctx.lineWidth = 3;
                ctx.strokeRect(-hw, -hh, block.w, block.h);

                // éª·é«…å›¾æ ‡
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(0, -3, 8, 0, Math.PI * 2);
                ctx.fill();
                // çœ¼ç›
                ctx.fillStyle = '#990000';
                ctx.beginPath();
                ctx.arc(-3, -4, 2, 0, Math.PI * 2);
                ctx.arc(3, -4, 2, 0, Math.PI * 2);
                ctx.fill();
                // å˜´å·´
                ctx.strokeStyle = '#990000';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                ctx.moveTo(-4, 2);
                ctx.lineTo(-2, 5);
                ctx.lineTo(0, 2);
                ctx.lineTo(2, 5);
                ctx.lineTo(4, 2);
                ctx.stroke();
                // é—ªçƒæ•ˆæœ
                if (frameCount % 40 < 20) {
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.fillRect(-hw, -hh, block.w, block.h);
                }
            }

            // ç»¿ç®±å­ (å¥½è¿æ°”)
            if (block.type === 'greenbox') {
                // ç»¿è‰²èƒŒæ™¯
                const greenGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, Math.max(hw, hh));
                greenGrad.addColorStop(0, '#44FF44');
                greenGrad.addColorStop(0.7, '#00CC00');
                greenGrad.addColorStop(1, '#009900');
                ctx.fillStyle = greenGrad;
                ctx.fillRect(-hw, -hh, block.w, block.h);
                ctx.strokeStyle = '#006600';
                ctx.lineWidth = 3;
                ctx.strokeRect(-hw, -hh, block.w, block.h);

                // æ˜Ÿæ˜Ÿå›¾æ ‡
                ctx.fillStyle = '#FFD700';
                drawStarShape(ctx, 0, 0, 5, 10, 5);

                // é—ªçƒæ•ˆæœ
                if (frameCount % 30 < 15) {
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(-hw, -hh, block.w, block.h);
                }
            }

            ctx.restore();
        }

        function drawDebris(d) {
            ctx.save();
            ctx.globalAlpha = d.alpha;
            ctx.translate(d.x, d.y);
            ctx.rotate(d.rotation);
            ctx.fillStyle = d.color;
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 1;

            switch(d.type) {
                case 'glasses':
                    // çœ¼é•œç¢ç‰‡
                    ctx.strokeStyle = d.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(-8, 0, 7, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(8, 0, 7, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(-1, 0);
                    ctx.lineTo(1, 0);
                    ctx.stroke();
                    break;
                case 'paper':
                    // çº¸ç‰‡ - è–„ç‰‡å½¢çŠ¶
                    ctx.beginPath();
                    ctx.moveTo(-d.size/2, -d.size/4);
                    ctx.lineTo(d.size/2, -d.size/3);
                    ctx.lineTo(d.size/2 - 2, d.size/3);
                    ctx.lineTo(-d.size/2 + 2, d.size/4);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    break;
                case 'metal':
                    // é‡‘å±ç¢ç‰‡ - ä¸è§„åˆ™å¤šè¾¹å½¢
                    ctx.beginPath();
                    ctx.moveTo(-d.size/2, 0);
                    ctx.lineTo(-d.size/3, -d.size/2);
                    ctx.lineTo(d.size/3, -d.size/3);
                    ctx.lineTo(d.size/2, d.size/4);
                    ctx.lineTo(0, d.size/2);
                    ctx.closePath();
                    ctx.fill();
                    // é‡‘å±å…‰æ³½
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.beginPath();
                    ctx.moveTo(-d.size/4, -d.size/4);
                    ctx.lineTo(d.size/4, -d.size/3);
                    ctx.lineTo(d.size/4, 0);
                    ctx.lineTo(-d.size/4, 0);
                    ctx.closePath();
                    ctx.fill();
                    break;
                case 'fur':
                    // æ¯›å‘ - æ¤­åœ†å½¢
                    ctx.beginPath();
                    ctx.ellipse(0, 0, d.size/2, d.size/4, 0, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                default:
                    ctx.fillRect(-d.size / 2, -d.size / 2, d.size, d.size);
            }
            ctx.restore();
        }

        function drawParticle(p) {
            ctx.save();
            ctx.globalAlpha = p.alpha;
            ctx.fillStyle = p.color;

            switch(p.type) {
                case 'star':
                    // ç”»æ˜Ÿæ˜Ÿ
                    drawStar(p.x, p.y, 5, p.size / 2, p.size / 4);
                    break;
                case 'spark':
                    // ç”µç«èŠ± - å°äº®ç‚¹
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    break;
                case 'smoke':
                    // çƒŸé›¾ - æ¨¡ç³Šåœ†å½¢
                    const smokeGrad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
                    smokeGrad.addColorStop(0, p.color);
                    smokeGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = smokeGrad;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    break;
                default:
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
            }
            ctx.restore();
        }

        // ç”»æ˜Ÿæ˜Ÿå½¢çŠ¶
        function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let x = cx;
            let y = cy;
            let step = Math.PI / spikes;

            ctx.beginPath();
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius;
                y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y);
                rot += step;

                x = cx + Math.cos(rot) * innerRadius;
                y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y);
                rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius);
            ctx.closePath();
            ctx.fill();
        }

        function drawTrajectory() {
            const power = Math.min(getDistance(projectile, { x: SLINGSHOT_X, y: SLINGSHOT_Y }), MAX_PULL_DISTANCE);
            const angle = Math.atan2(SLINGSHOT_Y - projectile.y, SLINGSHOT_X - projectile.x);
            const vx = Math.cos(angle) * power * LAUNCH_POWER_MULTIPLIER;
            const vy = Math.sin(angle) * power * LAUNCH_POWER_MULTIPLIER;

            let px = SLINGSHOT_X, py = SLINGSHOT_Y;
            let pvx = vx, pvy = vy;

            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 40; i++) {
                pvx *= AIR_RESISTANCE;
                pvy += GRAVITY * (projectile.mass || 1);
                pvy *= AIR_RESISTANCE;
                px += pvx;
                py += pvy;

                if (py > GROUND_Y) break;

                const alpha = 1 - i / 40;
                ctx.globalAlpha = alpha * 0.6;
                ctx.beginPath();
                ctx.arc(px, py, 4 - i * 0.08, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;
        }

        // ========================================
        // ç§»åŠ¨ç®±å­ç³»ç»Ÿ
        // ========================================
        function updateMovingBoxes() {
            blocks.forEach(block => {
                if (!block.alive || block.falling) return;

                // åªæœ‰è®¾ç½®äº†ç§»åŠ¨å±æ€§çš„ç®±å­æ‰ä¼šç§»åŠ¨
                if (block.moveX || block.moveY) {
                    block.movePhase += 0.03; // ç§»åŠ¨é€Ÿåº¦

                    if (block.moveX) {
                        // æ°´å¹³ç§»åŠ¨
                        block.x = block.originalX + Math.sin(block.movePhase) * block.moveX;
                    }
                    if (block.moveY) {
                        // å‚ç›´ç§»åŠ¨
                        block.y = block.originalY + Math.sin(block.movePhase) * block.moveY;
                    }
                }
            });
        }

        // ========================================
        // æ–¹å—ç‰©ç†ç³»ç»Ÿ - åªå¤„ç†æ­£åœ¨ä¸‹è½çš„æ–¹å—
        // ========================================
        function updateBlockPhysics() {
            const BLOCK_GRAVITY = 0.5;
            const BLOCK_BOUNCE = 0.3;
            const FALL_DAMAGE_THRESHOLD = 5;

            // åªå¤„ç†å·²ç»æ ‡è®°ä¸ºfallingçš„æ–¹å—
            blocks.forEach(block => {
                if (!block.alive || !block.falling) return;

                // åº”ç”¨é‡åŠ›
                block.vy = (block.vy || 0) + BLOCK_GRAVITY;
                block.y += block.vy;

                // è§’åº¦æ—‹è½¬
                if (block.vx) {
                    block.x += block.vx;
                    block.angle = (block.angle || 0) + block.vx * 0.02;
                    block.vx *= 0.98;
                }

                // æ£€æŸ¥ä¸åœ°é¢ç¢°æ’
                const blockBottom = block.y + (block.h || 40);
                if (blockBottom >= GROUND_Y) {
                    block.y = GROUND_Y - (block.h || 40);

                    // æ ¹æ®ä¸‹è½é€Ÿåº¦é€ æˆä¼¤å®³
                    if (block.vy > FALL_DAMAGE_THRESHOLD) {
                        block.health -= 1;
                        playImpact(block.type);
                        createDustParticles(block.x + (block.w || 40) / 2, GROUND_Y, 8);

                        if (block.health <= 0) {
                            block.alive = false;
                            createDebrisFromBlock(block);
                            score += 50;
                            if (block.type === 'wood') playWoodBreak();
                            else if (block.type === 'stone') playStoneBreak();
                            else playGlassBreak();
                        }
                    }

                    block.vy *= -BLOCK_BOUNCE;
                    if (Math.abs(block.vy) < 1) {
                        block.vy = 0;
                        block.falling = false;
                    }
                }

                // æ£€æŸ¥ä¸å…¶ä»–æ–¹å—çš„ç¢°æ’
                blocks.forEach(other => {
                    if (other === block || !other.alive || other.falling) return;

                    const blockBottom = block.y + (block.h || 40);
                    const otherTop = other.y;
                    const otherBottom = other.y + (other.h || 40);

                    const blockLeft = block.x;
                    const blockRight = block.x + (block.w || 40);
                    const otherLeft = other.x;
                    const otherRight = other.x + (other.w || 40);

                    const horizontalOverlap = blockRight > otherLeft && blockLeft < otherRight;

                    if (horizontalOverlap && blockBottom >= otherTop && block.y < otherBottom && block.vy > 0) {
                        block.y = otherTop - (block.h || 40);

                        if (block.vy > FALL_DAMAGE_THRESHOLD) {
                            other.health -= 1;
                            block.health -= 1;
                            playImpact(block.type);
                            createDustParticles(block.x + (block.w || 40) / 2, block.y + (block.h || 40), 5);

                            if (other.health <= 0) {
                                other.alive = false;
                                createDebrisFromBlock(other);
                                score += 50;
                                // è¢«ç ¸åçš„æ–¹å—ä¸Šé¢çš„æ–¹å—ä¹Ÿè¦æ‰è½
                                triggerBlocksAboveToFall(other);
                            }
                            if (block.health <= 0) {
                                block.alive = false;
                                createDebrisFromBlock(block);
                                score += 50;
                            }
                        }

                        block.vy *= -BLOCK_BOUNCE;
                        if (Math.abs(block.vy) < 1) {
                            block.vy = 0;
                            block.falling = false;
                        }
                    }
                });

                // æ£€æŸ¥æ˜¯å¦ç ¸åˆ°æ•Œäºº
                villains.forEach(v => {
                    if (!v.alive) return;
                    const blockBottom = block.y + (block.h || 40);
                    const blockCenterX = block.x + (block.w || 40) / 2;

                    if (blockBottom >= v.y && block.y < v.y + v.height &&
                        blockCenterX > v.x && blockCenterX < v.x + v.width &&
                        block.vy > 3) {
                        v.health -= 1;
                        if (v.health <= 0) {
                            v.alive = false;
                            score += 500;
                            playVillainDefeatSound(v.type);
                            createDebrisFromVillain(v);
                            checkGameEnd();
                        }
                    }
                });
            });
        }

        // å½“ä¸€ä¸ªæ–¹å—è¢«æ‘§æ¯æ—¶ï¼Œæ£€æŸ¥ä¸Šé¢çš„æ–¹å—æ˜¯å¦éœ€è¦æ‰è½
        function triggerBlocksAboveToFall(destroyedBlock) {
            const destroyedTop = destroyedBlock.y;
            const destroyedBottom = destroyedBlock.y + (destroyedBlock.h || 40);
            const destroyedLeft = destroyedBlock.x;
            const destroyedRight = destroyedBlock.x + (destroyedBlock.w || 40);

            blocks.forEach(block => {
                if (!block.alive || block.falling) return;

                const blockBottom = block.y + (block.h || 40);
                const blockLeft = block.x;
                const blockRight = block.x + (block.w || 40);

                // æ£€æŸ¥è¿™ä¸ªæ–¹å—æ˜¯å¦åœ¨è¢«æ‘§æ¯çš„æ–¹å—ä¸Šæ–¹
                // æ–¹å—çš„åº•éƒ¨åº”è¯¥æ¥è¿‘è¢«æ‘§æ¯æ–¹å—çš„é¡¶éƒ¨ï¼Œå¹¶ä¸”æœ‰æ°´å¹³é‡å 
                const isAbove = blockBottom <= destroyedTop + 10 && blockBottom >= destroyedTop - 20;
                const hasOverlap = blockRight > destroyedLeft && blockLeft < destroyedRight;

                if (isAbove && hasOverlap) {
                    // æ£€æŸ¥è¿™ä¸ªæ–¹å—æ˜¯å¦è¿˜æœ‰å…¶ä»–æ”¯æ’‘
                    if (!hasOtherSupport(block, destroyedBlock)) {
                        block.falling = true;
                        block.vy = 0;
                    }
                }
            });
        }

        // æ£€æŸ¥æ–¹å—æ˜¯å¦æœ‰å…¶ä»–æ”¯æ’‘ï¼ˆæ’é™¤æŒ‡å®šçš„æ–¹å—ï¼‰
        function hasOtherSupport(block, excludeBlock) {
            const blockBottom = block.y + (block.h || 40);
            const blockLeft = block.x;
            const blockRight = block.x + (block.w || 40);

            // æ£€æŸ¥æ˜¯å¦åœ¨åœ°é¢ä¸Š
            if (blockBottom >= GROUND_Y - 5) {
                return true;
            }

            // æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–æ–¹å—æ”¯æ’‘
            for (const other of blocks) {
                if (other === block || other === excludeBlock || !other.alive) continue;

                const otherTop = other.y;
                const otherLeft = other.x;
                const otherRight = other.x + (other.w || 40);

                const verticalContact = blockBottom >= otherTop - 5 && blockBottom <= otherTop + 10;
                const horizontalOverlap = blockRight > otherLeft + 5 && blockLeft < otherRight - 5;

                if (verticalContact && horizontalOverlap) {
                    return true;
                }
            }

            return false;
        }

        // ========================================
        // ç‰©ç†æ›´æ–°
        // ========================================
        function update() {
            if (gameState === 'flying' || gameState === 'waiting') {
                if (projectile && projectile.active) updateProjectile(projectile);
                projectiles.forEach(p => updateProjectile(p));
                projectiles = projectiles.filter(p => p.active);

                // æ›´æ–°ç¢ç‰‡
                debris.forEach(d => {
                    d.x += d.vx;
                    d.y += d.vy;
                    d.vy += 0.5;
                    d.rotation += d.rotSpeed;
                    d.alpha -= 0.015;
                });
                debris = debris.filter(d => d.alpha > 0 && d.y < canvas.height);

                // æ›´æ–°ç²’å­
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.1;
                    p.alpha -= 0.03;
                    p.size *= 0.97;
                });
                particles = particles.filter(p => p.alpha > 0);

                // æ›´æ–°ç§»åŠ¨çš„ç®±å­
                updateMovingBoxes();

                // æ›´æ–°æ–¹å—ç‰©ç† - æ”¯æ’‘å€’å¡Œç³»ç»Ÿ
                updateBlockPhysics();

                // æ›´æ–°æ‰è½ç‰©ä½“
                fallingObjects.forEach(fo => {
                    fo.x += fo.vx || 0;
                    fo.y += fo.vy;
                    fo.vy += 0.4; // é‡åŠ›
                    fo.rotation += fo.rotationSpeed || fo.rotSpeed || 0;

                    // åè¿æ°”ç‰©ä½“ï¼šæ£€æµ‹ä¸å¼¹å°„ç‰©çš„ç¢°æ’
                    if (fo.type === 'bad') {
                        // æ£€æµ‹ä¸»å¼¹å°„ç‰©
                        if (projectile && projectile.active) {
                            const dist = Math.hypot(fo.x - projectile.x, fo.y - projectile.y);
                            if (dist < fo.size + projectile.radius) {
                                // æ‘§æ¯å¼¹å°„ç‰©ï¼
                                projectile.active = false;
                                fo.hit = true;
                                createBadHitEffect(fo.x, fo.y);
                                playBadLuckSound();
                            }
                        }
                        // æ£€æµ‹åˆ†è£‚çš„å¼¹å°„ç‰©
                        projectiles.forEach(p => {
                            if (p.active) {
                                const dist = Math.hypot(fo.x - p.x, fo.y - p.y);
                                if (dist < fo.size + p.radius) {
                                    p.active = false;
                                    fo.hit = true;
                                    createBadHitEffect(fo.x, fo.y);
                                }
                            }
                        });
                    }

                    // å¥½è¿æ°”ç‰©ä½“ï¼šæ£€æµ‹ä¸æ•Œäººçš„ç¢°æ’
                    if (fo.type === 'good') {
                        villains.forEach(v => {
                            if (v.alive) {
                                const vCenterX = v.x + v.width / 2;
                                const vCenterY = v.y + v.height / 2;
                                const dist = Math.hypot(fo.x - vCenterX, fo.y - vCenterY);
                                if (dist < fo.size + Math.max(v.width, v.height) / 2) {
                                    // æ‘§æ¯æ•Œäººï¼
                                    v.alive = false;
                                    score += 800;
                                    fo.hit = true;
                                    createGoodHitEffect(vCenterX, vCenterY);
                                    playGoodLuckSound();
                                    playVillainDefeatSound(v.type);
                                    createDebrisFromVillain(v);
                                    checkGameEnd();
                                }
                            }
                        });
                    }
                });
                // ç§»é™¤å·²å‡»ä¸­æˆ–è¶…å‡ºå±å¹•çš„æ‰è½ç‰©ä½“
                fallingObjects = fallingObjects.filter(fo => !fo.hit && fo.y < canvas.height + 50);

                // æ£€æŸ¥é™æ­¢
                if (projectile && !projectile.active && projectiles.length === 0) {
                    setTimeout(() => {
                        if (gameState === 'waiting') {
                            currentBuddyIndex++;
                            placeCurrentBuddy();
                            renderBuddiesPanel();
                        }
                    }, 600);
                }
            }
            updateUI();
        }

        function updateProjectile(p) {
            if (!p.active) return;

            // ç‰©ç†æ¨¡æ‹Ÿï¼ˆé‡åŠ›å¯¹æ‰€æœ‰è§’è‰²ç›¸åŒï¼Œè´¨é‡åªå½±å“ç¢°æ’å†²å‡»åŠ›ï¼‰
            p.vx *= AIR_RESISTANCE;
            p.vy += GRAVITY;  // é‡åŠ›å¯¹æ‰€æœ‰ç‰©ä½“ç›¸åŒ
            p.vy *= AIR_RESISTANCE;
            p.x += p.vx;
            p.y += p.vy;

            // æ—‹è½¬
            p.rotationSpeed = p.vx * 0.02;
            p.rotation += p.rotationSpeed;

            // Flippyç´«å…‰å°¾è¿¹ - åŠ é€ŸåæŒç»­äº§ç”Ÿ
            if (p.boostActive && p.type === 'flippy') {
                // æ¯å¸§äº§ç”Ÿç´«å…‰ç²’å­
                if (frameCount % 2 === 0) {
                    particles.push({
                        x: p.x + (Math.random() - 0.5) * 10,
                        y: p.y + (Math.random() - 0.5) * 10,
                        vx: -p.vx * 0.05 + (Math.random() - 0.5) * 2,
                        vy: -p.vy * 0.05 + (Math.random() - 0.5) * 2,
                        size: 8 + Math.random() * 8,
                        color: ['#9C27B0', '#E040FB', '#AA00FF'][Math.floor(Math.random() * 3)],
                        alpha: 0.9
                    });
                }
                // å¿µåŠ›å…‰ç¯ç²’å­
                if (frameCount % 4 === 0) {
                    const angle = Math.random() * Math.PI * 2;
                    particles.push({
                        x: p.x + Math.cos(angle) * 20,
                        y: p.y + Math.sin(angle) * 20,
                        vx: Math.cos(angle) * 2,
                        vy: Math.sin(angle) * 2,
                        size: 4 + Math.random() * 4,
                        color: '#E040FB',
                        alpha: 0.7
                    });
                }
            }

            // è¾¹ç•Œ
            if (p.x < -60 || p.x > canvas.width + 60) {
                p.active = false;
                gameState = 'waiting';
            }

            // åœ°é¢ç¢°æ’
            if (p.y + p.radius >= GROUND_Y) {
                p.y = GROUND_Y - p.radius;
                if (Math.abs(p.vy) > 2) playImpact('ground');
                p.vy *= -BOUNCE_DAMPING;
                p.vx *= GROUND_FRICTION;
                createDustParticles(p.x, GROUND_Y, 5);

                if (Math.abs(p.vy) < 0.8 && Math.abs(p.vx) < 0.8) {
                    p.active = false;
                    gameState = 'waiting';
                }
            }

            // éšœç¢ç‰©ç¢°æ’
            blocks.forEach(block => {
                if (block.alive && checkCollision(p, block)) {
                    handleBlockCollision(p, block);
                }
            });

            // åæ´¾ç¢°æ’
            villains.forEach(villain => {
                if (villain.alive && checkCollisionRect(p, villain)) {
                    handleVillainCollision(p, villain);
                }
            });
        }

        function checkCollision(circle, rect) {
            const cx = circle.x, cy = circle.y, r = circle.radius;
            let rx = rect.x, ry = rect.y, rw = rect.w || 40, rh = rect.h || 40;

            const closestX = Math.max(rx, Math.min(cx, rx + rw));
            const closestY = Math.max(ry, Math.min(cy, ry + rh));
            return getDistance(circle, { x: closestX, y: closestY }) < r;
        }

        function checkCollisionRect(circle, rect) {
            return checkCollision(circle, { x: rect.x, y: rect.y, w: rect.width, h: rect.height });
        }

        function handleBlockCollision(p, block) {
            const damage = p.type === '80hd' ? 2 : 1;
            const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);

            playImpact(block.type);
            block.health -= damage;

            // ç¢°æ’å“åº”
            const centerX = block.x + (block.w || 40) / 2;
            const centerY = block.y + (block.h || 40) / 2;

            if (Math.abs(p.x - centerX) / (block.w || 40) > Math.abs(p.y - centerY) / (block.h || 40)) {
                p.vx *= -BOUNCE_DAMPING;
            } else {
                p.vy *= -BOUNCE_DAMPING;
            }

            if (block.health <= 0) {
                block.alive = false;

                // è§¦å‘ä¸Šæ–¹æ–¹å—æ‰è½
                triggerBlocksAboveToFall(block);

                if (block.type === 'tnt') {
                    // TNTçˆ†ç‚¸
                    explodeTNT(block);
                } else if (block.type === 'redbox') {
                    // çº¢ç®±å­ - åè¿æ°”ï¼
                    triggerBadLuck(block);
                    score += 150;
                } else if (block.type === 'greenbox') {
                    // ç»¿ç®±å­ - å¥½è¿æ°”ï¼
                    triggerGoodLuck(block);
                    score += 250;
                } else {
                    if (block.type === 'wood') playWoodBreak();
                    else if (block.type === 'stone') playStoneBreak();
                    else playGlassBreak();

                    createDebrisFromBlock(block);
                    score += block.type === 'stone' ? 300 : block.type === 'wood' ? 200 : 100;
                }
            }
        }

        function explodeTNT(tnt) {
            playStoneBreak();
            playGlassBreak();

            // çˆ†ç‚¸ç²’å­
            for (let i = 0; i < 30; i++) {
                particles.push({
                    x: tnt.x + 20,
                    y: tnt.y + 20,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15 - 5,
                    size: 5 + Math.random() * 10,
                    color: Math.random() > 0.5 ? '#FF6B6B' : '#FFD700',
                    alpha: 1
                });
            }

            // çˆ†ç‚¸èŒƒå›´å½±å“
            const explosionRadius = 120;
            const explosionPower = 15;

            blocks.forEach(b => {
                if (b.alive && b !== tnt) {
                    const dist = getDistance({ x: tnt.x + 20, y: tnt.y + 20 }, { x: b.x + (b.w || 40) / 2, y: b.y + (b.h || 40) / 2 });
                    if (dist < explosionRadius) {
                        b.health -= 2;
                        if (b.health <= 0) {
                            b.alive = false;
                            triggerBlocksAboveToFall(b);
                            createDebrisFromBlock(b);
                            score += 150;
                            if (b.type === 'tnt') setTimeout(() => explodeTNT(b), 100);
                            else if (b.type === 'redbox') triggerBadLuck(b);
                            else if (b.type === 'greenbox') triggerGoodLuck(b);
                        }
                    }
                }
            });

            villains.forEach(v => {
                if (v.alive) {
                    const dist = getDistance({ x: tnt.x + 20, y: tnt.y + 20 }, { x: v.x + v.width / 2, y: v.y + v.height / 2 });
                    if (dist < explosionRadius) {
                        v.health -= 2;
                        if (v.health <= 0) {
                            v.alive = false;
                            score += v.type === 'robot' ? 1000 : 500;
                            playVillainDefeatSound(v.type);
                            createDebrisFromVillain(v);
                        }
                        checkGameEnd();
                    }
                }
            });

            score += 500;
        }

        // è§¦å‘åè¿æ°” - çº¢ç®±å­è¢«å‡»ä¸­
        function triggerBadLuck(block) {
            playBadLuckSound();

            const cx = block.x + (block.w || 40) / 2;
            const cy = block.y + (block.h || 40) / 2;

            // å¼ºçƒˆå±å¹•éœ‡åŠ¨ï¼
            triggerScreenShake(12, 20);

            // éšæœºé€‰æ‹©åè¿æ°”æ•ˆæœ
            const badEffects = ['meteor', 'enemyHeal', 'losePoints', 'multiMeteor'];
            const effect = badEffects[Math.floor(Math.random() * badEffects.length)];

            // å¤§é‡çº¢è‰²è­¦å‘Šç²’å­çˆ†ç‚¸
            for (let i = 0; i < 35; i++) {
                const angle = (i / 35) * Math.PI * 2;
                const speed = 4 + Math.random() * 8;
                particles.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: 6 + Math.random() * 10,
                    color: ['#FF0000', '#FF4500', '#DC143C', '#8B0000'][Math.floor(Math.random() * 4)],
                    alpha: 1
                });
            }

            // çº¢è‰²å†²å‡»æ³¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: cx, y: cy,
                radius: 5,
                maxRadius: 100,
                color: 'rgba(255, 0, 0, 0.5)',
                lineWidth: 6
            });

            // æ˜¾ç¤ºå¤§å‹è­¦å‘Šæ–‡å­—
            showBigText('ğŸ’€ ' + getEffectName(effect, 'bad'), '#FF0000', 90);

            switch(effect) {
                case 'meteor':
                    // è¶…å¤§é™¨çŸ³ - ä»å¤©è€Œé™ï¼
                    let targetX = canvas.width / 2;
                    if (projectile && projectile.active) {
                        targetX = projectile.x + (Math.random() - 0.5) * 100;
                    }
                    // ä¸»é™¨çŸ³
                    fallingObjects.push({
                        x: targetX, y: -80, vy: 5, vx: 0, size: 40,
                        type: 'bad', rotation: 0,
                        rotationSpeed: 0.15, hit: false
                    });
                    // ä¼´éšå°é™¨çŸ³
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            fallingObjects.push({
                                x: targetX + (Math.random() - 0.5) * 150,
                                y: -50, vy: 4 + Math.random() * 2, vx: (Math.random() - 0.5) * 2, size: 18 + Math.random() * 10,
                                type: 'bad', rotation: Math.random() * Math.PI,
                                rotationSpeed: (Math.random() - 0.5) * 0.2, hit: false
                            });
                        }, i * 150);
                    }
                    break;

                case 'multiMeteor':
                    // æµæ˜Ÿé›¨ï¼æ»¡å¤©é™¨çŸ³ï¼
                    for (let i = 0; i < 8; i++) {
                        setTimeout(() => {
                            let dropX = 150 + Math.random() * (canvas.width - 300);
                            fallingObjects.push({
                                x: dropX,
                                y: -50 - Math.random() * 100, vy: 4 + Math.random() * 3, vx: (Math.random() - 0.5) * 3, size: 20 + Math.random() * 15,
                                type: 'bad', rotation: Math.random() * Math.PI,
                                rotationSpeed: (Math.random() - 0.5) * 0.3, hit: false
                            });
                            // æ¯ä¸ªé™¨çŸ³éƒ½æœ‰ç«èŠ±ç²’å­
                            for (let j = 0; j < 5; j++) {
                                particles.push({
                                    x: dropX, y: 50,
                                    vx: (Math.random() - 0.5) * 6,
                                    vy: Math.random() * 3,
                                    size: 3 + Math.random() * 4,
                                    color: ['#FF6600', '#FF9900', '#FFCC00'][Math.floor(Math.random() * 3)],
                                    alpha: 1
                                });
                            }
                        }, i * 200);
                    }
                    break;

                case 'enemyHeal':
                    // æ•Œäººå›è¡€ + æ˜æ˜¾æ²»æ„ˆæ•ˆæœ
                    villains.forEach(v => {
                        if (v.alive) {
                            v.health = v.maxHealth; // å®Œå…¨æ¢å¤ï¼
                            // å¤§é‡æ²»æ„ˆç²’å­
                            for (let i = 0; i < 20; i++) {
                                particles.push({
                                    x: v.x + v.width/2, y: v.y + v.height/2,
                                    vx: (Math.random() - 0.5) * 8,
                                    vy: -Math.random() * 6 - 2,
                                    size: 5 + Math.random() * 6,
                                    color: '#FF69B4', alpha: 1
                                });
                            }
                            // æ²»æ„ˆå†²å‡»æ³¢
                            window.shockwaves.push({
                                x: v.x + v.width/2, y: v.y + v.height/2,
                                radius: 5, maxRadius: 60,
                                color: 'rgba(255, 105, 180, 0.4)', lineWidth: 4
                            });
                        }
                    });
                    break;

                case 'losePoints':
                    // å¤§é‡æ‰£åˆ†
                    const pointsLost = Math.min(score, 800 + Math.floor(Math.random() * 700));
                    score = Math.max(0, score - pointsLost);
                    updateUI();
                    // é‡‘å¸é£èµ°æ•ˆæœ
                    for (let i = 0; i < 20; i++) {
                        particles.push({
                            x: cx, y: cy,
                            vx: (Math.random() - 0.5) * 15,
                            vy: -Math.random() * 10 - 5,
                            size: 6 + Math.random() * 6,
                            color: '#FFD700', alpha: 1
                        });
                    }
                    break;
            }

            // çº¢è‰²ç¢ç‰‡çˆ†ç‚¸
            for (let i = 0; i < 15; i++) {
                debris.push({
                    x: cx + (Math.random() - 0.5) * 40,
                    y: cy + (Math.random() - 0.5) * 40,
                    vx: (Math.random() - 0.5) * 10,
                    vy: -Math.random() * 8 - 3,
                    size: 6 + Math.random() * 10,
                    color: '#FF4444', alpha: 1,
                    rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.4
                });
            }
        }

        // è§¦å‘å¥½è¿æ°” - ç»¿ç®±å­è¢«å‡»ä¸­
        function triggerGoodLuck(block) {
            playGoodLuckSound();

            const cx = block.x + (block.w || 40) / 2;
            const cy = block.y + (block.h || 40) / 2;

            // æ¬¢å¿«çš„å±å¹•éœ‡åŠ¨
            triggerScreenShake(8, 15);

            // éšæœºé€‰æ‹©å¥½è¿æ°”æ•ˆæœ
            const goodEffects = ['starfall', 'bonusPoints', 'extraBuddy', 'destroyBlocks', 'multiStar'];
            const effect = goodEffects[Math.floor(Math.random() * goodEffects.length)];

            // å¤§é‡ç»¿è‰²/é‡‘è‰²åº†ç¥ç²’å­
            for (let i = 0; i < 40; i++) {
                const angle = (i / 40) * Math.PI * 2;
                const speed = 3 + Math.random() * 7;
                particles.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 2,
                    size: 5 + Math.random() * 8,
                    color: ['#00FF00', '#7CFC00', '#FFD700', '#FFFF00'][Math.floor(Math.random() * 4)],
                    alpha: 1
                });
            }

            // ç»¿è‰²/é‡‘è‰²å†²å‡»æ³¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: cx, y: cy,
                radius: 5,
                maxRadius: 80,
                color: 'rgba(0, 255, 0, 0.4)',
                lineWidth: 5
            });

            // æ˜¾ç¤ºå¤§å‹åº†ç¥æ–‡å­—
            showBigText('ğŸ‰ ' + getEffectName(effect, 'good'), '#00FF00', 90);

            switch(effect) {
                case 'starfall':
                    // è¶…çº§å¹¸è¿æ˜Ÿï¼ç²¾å‡†æ‰“å‡»æ•Œäººï¼
                    const aliveVillains = villains.filter(v => v.alive);
                    if (aliveVillains.length > 0) {
                        const target = aliveVillains[Math.floor(Math.random() * aliveVillains.length)];
                        // ä¸»æ˜Ÿæ˜Ÿ - æ›´å¤§æ›´äº®
                        fallingObjects.push({
                            x: target.x + target.width/2,
                            y: -80, vy: 5, vx: 0, size: 35,
                            type: 'good', rotation: 0,
                            rotationSpeed: 0.12, hit: false
                        });
                        // ä¼´éšå°æ˜Ÿæ˜Ÿ
                        for (let i = 0; i < 4; i++) {
                            setTimeout(() => {
                                fallingObjects.push({
                                    x: target.x + target.width/2 + (Math.random() - 0.5) * 80,
                                    y: -40, vy: 4 + Math.random() * 2, vx: (Math.random() - 0.5) * 2, size: 15 + Math.random() * 8,
                                    type: 'good', rotation: Math.random() * Math.PI,
                                    rotationSpeed: 0.1 + Math.random() * 0.1, hit: false
                                });
                            }, i * 100);
                        }
                        // ç›®æ ‡æ ‡è®° - å½©è™¹å…‰æŸ±æ•ˆæœ
                        for (let i = 0; i < 20; i++) {
                            particles.push({
                                x: target.x + target.width/2 + (Math.random() - 0.5) * 30,
                                y: target.y - 20,
                                vx: (Math.random() - 0.5) * 3,
                                vy: -Math.random() * 5 - 2,
                                size: 4 + Math.random() * 6,
                                color: ['#FFD700', '#FF6B9D', '#4D96FF', '#6BCB77'][Math.floor(Math.random() * 4)],
                                alpha: 1
                            });
                        }
                    }
                    break;

                case 'multiStar':
                    // æ˜Ÿæ˜Ÿé›¨ï¼æ¯ä¸ªæ•Œäººéƒ½ä¼šè¢«æ”»å‡»ï¼
                    const targets = villains.filter(v => v.alive);
                    targets.forEach((t, i) => {
                        setTimeout(() => {
                            // æ¯ä¸ªæ•Œäººä¸Šæ–¹3é¢—æ˜Ÿæ˜Ÿ
                            for (let j = 0; j < 3; j++) {
                                setTimeout(() => {
                                    fallingObjects.push({
                                        x: t.x + t.width/2 + (Math.random() - 0.5) * 60,
                                        y: -50 - Math.random() * 50, vy: 5 + Math.random() * 2, vx: (Math.random() - 0.5) * 2, size: 22 + Math.random() * 10,
                                        type: 'good', rotation: Math.random() * Math.PI,
                                        rotationSpeed: 0.1 + Math.random() * 0.15, hit: false
                                    });
                                }, j * 80);
                            }
                            // å½©è™¹ç²’å­
                            for (let k = 0; k < 15; k++) {
                                particles.push({
                                    x: t.x + t.width/2,
                                    y: t.y,
                                    vx: (Math.random() - 0.5) * 8,
                                    vy: -Math.random() * 6 - 2,
                                    size: 4 + Math.random() * 5,
                                    color: ['#FFD700', '#FF6B9D', '#4D96FF', '#6BCB77', '#9B59B6'][Math.floor(Math.random() * 5)],
                                    alpha: 1
                                });
                            }
                        }, i * 200);
                    });
                    break;

                case 'bonusPoints':
                    // å¤§é‡å¥–åŠ±ç§¯åˆ†
                    const bonusPoints = 1500 + Math.floor(Math.random() * 2000);
                    score += bonusPoints;
                    updateUI();
                    // é‡‘å¸å–·æ³‰æ•ˆæœ
                    for (let i = 0; i < 30; i++) {
                        particles.push({
                            x: cx, y: cy,
                            vx: (Math.random() - 0.5) * 12,
                            vy: -Math.random() * 12 - 5,
                            size: 6 + Math.random() * 8,
                            color: '#FFD700', alpha: 1
                        });
                    }
                    // é‡‘è‰²å†²å‡»æ³¢
                    window.shockwaves.push({
                        x: cx, y: cy,
                        radius: 10, maxRadius: 100,
                        color: 'rgba(255, 215, 0, 0.5)', lineWidth: 6
                    });
                    break;

                case 'extraBuddy':
                    // è·å¾—é¢å¤–é“å…·
                    const buddyTypeList = ['dogman', 'lilpetey', '80hd', 'flippy'];
                    const newBuddyType = buddyTypeList[Math.floor(Math.random() * buddyTypeList.length)];
                    const newBuddy = {
                        type: newBuddyType,
                        ...window.buddyTypes[newBuddyType],
                        used: false
                    };
                    buddies.push(newBuddy);
                    renderBuddiesPanel();
                    // å½©è™¹ç²’å­
                    for (let i = 0; i < 25; i++) {
                        particles.push({
                            x: cx, y: cy,
                            vx: (Math.random() - 0.5) * 10,
                            vy: -Math.random() * 10 - 3,
                            size: 5 + Math.random() * 6,
                            color: ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#8B00FF'][Math.floor(Math.random() * 6)],
                            alpha: 1
                        });
                    }
                    break;

                case 'destroyBlocks':
                    // æ‘§æ¯æ›´å¤šæ–¹å—
                    const aliveBlocks = blocks.filter(b => b.alive && b.type !== 'redbox' && b.type !== 'greenbox');
                    const toDestroy = aliveBlocks.slice(0, Math.min(5, aliveBlocks.length));
                    toDestroy.forEach((b, i) => {
                        setTimeout(() => {
                            if (b.alive) {
                                b.alive = false;
                                createDebrisFromBlock(b);
                                score += 150;
                                playGlassBreak();
                                triggerScreenShake(5, 10);
                                // æ¯ä¸ªæ–¹å—çˆ†ç‚¸æ•ˆæœ
                                window.shockwaves.push({
                                    x: b.x + (b.w || 40)/2,
                                    y: b.y + (b.h || 40)/2,
                                    radius: 5, maxRadius: 50,
                                    color: 'rgba(255, 255, 0, 0.4)', lineWidth: 3
                                });
                            }
                        }, i * 120);
                    });
                    break;
            }

            // ç»¿è‰²/é‡‘è‰²ç¢ç‰‡
            for (let i = 0; i < 12; i++) {
                debris.push({
                    x: cx + (Math.random() - 0.5) * 40,
                    y: cy + (Math.random() - 0.5) * 40,
                    vx: (Math.random() - 0.5) * 8,
                    vy: -Math.random() * 6 - 3,
                    size: 6 + Math.random() * 10,
                    color: Math.random() > 0.5 ? '#44FF44' : '#FFD700',
                    alpha: 1,
                    rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.4
                });
            }
        }

        // æ˜¾ç¤ºæµ®åŠ¨æ–‡å­—
        function showFloatingText(x, y, text, color) {
            const textObj = {
                x: x, y: y, text: text, color: color,
                alpha: 1, vy: -1.5, life: 60
            };
            if (!window.floatingTexts) window.floatingTexts = [];
            window.floatingTexts.push(textObj);
        }

        // è·å–æ•ˆæœåç§°
        function getEffectName(effect, type) {
            const names = {
                'meteor': 'â˜„ï¸ é™¨çŸ³æ¥è¢­!',
                'multiMeteor': 'â˜„ï¸â˜„ï¸ æµæ˜Ÿé›¨!',
                'enemyHeal': 'ğŸ’— æ•Œäººå›è¡€!',
                'losePoints': 'ğŸ’” æ‰£åˆ†!',
                'starfall': 'â­ å¹¸è¿æ˜Ÿ!',
                'multiStar': 'ğŸŒŸ æ˜Ÿæ˜Ÿé›¨!',
                'bonusPoints': 'ğŸ’° å¥–åŠ±ç§¯åˆ†!',
                'extraBuddy': 'ğŸ é¢å¤–é“å…·!',
                'destroyBlocks': 'ğŸ’¥ æ–¹å—ç ´å!'
            };
            return names[effect] || (type === 'bad' ? 'åè¿æ°”!' : 'å¥½è¿æ°”!');
        }

        // è·å–é“å…·åç§°
        function getBuddyName(type) {
            const names = {
                'dogman': 'ç‹—è¶…äºº',
                'lilpetey': 'å°çš®å¼Ÿ',
                '80hd': 'æœºå™¨ç‹—',
                'flippy': 'å¿µåŠ›é±¼'
            };
            return names[type] || type;
        }

        function handleVillainCollision(p, villain) {
            const damage = p.type === '80hd' ? 2 : 1;
            villain.health -= damage;

            playImpact('default');
            p.vx *= 0.5;
            p.vy *= 0.5;

            if (villain.health <= 0) {
                villain.alive = false;
                score += villain.type === 'robot' || villain.type === 'piggy' ? 1000 : 500;
                playVillainDefeatSound(villain.type);
                createDebrisFromVillain(villain);
            }

            updateUI();
            checkGameEnd();
        }

        function createDebrisFromBlock(block) {
            const color = block.type === 'wood' ? '#DEB887' : block.type === 'stone' ? '#808080' : '#87CEEB';
            for (let i = 0; i < 10; i++) {
                debris.push({
                    x: block.x + Math.random() * (block.w || 40),
                    y: block.y + Math.random() * (block.h || 40),
                    vx: (Math.random() - 0.5) * 8,
                    vy: -Math.random() * 6 - 2,
                    size: 4 + Math.random() * 8,
                    color: color,
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.3
                });
            }
        }

        function createDebrisFromVillain(villain) {
            const cx = villain.x + villain.width / 2;
            const cy = villain.y + villain.height / 2;

            // æ ¹æ®ä¸åŒåæ´¾ç±»å‹åˆ›å»ºä¸åŒçš„çˆ†ç‚¸æ•ˆæœ
            switch(villain.type) {
                case 'petey':
                    // Petey - æ©˜è‰²æ¯›å‘é£æº… + æ„¤æ€’çš„æ˜Ÿæ˜Ÿ
                    createPeteyExplosion(cx, cy);
                    break;
                case 'flatpetey':
                    // Flat Petey - çº¸ç‰‡ç¢ç‰‡é£æ•£
                    createPaperExplosion(cx, cy);
                    break;
                case 'piggy':
                    // Piggy - ç²‰è‰²çƒŸé›¾ + çœ¼é•œé£å‡º
                    createPiggyExplosion(cx, cy);
                    break;
                case 'robot':
                    // Robot - é‡‘å±ç¢ç‰‡ + ç”µç«èŠ± + å†’çƒŸ
                    createRobotExplosion(cx, cy);
                    break;
                default:
                    createDefaultExplosion(cx, cy, '#FF8C00');
            }
        }

        // Peteyçˆ†ç‚¸ - æ©˜è‰²æ¯›å‘ + æ„¤æ€’æ˜Ÿæ˜Ÿ
        function createPeteyExplosion(cx, cy) {
            // æ©˜è‰²æ¯›å‘ç¢ç‰‡
            for (let i = 0; i < 20; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 4 + Math.random() * 8;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 5,
                    size: 4 + Math.random() * 8,
                    color: Math.random() > 0.5 ? '#FF9800' : '#BF360C',
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.6,
                    type: 'fur'
                });
            }
            // æ„¤æ€’æ˜Ÿæ˜Ÿ
            for (let i = 0; i < 5; i++) {
                particles.push({
                    x: cx + (Math.random() - 0.5) * 40,
                    y: cy + (Math.random() - 0.5) * 40,
                    vx: (Math.random() - 0.5) * 4,
                    vy: -Math.random() * 5 - 2,
                    size: 15 + Math.random() * 10,
                    color: '#FFD700',
                    alpha: 1,
                    type: 'star'
                });
            }
        }

        // Flat Peteyçˆ†ç‚¸ - çº¸ç‰‡é£æ•£
        function createPaperExplosion(cx, cy) {
            for (let i = 0; i < 25; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 3 + Math.random() * 6;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 3,
                    size: 8 + Math.random() * 15,
                    color: Math.random() > 0.7 ? '#FF9800' : '#FFF8E1',
                    alpha: 1,
                    rotation: Math.random() * Math.PI,
                    rotSpeed: (Math.random() - 0.5) * 0.8,
                    type: 'paper'
                });
            }
        }

        // Piggyçˆ†ç‚¸ - ç²‰è‰²çƒŸé›¾ + çœ¼é•œ
        function createPiggyExplosion(cx, cy) {
            // ç²‰è‰²çƒŸé›¾
            for (let i = 0; i < 15; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 5;
                particles.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 3,
                    size: 20 + Math.random() * 30,
                    color: '#FFB6C1',
                    alpha: 0.7,
                    type: 'smoke'
                });
            }
            // çœ¼é•œé£å‡º
            debris.push({
                x: cx, y: cy - 10,
                vx: -3 + Math.random() * 6,
                vy: -8 - Math.random() * 5,
                size: 25,
                color: '#5D4037',
                alpha: 1,
                rotation: 0,
                rotSpeed: 0.3,
                type: 'glasses'
            });
            // ç²‰è‰²ç¢ç‰‡
            for (let i = 0; i < 12; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 4 + Math.random() * 6;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 4,
                    size: 5 + Math.random() * 8,
                    color: '#FFB6C1',
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.5
                });
            }
        }

        // Robotçˆ†ç‚¸ - é‡‘å±ç¢ç‰‡ + ç”µç«èŠ± + å†’çƒŸ
        function createRobotExplosion(cx, cy) {
            // é‡‘å±ç¢ç‰‡
            for (let i = 0; i < 18; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 5 + Math.random() * 8;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 6,
                    size: 6 + Math.random() * 12,
                    color: Math.random() > 0.5 ? '#78909C' : '#455A64',
                    alpha: 1,
                    rotation: Math.random() * Math.PI,
                    rotSpeed: (Math.random() - 0.5) * 0.7,
                    type: 'metal'
                });
            }
            // ç”µç«èŠ±
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    particles.push({
                        x: cx + (Math.random() - 0.5) * 50,
                        y: cy + (Math.random() - 0.5) * 50,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        size: 3 + Math.random() * 5,
                        color: Math.random() > 0.5 ? '#FFEB3B' : '#FF5722',
                        alpha: 1,
                        type: 'spark'
                    });
                }, i * 50);
            }
            // å†’çƒŸæ•ˆæœ
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x: cx + (Math.random() - 0.5) * 30,
                    y: cy,
                    vx: (Math.random() - 0.5) * 2,
                    vy: -2 - Math.random() * 3,
                    size: 25 + Math.random() * 20,
                    color: '#37474F',
                    alpha: 0.6,
                    type: 'smoke'
                });
            }
        }

        // é»˜è®¤çˆ†ç‚¸
        function createDefaultExplosion(cx, cy, color) {
            for (let i = 0; i < 12; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 4 + Math.random() * 6;
                debris.push({
                    x: cx, y: cy,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 4,
                    size: 5 + Math.random() * 10,
                    color: color,
                    alpha: 1,
                    rotation: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.4
                });
            }
        }

        function createDustParticles(x, y, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x + (Math.random() - 0.5) * 20,
                    y: y,
                    vx: (Math.random() - 0.5) * 3,
                    vy: -Math.random() * 2 - 1,
                    size: 3 + Math.random() * 4,
                    color: '#8B7355',
                    alpha: 0.7
                });
            }
        }

        // å±å¹•éœ‡åŠ¨æ•ˆæœ
        let screenShake = { x: 0, y: 0, intensity: 0 };

        function triggerScreenShake(intensity, duration) {
            screenShake.intensity = intensity;
            screenShake.duration = duration;
        }

        function updateScreenShake() {
            if (screenShake.intensity > 0) {
                screenShake.x = (Math.random() - 0.5) * screenShake.intensity * 2;
                screenShake.y = (Math.random() - 0.5) * screenShake.intensity * 2;
                screenShake.intensity *= 0.9;
                if (screenShake.intensity < 0.5) {
                    screenShake.intensity = 0;
                    screenShake.x = 0;
                    screenShake.y = 0;
                }
            }
        }

        // åè¿æ°”å‡»ä¸­æ•ˆæœ - éå¸¸æ˜æ˜¾çš„çº¢è‰²çˆ†ç‚¸
        function createBadHitEffect(x, y) {
            // å¼ºçƒˆå±å¹•éœ‡åŠ¨
            triggerScreenShake(15, 20);

            // å¤§å‹çº¢è‰²çˆ†ç‚¸
            for (let i = 0; i < 40; i++) {
                const angle = (i / 40) * Math.PI * 2;
                const speed = 5 + Math.random() * 10;
                particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: 8 + Math.random() * 12,
                    color: Math.random() > 0.5 ? '#FF0000' : '#FF4500',
                    alpha: 1
                });
            }

            // çº¢è‰²å†²å‡»æ³¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: x, y: y,
                radius: 10,
                maxRadius: 150,
                color: 'rgba(255, 0, 0, 0.6)',
                lineWidth: 8
            });

            // æ˜¾ç¤ºå¤§å‹è­¦å‘Šæ–‡å­—
            showBigText('ğŸ’€ åè¿æ°”! å¼¹å°„ç‰©è¢«æ‘§æ¯!', '#FF0000', 120);
        }

        // å¥½è¿æ°”å‡»ä¸­æ•ˆæœ - æ˜æ˜¾çš„é‡‘è‰²/ç»¿è‰²åº†ç¥
        function createGoodHitEffect(x, y) {
            // å±å¹•éœ‡åŠ¨
            triggerScreenShake(10, 15);

            // é‡‘è‰²æ˜Ÿæ˜Ÿçˆ†ç‚¸
            for (let i = 0; i < 50; i++) {
                const angle = (i / 50) * Math.PI * 2;
                const speed = 4 + Math.random() * 8;
                particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 3,
                    size: 6 + Math.random() * 10,
                    color: ['#FFD700', '#00FF00', '#FFFF00', '#7CFC00'][Math.floor(Math.random() * 4)],
                    alpha: 1
                });
            }

            // ç»¿è‰²å†²å‡»æ³¢
            if (!window.shockwaves) window.shockwaves = [];
            window.shockwaves.push({
                x: x, y: y,
                radius: 10,
                maxRadius: 120,
                color: 'rgba(0, 255, 0, 0.5)',
                lineWidth: 6
            });

            // æ˜¾ç¤ºåº†ç¥æ–‡å­—
            showBigText('â­ å¥½è¿æ°”! æ•Œäººè¢«æ¶ˆç­!', '#00FF00', 100);
        }

        // æ˜¾ç¤ºå¤§å‹æ–‡å­—æç¤º
        function showBigText(text, color, duration) {
            if (!window.bigTexts) window.bigTexts = [];
            window.bigTexts.push({
                text: text,
                color: color,
                alpha: 1,
                scale: 0.5,
                duration: duration,
                maxDuration: duration
            });
        }

        // ç»˜åˆ¶å†²å‡»æ³¢
        function drawShockwaves() {
            if (!window.shockwaves) return;
            window.shockwaves.forEach(sw => {
                ctx.beginPath();
                ctx.arc(sw.x, sw.y, sw.radius, 0, Math.PI * 2);
                ctx.strokeStyle = sw.color;
                ctx.lineWidth = sw.lineWidth * (1 - sw.radius / sw.maxRadius);
                ctx.stroke();
                sw.radius += 8;
            });
            window.shockwaves = window.shockwaves.filter(sw => sw.radius < sw.maxRadius);
        }

        // ç»˜åˆ¶å¤§å‹æ–‡å­—
        function drawBigTexts() {
            if (!window.bigTexts) return;
            window.bigTexts.forEach(bt => {
                ctx.save();
                ctx.globalAlpha = bt.alpha;
                ctx.font = `bold ${32 * bt.scale}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // é»‘è‰²æè¾¹
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 4;
                ctx.strokeText(bt.text, canvas.width / 2, canvas.height / 3);

                // å¡«å……é¢œè‰²
                ctx.fillStyle = bt.color;
                ctx.fillText(bt.text, canvas.width / 2, canvas.height / 3);
                ctx.restore();

                // åŠ¨ç”»
                if (bt.scale < 1.2) bt.scale += 0.05;
                bt.duration--;
                if (bt.duration < 30) bt.alpha = bt.duration / 30;
            });
            window.bigTexts = window.bigTexts.filter(bt => bt.duration > 0);
        }

        // ========================================
        // äº‹ä»¶å¤„ç†
        // ========================================
        function setupEventListeners() {
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('click', handleClick);
            canvas.addEventListener('touchstart', e => { e.preventDefault(); handleMouseDown(getTouchEvent(e)); });
            canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMouseMove(getTouchEvent(e)); });
            canvas.addEventListener('touchend', e => { e.preventDefault(); handleMouseUp(e); });
        }

        function getTouchEvent(e) {
            return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function handleMouseDown(e) {
            if (gameState !== 'ready' || !projectile) return;
            const pos = getMousePos(e);
            if (getDistance(pos, projectile) < projectile.radius + 25) {
                isDragging = true;
                gameState = 'aiming';
                initAudio();
                playStretchSound();
            }
        }

        function handleMouseMove(e) {
            if (!isDragging || gameState !== 'aiming') return;
            const pos = getMousePos(e);

            const dx = pos.x - SLINGSHOT_X;
            const dy = pos.y - SLINGSHOT_Y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist > MAX_PULL_DISTANCE) {
                projectile.x = SLINGSHOT_X + (dx / dist) * MAX_PULL_DISTANCE;
                projectile.y = SLINGSHOT_Y + (dy / dist) * MAX_PULL_DISTANCE;
            } else {
                projectile.x = pos.x;
                projectile.y = pos.y;
            }

            if (projectile.x > SLINGSHOT_X) projectile.x = SLINGSHOT_X;
        }

        function handleMouseUp(e) {
            if (!isDragging || gameState !== 'aiming') return;
            isDragging = false;
            launchProjectile();
        }

        function handleClick(e) {
            if (gameState === 'flying' && projectile && projectile.active && !projectile.specialUsed) {
                if (projectile.special === 'split') {
                    projectile.specialUsed = true;
                    playSplitSound();
                    playMeowSound();
                    for (let i = -1; i <= 1; i++) {
                        if (i === 0) continue;
                        projectiles.push({
                            ...projectile,
                            x: projectile.x,
                            y: projectile.y,
                            vx: projectile.vx + i * 4,
                            vy: projectile.vy + i * 2.5,
                            radius: 14,
                            active: true,
                            specialUsed: true
                        });
                    }
                } else if (projectile.special === 'boost') {
                    projectile.specialUsed = true;
                    projectile.boostActive = true; // æ ‡è®°ç´«å…‰æ¿€æ´»
                    playBoostSound();
                    const speed = Math.sqrt(projectile.vx ** 2 + projectile.vy ** 2);
                    const angle = Math.atan2(projectile.vy, projectile.vx);
                    projectile.vx = Math.cos(angle) * (speed + 18);
                    projectile.vy = Math.sin(angle) * (speed + 18);

                    // ç´«å…‰å†²å‡»æ³¢
                    if (!window.shockwaves) window.shockwaves = [];
                    window.shockwaves.push({
                        x: projectile.x, y: projectile.y,
                        radius: 5, maxRadius: 120,
                        color: 'rgba(156, 39, 176, 0.6)', lineWidth: 8
                    });

                    // ç´«è‰²å¿µåŠ›çˆ†å‘ç‰¹æ•ˆ
                    for (let i = 0; i < 25; i++) {
                        const burstAngle = (i / 25) * Math.PI * 2;
                        particles.push({
                            x: projectile.x,
                            y: projectile.y,
                            vx: Math.cos(burstAngle) * (3 + Math.random() * 5),
                            vy: Math.sin(burstAngle) * (3 + Math.random() * 5),
                            size: 5 + Math.random() * 8,
                            color: ['#9C27B0', '#E040FB', '#AA00FF', '#7B1FA2'][Math.floor(Math.random() * 4)],
                            alpha: 1
                        });
                    }

                    // ç´«è‰²å°¾è¿¹ç²’å­
                    for (let i = 0; i < 15; i++) {
                        particles.push({
                            x: projectile.x,
                            y: projectile.y,
                            vx: -projectile.vx * 0.15 + (Math.random() - 0.5) * 4,
                            vy: -projectile.vy * 0.15 + (Math.random() - 0.5) * 4,
                            size: 6 + Math.random() * 6,
                            color: '#E040FB',
                            alpha: 1
                        });
                    }
                } else if (projectile.special === 'shockwave') {
                    // Chief å†²å‡»æ³¢æŠ€èƒ½ - èŒƒå›´ä¼¤å®³
                    projectile.specialUsed = true;
                    playSimpleSound(150, 0.3, 'square');
                    playSimpleSound(100, 0.4, 'sawtooth');

                    // å¤§èŒƒå›´å†²å‡»æ³¢
                    if (!window.shockwaves) window.shockwaves = [];
                    window.shockwaves.push({
                        x: projectile.x, y: projectile.y,
                        radius: 10, maxRadius: 200,
                        color: 'rgba(46, 134, 171, 0.7)', lineWidth: 12
                    });

                    // å¯¹èŒƒå›´å†…çš„æ–¹å—å’Œæ•Œäººé€ æˆä¼¤å®³
                    const shockRadius = 150;
                    blocks.forEach(b => {
                        const dist = Math.sqrt((b.x + b.w/2 - projectile.x)**2 + (b.y + b.h/2 - projectile.y)**2);
                        if (dist < shockRadius && b.type !== 'stone') {
                            b.health -= 50;
                        }
                    });
                    villains.forEach(v => {
                        if (v.alive) {
                            const dist = Math.sqrt((v.x + v.width/2 - projectile.x)**2 + (v.y + v.height/2 - projectile.y)**2);
                            if (dist < shockRadius) {
                                v.health -= 1;
                                if (v.health <= 0) {
                                    v.alive = false;
                                    score += 5000;
                                }
                            }
                        }
                    });

                    // å†²å‡»æ³¢ç²’å­
                    for (let i = 0; i < 30; i++) {
                        const angle = (i / 30) * Math.PI * 2;
                        particles.push({
                            x: projectile.x,
                            y: projectile.y,
                            vx: Math.cos(angle) * 8,
                            vy: Math.sin(angle) * 8,
                            size: 5 + Math.random() * 5,
                            color: '#2E86AB',
                            alpha: 1
                        });
                    }
                } else if (projectile.special === 'boomerang') {
                    // Sarah å›æ—‹é•–æŠ€èƒ½ - è¿”å›å¹¶å†æ¬¡æ”»å‡»
                    projectile.specialUsed = true;
                    projectile.boomerangActive = true;
                    playSimpleSound(600, 0.15, 'sine');
                    playSimpleSound(800, 0.15, 'sine');

                    // åè½¬é€Ÿåº¦å¹¶åŠ é€Ÿ
                    projectile.vx = -projectile.vx * 1.3;
                    projectile.vy = -projectile.vy * 0.5 - 5;

                    // å›æ—‹ç‰¹æ•ˆ
                    for (let i = 0; i < 20; i++) {
                        const angle = (i / 20) * Math.PI * 2;
                        particles.push({
                            x: projectile.x,
                            y: projectile.y,
                            vx: Math.cos(angle) * 5,
                            vy: Math.sin(angle) * 5,
                            size: 4 + Math.random() * 4,
                            color: '#E91E63',
                            alpha: 1
                        });
                    }
                } else if (projectile.special === 'heavy') {
                    // 80-HD è¶…çº§é‡å‡» - ç›´æ¥å‘ä¸‹ç ¸
                    projectile.specialUsed = true;
                    playSimpleSound(80, 0.3, 'square');

                    // å¢åŠ è´¨é‡å’Œå‘ä¸‹é€Ÿåº¦
                    projectile.mass = 5;
                    projectile.vy = Math.abs(projectile.vy) + 15;
                    projectile.vx *= 0.3;

                    // é‡å‡»ç‰¹æ•ˆ
                    for (let i = 0; i < 15; i++) {
                        particles.push({
                            x: projectile.x,
                            y: projectile.y + 20,
                            vx: (Math.random() - 0.5) * 6,
                            vy: Math.random() * 5,
                            size: 6 + Math.random() * 6,
                            color: '#5DADE2',
                            alpha: 1
                        });
                    }
                }
            }
        }

        function launchProjectile() {
            const power = Math.min(getDistance(projectile, { x: SLINGSHOT_X, y: SLINGSHOT_Y }), MAX_PULL_DISTANCE);
            const angle = Math.atan2(SLINGSHOT_Y - projectile.y, SLINGSHOT_X - projectile.x);

            projectile.vx = Math.cos(angle) * power * LAUNCH_POWER_MULTIPLIER;
            projectile.vy = Math.sin(angle) * power * LAUNCH_POWER_MULTIPLIER;
            projectile.x = SLINGSHOT_X;
            projectile.y = SLINGSHOT_Y;
            projectile.active = true;

            playLaunchSound(projectile.type);
            buddies[currentBuddyIndex].used = true;
            gameState = 'flying';
            renderBuddiesPanel();
        }

        // ========================================
        // æ¸¸æˆé€»è¾‘
        // ========================================
        function checkGameEnd() {
            const alive = villains.filter(v => v.alive).length;
            document.getElementById('villainsLeft').textContent = alive;

            if (alive === 0) {
                gameState = 'won';
                const used = buddies.filter(b => b.used).length;
                const unused = buddies.length - used;
                const lvl = levels[currentLevel - 1];
                let stars = 1;
                if (used <= lvl.stars[2]) stars = 3;
                else if (used <= lvl.stars[1]) stars = 2;

                // è®¡ç®—æœªä½¿ç”¨é“å…·çš„å¥–åŠ±åˆ†æ•°
                let bonusScore = 0;
                buddies.forEach((buddy, index) => {
                    if (!buddy.used) {
                        // ä¸åŒé“å…·ä¸åŒå¥–åŠ±
                        const bonusValues = {
                            'dogman': 5000,
                            'lilpetey': 6000,
                            '80hd': 7000,
                            'flippy': 8000
                        };
                        bonusScore += bonusValues[buddy.type] || 5000;
                    }
                });

                score += bonusScore;
                lastBonusScore = bonusScore;
                lastUnusedCount = unused;

                levelProgress[currentLevel] = {
                    completed: true,
                    stars: Math.max(stars, levelProgress[currentLevel]?.stars || 0),
                    score: Math.max(score, levelProgress[currentLevel]?.score || 0)
                };
                localStorage.setItem('dogmanLevelProgress', JSON.stringify(levelProgress));
                setTimeout(() => showResult(true, stars, bonusScore, unused), 1200);
            } else if (currentBuddyIndex >= buddies.length - 1 && gameState === 'waiting') {
                if (!projectile?.active && projectiles.length === 0) {
                    setTimeout(() => {
                        if (villains.filter(v => v.alive).length > 0) {
                            gameState = 'lost';
                            showResult(false, 0, 0, 0);
                        }
                    }, 1200);
                }
            }
        }

        function showResult(won, stars, bonusScore = 0, unusedCount = 0) {
            document.getElementById('resultTitle').textContent = won ?
                (currentLevel === MAX_LEVELS ? 'æ­å–œé€šå…³!' : 'å…³å¡å®Œæˆ!') : 'å¤±è´¥';

            let starText = '';
            for (let i = 0; i < 3; i++) starText += i < stars ? 'â­' : 'â˜†';
            document.getElementById('resultStars').textContent = starText;

            // æ˜¾ç¤ºè¯¦ç»†åˆ†æ•°
            let scoreHTML = `åŸºç¡€åˆ†æ•°: ${score - bonusScore}`;
            if (bonusScore > 0) {
                scoreHTML += `<br><span style="color: #4CAF50;">ğŸ é“å…·å›æ”¶å¥–åŠ± x${unusedCount}: +${bonusScore}</span>`;
            }
            scoreHTML += `<br><strong style="font-size: 1.3em;">æ€»åˆ†: ${score}</strong>`;
            document.getElementById('resultScore').innerHTML = scoreHTML;

            document.getElementById('resultNextBtn').style.display = (won && currentLevel < MAX_LEVELS) ? 'inline-block' : 'none';
            document.getElementById('resultModal').style.display = 'flex';

            if (won) playVictorySound(); else playFailSound();
            updateStarsDisplay(stars);
            document.getElementById('nextLevelBtn').disabled = !won || currentLevel >= MAX_LEVELS;
        }

        function closeResultModal() {
            document.getElementById('resultModal').style.display = 'none';
        }

        function restartLevel() {
            playClickSound();
            closeResultModal();
            loadLevel(currentLevel);
        }

        function nextLevel() {
            if (currentLevel < MAX_LEVELS) {
                playClickSound();
                currentLevel++;
                closeResultModal();
                loadLevel(currentLevel);
                generateLevelButtons();
            }
        }

        function updateUI() {
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('currentScore').textContent = score;
            document.getElementById('villainsLeft').textContent = villains.filter(v => v.alive).length;
        }

        function updateStarsDisplay(stars) {
            for (let i = 1; i <= 3; i++) {
                document.getElementById('star' + i).className = 'star' + (i <= stars ? ' earned' : '');
            }
        }

        function renderBuddiesPanel() {
            const panel = document.getElementById('buddiesPanel');
            panel.innerHTML = '';
            buddies.forEach((b, i) => {
                const slot = document.createElement('div');
                slot.className = 'buddy-slot' +
                    (i === currentBuddyIndex && !b.used ? ' active' : '') +
                    (b.used ? ' used' : '') +
                    (i === selectedBuddyIndex && !b.used ? ' selected' : '');

                // åˆ›å»ºå°canvasæ˜¾ç¤ºè§’è‰²å›¾æ ‡
                const miniCanvas = document.createElement('canvas');
                miniCanvas.width = 50;
                miniCanvas.height = 50;
                miniCanvas.style.width = '50px';
                miniCanvas.style.height = '50px';
                const miniCtx = miniCanvas.getContext('2d');

                // ç»˜åˆ¶å°ç‰ˆæœ¬çš„è§’è‰²
                miniCtx.save();
                miniCtx.translate(25, 28);
                miniCtx.scale(0.65, 0.65);
                drawBuddyOnContext(miniCtx, b.type, 22);
                miniCtx.restore();

                slot.appendChild(miniCanvas);
                slot.title = b.name + ' - ' + (buddyTypes[b.type]?.desc || '');

                // ç‚¹å‡»é€‰æ‹©è§’è‰²ï¼ˆè‡ªé€‰åŠŸèƒ½ï¼‰
                if (!b.used) {
                    slot.style.cursor = 'pointer';
                    let handled = false;
                    slot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (!handled && gameState === 'ready') {
                            handled = true;
                            selectBuddy(i);
                            setTimeout(() => handled = false, 300);
                        }
                    });
                    slot.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!handled && gameState === 'ready') {
                            handled = true;
                            selectBuddy(i);
                            setTimeout(() => handled = false, 300);
                        }
                    });
                }

                panel.appendChild(slot);
            });
        }

        // é€‰æ‹©è§’è‰²ï¼ˆè‡ªé€‰åŠŸèƒ½ï¼‰
        function selectBuddy(index) {
            if (buddies[index] && !buddies[index].used && gameState === 'ready') {
                currentBuddyIndex = index;
                selectedBuddyIndex = index;
                playSimpleSound(500, 0.1, 'sine'); // é€‰æ‹©éŸ³æ•ˆ
                renderBuddiesPanel();
                placeCurrentBuddy(); // æ›´æ–°å¼¹å¼“ä¸Šçš„è§’è‰²
            }
        }

        function showLevelSelect() {
            playClickSound();
            generateLevelButtons();
            document.getElementById('levelSelectModal').style.display = 'flex';
        }

        function closeLevelSelect() {
            playClickSound();
            document.getElementById('levelSelectModal').style.display = 'none';
        }

        function generateLevelButtons() {
            const grid = document.getElementById('levelsGrid');
            grid.innerHTML = '';
            for (let i = 1; i <= MAX_LEVELS; i++) {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                const progress = levelProgress[i];
                const unlocked = i === 1 || levelProgress[i - 1]?.completed;
                if (progress?.completed) btn.classList.add('completed');
                btn.disabled = !unlocked;
                btn.innerHTML = `${i}<div class="level-stars">${progress?.stars ? 'â­'.repeat(progress.stars) : ''}</div>`;
                btn.onclick = () => { if (unlocked) { playClickSound(); closeLevelSelect(); loadLevel(i); } };
                grid.appendChild(btn);
            }
        }

        function getDistance(a, b) {
            return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
        }

        function lightenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.min(255, (num >> 16) + amt);
            const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            const B = Math.min(255, (num & 0x0000FF) + amt);
            return `rgb(${R},${G},${B})`;
        }

        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, (num >> 16) - amt);
            const G = Math.max(0, ((num >> 8) & 0x00FF) - amt);
            const B = Math.max(0, (num & 0x0000FF) - amt);
            return `rgb(${R},${G},${B})`;
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        // ========================================
        // iOS æ£€æµ‹
        // ========================================
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.navigator.standalone === true;
        let iosFullscreenMode = false;

        // ========================================
        // å…¨å±åŠŸèƒ½ (æ”¯æŒ iOS)
        // ========================================
        function toggleFullscreen() {
            const elem = document.documentElement;
            const btn = document.getElementById('fullscreenBtn');

            // iOS ä¸æ”¯æŒæ ‡å‡† Fullscreen APIï¼Œä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆ
            if (isIOS) {
                toggleIOSFullscreen();
                return;
            }

            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                }
                btn.textContent = 'âœ•';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
                btn.textContent = 'â›¶';
            }
        }

        // iOS ä¼ªå…¨å±æ¨¡å¼
        function toggleIOSFullscreen() {
            const btn = document.getElementById('fullscreenBtn');
            iosFullscreenMode = !iosFullscreenMode;

            if (iosFullscreenMode) {
                document.body.classList.add('ios-fullscreen');
                btn.textContent = 'âœ•';
                // æ»šåŠ¨åˆ°é¡¶éƒ¨éšè—åœ°å€æ 
                window.scrollTo(0, 1);
                // æ˜¾ç¤ºé€€å‡ºæç¤º
                showIOSFullscreenTip();
            } else {
                document.body.classList.remove('ios-fullscreen');
                btn.textContent = 'â›¶';
            }
        }

        // æ˜¾ç¤º iOS å…¨å±æç¤º
        function showIOSFullscreenTip() {
            // å¦‚æœä¸æ˜¯ä»ä¸»å±å¹•å¯åŠ¨ï¼Œæç¤ºç”¨æˆ·
            if (!isStandalone && isIOS) {
                const existingTip = document.getElementById('iosTip');
                if (existingTip) existingTip.remove();

                const tip = document.createElement('div');
                tip.id = 'iosTip';
                tip.innerHTML = `
                    <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
                        background:rgba(0,0,0,0.9);color:white;padding:25px;border-radius:15px;
                        z-index:9999;text-align:center;max-width:300px;border:2px solid #FFD700;">
                        <div style="font-size:2rem;margin-bottom:15px;">ğŸ“±</div>
                        <div style="font-size:1rem;margin-bottom:15px;font-weight:bold;color:#FFD700;">è·å¾—æœ€ä½³å…¨å±ä½“éªŒ</div>
                        <div style="font-size:0.85rem;line-height:1.6;margin-bottom:15px;">
                            æ¨ªå±æ¸¸ç©æ•ˆæœæ›´å¥½ï¼<br><br>
                            ç‚¹å‡» Safari åº•éƒ¨ <span style="font-size:1.2rem;">â¬†ï¸</span> æŒ‰é’®<br>
                            é€‰æ‹© "æ·»åŠ åˆ°ä¸»å±å¹•"<br>
                            å³å¯è·å¾—çœŸæ­£çš„å…¨å±ä½“éªŒï¼
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()"
                            style="background:#FFD700;color:#000;border:none;padding:10px 25px;
                            border-radius:20px;font-weight:bold;cursor:pointer;">çŸ¥é“äº†</button>
                    </div>
                `;
                document.body.appendChild(tip);
            }
        }

        // ç›‘å¬å…¨å±å˜åŒ–
        document.addEventListener('fullscreenchange', updateFullscreenBtn);
        document.addEventListener('webkitfullscreenchange', updateFullscreenBtn);

        function updateFullscreenBtn() {
            const btn = document.getElementById('fullscreenBtn');
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                btn.textContent = 'âœ•';
            } else {
                btn.textContent = 'â›¶';
            }
        }

        // ========================================
        // æ¸¸æˆå¯åŠ¨å‡½æ•° (æ”¯æŒ iOS éŸ³é¢‘)
        // ========================================
        let gameStarted = false;

        function startGame() {
            if (gameStarted) return;
            gameStarted = true;

            console.log('Starting game...');

            // åˆå§‹åŒ– HTML5 Audio æ± ä½œä¸ºå¤‡é€‰
            if (audioPool.length === 0) {
                initAudioPool();
            }

            // éšè—å¯åŠ¨ç”»é¢
            const startScreen = document.getElementById('startScreen');
            startScreen.style.opacity = '0';
            startScreen.style.transition = 'opacity 0.5s';
            setTimeout(() => {
                startScreen.style.display = 'none';
            }, 500);

            // åˆå§‹åŒ–æ¸¸æˆ
            init();

            // åœ¨ canvas ä¸Šæ·»åŠ è§¦æ‘¸ç›‘å¬æ¥è§£é”éŸ³é¢‘
            const gameCanvas = document.getElementById('gameCanvas');
            gameCanvas.addEventListener('touchstart', function() {
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        console.log('Canvas touch resumed audio');
                        playTestTone();
                    });
                }
            }, { passive: true });

            console.log('Game initialization complete');
        }

        // æ£€æµ‹æ˜¯å¦ä»ä¸»å±å¹•å¯åŠ¨ (PWAæ¨¡å¼)ï¼Œå¦‚æœæ˜¯åˆ™è‡ªåŠ¨å¼€å§‹
        if (isStandalone) {
            document.getElementById('startScreen').style.display = 'none';
            startGame();
        }

        // iOS å…³é”®ï¼šå¿…é¡»åœ¨ touchend/click äº‹ä»¶ç›‘å¬å™¨ä¸­åˆå§‹åŒ–éŸ³é¢‘
        document.getElementById('startGameBtn').addEventListener('touchend', function(e) {
            e.preventDefault();
            initAudioOnUserGesture();
            startGame();
        }, { passive: false });

        document.getElementById('startGameBtn').addEventListener('click', function(e) {
            initAudioOnUserGesture();
            startGame();
        });

        // åœ¨ç”¨æˆ·æ‰‹åŠ¿ä¸­åˆå§‹åŒ–éŸ³é¢‘ï¼ˆiOS å…³é”®ï¼‰
        function initAudioOnUserGesture() {
            const debug = document.getElementById('audioDebug');
            try {
                // åˆ›å»º AudioContext
                if (!audioCtx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    audioCtx = new AC();
                    if (debug) debug.textContent = 'Created: ' + audioCtx.state;
                }

                // åˆ›å»º gain èŠ‚ç‚¹
                if (!masterGain && audioCtx) {
                    masterGain = audioCtx.createGain();
                    masterGain.connect(audioCtx.destination);
                    masterGain.gain.value = 0.5;
                }

                // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        if (debug) debug.textContent = 'Resumed: ' + audioCtx.state;
                        audioInitialized = true;
                        // ç«‹å³æ’­æ”¾æµ‹è¯•éŸ³
                        playTestTone();
                    }).catch(err => {
                        if (debug) debug.textContent = 'Resume error: ' + err;
                    });
                } else {
                    if (debug) debug.textContent = 'State: ' + audioCtx.state;
                    audioInitialized = true;
                    playTestTone();
                }
            } catch (err) {
                if (debug) debug.textContent = 'Error: ' + err;
            }
        }

        // ç®€å•æµ‹è¯•éŸ³
        function playTestTone() {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 660;
                gain.gain.value = 0.3;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.2);
                console.log('Test tone played');
            } catch (e) {
                console.error('Test tone error:', e);
            }
        }
    </script>
</body>
</html>
